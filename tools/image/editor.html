<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: blob:; connect-src 'self' https:; worker-src 'self' blob:; media-src 'self' blob: mediastream:;">
    <title>Pro Image Editor - Vibox</title>
    <link rel="icon" href="../../favicon.png" type="image/png">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="./editor.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <!-- Menu Bar -->
    <div class="menu-bar">
        <a href="../../index.html" class="app-logo"><span>V</span> Photo Editor</a>
        <div class="menu-item" onclick="toggleDropdown('file-dd')">File
            <div class="dropdown-content" id="file-dd">
                <div class="dropdown-item" onclick="document.getElementById('new-project-modal').style.display='flex'">
                    New Project...</div>
                <div class="dropdown-item" onclick="document.getElementById('file-input-load').click()">Open Project...
                </div>
                <div class="dropdown-item" onclick="saveProject()">Save Project</div>
                <div class="dropdown-item" onclick="exportImage()">Export as PNG...</div>
                <div class="dropdown-item" onclick="closeProject()">Close Project</div>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('edit-dd')">Edit
            <div class="dropdown-content" id="edit-dd">
                <div class="dropdown-item" onclick="restoreHistory(state.historyIndex-1)">Undo <span style='float:right;color:#888'>Ctrl+Z</span></div>
                <div class="dropdown-item" onclick="restoreHistory(state.historyIndex+1)">Redo <span style='float:right;color:#888'>Ctrl+Y</span></div>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('image-dd')">Image
            <div class="dropdown-content" id="image-dd">
                <div class="dropdown-item" onclick="openResizeModal('image')">Image Size</div>
                <div class="dropdown-item" onclick="openResizeModal('canvas')">Canvas Size</div>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('layer-dd')">Layer
            <div class="dropdown-content" id="layer-dd">
                <div class="dropdown-item" id="menu-new-layer">New Layer</div>
                <div class="dropdown-item" id="menu-del-layer">Delete Layer</div>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('select-dd')">Select
            <div class="dropdown-content" id="select-dd">
                <div class="dropdown-item" onclick="state.selection={x:0,y:0,w:state.config.width,h:state.config.height};state.selectionPath=null;state.selectionMask=null;">All <span style='float:right;color:#888'>Ctrl+A</span></div>
                <div class="dropdown-item" onclick="state.selection=null;state.selectionPath=null;state.selectionMask=null;">Deselect <span style='float:right;color:#888'>Ctrl+D</span></div>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('filter-dd')">Filter
            <div class="dropdown-content" id="filter-dd">
                <div class="dropdown-item" onclick="applyAutoFix()">? Auto Magic Fix</div>
                <div class="dropdown-item" onclick="openHueSatModal()">Hue/Saturation</div>
                <div class="dropdown-item" onclick="applyWorkerFilter('denoise')">Denoise</div>
                <div class="dropdown-item" onclick="applyWorkerFilter('blur')">Blur</div>
                <div class="dropdown-item" onclick="applyWorkerFilter('sharpen')">Sharpen</div>
                <div class="dropdown-item" onclick="applyWorkerFilter('emboss')">Emboss</div>
                <div class="dropdown-item" onclick="applyWorkerFilter('edge')">Edge Detect</div>
                <div class="dropdown-item" onclick="applyWorkerFilter('oil')">Oil Paint</div>
                <div class="dropdown-item" onclick="promptLevels()">Levels</div>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('view-dd')">View
            <div class="dropdown-content" id="view-dd">
                <div class="dropdown-item" onclick="state.zoom += 0.1; updateZoom();">Zoom In</div>
                <div class="dropdown-item" onclick="state.zoom -= 0.1; updateZoom();">Zoom Out</div>
                <div class="dropdown-item" onclick="openCompareModal()">Compare (Before/After)</div>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('window-dd')">Window
            <div class="dropdown-content" id="window-dd">
                <div class="dropdown-item">Arrange</div>
                <div class="dropdown-item">Workspace</div>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('more-dd')">More
            <div class="dropdown-content" id="more-dd">
                <div class="dropdown-item" onclick="document.getElementById('help-modal').style.display='flex'">Help
                </div>
                <div class="dropdown-item">About</div>
            </div>
        </div>

        <div style="margin-left:auto; display:flex; gap:10px;">
            <!-- Zoom/Dims -->
            <span id="canvas-dims" style="font-size:0.8rem; color:#aaa;">1080x720</span>
            <span id="zoom-level" style="font-size:0.8rem; color:#aaa;">100%</span>
        </div>
    </div>

    <!-- Options Bar -->
    <div class="options-bar" id="options-bar">
        <span style="color:#aaa; font-style:italic; margin-left:10px;">Tool Options</span>
    </div>

    <!-- Toolbar -->
    <div class="toolbar" id="toolbar">
        <div class="tool" data-tool="select-rect" title="Rect Select (M)"><i class="far fa-square"></i></div>
        <div class="tool" data-tool="select-lasso" title="Lasso Select (L)"><i class="fas fa-draw-polygon"></i></div>
        <div class="tool" data-tool="magic-wand" title="Magic Wand (W)"><i class="fas fa-magic"></i></div>
        <div class="tool active" data-tool="move" title="Move Tool (V)"><i class="fas fa-arrows-alt"></i></div>
        <div class="tool" data-tool="brush" title="Brush (B)"><i class="fas fa-paint-brush"></i></div>
        <div class="tool" data-tool="eraser" title="Eraser (E)"><i class="fas fa-eraser"></i></div>
        <div class="tool" data-tool="clone" title="Clone Stamp (S) - Alt+Click to Set Source"><i
                class="fas fa-stamp"></i></div>
        <div class="tool" data-tool="fill" title="Fill (G)"><i class="fas fa-fill-drip"></i></div>
        <div class="tool" data-tool="gradient" title="Gradient"><i class="fas fa-palette"></i></div>
        <div class="tool" data-tool="text" title="Text (T)"><i class="fas fa-font"></i></div>
        <div class="tool" data-tool="shape" title="Shapes (U)"><i class="fas fa-shapes"></i></div>
        <div class="tool" data-tool="pipette" title="Eyedropper (I)"><i class="fas fa-eye-dropper"></i></div>
        <div class="tool" data-tool="pen" title="Pen Tool (P)"><i class="fas fa-pen-nib"></i></div>
        <div class="tool" data-tool="dodge" title="Dodge"><i class="fas fa-sun"></i></div>
        <div class="tool" data-tool="burn" title="Burn"><i class="fas fa-moon"></i></div>
        <div class="tool" data-tool="blur-tool" title="Blur"><i class="fas fa-tint"></i></div>
        <div class="tool" data-tool="heal" title="Heal"><i class="fas fa-band-aid"></i></div>
    </div>

    <!-- Workspace -->
    <div class="workspace" id="workspace">
        <!-- Project Tabs -->
        <div class="project-bar" id="project-bar" style="display:none;">
            <div class="project-tab active">
                <span id="project-name-display">New Project.psd</span>
                <span class="project-close" onclick="closeProject()">&times;</span>
            </div>
        </div>

        <div id="viewport" style="width:100%; height:100%; position:relative; overflow:hidden;">
            <!-- Home Screen Overlay -->
            <div id="home-screen" class="home-screen">
                <div class="home-content">
                    <div class="home-logo"><span>V</span> Photo Editor</div>
                    <div class="home-btns">
                        <button class="home-btn" onclick="openNewProjectDialog()"><i class="fas fa-file"></i> New
                            Project</button>
                        <button class="home-btn" onclick="document.getElementById('file-upload').click()"><i
                                class="fas fa-folder-open"></i> Open From Computer</button>
                    </div>
                    <div class="drop-zone-msg">
                        Drop any files here
                    </div>
                    <div class="footer-icons">
                        <div class="footer-icon-group"><i class="fas fa-file-image"></i><span>PSD</span></div>
                        <div class="footer-icon-group"><i class="fas fa-file-pdf"></i><span>PDF</span></div>
                        <div class="footer-icon-group"><i class="fas fa-file-code"></i><span>SVG</span></div>
                        <div class="footer-icon-group"><i class="fas fa-file-alt"></i><span>RAW</span></div>
                        <div class="footer-icon-group"><i class="fas fa-image"></i><span>JPG</span></div>
                    </div>
                </div>
            </div>

            <div id="canvas-wrapper" class="hidden"
                style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
                <canvas id="canvas-stage"></canvas>
                <div id="transform-controls" class="transform-layer">
                    <div class="handle tl" data-handle="tl"></div>
                    <div class="handle tr" data-handle="tr"></div>
                    <div class="handle bl" data-handle="bl"></div>
                    <div class="handle br" data-handle="br"></div>
                    <div class="rot-line"></div>
                    <div class="handle rot" data-handle="rot" title="Rotate"></div>
                </div>
                <!-- Text Editor Overlay -->
                <div id="text-editor-overlay" style="display:none; position:absolute; z-index:200;">
                    <input type="text" id="text-input" style="font-size:20px; padding:5px;">
                    <button id="text-ok">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Panels -->
    <div class="panels">
        <!-- Top Panel (History / Swatches) -->
        <div class="panel-top">
            <div class="panel-tabs">
                <div class="panel-tab active">History</div>
                <div class="panel-tab">Swatches</div>
                <div class="panel-tab">Info</div>
            </div>
            <div class="history-list" id="history-list"></div>
        </div>

        <!-- Color Swatches (Photopea Style) -->
        <div class="tool-separator"></div>
        <div class="color-swatches">
            <div class="color-swatch bg-swatch" id="bg-color-display" title="Background Color"></div>
            <div class="color-swatch fg-swatch" id="fg-color-display" title="Foreground Color"></div>
            <div class="color-switch" id="btn-switch-colors" title="Switch Colors (X)"><i
                    class="fas fa-exchange-alt"></i></div>

            <!-- Hidden Inputs for logic -->
            <input type="color" id="fg-color-picker" style="display:none;">
            <input type="color" id="bg-color-picker" style="display:none;">
        </div>
        <!-- Bottom Panel (Layers / Paths) -->
        <div class="panel-bottom">
            <div class="panel-tabs">
                <div class="panel-tab active">Layers</div>
                <div class="panel-tab">Channels</div>
                <div class="panel-tab">Paths</div>
            </div>

            <div class="prop-row" style="background:var(--bg-panel); padding:5px 10px; border-bottom:1px solid #444;">
                <select id="layer-blend" style="width:80px; background:#444; border:none; color:#ddd;">
                    <option value="source-over">Normal</option>
                    <option value="multiply">Multiply</option>
                    <option value="screen">Screen</option>
                    <option value="overlay">Overlay</option>
                </select>
                <div class="slider-group" style="margin-left:10px;">
                    <span style="font-size:0.7rem;">Op:</span>
                    <input type="range" id="layer-opacity" min="0" max="100" value="100">
                </div>
            </div>

            <div class="layer-list" id="layer-list" style="flex:1; border-bottom:1px solid #444;"></div>

            <div class="layer-controls">
                <button class="layer-btn" id="btn-add-layer" title="New Layer"><i class="fas fa-plus"></i></button>
                <button class="layer-btn" id="btn-del-layer" title="Delete"><i class="fas fa-trash"></i></button>
                <button class="layer-btn" id="btn-add-group" title="New Group"><i class="fas fa-folder"></i></button>
                <button class="layer-btn" id="btn-add-mask" title="Mask"><i class="fas fa-mask"></i></button>
                <button class="layer-btn" title="Effects"><i class="fas fa-magic"></i></button>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="file-upload" accept="image/*" style="display:none">

    <!-- Modals -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal" style="width: 500px;">
            <h3>Keyboard Shortcuts</h3>
            <div class="shortcut-list">
                <div class="shortcut-item"><span>Move Tool</span> <span>V</span></div>
                <div class="shortcut-item"><span>Brush</span> <span>B</span></div>
                <div class="shortcut-item"><span>Eraser</span> <span>E</span></div>
                <div class="shortcut-item"><span>Text</span> <span>T</span></div>
                <div class="shortcut-item"><span>Rect Select</span> <span>M</span></div>
                <div class="shortcut-item"><span>Lasso Select</span> <span>L</span></div>
                <div class="shortcut-item"><span>Magic Wand</span> <span>W</span></div>
                <div class="shortcut-item"><span>Fill</span> <span>G</span></div>
                <div class="shortcut-item"><span>Clone Stamp</span> <span>S</span></div>
                <div class="shortcut-item"><span>Eyedropper</span> <span>I</span></div>
                <div class="shortcut-item"><span>Pen</span> <span>P</span></div>
                <div class="shortcut-item"><span>Shapes</span> <span>U</span></div>
                <div class="shortcut-item"><span>Switch Colors</span> <span>X</span></div>
                <div class="shortcut-item"><span>Undo</span> <span>Ctrl+Z</span></div>
                <div class="shortcut-item"><span>Redo</span> <span>Ctrl+Y</span></div>
                <div class="shortcut-item"><span>Deselect</span> <span>Ctrl+D</span></div>
                <div class="shortcut-item"><span>Save Project</span> <span>Ctrl+S</span></div>
                <div class="shortcut-item"><span>Export</span> <span>Ctrl+E</span></div>
                <div class="shortcut-item"><span>Pan Canvas</span> <span>Space+Drag</span></div>
                <div class="shortcut-item"><span>Zoom In/Out</span> <span>+/-</span></div>
                <div class="shortcut-item"><span>Brush Size</span> <span>[ / ]</span></div>
                <div class="shortcut-item"><span>Delete Selection</span> <span>Delete</span></div>
            </div>
            <div class="modal-btns">
                <button class="btn btn-primary"
                    onclick="document.getElementById('help-modal').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <!-- Advanced New Project Modal -->
    <div class="modal-overlay" id="new-project-modal" style="display:none; align-items:center; justify-content:center;">
        <div class="np-modal">
            <div class="np-header">
                <h3>New Project</h3>
                <button class="np-close"
                    onclick="document.getElementById('new-project-modal').style.display='none'">&times;</button>
            </div>
            <div class="np-body">
                <!-- Sidebar -->
                <div class="np-sidebar">
                    <div class="np-tab active" data-cat="social">Social</div>
                    <div class="np-tab" data-cat="print">Print</div>
                    <div class="np-tab" data-cat="photo">Photo</div>
                    <div class="np-tab" data-cat="screen">Screen</div>
                    <div class="np-tab" data-cat="mobile">Mobile</div>
                    <div class="np-tab" data-cat="ads">Ads</div>
                </div>

                <!-- Grid -->
                <div class="np-grid-wrapper">
                    <div class="np-grid" id="np-grid">
                        <!-- Templates injected here -->
                    </div>
                </div>

                <!-- Settings -->
                <div class="np-settings">
                    <div class="np-group">
                        <label>Name</label>
                        <input type="text" id="np-name" value="New Project">
                    </div>
                    <div class="np-row">
                        <div class="np-group">
                            <label>Width</label>
                            <input type="number" id="np-width" value="1280">
                        </div>
                        <div class="np-group">
                            <label>Height</label>
                            <input type="number" id="np-height" value="720">
                        </div>
                        <select id="np-unit" style="width:70px; margin-top:18px;">
                            <option value="px">px</option>
                            <option value="in">in</option>
                            <option value="mm">mm</option>
                        </select>
                    </div>
                    <div class="np-row">
                        <div class="np-group">
                            <label>DPI</label>
                            <input type="number" id="np-dpi" value="72">
                        </div>
                        <select style="width:100px; margin-top:18px;">
                            <option>Pixels/Inch</option>
                        </select>
                    </div>
                    <div class="np-group">
                        <label>Background</label>
                        <div class="np-bg-select">
                            <select id="np-bg-type" onchange="toggleNpColor(this.value)">
                                <option value="white">White</option>
                                <option value="black">Black</option>
                                <option value="transparent">Transparent</option>
                                <option value="custom">Custom</option>
                            </select>
                            <input type="color" id="np-bg-color" value="#ffffff"
                                style="display:none; width:30px; height:30px; border:none; padding:0;">
                        </div>
                    </div>
                    <div class="np-spacer"></div>
                    <button class="np-create-btn" id="btn-create-project">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Resize Modal (Kept for Image/Canvas Size) -->
    <div class="modal-overlay" id="resize-modal">
        <div class="modal">
            <h3 id="resize-title">Resize</h3>
            <div class="control-group">
                <label>Width (px)</label>
                <input type="number" id="resize-w" value="800" style="width:100%">
                <label>Height (px)</label>
                <input type="number" id="resize-h" value="600" style="width:100%">
                <div style="margin-top:10px;">
                    <input type="checkbox" id="resize-aspect" checked> <label for="resize-aspect"
                        style="display:inline;">Maintain Aspect Ratio</label>
                </div>
                <div style="margin-top:5px;">
                    <input type="checkbox" id="resize-hq"> <label for="resize-hq" style="display:inline;">High Quality
                        (Slower)</label>
                </div>
            </div>
            <div class="modal-btns">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('resize-modal').style.display='none'">Cancel</button>
                <button class="btn btn-primary" id="btn-do-resize">Apply</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="export-modal">
        <div class="modal">
            <h3>Export Image</h3>
            <!-- (Content same as before) -->
            <div class="control-group">
                <label>Format</label>
                <select id="export-format" style="width:100%; padding:5px; margin-bottom:10px;">
                    <option value="image/png">PNG</option>
                    <option value="image/jpeg">JPG</option>
                    <option value="image/webp">WEBP</option>
                </select>
                <button class="btn btn-secondary"
                    onclick="document.getElementById('export-modal').style.display='none'">Cancel</button>
                <button class="btn btn-primary" id="btn-do-export">Download</button>
                <button class="btn" id="btn-share-export"
                    style="display:none; background:var(--accent-color); color:white;"><i
                        class="fas fa-share-alt"></i></button>
                <button class="btn" id="btn-save-as-export" style="display:none; background:#9b59b6; color:white;"><i
                        class="fas fa-save"></i></button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="huesat-modal">
        <div class="modal">
            <h3>Hue / Saturation</h3>
            <div class="control-group">
                <label>Hue</label>
                <input type="range" id="hs-hue" min="-180" max="180" value="0">
                <label>Saturation</label>
                <input type="range" id="hs-sat" min="-100" max="100" value="0">
                <label>Lightness</label>
                <input type="range" id="hs-light" min="-100" max="100" value="0">
            </div>
            <div class="modal-btns">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('huesat-modal').style.display='none'">Cancel</button>
                <button class="btn btn-primary" id="btn-apply-huesat">Apply</button>
            </div>
        </div>
    </div>

    <!-- Compare Modal -->
    <div class="modal-overlay" id="compare-modal" style="display:none; align-items:center; justify-content:center;">
        <div class="compare-container">
            <div class="compare-header">
                <h3>Compare (Before / After)</h3>
                <button class="icon-btn" onclick="document.getElementById('compare-modal').style.display='none'"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="compare-view" id="compare-view">
                <img id="compare-before" class="compare-img">
                <img id="compare-after" class="compare-img">
                <div class="compare-slider">
                    <div class="compare-handle"><i class="fas fa-arrows-alt-h"></i></div>
                </div>
            </div>
            <p style="text-align:center; color:#aaa; margin-top:10px; font-size:0.9rem;">Drag slider to compare</p>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="file-input-load" style="display:none" accept=".vtz,.json"
        onchange="handleFileLoad(this.files[0])">

    <script type="module" src="../../js/image/main.js"></script>
</body>

</html>