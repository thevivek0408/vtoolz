<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Compressor - Privacy-First Tools</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-card {
            background: var(--background-color);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .image-card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            background: #fff;
            border-radius: 4px;
        }

        .stats {
            font-size: 0.85rem;
            margin-top: 10px;
            color: var(--text-muted);
        }

        .quality-slider {
            width: 100%;
            margin: 15px 0;
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <a href="../../index.html" class="logo">Vibox</a>
            <nav>
                <ul>
                    <li><a href="../image/index.html">Image Tools</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="tool-container" id="tool-container">
            <div class="step-indicator">
                <span class="step active">1. Upload</span>
                <span class="step">2. Compress</span>
                <span class="step">3. Download</span>
            </div>

            <div style="text-align: center; margin-bottom: 2rem;">
                <h1>Image Compressor</h1>
                <p class="text-muted">Reduce file size of JPG, PNG, and WEBP images without losing quality.</p>
            </div>

            <div class="drop-zone" id="drop-zone">
                <span class="drop-zone-icon">üñºÔ∏è</span>
                <h3>Drop Images Here</h3>
                <p class="text-muted">or click to browse</p>
                <input type="file" id="file-input" multiple accept="image/*" hidden>
            </div>

            <div id="controls" style="display:none; max-width: 600px; margin: 0 auto;">
                <div class="tool-card" style="text-align:center;">
                    <label for="quality" style="display:block; margin-bottom:10px;">Compression Level: <strong
                            id="quality-val" style="color:var(--primary-color);">80%</strong></label>
                    <input type="range" id="quality" class="quality-slider" min="0.1" max="1.0" step="0.1" value="0.8"
                        style="width:100%;">
                    <div
                        style="display:flex; justify-content:space-between; font-size:0.8rem; color:var(--text-muted); margin-top:5px;">
                        <span>Max Compression</span>
                        <span>Best Quality</span>
                    </div>
                </div>

                <div class="action-bar" style="text-align: center; margin-top: 2rem;">
                    <button id="compress-btn" class="btn btn-primary" style="min-width: 200px;">
                        Compress All Images
                    </button>
                </div>
            </div>

            <div id="results" class="preview-grid"></div>
        </div>
    </main>

    <script type="module">
        import '../../js/image/image-main.js';

        const fileInput = document.getElementById('file-input');
        const qualitySlider = document.getElementById('quality');
        const qualityVal = document.getElementById('quality-val');
        const results = document.getElementById('results');
        const controls = document.getElementById('controls');
        const dropZone = document.getElementById('drop-zone');

        let selectedFiles = [];

        qualitySlider.addEventListener('input', (e) => {
            qualityVal.textContent = Math.round(e.target.value * 100) + '%';
        });

        window.Utils.initDragAndDrop('#drop-zone', (files) => handleFiles(files));
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
            if (selectedFiles.length === 0) {
                window.Utils.showToast('No valid images found', 'error');
                return;
            }

            dropZone.style.display = 'none';
            controls.style.display = 'block';
            results.innerHTML = '';

            selectedFiles.forEach(file => {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.innerHTML = `
                    <p><strong>${file.name}</strong></p>
                    <p class="stats">Original: ${window.Utils.formatBytes(file.size)}</p>
                    <div class="status-indicator">Pending...</div>
                `;
                results.appendChild(card);

                // Keep reference for status update
                file.cardElement = card;
            });
        }

        document.getElementById('compress-btn').addEventListener('click', async () => {
            const quality = parseFloat(qualitySlider.value);

            for (const file of selectedFiles) {
                const card = file.cardElement;
                const status = card.querySelector('.status-indicator');
                status.textContent = 'Compressing...';

                try {
                    const blob = await window.ImageTools.runImageTask('COMPRESS', {
                        file,
                        options: { quality }
                    });

                    const saved = file.size - blob.size;
                    const savedPct = Math.round((saved / file.size) * 100);

                    status.innerHTML = `
                        <span style="color:var(--accent-color)">Done!</span><br>
                        New Size: ${window.Utils.formatBytes(blob.size)} (-${savedPct}%)
                    `;

                    // Add preview and download
                    const url = URL.createObjectURL(blob);
                    const img = document.createElement('img');
                    img.src = url;
                    card.insertBefore(img, card.querySelector('.stats')); // Insert before stats

                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary btn-block';
                    btn.style.marginTop = '10px';
                    btn.textContent = 'Download';
                    btn.onclick = () => window.Utils.downloadBlob(blob, `compressed-${file.name}`);
                    card.appendChild(btn);

                } catch (err) {
                    console.error(err);
                    status.textContent = 'Error: ' + err.message;
                    status.style.color = 'var(--danger-color)';
                }
            }
            window.Utils.showToast('Batch compression complete!', 'success');
        });
    </script>
</body>

</html>
