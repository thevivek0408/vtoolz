<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Free Online Presentation Maker - Theme presets, transitions, speaker notes. Export PPTX. Works offline.">
    <title>Presentation Maker - Vibox</title>
    <link rel="icon" href="../../favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --po: #d04423;
            --pol: #ff6f43;
        }

        .ppt-app {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--card-bg, #1e1e2e);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, .3);
        }

        .ppt-toolbar {
            background: linear-gradient(135deg, var(--po), var(--pol));
            padding: 10px 14px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .ppt-toolbar .tg {
            display: flex;
            gap: 3px;
            padding-right: 10px;
            border-right: 1px solid rgba(255, 255, 255, .2);
        }

        .ppt-toolbar .tg:last-child {
            border-right: none;
        }

        .ppt-toolbar button,
        .ppt-toolbar select {
            background: rgba(255, 255, 255, .12);
            border: none;
            color: #fff;
            height: 34px;
            border-radius: 7px;
            cursor: pointer;
            font-size: 12px;
            transition: .2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            padding: 0 8px;
        }

        .ppt-toolbar button:hover {
            background: rgba(255, 255, 255, .25);
        }

        .ppt-toolbar select option {
            background: #222;
            color: #fff;
        }

        .doc-title-bar {
            background: rgba(255, 255, 255, .04);
            padding: 6px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, .06);
        }

        .doc-title-bar input {
            background: none;
            border: 1px solid transparent;
            color: inherit;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 6px;
            flex: 1;
        }

        .doc-title-bar input:focus {
            border-color: var(--pol);
            outline: none;
        }

        /* Find Panel */
        .find-panel {
            display: none;
            padding: 8px 16px;
            background: rgba(255, 255, 255, .06);
            border-bottom: 1px solid rgba(255, 255, 255, .06);
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .find-panel.open {
            display: flex;
        }

        .find-panel input {
            background: rgba(255, 255, 255, .08);
            border: 1px solid rgba(255, 255, 255, .1);
            color: inherit;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 12px;
            width: 140px;
        }

        .find-panel input:focus {
            border-color: var(--pol);
            outline: none;
        }

        .find-panel button {
            background: rgba(255, 255, 255, .12);
            border: none;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .find-panel button:hover {
            background: rgba(255, 255, 255, .25);
        }

        .find-panel .count {
            font-size: 11px;
            opacity: .7;
        }

        .ppt-workspace {
            display: flex;
            gap: 14px;
            padding: 14px;
            min-height: 480px;
        }

        .slide-panel {
            width: 150px;
            flex-shrink: 0;
            overflow-y: auto;
            max-height: 520px;
        }

        .slide-thumb {
            width: 130px;
            height: 74px;
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: .2s;
            position: relative;
            overflow: hidden;
            background: #fff;
        }

        .slide-thumb.active {
            border-color: var(--pol);
            box-shadow: 0 0 10px rgba(255, 111, 67, .4);
        }

        .slide-thumb canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .slide-thumb .num {
            position: absolute;
            bottom: 2px;
            right: 5px;
            font-size: 9px;
            background: rgba(0, 0, 0, .5);
            color: #fff;
            padding: 1px 4px;
            border-radius: 3px;
        }

        .slide-thumb .del-slide {
            position: absolute;
            top: 2px;
            right: 3px;
            background: rgba(255, 0, 0, .7);
            color: #fff;
            border: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 9px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .slide-thumb:hover .del-slide {
            display: flex;
        }

        .add-slide-btn {
            width: 130px;
            height: 36px;
            border-radius: 7px;
            border: 2px dashed rgba(255, 255, 255, .2);
            background: none;
            color: inherit;
            cursor: pointer;
            font-size: 12px;
            transition: .2s;
        }

        .add-slide-btn:hover {
            border-color: var(--pol);
            color: var(--pol);
        }

        .slide-editor {
            flex: 1;
            background: #fff;
            border-radius: 12px;
            aspect-ratio: 16/9;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .2);
            cursor: crosshair;
        }

        .slide-element {
            position: absolute;
            cursor: move;
            user-select: none;
            min-width: 30px;
            min-height: 20px;
        }

        .slide-element.selected {
            outline: 2px solid var(--pol);
            outline-offset: 2px;
        }

        .slide-element.text-el {
            padding: 6px 10px;
            font-size: 18px;
            color: #1a1a2e;
        }

        .slide-element.text-el[contenteditable="true"] {
            cursor: text;
            outline: 2px dashed var(--pol);
        }

        .slide-element.shape-el {
            border-radius: 4px;
        }

        .slide-element .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--pol);
            border-radius: 50%;
            bottom: -5px;
            right: -5px;
            cursor: se-resize;
            display: none;
        }

        .slide-element.selected .resize-handle {
            display: block;
        }

        .props-panel {
            width: 190px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, .04);
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            max-height: 520px;
        }

        .props-panel h4 {
            font-size: 11px;
            opacity: .6;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .prop-row {
            margin-bottom: 8px;
        }

        .prop-row label {
            font-size: 11px;
            opacity: .7;
            display: block;
            margin-bottom: 3px;
        }

        .prop-row input,
        .prop-row select,
        .prop-row textarea {
            width: 100%;
            padding: 5px 7px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, .1);
            background: rgba(255, 255, 255, .06);
            color: inherit;
            font-size: 12px;
        }

        .prop-row input:focus,
        .prop-row textarea:focus {
            border-color: var(--pol);
            outline: none;
        }

        .prop-row textarea {
            resize: vertical;
            min-height: 50px;
            font-family: inherit;
        }

        .export-panel {
            padding: 12px;
            display: flex;
            gap: 6px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 9px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: .2s;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #fff;
        }

        .export-btn.pptx {
            background: var(--po);
        }

        .export-btn.present {
            background: #2c3e50;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, .3);
        }

        /* Speaker Notes */
        .notes-bar {
            padding: 8px 16px;
            background: rgba(255, 255, 255, .03);
            border-top: 1px solid rgba(255, 255, 255, .06);
        }

        .notes-bar textarea {
            width: 100%;
            background: rgba(255, 255, 255, .06);
            border: 1px solid rgba(255, 255, 255, .08);
            color: inherit;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            min-height: 50px;
            resize: vertical;
            font-family: inherit;
        }

        .notes-bar textarea:focus {
            border-color: var(--pol);
            outline: none;
        }

        .notes-bar label {
            font-size: 11px;
            opacity: .5;
            margin-bottom: 4px;
            display: block;
        }

        /* Theme Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, .7);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: var(--card-bg, #1e1e2e);
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 12px 48px rgba(0, 0, 0, .5);
            position: relative;
        }

        .modal h2 {
            margin-bottom: 14px;
            font-size: 1.2em;
        }

        .modal .close-modal {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            color: inherit;
            font-size: 20px;
            cursor: pointer;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .theme-card {
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: .2s;
            text-align: center;
        }

        .theme-card:hover {
            border-color: var(--pol);
            transform: translateY(-2px);
        }

        .theme-card .preview {
            height: 60px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .theme-card h4 {
            font-size: 12px;
        }

        /* Presentation overlay */
        .present-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 9999;
            cursor: none;
        }

        .present-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .present-overlay canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .present-overlay .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: .3s;
        }

        .present-overlay:hover .controls {
            opacity: 1;
            cursor: default;
        }

        .present-overlay .controls button {
            background: rgba(255, 255, 255, .15);
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        /* Transitions */
        .slide-editor.trans-fade {
            animation: fadeIn .5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @media(max-width:768px) {
            .ppt-workspace {
                flex-direction: column;
            }

            .slide-panel {
                width: 100%;
                display: flex;
                overflow-x: auto;
                gap: 6px;
                max-height: 90px;
            }

            .slide-thumb {
                flex-shrink: 0;
            }

            .props-panel {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="container"><a href="../../index.html" class="logo">Vibox</a>
            <nav>
                <ul>
                    <li><a href="../../index.html">Home</a></li>
                    <li><a href="index.html">Office</a></li>
                    <li><a href="#" class="active">PowerPoint</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container tool-container" style="padding-top:20px;max-width:1200px;">
            <div class="ppt-app">
                <div class="ppt-toolbar">
                    <div class="tg">
                        <button onclick="addTextBox()" title="Text"><i class="fas fa-font"></i> Text</button>
                        <button onclick="addShape('rect')" title="Rect"><i class="fas fa-square"></i></button>
                        <button onclick="addShape('circle')" title="Circle"><i class="fas fa-circle"></i></button>
                        <button onclick="addShape('triangle')" title="Triangle"><i
                                class="fas fa-play fa-rotate-270"></i></button>
                        <button onclick="addShape('line')" title="Line"><i class="fas fa-minus"></i></button>
                        <button onclick="addShape('arrow')" title="Arrow"><i class="fas fa-arrow-right"></i></button>
                        <button onclick="addShape('star')" title="Star"><i class="fas fa-star"></i></button>
                        <button onclick="addImage()" title="Image"><i class="fas fa-image"></i></button>
                    </div>
                    <div class="tg">
                        <select id="slideLayout" onchange="applyLayout(this.value)">
                            <option value="">Layout...</option>
                            <option value="title">Title</option>
                            <option value="titleContent">Title+Content</option>
                            <option value="twoCol">Two Columns</option>
                            <option value="sectionHeader">Section Header</option>
                            <option value="imageCaption">Image+Caption</option>
                            <option value="quote">Quote</option>
                            <option value="comparison">Comparison</option>
                            <option value="blank">Blank</option>
                        </select>
                        <input type="color" id="slideBg" value="#ffffff" title="Slide BG"
                            onchange="changeSlideBg(this.value)"
                            style="width:34px;height:34px;border:none;border-radius:7px;cursor:pointer;">
                    </div>
                    <div class="tg">
                        <button onclick="deleteSelected()" title="Delete"><i class="fas fa-trash"></i></button>
                        <button onclick="bringForward()" title="Forward"><i class="fas fa-layer-group"></i></button>
                        <button onclick="duplicateSlide()" title="Duplicate Slide"><i class="fas fa-copy"></i></button>
                    </div>
                    <div class="tg">
                        <button onclick="openThemeModal()" title="Themes"><i class="fas fa-palette"></i> Theme</button>
                        <select id="transition" title="Transition">
                            <option value="none">No Transition</option>
                            <option value="fade">Fade</option>
                            <option value="slide">Slide</option>
                        </select>
                        <button id="btnFindPPT" title="Find (Ctrl+F)"><i class="fas fa-search"></i></button>
                    </div>
                </div>

                <!-- Find Panel -->
                <div class="find-panel" id="findPanel">
                    <input type="text" id="findInput" placeholder="Find text across slides...">
                    <button onclick="findInSlides()">Find</button>
                    <span class="count" id="findCount"></span>
                    <button onclick="document.getElementById('findPanel').classList.remove('open')"
                        style="margin-left:auto;">‚úï</button>
                </div>

                <div class="doc-title-bar">
                    <i class="fas fa-file-powerpoint" style="color:var(--pol);"></i>
                    <input type="text" id="docTitle" value="Untitled Presentation" placeholder="Presentation title...">
                </div>

                <div class="ppt-workspace">
                    <div class="slide-panel" id="slidePanel"></div>
                    <div class="slide-editor" id="slideEditor" onclick="editorClick(event)"></div>
                    <div class="props-panel" id="propsPanel">
                        <h4>Properties</h4>
                        <div id="propContents">
                            <p style="font-size:12px;opacity:.5;">Select an element to edit.</p>
                        </div>
                    </div>
                </div>

                <!-- Speaker Notes -->
                <div class="notes-bar">
                    <label>üìù Speaker Notes</label>
                    <textarea id="speakerNotes" placeholder="Add speaker notes for this slide..."
                        onchange="saveSpeakerNotes()"></textarea>
                </div>

                <div class="export-panel">
                    <button class="export-btn present" onclick="startPresentation()"><i class="fas fa-play"></i>
                        Present</button>
                    <button class="export-btn pptx" onclick="exportPPTX()"><i class="fas fa-file-powerpoint"></i>
                        PPTX</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Theme Modal -->
    <div class="modal-overlay" id="themeModal">
        <div class="modal">
            <button class="close-modal" onclick="closeThemeModal()">‚úï</button>
            <h2>üé® Theme Presets</h2>
            <div class="theme-grid" id="themeGrid"></div>
        </div>
    </div>

    <!-- Presentation Overlay -->
    <div class="present-overlay" id="presentOverlay">
        <canvas id="presentCanvas"></canvas>
        <div class="controls">
            <button onclick="prevSlideP()"><i class="fas fa-chevron-left"></i> Prev</button>
            <span id="presentNum" style="color:#fff;padding:8px;">1/1</span>
            <button onclick="nextSlideP()">Next <i class="fas fa-chevron-right"></i></button>
            <button onclick="exitPresentation()"><i class="fas fa-times"></i> Exit</button>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2026 Vibox. Open Source & Client-Side.</p>
        </div>
    </footer>

    <script src="../../js/vendor/pptxgen.bundle.min.js"></script>
    <script>
        const _$ = id => document.getElementById(id);
        let slides = [], curSlide = 0, selEl = null;

        // ‚îÄ‚îÄ THEMES ‚îÄ‚îÄ
        const themes = [
            { name: 'Default', bg: '#ffffff', title: '#1a1a2e', text: '#333333', accent: '#4a90d9' },
            { name: 'Dark', bg: '#1a1a2e', title: '#ffffff', text: '#cccccc', accent: '#ff6f43' },
            { name: 'Corporate', bg: '#f8f9fa', title: '#2c3e50', text: '#34495e', accent: '#3498db' },
            { name: 'Creative', bg: '#fff3e0', title: '#e65100', text: '#4e342e', accent: '#ff9800' },
            { name: 'Nature', bg: '#e8f5e9', title: '#1b5e20', text: '#2e7d32', accent: '#4caf50' },
            { name: 'Ocean', bg: '#e3f2fd', title: '#0d47a1', text: '#1565c0', accent: '#2196f3' },
            { name: 'Midnight', bg: '#0d1117', title: '#58a6ff', text: '#c9d1d9', accent: '#f78166' },
            { name: 'Sunset', bg: '#1a0a2e', title: '#ff6b6b', text: '#dda0dd', accent: '#ffd93d' },
            { name: 'Minimal', bg: '#fafafa', title: '#212121', text: '#616161', accent: '#9e9e9e' },
        ];
        let activeTheme = themes[0];

        function openThemeModal() { _$('themeModal').classList.add('open'); }
        function closeThemeModal() { _$('themeModal').classList.remove('open'); }
        _$('themeModal').onclick = e => { if (e.target === _$('themeModal')) closeThemeModal(); };

        (function renderThemes() {
            const g = _$('themeGrid');
            themes.forEach(t => {
                const c = document.createElement('div');
                c.className = 'theme-card';
                c.innerHTML = `<div class="preview" style="background:${t.bg};color:${t.title};">${t.name}</div><h4>${t.name}</h4>`;
                c.onclick = () => { applyTheme(t); closeThemeModal(); };
                g.appendChild(c);
            });
        })();

        function applyTheme(t) {
            activeTheme = t;
            slides.forEach(s => {
                s.background = t.bg;
                s.elements.forEach(el => {
                    if (el.type === 'text') {
                        if (el.isTitle) el.color = t.title;
                        else el.color = t.text;
                    }
                    if (el.type === 'rect' || el.type === 'circle' || el.type === 'star' || el.type === 'triangle' || el.type === 'arrow' || el.type === 'line') el.fill = t.accent;
                });
            });
            renderSlidePanel(); renderSlide();
        }

        // ‚îÄ‚îÄ SLIDE DATA ‚îÄ‚îÄ
        function mkSlide() { return { background: activeTheme.bg, elements: [], notes: '' }; }

        function init() {
            const saved = loadFromStorage();
            if (!saved) addSlide();
        }

        function addSlide() {
            saveCurrentSlide();
            slides.push(mkSlide());
            curSlide = slides.length - 1;
            renderSlidePanel(); renderSlide(); updateNotes();
        }

        function duplicateSlide() {
            const dup = JSON.parse(JSON.stringify(slides[curSlide]));
            slides.splice(curSlide + 1, 0, dup);
            curSlide++;
            renderSlidePanel(); renderSlide(); updateNotes(); saveToStorage();
        }

        function selectSlide(i) {
            saveCurrentSlide();
            curSlide = i; selEl = null;
            renderSlidePanel(); renderSlide(); updateProps(); updateNotes();
        }

        function deleteSlide(i) {
            if (slides.length <= 1) return;
            slides.splice(i, 1);
            if (curSlide >= slides.length) curSlide = slides.length - 1;
            renderSlidePanel(); renderSlide(); updateNotes();
        }

        function saveCurrentSlide() { /* elements are mutated in-place */ }

        // ‚îÄ‚îÄ SPEAKER NOTES ‚îÄ‚îÄ
        function updateNotes() { _$('speakerNotes').value = slides[curSlide].notes || ''; }
        function saveSpeakerNotes() { slides[curSlide].notes = _$('speakerNotes').value; saveToStorage(); }

        // ‚îÄ‚îÄ FIND ‚îÄ‚îÄ
        _$('btnFindPPT').onclick = () => { _$('findPanel').classList.toggle('open'); _$('findInput').focus(); };
        document.addEventListener('keydown', e => { if ((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); _$('btnFindPPT').click(); } });

        function findInSlides() {
            const q = _$('findInput').value.toLowerCase(); if (!q) return;
            let results = [];
            slides.forEach((s, si) => s.elements.forEach((el, ei) => {
                if (el.type === 'text' && (el.text || '').toLowerCase().includes(q)) results.push({ si, ei });
            }));
            _$('findCount').textContent = results.length + ' found';
            if (results.length > 0) { selectSlide(results[0].si); }
        }

        // ‚îÄ‚îÄ SLIDE PANEL ‚îÄ‚îÄ
        function renderSlidePanel() {
            const p = _$('slidePanel'); p.innerHTML = '';
            slides.forEach((s, i) => {
                const t = document.createElement('div');
                t.className = 'slide-thumb' + (i === curSlide ? ' active' : '');
                t.onclick = e => { if (!e.target.classList.contains('del-slide')) selectSlide(i); };
                t.style.background = s.background;
                const prev = document.createElement('div');
                prev.style.cssText = 'width:100%;height:100%;position:relative;overflow:hidden;';
                s.elements.forEach(el => {
                    const m = document.createElement('div');
                    m.style.cssText = `position:absolute;left:${el.x / 7}px;top:${el.y / 5.5}px;font-size:5px;`;
                    if (el.type === 'text') { m.textContent = (el.text || '').substring(0, 12); m.style.color = el.color || '#333'; }
                    else { m.style.background = el.fill || '#4a90d9'; m.style.width = (el.w / 7) + 'px'; m.style.height = (el.h / 5.5) + 'px'; if (el.type === 'circle') m.style.borderRadius = '50%'; }
                    prev.appendChild(m);
                });
                t.appendChild(prev);
                const num = document.createElement('span'); num.className = 'num'; num.textContent = i + 1; t.appendChild(num);
                const del = document.createElement('button'); del.className = 'del-slide'; del.innerHTML = '√ó'; del.onclick = e => { e.stopPropagation(); deleteSlide(i); }; t.appendChild(del);
                p.appendChild(t);
            });
            const ab = document.createElement('button'); ab.className = 'add-slide-btn'; ab.innerHTML = '<i class="fas fa-plus"></i> New'; ab.onclick = addSlide; p.appendChild(ab);
        }

        // ‚îÄ‚îÄ RENDER SLIDE ‚îÄ‚îÄ
        function renderSlide() {
            const ed = _$('slideEditor'); ed.innerHTML = '';
            const s = slides[curSlide];
            ed.style.background = s.background;
            _$('slideBg').value = s.background;
            s.elements.forEach((el, i) => ed.appendChild(createElDOM(el, i)));
            // Apply transition
            const trans = _$('transition').value;
            if (trans === 'fade') { ed.classList.add('trans-fade'); setTimeout(() => ed.classList.remove('trans-fade'), 500); }
        }

        function createElDOM(el, idx) {
            const d = document.createElement('div');
            d.className = 'slide-element' + (el.type === 'text' ? ' text-el' : ' shape-el');
            d.dataset.idx = idx;
            d.style.left = el.x + 'px'; d.style.top = el.y + 'px'; d.style.width = el.w + 'px';
            d.style.height = el.type === 'text' ? 'auto' : el.h + 'px';
            d.style.minHeight = el.h + 'px';

            if (el.type === 'text') {
                d.textContent = el.text || 'Double-click to edit';
                d.style.fontSize = (el.fontSize || 18) + 'px';
                d.style.fontWeight = el.bold ? 'bold' : 'normal';
                d.style.fontStyle = el.italic ? 'italic' : 'normal';
                d.style.color = el.color || activeTheme.text;
                d.style.fontFamily = el.fontFamily || 'Arial';
                d.style.textAlign = el.align || 'left';
                d.ondblclick = () => { d.contentEditable = 'true'; d.focus(); d.style.cursor = 'text'; };
                d.onblur = () => { d.contentEditable = 'false'; d.style.cursor = 'move'; slides[curSlide].elements[idx].text = d.textContent; saveToStorage(); };
            } else if (el.type === 'rect') {
                d.style.background = el.fill || activeTheme.accent;
                d.style.borderRadius = (el.radius || 0) + 'px';
            } else if (el.type === 'circle') {
                d.style.background = el.fill || activeTheme.accent;
                d.style.borderRadius = '50%';
            } else if (el.type === 'triangle') {
                d.style.width = '0'; d.style.height = '0';
                d.style.borderLeft = (el.w / 2) + 'px solid transparent';
                d.style.borderRight = (el.w / 2) + 'px solid transparent';
                d.style.borderBottom = el.h + 'px solid ' + (el.fill || activeTheme.accent);
                d.style.background = 'transparent';
            } else if (el.type === 'line') {
                d.style.height = '3px'; d.style.background = el.fill || activeTheme.accent;
                d.style.borderRadius = '2px';
            } else if (el.type === 'arrow') {
                d.innerHTML = `<svg viewBox="0 0 100 30" style="width:100%;height:100%;"><polygon points="0,10 70,10 70,0 100,15 70,30 70,20 0,20" fill="${el.fill || activeTheme.accent}"/></svg>`;
                d.style.background = 'transparent';
            } else if (el.type === 'star') {
                d.innerHTML = `<svg viewBox="0 0 100 100" style="width:100%;height:100%;"><polygon points="50,5 63,35 95,35 70,57 80,90 50,70 20,90 30,57 5,35 37,35" fill="${el.fill || activeTheme.accent}"/></svg>`;
                d.style.background = 'transparent';
            } else if (el.type === 'image') {
                const img = document.createElement('img');
                img.src = el.src; img.style.cssText = 'width:100%;height:100%;object-fit:contain;pointer-events:none;';
                d.appendChild(img);
            }

            const handle = document.createElement('div'); handle.className = 'resize-handle'; d.appendChild(handle);
            d.onmousedown = e => {
                if (e.target === handle) { startResize(e, d, idx); return; }
                selectEl(d, idx);
                if (d.contentEditable !== 'true') startDrag(e, d, idx);
            };
            return d;
        }

        function selectEl(d, idx) {
            document.querySelectorAll('.slide-element.selected').forEach(e => e.classList.remove('selected'));
            d.classList.add('selected'); selEl = idx; updateProps();
        }
        function editorClick(e) { if (e.target.id === 'slideEditor') { selEl = null; document.querySelectorAll('.slide-element.selected').forEach(e => e.classList.remove('selected')); updateProps(); } }

        // ‚îÄ‚îÄ PROPERTIES ‚îÄ‚îÄ
        function updateProps() {
            const c = _$('propContents');
            if (selEl === null || !slides[curSlide].elements[selEl]) { c.innerHTML = '<p style="font-size:12px;opacity:.5;">Select an element to edit.</p>'; return; }
            const el = slides[curSlide].elements[selEl];
            let h = '';
            if (el.type === 'text') {
                h += `<div class="prop-row"><label>Font Size</label><input type="number" value="${el.fontSize || 18}" onchange="uProp('fontSize',+this.value)"></div>`;
                h += `<div class="prop-row"><label>Font</label><select onchange="uProp('fontFamily',this.value)">`;
                ['Arial', 'Georgia', 'Times New Roman', 'Courier New', 'Verdana', 'Impact', 'Comic Sans MS'].forEach(f => {
                    h += `<option ${el.fontFamily === f ? 'selected' : ''}>${f}</option>`;
                });
                h += `</select></div>`;
                h += `<div class="prop-row"><label>Color</label><input type="color" value="${el.color || '#1a1a2e'}" onchange="uProp('color',this.value)"></div>`;
                h += `<div class="prop-row"><label>Align</label><select onchange="uProp('align',this.value)"><option ${el.align === 'left' ? 'selected' : ''}>left</option><option ${el.align === 'center' ? 'selected' : ''}>center</option><option ${el.align === 'right' ? 'selected' : ''}>right</option></select></div>`;
                h += `<div class="prop-row"><label><input type="checkbox" ${el.bold ? 'checked' : ''} onchange="uProp('bold',this.checked)"> Bold</label></div>`;
                h += `<div class="prop-row"><label><input type="checkbox" ${el.italic ? 'checked' : ''} onchange="uProp('italic',this.checked)"> Italic</label></div>`;
            } else if (['rect', 'circle', 'triangle', 'star', 'arrow', 'line'].includes(el.type)) {
                h += `<div class="prop-row"><label>Fill</label><input type="color" value="${el.fill || '#4a90d9'}" onchange="uProp('fill',this.value)"></div>`;
                h += `<div class="prop-row"><label>Width</label><input type="number" value="${el.w}" onchange="uProp('w',+this.value)"></div>`;
                h += `<div class="prop-row"><label>Height</label><input type="number" value="${el.h}" onchange="uProp('h',+this.value)"></div>`;
                if (el.type === 'rect') h += `<div class="prop-row"><label>Radius</label><input type="number" value="${el.radius || 0}" onchange="uProp('radius',+this.value)"></div>`;
            } else if (el.type === 'image') {
                h += `<div class="prop-row"><label>Width</label><input type="number" value="${el.w}" onchange="uProp('w',+this.value)"></div>`;
                h += `<div class="prop-row"><label>Height</label><input type="number" value="${el.h}" onchange="uProp('h',+this.value)"></div>`;
            }
            h += `<div class="prop-row"><label>X</label><input type="number" value="${Math.round(el.x)}" onchange="uProp('x',+this.value)"></div>`;
            h += `<div class="prop-row"><label>Y</label><input type="number" value="${Math.round(el.y)}" onchange="uProp('y',+this.value)"></div>`;
            c.innerHTML = h;
        }

        function uProp(k, v) {
            if (selEl !== null && slides[curSlide].elements[selEl]) {
                slides[curSlide].elements[selEl][k] = v;
                renderSlide();
                const d = document.querySelector(`.slide-element[data-idx="${selEl}"]`);
                if (d) selectEl(d, selEl);
                saveToStorage();
            }
        }

        // ‚îÄ‚îÄ DRAG & RESIZE ‚îÄ‚îÄ
        function startDrag(e, dom, idx) {
            e.preventDefault();
            const sx = e.clientX, sy = e.clientY, ox = slides[curSlide].elements[idx].x, oy = slides[curSlide].elements[idx].y;
            function mv(ev) { const el = slides[curSlide].elements[idx]; el.x = Math.max(0, ox + (ev.clientX - sx)); el.y = Math.max(0, oy + (ev.clientY - sy)); dom.style.left = el.x + 'px'; dom.style.top = el.y + 'px'; }
            function up() { document.removeEventListener('mousemove', mv); document.removeEventListener('mouseup', up); saveToStorage(); renderSlidePanel(); }
            document.addEventListener('mousemove', mv); document.addEventListener('mouseup', up);
        }
        function startResize(e, dom, idx) {
            e.preventDefault(); e.stopPropagation();
            const sx = e.clientX, sy = e.clientY, el = slides[curSlide].elements[idx], ow = el.w, oh = el.h;
            function mv(ev) { el.w = Math.max(30, ow + (ev.clientX - sx)); el.h = Math.max(20, oh + (ev.clientY - sy)); dom.style.width = el.w + 'px'; dom.style.height = el.h + 'px'; }
            function up() { document.removeEventListener('mousemove', mv); document.removeEventListener('mouseup', up); updateProps(); saveToStorage(); }
            document.addEventListener('mousemove', mv); document.addEventListener('mouseup', up);
        }

        // ‚îÄ‚îÄ ADD ELEMENTS ‚îÄ‚îÄ
        function addTextBox(isTitle) {
            slides[curSlide].elements.push({ type: 'text', text: isTitle ? 'Title' : 'Click to edit', x: 50, y: isTitle ? 40 : 120, w: 500, h: 40, fontSize: isTitle ? 36 : 20, fontFamily: 'Arial', color: isTitle ? activeTheme.title : activeTheme.text, bold: !!isTitle, italic: false, align: isTitle ? 'center' : 'left', isTitle: !!isTitle });
            renderSlide(); renderSlidePanel();
        }
        function addShape(type) {
            const defaults = { rect: { w: 150, h: 100 }, circle: { w: 120, h: 120 }, triangle: { w: 120, h: 100 }, line: { w: 200, h: 4 }, arrow: { w: 150, h: 40 }, star: { w: 100, h: 100 } };
            const d = defaults[type] || { w: 100, h: 100 };
            slides[curSlide].elements.push({ type, x: 100, y: 100, w: d.w, h: d.h, fill: activeTheme.accent, radius: 0 });
            renderSlide(); renderSlidePanel();
        }
        function addImage() {
            const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'image/*';
            inp.onchange = () => { const f = inp.files[0]; if (!f) return; const r = new FileReader(); r.onload = e => { slides[curSlide].elements.push({ type: 'image', src: e.target.result, x: 80, y: 80, w: 200, h: 150 }); renderSlide(); renderSlidePanel(); }; r.readAsDataURL(f); };
            inp.click();
        }
        function deleteSelected() {
            if (selEl === null) return;
            slides[curSlide].elements.splice(selEl, 1); selEl = null;
            renderSlide(); updateProps(); renderSlidePanel(); saveToStorage();
        }
        function bringForward() {
            if (selEl === null || selEl >= slides[curSlide].elements.length - 1) return;
            const els = slides[curSlide].elements;[els[selEl], els[selEl + 1]] = [els[selEl + 1], els[selEl]]; selEl++;
            renderSlide(); const d = document.querySelector(`.slide-element[data-idx="${selEl}"]`); if (d) selectEl(d, selEl);
        }
        function changeSlideBg(v) { slides[curSlide].background = v; _$('slideEditor').style.background = v; renderSlidePanel(); saveToStorage(); }

        // ‚îÄ‚îÄ LAYOUTS ‚îÄ‚îÄ
        function applyLayout(layout) {
            if (!layout) return;
            const s = slides[curSlide]; s.elements = [];
            const c = activeTheme;
            if (layout === 'title') {
                s.elements.push({ type: 'text', text: 'Presentation Title', x: 60, y: 120, w: 500, h: 50, fontSize: 40, fontFamily: 'Arial', color: c.title, bold: true, align: 'center', isTitle: true });
                s.elements.push({ type: 'text', text: 'Subtitle text here', x: 100, y: 200, w: 420, h: 30, fontSize: 20, fontFamily: 'Arial', color: c.text, bold: false, align: 'center' });
            } else if (layout === 'titleContent') {
                s.elements.push({ type: 'text', text: 'Slide Title', x: 30, y: 20, w: 560, h: 40, fontSize: 30, fontFamily: 'Arial', color: c.title, bold: true, align: 'left', isTitle: true });
                s.elements.push({ type: 'text', text: '‚Ä¢ Content point 1\n‚Ä¢ Content point 2\n‚Ä¢ Content point 3', x: 30, y: 80, w: 560, h: 200, fontSize: 18, fontFamily: 'Arial', color: c.text, bold: false, align: 'left' });
            } else if (layout === 'twoCol') {
                s.elements.push({ type: 'text', text: 'Title', x: 30, y: 20, w: 560, h: 35, fontSize: 28, fontFamily: 'Arial', color: c.title, bold: true, align: 'center', isTitle: true });
                s.elements.push({ type: 'text', text: 'Left column content...', x: 20, y: 70, w: 275, h: 200, fontSize: 16, fontFamily: 'Arial', color: c.text, bold: false, align: 'left' });
                s.elements.push({ type: 'text', text: 'Right column content...', x: 315, y: 70, w: 275, h: 200, fontSize: 16, fontFamily: 'Arial', color: c.text, bold: false, align: 'left' });
            } else if (layout === 'sectionHeader') {
                s.elements.push({ type: 'rect', x: 0, y: 100, w: 620, h: 120, fill: c.accent, radius: 0 });
                s.elements.push({ type: 'text', text: 'Section Title', x: 40, y: 120, w: 540, h: 50, fontSize: 36, fontFamily: 'Arial', color: '#ffffff', bold: true, align: 'center', isTitle: true });
            } else if (layout === 'imageCaption') {
                s.elements.push({ type: 'rect', x: 30, y: 25, w: 350, h: 260, fill: '#e0e0e0', radius: 8 });
                s.elements.push({ type: 'text', text: '[Image Placeholder]', x: 100, y: 130, w: 200, h: 30, fontSize: 14, fontFamily: 'Arial', color: '#999', bold: false, align: 'center' });
                s.elements.push({ type: 'text', text: 'Caption Title', x: 400, y: 60, w: 200, h: 30, fontSize: 22, fontFamily: 'Arial', color: c.title, bold: true, align: 'left', isTitle: true });
                s.elements.push({ type: 'text', text: 'Description text here...', x: 400, y: 100, w: 200, h: 150, fontSize: 14, fontFamily: 'Arial', color: c.text, bold: false, align: 'left' });
            } else if (layout === 'quote') {
                s.elements.push({ type: 'text', text: '"', x: 50, y: 40, w: 60, h: 80, fontSize: 80, fontFamily: 'Georgia', color: c.accent, bold: true, align: 'center' });
                s.elements.push({ type: 'text', text: 'Your inspiring quote goes here.', x: 60, y: 110, w: 500, h: 80, fontSize: 24, fontFamily: 'Georgia', color: c.title, bold: false, italic: true, align: 'center' });
                s.elements.push({ type: 'text', text: '‚Äî Author Name', x: 200, y: 210, w: 220, h: 25, fontSize: 16, fontFamily: 'Arial', color: c.text, bold: false, align: 'center' });
            } else if (layout === 'comparison') {
                s.elements.push({ type: 'text', text: 'Comparison', x: 30, y: 15, w: 560, h: 30, fontSize: 26, fontFamily: 'Arial', color: c.title, bold: true, align: 'center', isTitle: true });
                s.elements.push({ type: 'rect', x: 20, y: 55, w: 280, h: 230, fill: c.accent + '22', radius: 8 });
                s.elements.push({ type: 'text', text: 'Option A', x: 80, y: 65, w: 160, h: 25, fontSize: 18, fontFamily: 'Arial', color: c.accent, bold: true, align: 'center' });
                s.elements.push({ type: 'text', text: 'Details...', x: 40, y: 100, w: 240, h: 170, fontSize: 14, fontFamily: 'Arial', color: c.text, bold: false, align: 'left' });
                s.elements.push({ type: 'rect', x: 320, y: 55, w: 280, h: 230, fill: c.accent + '22', radius: 8 });
                s.elements.push({ type: 'text', text: 'Option B', x: 380, y: 65, w: 160, h: 25, fontSize: 18, fontFamily: 'Arial', color: c.accent, bold: true, align: 'center' });
                s.elements.push({ type: 'text', text: 'Details...', x: 340, y: 100, w: 240, h: 170, fontSize: 14, fontFamily: 'Arial', color: c.text, bold: false, align: 'left' });
            }
            _$('slideLayout').value = '';
            renderSlide(); renderSlidePanel(); saveToStorage();
        }

        // ‚îÄ‚îÄ PRESENTATION MODE ‚îÄ‚îÄ
        let presentIdx = 0;
        function startPresentation() {
            presentIdx = 0; _$('presentOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
            renderPresentSlide();
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(() => { });
        }
        function exitPresentation() {
            _$('presentOverlay').classList.remove('active');
            document.body.style.overflow = '';
            if (document.exitFullscreen) document.exitFullscreen().catch(() => { });
        }
        function nextSlideP() { if (presentIdx < slides.length - 1) { presentIdx++; renderPresentSlide(); } }
        function prevSlideP() { if (presentIdx > 0) { presentIdx--; renderPresentSlide(); } }

        function renderPresentSlide() {
            const c = _$('presentCanvas'); const ctx = c.getContext('2d');
            c.width = 1280; c.height = 720;
            const s = slides[presentIdx];
            ctx.fillStyle = s.background; ctx.fillRect(0, 0, 1280, 720);
            s.elements.forEach(el => {
                const sx = 1280 / 620, sy = 720 / 350; // scale from editor to canvas
                const x = el.x * sx, y = el.y * sy, w = el.w * sx, h = el.h * sy;
                if (el.type === 'text') {
                    ctx.fillStyle = el.color || '#333';
                    ctx.font = `${el.bold ? 'bold ' : ''} ${el.italic ? 'italic ' : ''}${(el.fontSize || 18) * sx}px ${el.fontFamily || 'Arial'}`;
                    ctx.textAlign = el.align || 'left';
                    const tx = el.align === 'center' ? x + w / 2 : el.align === 'right' ? x + w : x;
                    const words = (el.text || '').split(' ');
                    let line = '', ly = y + (el.fontSize || 18) * sy;
                    words.forEach(word => {
                        const test = line + word + ' ';
                        if (ctx.measureText(test).width > w && line !== '') { ctx.fillText(line.trim(), tx, ly); ly += (el.fontSize || 18) * sy * 1.3; line = word + ' '; }
                        else line = test;
                    });
                    ctx.fillText(line.trim(), tx, ly);
                } else if (el.type === 'rect') {
                    ctx.fillStyle = el.fill || '#4a90d9';
                    const r = (el.radius || 0) * sx;
                    ctx.beginPath(); ctx.roundRect(x, y, w, h, r); ctx.fill();
                } else if (el.type === 'circle') {
                    ctx.fillStyle = el.fill || '#4a90d9';
                    ctx.beginPath(); ctx.ellipse(x + w / 2, y + h / 2, w / 2, h / 2, 0, 0, Math.PI * 2); ctx.fill();
                } else if (el.type === 'image' && el.src) {
                    try { const img = new Image(); img.src = el.src; ctx.drawImage(img, x, y, w, h); } catch (e) { }
                } else if (el.type === 'line') {
                    ctx.strokeStyle = el.fill || '#4a90d9'; ctx.lineWidth = 3 * sx; ctx.beginPath(); ctx.moveTo(x, y + h / 2); ctx.lineTo(x + w, y + h / 2); ctx.stroke();
                } else if (el.type === 'star') {
                    ctx.fillStyle = el.fill || '#4a90d9';
                    drawStar(ctx, x + w / 2, y + h / 2, 5, w / 2, w / 4); ctx.fill();
                } else if (el.type === 'triangle') {
                    ctx.fillStyle = el.fill || '#4a90d9';
                    ctx.beginPath(); ctx.moveTo(x + w / 2, y); ctx.lineTo(x + w, y + h); ctx.lineTo(x, y + h); ctx.closePath(); ctx.fill();
                } else if (el.type === 'arrow') {
                    ctx.fillStyle = el.fill || '#4a90d9';
                    ctx.beginPath(); ctx.moveTo(x, y + h * 0.33); ctx.lineTo(x + w * 0.7, y + h * 0.33); ctx.lineTo(x + w * 0.7, y); ctx.lineTo(x + w, y + h / 2); ctx.lineTo(x + w * 0.7, y + h); ctx.lineTo(x + w * 0.7, y + h * 0.67); ctx.lineTo(x, y + h * 0.67); ctx.closePath(); ctx.fill();
                }
            });
            _$('presentNum').textContent = `${presentIdx + 1} / ${slides.length}`;
        }

        function drawStar(ctx, cx, cy, spikes, outerR, innerR) {
            let rot = Math.PI / 2 * 3, x = cx, y = cy, step = Math.PI / spikes;
            ctx.beginPath(); ctx.moveTo(cx, cy - outerR);
            for (let i = 0; i < spikes; i++) { x = cx + Math.cos(rot) * outerR; y = cy + Math.sin(rot) * outerR; ctx.lineTo(x, y); rot += step; x = cx + Math.cos(rot) * innerR; y = cy + Math.sin(rot) * innerR; ctx.lineTo(x, y); rot += step; }
            ctx.closePath();
        }

        document.addEventListener('keydown', e => {
            if (!_$('presentOverlay').classList.contains('active')) return;
            if (e.key === 'ArrowRight' || e.key === ' ') nextSlideP();
            else if (e.key === 'ArrowLeft') prevSlideP();
            else if (e.key === 'Escape') exitPresentation();
        });

        // ‚îÄ‚îÄ EXPORT PPTX ‚îÄ‚îÄ
        function exportPPTX() {
            const pptx = new PptxGenJS();
            pptx.title = _$('docTitle').value || 'Presentation';
            slides.forEach(s => {
                const sl = pptx.addSlide();
                sl.background = { fill: s.background.replace('#', '') };
                s.elements.forEach(el => {
                    const xIn = el.x / 96, yIn = el.y / 96, wIn = el.w / 96, hIn = el.h / 96;
                    if (el.type === 'text') {
                        sl.addText(el.text || '', { x: xIn, y: yIn, w: wIn, h: hIn, fontSize: (el.fontSize || 18) * 0.75, fontFace: el.fontFamily || 'Arial', color: el.color ? el.color.replace('#', '') : '333333', bold: !!el.bold, italic: !!el.italic, align: el.align || 'left' });
                    } else if (el.type === 'rect') {
                        sl.addShape(pptx.ShapeType.rect, { x: xIn, y: yIn, w: wIn, h: hIn, fill: { color: (el.fill || '#4a90d9').replace('#', '') }, rectRadius: el.radius ? el.radius / 96 : 0 });
                    } else if (el.type === 'circle') {
                        sl.addShape(pptx.ShapeType.ellipse, { x: xIn, y: yIn, w: wIn, h: hIn, fill: { color: (el.fill || '#4a90d9').replace('#', '') } });
                    } else if (el.type === 'image' && el.src) {
                        try { sl.addImage({ data: el.src, x: xIn, y: yIn, w: wIn, h: hIn }); } catch (e) { }
                    } else if (el.type === 'line') {
                        sl.addShape(pptx.ShapeType.line, { x: xIn, y: yIn, w: wIn, h: 0, line: { color: (el.fill || '#4a90d9').replace('#', ''), width: 2 } });
                    } else if (el.type === 'triangle') {
                        sl.addShape(pptx.ShapeType.triangle, { x: xIn, y: yIn, w: wIn, h: hIn, fill: { color: (el.fill || '#4a90d9').replace('#', '') } });
                    }
                });
                if (s.notes) sl.addNotes(s.notes);
            });
            pptx.writeFile({ fileName: (_$('docTitle').value || 'presentation') + '.pptx' });
        }

        // ‚îÄ‚îÄ DELETE KEY ‚îÄ‚îÄ
        document.addEventListener('keydown', e => {
            if (e.key === 'Delete' && selEl !== null && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.contentEditable !== 'true') deleteSelected();
        });

        // ‚îÄ‚îÄ AUTO-SAVE ‚îÄ‚îÄ
        function saveToStorage() { try { localStorage.setItem('vibox-ppt-doc', JSON.stringify({ s: slides, t: _$('docTitle').value })); } catch (e) { } }
        function loadFromStorage() { try { const d = JSON.parse(localStorage.getItem('vibox-ppt-doc')); if (d && d.s && d.s.length) { slides = d.s; curSlide = 0; if (d.t) _$('docTitle').value = d.t; renderSlidePanel(); renderSlide(); updateNotes(); return true; } } catch (e) { } return false; }

        init();
    </script>
    <script src="../../js/utils/common.js" type="module"></script>
</body>

</html>