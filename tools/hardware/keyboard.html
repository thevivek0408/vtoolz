<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyboard Tester - Vibox</title>
    <link rel="icon" href="../../favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .keyboard-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background: var(--surface-color);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }

        .stat-item h3 {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .stat-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            font-family: monospace;
        }

        .keyboard-visual {
            background: var(--surface-color);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .kb-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            justify-content: center;
        }

        .key {
            padding: 10px;
            min-width: 40px;
            height: 40px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.1s;
            position: relative;
            user-select: none;
        }

        .key.pressed {
            background: var(--primary-color);
            color: #000;
            border-color: var(--primary-color);
            transform: translateY(2px);
        }

        .key.history {
            background: rgba(var(--primary-rgb), 0.2);
            border-color: rgba(var(--primary-rgb), 0.4);
        }

        /* Key Sizes */
        .key.w-1-5 {
            min-width: 60px;
        }

        .key.w-2 {
            min-width: 80px;
        }

        .key.w-2-5 {
            min-width: 100px;
        }

        .key.w-space {
            min-width: 280px;
        }

        .log-container {
            height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            border: 1px solid var(--border-color);
        }

        .log-entry {
            margin-bottom: 5px;
            color: var(--text-muted);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-entry span {
            color: var(--text-color);
        }

        .log-entry .code {
            color: var(--accent-color);
        }
    </style>
</head>

<body>
    <header>
        <nav class="container">
            <a href="../../index.html" class="logo">
                <i class="fas fa-cube"></i> Vibox
            </a>
            <div class="nav-links">
                <a href="../../index.html">Home</a>
                <a href="index.html">Hardware</a>
                <a href="#" class="active">Keyboard</a>
            </div>
        </nav>
    </header>

    <main class="container page-content">
        <div class="page-header">
            <h1>Keyboard Tester</h1>
            <p>Press any key to test functionality and ghosting.</p>
        </div>

        <div class="keyboard-container">
            <div class="stats-panel">
                <div class="stat-item">
                    <h3>Last Key</h3>
                    <div class="value" id="lastKey">-</div>
                </div>
                <div class="stat-item">
                    <h3>Key Code</h3>
                    <div class="value" id="lastCode">-</div>
                </div>
                <div class="stat-item">
                    <h3>Event Code</h3>
                    <div class="value" id="eventCode">-</div>
                </div>
                <div class="stat-item">
                    <h3>Active Keys</h3>
                    <div class="value" id="activeCount">0</div>
                </div>
            </div>

            <div class="keyboard-visual" id="keyboard">
                <!-- Generated by JS -->
            </div>

            <div class="control-group" style="text-align: right;">
                <button class="btn btn-secondary" id="btnReset">Reset History</button>
            </div>

            <div class="log-container" id="eventLog">
                <!-- Logs appear here -->
            </div>
        </div>
    </main>

    <script src="../../js/utils/common.js" type="module"></script>
    <script>
        const els = {
            keyboard: document.getElementById('keyboard'),
            lastKey: document.getElementById('lastKey'),
            lastCode: document.getElementById('lastCode'),
            eventCode: document.getElementById('eventCode'),
            activeCount: document.getElementById('activeCount'),
            log: document.getElementById('eventLog'),
            btnReset: document.getElementById('btnReset')
        };

        // Layout Definitions (ANSI Standard)
        const layout = [
            [
                { code: 'Escape', label: 'Esc' },
                { code: 'F1', label: 'F1' }, { code: 'F2', label: 'F2' }, { code: 'F3', label: 'F3' }, { code: 'F4', label: 'F4' },
                { code: 'F5', label: 'F5' }, { code: 'F6', label: 'F6' }, { code: 'F7', label: 'F7' }, { code: 'F8', label: 'F8' },
                { code: 'F9', label: 'F9' }, { code: 'F10', label: 'F10' }, { code: 'F11', label: 'F11' }, { code: 'F12', label: 'F12' }
            ],
            [
                { code: 'Backquote', label: '`' }, { code: 'Digit1', label: '1' }, { code: 'Digit2', label: '2' }, { code: 'Digit3', label: '3' },
                { code: 'Digit4', label: '4' }, { code: 'Digit5', label: '5' }, { code: 'Digit6', label: '6' }, { code: 'Digit7', label: '7' },
                { code: 'Digit8', label: '8' }, { code: 'Digit9', label: '9' }, { code: 'Digit0', label: '0' }, { code: 'Minus', label: '-' },
                { code: 'Equal', label: '=' }, { code: 'Backspace', label: 'Bksp', width: 'w-2' }
            ],
            [
                { code: 'Tab', label: 'Tab', width: 'w-1-5' }, { code: 'KeyQ', label: 'Q' }, { code: 'KeyW', label: 'W' }, { code: 'KeyE', label: 'E' },
                { code: 'KeyR', label: 'R' }, { code: 'KeyT', label: 'T' }, { code: 'KeyY', label: 'Y' }, { code: 'KeyU', label: 'U' },
                { code: 'KeyI', label: 'I' }, { code: 'KeyO', label: 'O' }, { code: 'KeyP', label: 'P' }, { code: 'BracketLeft', label: '[' },
                { code: 'BracketRight', label: ']' }, { code: 'Backslash', label: '\\', width: 'w-1-5' }
            ],
            [
                { code: 'CapsLock', label: 'Caps', width: 'w-1-5' }, { code: 'KeyA', label: 'A' }, { code: 'KeyS', label: 'S' }, { code: 'KeyD', label: 'D' },
                { code: 'KeyF', label: 'F' }, { code: 'KeyG', label: 'G' }, { code: 'KeyH', label: 'H' }, { code: 'KeyJ', label: 'J' },
                { code: 'KeyK', label: 'K' }, { code: 'KeyL', label: 'L' }, { code: 'Semicolon', label: ';' }, { code: 'Quote', label: '\'' },
                { code: 'Enter', label: 'Enter', width: 'w-2' }
            ],
            [
                { code: 'ShiftLeft', label: 'Shift', width: 'w-2' }, { code: 'KeyZ', label: 'Z' }, { code: 'KeyX', label: 'X' }, { code: 'KeyC', label: 'C' },
                { code: 'KeyV', label: 'V' }, { code: 'KeyB', label: 'B' }, { code: 'KeyN', label: 'N' }, { code: 'KeyM', label: 'M' },
                { code: 'Comma', label: ',' }, { code: 'Period', label: '.' }, { code: 'Slash', label: '/' }, { code: 'ShiftRight', label: 'Shift', width: 'w-2-5' }
            ],
            [
                { code: 'ControlLeft', label: 'Ctrl', width: 'w-1-5' }, { code: 'MetaLeft', label: 'Win' }, { code: 'AltLeft', label: 'Alt' },
                { code: 'Space', label: 'Space', width: 'w-space' },
                { code: 'AltRight', label: 'Alt' }, { code: 'MetaRight', label: 'Win' }, { code: 'ContextMenu', label: 'Menu' }, { code: 'ControlRight', label: 'Ctrl', width: 'w-1-5' }
            ]
        ];

        // Arrow and Nav Key Cluster (Simplified)
        const navCluster = [
            { code: 'Insert', label: 'Ins' }, { code: 'Home', label: 'Home' }, { code: 'PageUp', label: 'PgUp' },
            { code: 'Delete', label: 'Del' }, { code: 'End', label: 'End' }, { code: 'PageDown', label: 'PgDn' },
            { code: 'ArrowUp', label: '↑' },
            { code: 'ArrowLeft', label: '←' }, { code: 'ArrowDown', label: '↓' }, { code: 'ArrowRight', label: '→' }
        ];

        const state = {
            pressedKeys: new Set()
        };

        function renderKeyboard() {
            layout.forEach(row => {
                const rowEl = document.createElement('div');
                rowEl.className = 'kb-row';
                row.forEach(key => {
                    const keyEl = document.createElement('div');
                    keyEl.className = `key ${key.width || ''}`;
                    keyEl.dataset.code = key.code;
                    keyEl.textContent = key.label;
                    rowEl.appendChild(keyEl);
                });
                els.keyboard.appendChild(rowEl);
            });

            // Render Nav Cluster separately or below? For now, add a separator
            const divider = document.createElement('div');
            divider.style.height = '20px';
            els.keyboard.appendChild(divider);

            const navRow = document.createElement('div');
            navRow.className = 'kb-row';
            navCluster.forEach(key => {
                const keyEl = document.createElement('div');
                keyEl.className = `key`;
                keyEl.dataset.code = key.code;
                keyEl.textContent = key.label;
                navRow.appendChild(keyEl);
            });
            els.keyboard.appendChild(navRow);
        }

        function logEvent(e) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span>${e.type}</span>: Key="${e.key}" Code="<span class='code'>${e.code}</span>" Which=${e.which}`;
            els.log.insertBefore(entry, els.log.firstChild);
        }

        function handleKey(e, isDown) {
            e.preventDefault(); // Prevent default browser actions (like scrolling with space)

            const keyEl = document.querySelector(`.key[dataset-code="${e.code}"]`) ||
                document.querySelector(`.key[data-code="${e.code}"]`); // Select by data-code

            if (isDown) {
                if (!state.pressedKeys.has(e.code)) {
                    state.pressedKeys.add(e.code);
                    logEvent(e);

                    // Update Stats
                    els.lastKey.textContent = e.key;
                    els.lastCode.textContent = e.which;
                    els.eventCode.textContent = e.code;
                }

                if (keyEl) {
                    keyEl.classList.add('pressed');
                    keyEl.classList.add('history');
                }
            } else {
                state.pressedKeys.delete(e.code);
                if (keyEl) keyEl.classList.remove('pressed');
            }

            els.activeCount.textContent = state.pressedKeys.size;
        }

        // Init
        renderKeyboard();

        // Listeners
        window.addEventListener('keydown', (e) => handleKey(e, true));
        window.addEventListener('keyup', (e) => handleKey(e, false));

        els.btnReset.addEventListener('click', () => {
            document.querySelectorAll('.key.history').forEach(el => el.classList.remove('history'));
            els.log.innerHTML = '';
            els.lastKey.textContent = '-';
            els.lastCode.textContent = '-';
            els.eventCode.textContent = '-';
        });

    </script>
</body>

</html>