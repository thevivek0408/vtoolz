import{$ as e,$t as t,A as n,An as r,At as i,B as a,Bn as o,Bt as s,C as c,Cn as l,Ct as u,Dn as d,Dt as f,E as p,En as m,Et as h,F as g,Fn as _,Ft as v,G as y,Gn as b,Gt as x,H as ee,Hn as te,Ht as ne,I as re,In as ie,It as ae,J as oe,Jn as S,Jt as se,K as ce,Kn as C,Kt as le,L as ue,Ln as w,Lt as de,M as fe,Mn as pe,Mt as me,N as he,Nn as ge,Nt as _e,On as ve,Ot as ye,P as be,Pn as xe,Pt as Se,Q as Ce,Qt as we,R as Te,Rn as T,Rt as Ee,S as E,Sn as De,St as Oe,T as ke,Tn as Ae,Tt as je,U as Me,Un as Ne,Ut as Pe,V as Fe,Vn as D,Vt as Ie,W as Le,Wn as O,Wt as Re,X as ze,Xt as Be,Y as Ve,Yn as k,Yt as He,Z as Ue,Zt as We,_ as A,_n as Ge,_t as Ke,a as qe,an as Je,at as Ye,b as Xe,bn as Ze,bt as Qe,c as $e,cn as et,ct as tt,d as nt,dn as rt,dt as it,en as at,et as ot,fn as st,ft as ct,g as lt,gn as ut,gt as dt,h as j,hn as ft,ht as pt,i as mt,in as ht,it as gt,j as _t,jn as M,jt as vt,k as yt,kn as bt,kt as xt,l as N,ln as St,lt as Ct,m as wt,mn as Tt,mt as Et,n as Dt,nn as Ot,nt as kt,o as At,on as jt,ot as Mt,p as Nt,pn as Pt,pt as Ft,q as It,qn as P,qt as Lt,r as Rt,rn as zt,rt as Bt,s as F,sn as Vt,st as Ht,tn as Ut,tt as Wt,u as I,un as Gt,ut as Kt,v as qt,vn as Jt,vt as Yt,w as L,wn as Xt,wt as Zt,x as R,xn as Qt,xt as $t,yn as en,yt as tn,z as nn,zn as z,zt as rn}from"./Doors-iAfFIQWS.js";var an=null;function on(){if(an)return an;if(typeof window>`u`)return null;if(window.audioContext__)return an=window.audioContext__,an;let e=window.AudioContext;return e?(an=new e,window.audioContext__=an,an):null}function sn(){let e=on();return e&&e.state===`suspended`&&typeof e.resume==`function`&&e.resume().catch(e=>{console.warn(`Failed to resume AudioContext`,e)}),e}const cn=new class{sounds;constructor(){this.sounds=new Map}set(e,t){this.sounds.set(e,t)}get(e){return this.sounds.get(e)}has(e){return this.sounds.has(e)}delete(e){let t=this.sounds.get(e);if(t){for(let e of t.playingSources||[])try{e.stop(),e.disconnect()}catch(e){console.log(`soundData.gainNode error: ${e}`)}if(t.playingSources&&t.playingSources.clear(),t.gainNode)try{t.gainNode.disconnect()}catch(e){console.log(`soundData.gainNode error: ${e}`)}}return this.sounds.delete(e)}clear(){for(let[e]of this.sounds)this.delete(e);this.sounds.clear()}getAll(){return Array.from(this.sounds.keys())}};var B=new class{getSoundData(e){let t=`s${e}`,n=cn.get(t);return!n||!n.buffer?(console.error(`Sound not loaded`,e),null):n}stopSources(e,t=!1,n){if(!e)return 0;let r=Array.from(e.playingSources),i=0;n||e.playingSources.clear();for(let a of r){if(n&&!n(a))continue;i++,e.playingSources.delete(a);let r=t?a.__onComplete:null;a.__skipOnEnd=!0,a.__onComplete=null,a.onended=null;try{a.stop()}catch(e){console.warn(`Failed to stop audio source`,e)}try{a.disconnect()}catch(e){console.warn(`Failed to disconnect audio source`,e)}if(typeof r==`function`)try{r()}catch(e){console.error(`Sound completion callback failed`,e)}}return i}calculateResumeOffset(e){if(!e||e.playingSources.size===0)return e?.resumeOffset??0;let t=on();if(!t)return e.resumeOffset??0;let n=e.playingSources.values().next().value;if(!n||typeof n.__startedAt!=`number`)return e.resumeOffset??0;let r=Math.max(0,t.currentTime-n.__startedAt),i=n.__startOffset||0,a=e.buffer?.duration||0,o=i+r;return a>0?o%a:o}onReady(e){typeof e==`function`&&e()}play(e,t,n={}){let r=this.getSoundData(e);if(!r)return;let i=sn();if(!i){console.warn(`AudioContext not available for sound`,e);return}let a=i.createBufferSource();a.buffer=r.buffer,a.__skipOnEnd=!1,a.__onComplete=t||null;let o=r.buffer?.duration||0,s=Math.max(0,n.offset||0),c=n.instanceId||null,l=o>0?Math.min(s%o,Math.max(0,o-1e-4)):s;a.__startOffset=l,a.__startedAt=i.currentTime,a.__instanceId=c;try{a.connect(r.gainNode)}catch(e){console.warn(`Failed to connect audio source`,e),this.#safeInvokeCallback(a);return}a.onended=()=>{try{a.disconnect()}catch(e){console.warn(`source.onended error:`,e)}if(r.playingSources.delete(a),a.__skipOnEnd||(r.resumeOffset=0,r.isPaused=!1),!a.__skipOnEnd&&typeof a.__onComplete==`function`)try{a.__onComplete()}catch(e){console.error(`Sound completion callback failed`,e)}},r.playingSources.add(a),r.isPaused=!1,r.resumeOffset=l;try{a.start(0,l)}catch(e){r.playingSources.delete(a),r.resumeOffset=0;let t=e instanceof Error?e:Error(String(e));this.#safeInvokeCallback(a,t),console.error(`Failed to start audio source`,t)}}#safeInvokeCallback(e,t=null){let n=e.__onComplete;e.__onComplete=null,e.onended=null;try{e.disconnect()}catch(e){console.warn(`Failed to disconnect audio source`,e)}if(typeof n==`function`)try{n()}catch(e){console.error(`Sound completion callback failed`,e)}}isPlaying(e){let t=this.getSoundData(e);return!!(t&&t.playingSources.size>0)}isPaused(e){let t=this.getSoundData(e);return!!(t&&t.isPaused&&t.playingSources.size===0)}pause(e){let t=this.getSoundData(e);t&&(t.resumeOffset=this.calculateResumeOffset(t),this.stopSources(t,!1),t.isPaused=!0)}stop(e){let t=this.getSoundData(e);t&&(this.stopSources(t,!1),t.isPaused=!1,t.resumeOffset=0)}stopInstance(e,t){if(!t)return;let n=this.getSoundData(e);n&&this.stopSources(n,!1,e=>e.__instanceId===t)>0&&n.playingSources.size===0&&(n.isPaused=!1,n.resumeOffset=0)}getResumeOffset(e){return this.getSoundData(e)?.resumeOffset||0}setVolume(e,t){let n=this.getSoundData(e);if(!n)return;let r=Math.max(0,Math.min(100,t))/100;n.volume=r,n.gainNode.gain.value=r}},V={MENU:0,BOXES:1,LEVELS:2,GAME:3,GAMEMENU:4,LEVELCOMPLETE:5,GAMECOMPLETE:6,OPTIONS:7,CREDITS:8,LEADERBOARDS:9,ACHIEVEMENTS:10,PASSWORD:11,SKIN_SELECT:12},H=class{id;panelDivId;bgDivId;showShadow;constructor(e,t,n,r){this.id=e,this.panelDivId=t,this.bgDivId=n,this.showShadow=r}},ln=class{static startEventName=`pointerdown`;static endEventName=`pointerup`;el;getZoom;activePointerId;startHandler;moveHandler;endHandler;cancelHandler;constructor(e){this.el=e.element,this.getZoom=e.getZoom,this.activePointerId=null,this.startHandler=t=>{t.preventDefault(),this.activePointerId===null&&(this.activePointerId=t.pointerId,this.el.setPointerCapture(t.pointerId),e.onStart&&this.translatePosition(t,e.onStart))},this.moveHandler=t=>{this.activePointerId!==null&&t.pointerId===this.activePointerId&&t.preventDefault(),e.onMove&&this.translatePosition(t,e.onMove)},this.endHandler=t=>{t.preventDefault(),t.pointerId===this.activePointerId&&(this.activePointerId=null,e.onEnd&&this.translatePosition(t,e.onEnd))},this.cancelHandler=t=>{t.pointerId===this.activePointerId&&(this.activePointerId=null,e.onOut&&this.translatePosition(t,e.onOut))}}translatePosition(e,t){let n=this.el.getBoundingClientRect(),r=this.getZoom?this.getZoom():1;t(Math.round((e.clientX-n.left)/r),Math.round((e.clientY-n.top)/r))}activate(){this.el.addEventListener(`pointerdown`,this.startHandler),this.el.addEventListener(`pointermove`,this.moveHandler),this.el.addEventListener(`pointerup`,this.endHandler),this.el.addEventListener(`pointercancel`,this.cancelHandler),this.el.style.touchAction=`none`}deactivate(){this.el.removeEventListener(`pointerdown`,this.startHandler),this.el.removeEventListener(`pointermove`,this.moveHandler),this.el.removeEventListener(`pointerup`,this.endHandler),this.el.removeEventListener(`pointercancel`,this.cancelHandler),this.el.style.touchAction=``}},un=new class{#bgZoom=1;#element=null;#nativeHeight=0;#nativeWidth=0;#transformOrigin=`top left`;#zoom=1;originalHeight=270;domReady(){this.setElementId(`gameContainer`),this.#nativeWidth=A.UI_WIDTH,this.#nativeHeight=A.UI_HEIGHT,this.autoResize()}setElementId(e){this.#element=document.getElementById(e)}setElement(e){this.#element=e}updateCss(e={}){if(!this.#element)return;let t=this.#zoom===1?``:`scale(${this.#zoom})`,n=this.#zoom===1?``:this.#transformOrigin;this.#element.style.transform=t,this.#element.style.transformOrigin=n,Object.assign(this.#element.style,e)}getCanvasZoom(){return this.#zoom||1}getUIZoom(){return this.#zoom||1}autoResize(){window.addEventListener(`resize`,()=>this.resize()),this.resize()}resize(e=!1){if(!this.#element)return;let t=window.innerWidth,n=window.innerHeight,r=this.#nativeWidth,i=this.#nativeHeight,a=this.originalHeight;e||(this.#zoom=Math.min(t/r,n/i)),this.#bgZoom=n/(a*this.#zoom),this.#applyBackgroundScale(`.coverBg`,`scale(${this.#bgZoom})`),this.#applyBackgroundScale(`.scaleBg`,`scaleY(${this.#bgZoom})`);let o=r*this.#zoom,s=i*this.#zoom,c=Math.round((t-o)/2),l=Math.round((n-s)/2);this.updateCss({position:`absolute`,left:`${c}px`,top:`${l}px`,width:`${r}px`,height:`${i}px`})}#applyBackgroundScale(e,t){document.querySelectorAll(e).forEach(e=>{e instanceof HTMLElement&&(e.style.transform=t)})}};un.domReady();var dn=un,U=new class{audioPaused;soundEnabled;musicEnabled;musicId;musicResumeOffset;gameMusicLibrary;currentGameMusicId;loopingSounds;constructor(){this.audioPaused=!1,this.soundEnabled=qt.getSoundEnabled(),this.musicEnabled=qt.getMusicEnabled(),this.musicId=null,this.musicResumeOffset=0,this.gameMusicLibrary=L?[n.SND_GAME_MUSIC_XMAS]:[n.SND_GAME_MUSIC,n.SND_GAME_MUSIC2,n.SND_GAME_MUSIC3,n.SND_GAME_MUSIC4],this.currentGameMusicId=n.SND_GAME_MUSIC,this.loopingSounds=new Map}_getActiveLoopSoundIds(){let e=new Set;for(let t of this.loopingSounds.values())t?.active&&e.add(t.soundId);return e}_deactivateLoopEntry(e,t){t&&(t.active=!1,t.timeoutId&&=(clearTimeout(t.timeoutId),null),this.loopingSounds.delete(e))}playSound(e){this.soundEnabled&&B.play(e,void 0)}pauseSound(e){this.soundEnabled&&B.isPlaying(e)&&B.pause(e)}resumeSound(e){this.soundEnabled&&B.isPaused(e)&&B.play(e,void 0)}playLoopedSound(e,t,n=0){if(!this.soundEnabled||this.audioPaused)return;let r=t?`${e}_${t}`:`${e}_${Date.now()}_${Math.random()}`;if(this.loopingSounds.has(r))return;let i=()=>{let t=this.loopingSounds.get(r);!t||!t.active||!this.audioPaused&&this.soundEnabled&&B.play(e,i,{instanceId:r})},a={active:!0,loopFn:i,soundId:e,timeoutId:null};this.loopingSounds.set(r,a),n>0?a.timeoutId=setTimeout(i,n):i()}stopLoopedSoundInstance(e,t){let n=`${e}_${t}`,r=this.loopingSounds.get(n);r&&this._deactivateLoopEntry(n,r),B.stopInstance(e,n);let i=!1;for(let t of this.loopingSounds.values())if(t.soundId===e&&t.active){i=!0;break}i||B.stop(e)}stopLoopedSound(e){let t=[];for(let[n,r]of this.loopingSounds)r.soundId===e&&t.push(n);for(let e of t){let t=this.loopingSounds.get(e);t&&this._deactivateLoopEntry(e,t)}B.stop(e)}stopSound(e){this.stopLoopedSound(e)}_getAvailableGameMusic(){return!this.gameMusicLibrary||this.gameMusicLibrary.length===0?[]:this.gameMusicLibrary}selectRandomGameMusic(){let e=this._getAvailableGameMusic();if(e.length===0)return this.currentGameMusicId=null,null;let t=e;t.length>1&&this.currentGameMusicId!=null&&(t=t.filter(e=>e!==this.currentGameMusicId),t.length===0&&(t=e));let n=t[Math.floor(Math.random()*t.length)]??null;return this.currentGameMusicId=n,n}playGameMusic(){let e=this._getAvailableGameMusic();if(e.length===0)return;let t=this.currentGameMusicId!=null&&e.includes(this.currentGameMusicId)?this.currentGameMusicId:e[0]??null;t!==null&&(this.currentGameMusicId=t,this.playMusic(t))}playMusic(e){let t=this.musicId;if(t&&t!==e&&this.stopMusic(),this.musicId=e,this.musicEnabled&&!B.isPlaying(e)){let t=this.musicResumeOffset||0;this.musicResumeOffset=0,B.setVolume(e,70),B.play(e,()=>{!this.audioPaused&&this.musicEnabled&&(this.musicResumeOffset=0,this.playMusic(e))},{offset:t})}}pauseAudio(){if(!this.audioPaused){this.audioPaused=!0,this.pauseMusic();for(let e of this._getActiveLoopSoundIds())B.pause(e)}}pauseMusic(){this.musicId&&B.isPlaying(this.musicId)&&(B.pause(this.musicId),this.musicResumeOffset=B.getResumeOffset(this.musicId))}resumeAudio(){if(this.audioPaused&&(this.audioPaused=!1,this.resumeMusic(),this.soundEnabled))for(let e of this.loopingSounds.values())e&&e.active&&e.loopFn()}resumeMusic(){this.musicId&&!B.isPlaying(this.musicId)&&this.playMusic(this.musicId)}stopMusic(){this.musicId&&(B.stop(this.musicId),this.musicResumeOffset=0)}setMusicEnabled(e){this.musicEnabled=e,qt.setMusicEnabled(e),this.musicEnabled?this.resumeMusic():this.pauseMusic()}setSoundEnabled(e){if(this.soundEnabled=e,qt.setSoundEnabled(e),!e){let e=Array.from(this._getActiveLoopSoundIds());for(let t of e)this.stopLoopedSound(t)}}},fn=new class extends H{boxes;currentBoxIndex;currentOffset;isBoxCentered;bounceBox;ctx;canvas;$navBack;$navForward;pointerCapture;im;slideInProgress;from;to;startTime;spacing;centerOffset;isMouseDown;downX;downY;delta;downOffset;rafId=null;constructor(){super(V.BOXES,`boxPanel`,`menuBackground`,!0),Rt.registerBoxPanel(this),this.boxes=[],this.currentBoxIndex=this.getDefaultBoxIndex(),this.currentOffset=0,this.isBoxCentered=!0,this.bounceBox=null,this.ctx=null,this.canvas=null,this.$navBack=null,this.$navForward=null,this.pointerCapture=null,this.im=null,this.slideInProgress=!1,this.from=0,this.to=0,this.startTime=0,this.spacing=A.uiScaledNumber(600),this.centerOffset=A.uiScaledNumber(312),this.isMouseDown=!1,this.downX=null,this.downY=null,this.delta=0,this.downOffset=0,this.initializeDOM(),R.subscribe(R.ChannelId.UpdateVisibleBoxes,(...e)=>{let[t]=e;Array.isArray(t)&&(this.boxes=t,this.redraw())})}getDefaultBoxIndex(){return L?0:1}initializeDOM(){let e=()=>{let e=document.getElementById(`boxCanvas`);this.canvas=e,this.ctx=e?e.getContext(`2d`):null,!(!this.canvas||!this.ctx)&&(this.canvas.width=A.uiScaledNumber(1024),this.canvas.height=A.uiScaledNumber(576),this.$navBack=document.getElementById(`boxNavBack`),this.$navForward=document.getElementById(`boxNavForward`),this.$navBack?.addEventListener(`click`,()=>{this.currentBoxIndex>0&&(this.slideToBox(this.currentBoxIndex-1),U.playSound(n.SND_TAP))}),this.$navForward?.addEventListener(`click`,()=>{this.currentBoxIndex<this.boxes.length-1&&(this.slideToBox(this.currentBoxIndex+1),U.playSound(n.SND_TAP))}),document.getElementById(`boxUpgradePlate`)?.addEventListener(`click`,()=>{this.boxClicked(this.currentBoxIndex)}))};document.readyState===`loading`?document.addEventListener(`DOMContentLoaded`,e):e()}init(e){this.im=e}onShow(){this.activate()}onHide(){this.deactivate()}slideToNextBox(){this.slideToBox(this.currentBoxIndex+1)}bounceCurrentBox(){let e=this.bounceBox,t=this.ctx;e&&t&&(e.cancelBounce(),e.bounce(t))}boxClicked(e){if(e!==this.currentBoxIndex)return;let t=this.boxes[e];if(!t)return;let r=t.index;t.isClickable()&&(U.playSound(n.SND_TAP),mt.isBoxLocked(r)?t.type===p.HOLIDAY&&!L?this.showHolidayUnavailableDialog():this.showLockDialog(r):this.im?.gameFlow.openLevelMenu(r))}showLockDialog(e){N.drawBig({text:$e.menuText(F.CANT_UNLOCK_TEXT1),imgParentId:`missingLine1`,scaleToUI:!0}),N.drawBig({text:String(mt.requiredStars(e)-mt.totalStars()),imgParentId:`missingCount`,scaleToUI:!0}),N.drawBig({text:$e.menuText(F.CANT_UNLOCK_TEXT2),imgParentId:`missingLine2`,scaleToUI:!0}),N.drawSmall({text:$e.menuText(F.CANT_UNLOCK_TEXT3),imgParentId:`missingLine3`,scaleToUI:!0}),N.drawBig({text:$e.menuText(F.OK),imgParentId:`missingOkBtn`,scaleToUI:!0}),U.playSound(n.SND_TAP),Rt.getDialogs()?.showPopup(`missingStars`)}showHolidayUnavailableDialog(){let e=N.drawBig({text:$e.menuText(F.HOLIDAY_LEVELS_UNAVAILABLE_TITLE),imgParentId:`holidayLine1`,alignment:S.CENTER,scaleToUI:!0});e&&Object.assign(e.style,{display:`block`,margin:`0 auto`});let t=N.drawSmall({text:$e.menuText(F.HOLIDAY_LEVELS_UNAVAILABLE_TEXT),imgParentId:`holidayLine2`,alignment:S.CENTER,width:A.uiScaledNumber(420),scaleToUI:!0});t&&Object.assign(t.style,{display:`block`,margin:`${A.uiScaledNumber(16)}px auto 0`}),N.drawBig({text:$e.menuText(F.OK),imgParentId:`holidayOkBtn`,scaleToUI:!0});let r=document.getElementById(`holidayOkBtn`);if(r){Object.assign(r.style,{display:`block`,margin:`${A.uiScaledNumber(24)}px auto 0`,textAlign:`center`});let e=r.querySelector(`img`);e&&Object.assign(e.style,{display:`block`,margin:`0 auto`})}U.playSound(n.SND_TAP),Rt.getDialogs()?.showPopup(`holidayUnavailable`)}doBounceCurrentBox(){let e=this.bounceBox,t=this.ctx;e&&t&&(e.cancelBounce(),e.bounce(t))}render(e){let t=this.ctx,n=this.canvas;if(!t||!n)return;this.currentOffset=e,t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,n.width,n.height);let r=this.centerOffset+e,i=A.uiScaledNumber(130);t.translate(r,i);let a=0;for(let n of this.boxes){if(!n.visible)continue;let r=null,i=e+a;i>A.uiScaledNumber(-100)&&i<A.uiScaledNumber(100)&&(r=(this.centerOffset+e)*-1-a+A.uiScaledNumber(452)),t.translate(a,0),n.draw(t,r),t.translate(-a,0),a+=this.spacing}t.translate(-r,-i)}slideToBox(e){let t=this.ctx;if(!t||this.boxes.length===0)return;let n=Math.max(0,Math.min(e,this.boxes.length-1)),r=this.boxes[n];if(!r)return;this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=null,this.slideInProgress=!1,this.bounceBox?.cancelBounce();let i=n===this.currentBoxIndex?0:550,a=this.bounceBox;a&&a!==r&&(a.cancelBounce(),a.onUnselected?.());let o=r;this.bounceBox=o,this.currentBoxIndex=n,R.publish(R.ChannelId.SelectedBoxChanged,r.index),this.from=this.currentOffset,this.to=-1*this.spacing*n,this.startTime=Date.now(),this.slideInProgress=!0,this.isBoxCentered=i<=0;let s=()=>{t&&this.bounceBox===o&&(o.cancelBounce(),o.bounce(t),o.onSelected?.())},c=()=>{window.setTimeout(()=>{this.slideInProgress||s()},50)};if(i<=0){this.currentOffset=this.to,this.render(this.currentOffset),this.isBoxCentered=!0,this.slideInProgress=!1,this.updateNavButtons(),c();return}let l=()=>{if(!this.slideInProgress)return;let e=Date.now()-this.startTime,t=Math.min(e,i);this.currentOffset=qe.easeOutExpo(t,this.from,this.to-this.from,i),this.render(this.currentOffset),e>=i?(this.currentOffset=this.to,this.render(this.currentOffset),this.isBoxCentered=!0,this.slideInProgress=!1,this.updateNavButtons(),c(),this.rafId=null):this.rafId=requestAnimationFrame(l)};l(),this.updateNavButtons()}updateNavButtons(){if(!this.$navBack||!this.$navForward)return;let e=this.$navBack.querySelector(`div`),t=this.$navForward.querySelector(`div`);!e||!t||(this.currentBoxIndex<=0?e.classList.add(`boxNavDisabled`):e.classList.remove(`boxNavDisabled`),this.currentBoxIndex>=this.boxes.length-1?t.classList.add(`boxNavDisabled`):t.classList.remove(`boxNavDisabled`))}snapToBox(e){if(this.boxes.length===0){this.currentOffset=0,this.isBoxCentered=!0;return}let t=Math.max(0,Math.min(e,this.boxes.length-1));this.currentBoxIndex=t,this.currentOffset=-1*this.spacing*t,this.isBoxCentered=!0,this.slideInProgress=!1,this.render(this.currentOffset),this.updateNavButtons()}cancelSlideToBox(e=!1){this.slideInProgress=!1,this.bounceBox?.cancelBounce(),this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=null,e&&this.snapToBox(this.currentBoxIndex)}isMouseOverBox(e,t){let n=this.bounceBox;return!!(this.isBoxCentered&&n&&n.isClickable()&&e>A.uiScaledNumber(340)&&e<A.uiScaledNumber(680)&&t>A.uiScaledNumber(140)&&t<A.uiScaledNumber(460))}pointerDown(e,t){this.isMouseDown||=(this.cancelSlideToBox(!0),this.downX=e,this.downY=t,this.downOffset=this.currentOffset,!0)}pointerMove(e,t){if(this.canvas)if(this.isMouseDown){if(this.downX==null)return;this.cancelSlideToBox(),this.delta=e-this.downX,Math.abs(this.delta)>5&&(this.isBoxCentered=!1,this.render(this.downOffset+this.delta))}else this.isMouseOverBox(e,t)?this.canvas.classList.add(`ctrPointer`):this.canvas.classList.remove(`ctrPointer`)}pointerUp(e,t){if(!this.isMouseDown||this.downX==null||this.downY==null){this.isMouseDown=!1;return}if(this.cancelSlideToBox(),this.delta=e-this.downX,Math.abs(this.delta)>this.spacing/2){let e=this.currentOffset,t=Math.round(-1*e/this.spacing);this.slideToBox(t)}else if(Math.abs(this.delta)>5){let e=A.uiScaledNumber(30),t=this.delta>e?this.currentBoxIndex-1:this.delta<-e?this.currentBoxIndex+1:this.currentBoxIndex;this.slideToBox(t)}else this.isMouseOverBox(e,t)&&this.boxClicked(this.currentBoxIndex);this.isMouseDown=!1,this.downX=null,this.downY=null}pointerOut(e,t){this.pointerUp(e,t)}activate(){this.canvas&&(this.pointerCapture||=new ln({element:this.canvas,onStart:this.pointerDown.bind(this),onMove:this.pointerMove.bind(this),onEnd:this.pointerUp.bind(this),onOut:this.pointerOut.bind(this),getZoom:()=>dn.getUIZoom()}),this.pointerCapture?.activate())}deactivate(){this.pointerCapture?.deactivate()}redraw(){this.slideToBox(this.currentBoxIndex)}};const W=e=>e?typeof e==`string`?e[0]===`#`&&e.indexOf(` `)===-1?document.getElementById(e.slice(1)):document.querySelector(e):e instanceof Element||e===window||e===document?e:null:null,pn=(e,t)=>{let n=W(e);!n||!(n instanceof Element)||t.split(/\s+/).filter(Boolean).forEach(e=>n.classList.add(e))},mn=(e,t)=>{let n=W(e);!n||!t||!(n instanceof Element)||t.split(/\s+/).filter(Boolean).forEach(e=>n.classList.remove(e))},hn=(e,t,n)=>{let r=W(e);!r||!(r instanceof Element)||(n===void 0?r.classList.toggle(t):r.classList.toggle(t,!!n))},gn=(e,t,n)=>{let r=W(e);!r||!(r instanceof HTMLElement)||r.style.setProperty(t,n)};var _n=new WeakMap,vn=(e,t)=>{let n=_n.get(e);n||(n=new Set,_n.set(e,n)),n.add(t)},yn=(e,t)=>{let n=_n.get(e);n&&(n.has(t)&&(n.delete(t),clearTimeout(t)),n.size===0&&_n.delete(e))},bn=e=>{let t=_n.get(e);t&&(t.forEach(e=>clearTimeout(e)),t.clear(),_n.delete(e))},xn=new Map,Sn=e=>{let t=e.toLowerCase();if(xn.has(t)){let e=xn.get(t);if(e!==void 0)return e}if(!document.body)return`block`;let n=document.createElement(t);document.body.appendChild(n);let r=window.getComputedStyle(n).display;return document.body.removeChild(n),(!r||r===`none`)&&(r=`block`),xn.set(t,r),r};const Cn=(e,t)=>{let n=W(e);!n||!(n instanceof HTMLElement)||(n.style.removeProperty(`display`),window.getComputedStyle(n).display===`none`&&(n.style.display=t??Sn(n.nodeName)))},wn=e=>{let t=W(e);!t||!(t instanceof HTMLElement)||(t.style.display=`none`)},Tn=e=>{let t=W(e);if(!(!t||!(t instanceof Element)))for(;t.firstChild;)t.removeChild(t.firstChild)},En=(e,t)=>{let n=W(e);if(!n||t==null||!(n instanceof Element))return null;if(typeof t==`string`)return n.insertAdjacentHTML(`beforeend`,t),n.lastElementChild;let r=t instanceof Element?t:null;return r?(n.appendChild(r),r):null},Dn=e=>{let t=W(e);if(!t||!(t instanceof HTMLElement))return;bn(t);let n=window.getComputedStyle(t).opacity;t.style.transition=``,t.style.opacity=n},On=(e,t,n)=>{let r=W(e);if(!r||!(r instanceof HTMLElement))return Promise.resolve();let i=typeof t==`number`?t:400;return Dn(r),n?Cn(r,n):Cn(r),r.style.transition=`opacity ${i}ms ease`,r.style.opacity=`0`,r.getBoundingClientRect(),r.style.opacity=`1`,new Promise(e=>{let t=window.setTimeout(()=>{yn(r,t),r.style.transition=``,e()},i);vn(r,t)})},kn=(e,t)=>{let n=W(e);if(!n||!(n instanceof HTMLElement))return Promise.resolve();let r=typeof t==`number`?t:400;return Dn(n),n.style.transition=`opacity ${r}ms ease`,n.style.opacity=`1`,n.getBoundingClientRect(),n.style.opacity=`0`,new Promise(e=>{let t=window.setTimeout(()=>{yn(n,t),n.style.transition=``,n.style.display=`none`,e()},r);vn(n,t)})},An=(e,t)=>{let n=W(e);return!n||!(n instanceof HTMLElement)?new Promise(e=>{window.setTimeout(e,t)}):(Dn(n),new Promise(e=>{let r=window.setTimeout(()=>{yn(n,r),e()},t);vn(n,r)}))},jn=(e,t,n,r=!1)=>{let i=W(e);return i?(i.addEventListener(t,n,r),()=>{i.removeEventListener(t,n,r)}):()=>void 0},Mn=(e,t,n)=>{let r=W(e);if(!r)return()=>void 0;let i=typeof t==`function`?t:()=>void 0,a=typeof n==`function`?n:()=>void 0;return r.addEventListener(`mouseenter`,i),r.addEventListener(`mouseleave`,a),()=>{r.removeEventListener(`mouseenter`,i),r.removeEventListener(`mouseleave`,a)}},Nn=(e,t)=>{let n=W(e);if(!(!n||!(n instanceof Element)))return t===void 0?n.textContent:(n.textContent=t,t)},Pn=e=>{let t=W(e);return t?t===window?window.innerWidth:t instanceof Element?t.getBoundingClientRect().width:0:0};var Fn=E.levelBackgroundId??`levelBackground`,In=25,Ln=e=>{if(e<=In)return 1;let t=Math.ceil(e/In),n=e%In;return n>0&&n<10?2:t},Rn=(e,t=0)=>{if(e<=In)return e;let n=e%In;if(n>0&&n<10){if(t===0){let t=Math.ceil(e/2);if(t>12&&e-t>12)return t;let r=Math.floor((e-n)/5)*5;return r>=15&&r<=In?r:In-n}return e-Rn(e,0)}return In},zn=e=>e>12?{columns:5,leftOffset:-30,topOffset:-40,inc:A.uiScaledNumber(101)}:e>9?{columns:4,leftOffset:-80,topOffset:10,inc:A.uiScaledNumber(153)}:{columns:3,leftOffset:0,topOffset:0,inc:A.uiScaledNumber(153)},Bn=(e,t,n,r)=>{let{columns:i,leftOffset:a,topOffset:o,inc:s}=r,c=Math.floor(t/i),l=t%i,u=n%i||i,d=c===Math.floor((n-1)/i)?(i-u)*s/2:0,f=Math.ceil(n/i)*s,p=(5*s-f)/2;e.style.left=`${a+l*s+d}px`,e.style.top=`${o+c*s+p}px`,e.classList.toggle(`option-small`,i===5)},Vn=new class extends H{im=null;currentPage=0;lastBoxIndex=null;levelNavBack=null;levelNavForward=null;levelButtons=[];isLevelNavigationActive=!0;lastTotalPages=0;onLevelClick=e=>{let t=e.currentTarget;if(!t)return;let r=parseInt(t.dataset.level??`0`,10);if(mt.isLevelUnlocked(Dt.currentBoxIndex,r))U.selectRandomGameMusic(),this.im?.gameFlow.openLevel(r+1,!1,!1);else return;U.playSound(n.SND_TAP)};constructor(){super(V.LEVELS,`levelPanel`,Fn,!0),R.subscribe(R.ChannelId.UpdateVisibleBoxes,()=>{this.updateLevelOptions()})}init(e){this.im=e;let t=W(`#levelOptions`);if(this.levelNavBack=W(`#levelNavBack`),this.levelNavForward=W(`#levelNavForward`),this.isLevelNavigationActive||(this.levelNavBack&&wn(this.levelNavBack),this.levelNavForward&&wn(this.levelNavForward)),this.levelNavBack?.addEventListener(`click`,()=>{this.currentPage!==0&&(--this.currentPage,U.playSound(n.SND_TAP),this.updateLevelOptions())}),this.levelNavForward?.addEventListener(`click`,()=>{let e=Dt.currentBoxIndex,t=Ln(mt.levelCount(e)??0);this.currentPage>=t-1||(this.currentPage+=1,U.playSound(n.SND_TAP),this.updateLevelOptions())}),t instanceof HTMLElement)for(let e=0;e<In;e++){let n=document.createElement(`div`);n.dataset.level=e.toString(),n.className=`option locked ctrPointer`,n.addEventListener(`click`,this.onLevelClick),t.appendChild(n),this.levelButtons.push(n)}}setNavigationActive(e){if(this.isLevelNavigationActive=e,!(!this.levelNavBack||!this.levelNavForward)){if(!e){wn(this.levelNavBack),wn(this.levelNavForward);return}this.updateLevelNavigation(this.lastTotalPages)}}onShow(){this.setNavigationActive(!1),this.updateLevelOptions();let e=W(`#levelScore`),t=W(`#levelBack`),n=W(`#levelOptions`),r=W(`#levelResults`);e instanceof HTMLElement&&An(e,200).then(()=>On(e,700)),t instanceof HTMLElement&&An(t,200).then(()=>On(t,700)),n instanceof HTMLElement?(An(n,200).then(()=>On(n,700)).then(()=>{this.setNavigationActive(!0)}),this.setNavigationActive(!0),this.lastTotalPages>1&&this.levelNavBack&&this.levelNavForward&&(Cn(this.levelNavBack),Cn(this.levelNavForward),this.levelNavBack.style.opacity=`1`,this.levelNavForward.style.opacity=`1`)):this.setNavigationActive(!0),r instanceof HTMLElement&&An(r,200).then(()=>kn(r,700))}updateLevelOptions(){let e=Dt.currentBoxIndex,t=mt.levelCount(e)??0;this.lastBoxIndex!==e&&(this.currentPage=0,this.lastBoxIndex=e);let n=Ln(t);this.currentPage>=n&&(this.currentPage=n-1);let r=0;for(let e=0;e<this.currentPage;e++)r+=Rn(t,e);let i=Rn(t,this.currentPage),a=Math.min(i,Math.max(0,t-r));this.updateLevelNavigation(n);let o=zn(a);for(let n=0;n<this.levelButtons.length;n++){let i=this.levelButtons[n];if(!i)continue;let s=r+n;if(n<a&&s<t){Bn(i,n,a,o),i.dataset.level=s.toString(),Cn(i);let t=mt.getStars(e,s);if(t!=null){let e=document.createElement(`div`);e.className=`txt`,En(e,N.drawBig({text:String(s+1),scaleToUI:!0}));let n=document.createElement(`div`);pn(n,`stars${t}`),e.appendChild(n),mn(i,`locked`),mn(i,`purchase`),pn(i,`open`),pn(i,`ctrPointer`),Tn(i),i.appendChild(e)}else mn(i,`open`),pn(i,`locked`),Tn(i)}else wn(i)}let s=`${mt.achievedStars(Dt.currentBoxIndex)??0}/${(mt.levelCount(Dt.currentBoxIndex)??0)*3}`;N.drawBig({text:s,imgSel:`#levelScore img`,scaleToUI:!0}),Dt.updateBoxLocks(),mt.updateTotalScoreText()}updateLevelNavigation(e){if(!this.levelNavBack||!this.levelNavForward)return;if(this.lastTotalPages=e,!this.isLevelNavigationActive||e<=1){wn(this.levelNavBack),wn(this.levelNavForward);return}Cn(this.levelNavBack),Cn(this.levelNavForward);let t=this.levelNavBack.firstElementChild,n=this.levelNavForward.firstElementChild;t instanceof HTMLElement&&(this.currentPage===0?pn(t,`boxNavDisabled`):mn(t,`boxNavDisabled`)),n instanceof HTMLElement&&(this.currentPage>=e-1?pn(n,`boxNavDisabled`):mn(n,`boxNavDisabled`))}},Hn=new class{panels;fadeInDur;fadePause;fadeOutDur;fadeTo;fadeToBlack;isFading;shadowIsRotating;shadowAngle;shadowCanvas;shadowImage;shadowOpacity;shadowIsVisible;shadowSpeedup;shadowPanelElement;currentPanelId;onShowPanel;constructor(){this.panels=[new H(V.MENU,`menuPanel`,`startBackground`,!0),fn,Vn,new H(V.GAME,null,`levelBackground`,!1),new H(V.GAMEMENU,null,null,!1),new H(V.LEVELCOMPLETE,null,null,!1),new H(V.GAMECOMPLETE,`gameCompletePanel`,`menuBackground`,!0),new H(V.OPTIONS,`optionsPanel`,`menuBackground`,!0),new H(V.CREDITS,null,null,!1),new H(V.LEADERBOARDS,`leaderboardPanel`,`menuBackground`,!0),new H(V.ACHIEVEMENTS,`achievementsPanel`,`menuBackground`,!0),new H(V.SKIN_SELECT,`skinPanel`,`menuBackground`,!0)],this.fadeInDur=100,this.fadePause=50,this.fadeOutDur=100,this.fadeTo=1,this.fadeToBlack=null,this.isFading=!1,this.shadowIsRotating=!1,this.shadowAngle=15,this.shadowCanvas=null,this.shadowImage=null,this.shadowOpacity=1,this.shadowIsVisible=!1,this.shadowSpeedup=E.shadowSpeedup||1,this.shadowPanelElement=null,this.currentPanelId=V.MENU,this.onShowPanel=null,this.showPanel=this.showPanel.bind(this),this.runBlackFadeIn=this.runBlackFadeIn.bind(this),this.runBlackFadeOut=this.runBlackFadeOut.bind(this),R.subscribe(R.ChannelId.BoxesUnlocked,e=>{let t=e?V.MENU:V.BOXES;setTimeout(()=>this.showPanel(t),1e3)})}getPanelById(e){return this.panels.find(t=>t.id===e)??null}domReady(){this.fadeToBlack=document.getElementById(`fadeToBlack`),this.shadowCanvas=document.getElementById(`shadowCanvas`),this.shadowPanelElement=document.getElementById(`shadowPanel`),this.shadowCanvas&&(this.shadowCanvas.width=A.uiScaledNumber(1024),this.shadowCanvas.height=A.uiScaledNumber(576))}appReady(e){if(this.shadowImage=new Image,this.shadowImage.src=`${At.uiImageBaseUrl}shadow.webp`,e)for(let t of this.panels)e(t.id)}showShadow(){if(!this.shadowIsVisible){if(this.shadowCanvas){let e=this.shadowCanvas.getContext(`2d`);e&&(e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,this.shadowCanvas.width,this.shadowCanvas.height),e.restore())}this.shadowOpacity=0,this.shadowIsVisible=!0,this.shadowPanelElement&&(this.shadowPanelElement.style.display=`block`),this.shadowIsRotating||this.beginRotateShadow()}}hideShadow(){this.shadowIsVisible=!1,this.shadowIsRotating=!1,this.shadowPanelElement&&(this.shadowPanelElement.style.display=`none`)}beginRotateShadow(){if(!this.shadowCanvas||!this.shadowImage)return;let e=this.shadowCanvas.getContext(`2d`);if(!e)return;let t=window.requestAnimationFrame,n=Date.now(),r=()=>{if(!this.shadowIsRotating||!this.shadowCanvas||!this.shadowImage||!e)return;let i=Date.now(),a=i-n;this.shadowAngle+=a*.1/25*this.shadowSpeedup,n=i,e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,this.shadowCanvas.width,this.shadowCanvas.height),this.shadowOpacity<1&&(this.shadowOpacity=Math.min(this.shadowOpacity+.025,1),e.globalAlpha=this.shadowOpacity),e.save(),e.translate(this.shadowImage.width*.5,this.shadowImage.height*.5),e.translate(A.uiScaledNumber(-300),A.uiScaledNumber(-510)),e.rotate(this.shadowAngle*Math.PI/180),e.translate(-this.shadowImage.width*.5,-this.shadowImage.height*.5),e.drawImage(this.shadowImage,0,0),e.restore(),t(r)};this.shadowIsRotating=!0,r()}runBlackFadeIn(e){let t=Date.now();if(!this.fadeToBlack){e?.();return}this.isFading=!0,this.fadeToBlack.style.opacity=`0`,this.fadeToBlack.style.display=`block`;let n=()=>{if(!this.fadeToBlack)return;let r=Date.now()-t,i=qe.noEase(r,0,this.fadeTo,this.fadeInDur);this.fadeToBlack.style.opacity=String(i),r<this.fadeInDur?window.requestAnimationFrame(n):(this.fadeToBlack&&(this.fadeToBlack.style.opacity=String(this.fadeTo)),e?.())};window.requestAnimationFrame(n)}runBlackFadeOut(){if(!this.isFading||!this.fadeToBlack)return;let e=Date.now(),t=()=>{if(!this.fadeToBlack)return;let n=Date.now()-e,r=this.fadeTo-qe.noEase(n,0,this.fadeTo,this.fadeInDur);this.fadeToBlack.style.opacity=String(r),n<this.fadeInDur?window.requestAnimationFrame(t):(this.fadeToBlack&&(this.fadeToBlack.style.opacity=`0`,this.fadeToBlack.style.display=`none`),this.isFading=!1)};window.requestAnimationFrame(t)}showPanel(e,t=!1){this.currentPanelId=e;let n=this.getPanelById(e);if(!n)return;n.showShadow?this.showShadow():this.hideShadow();let r=t?0:this.fadeInDur+this.fadePause;setTimeout(()=>{if(n.bgDivId){let e=document.getElementById(n.bgDivId);e&&(e.style.display=`block`)}if(n.panelDivId){let e=document.getElementById(n.panelDivId);e&&(e.style.display=`block`)}for(let e of this.panels){if(e.panelDivId&&e.panelDivId!==n.panelDivId){let t=document.getElementById(e.panelDivId);t&&(t.style.display=`none`)}if(e.bgDivId&&e.bgDivId!==n.bgDivId){let t=document.getElementById(e.bgDivId);t&&(t.style.display=`none`)}}this.onShowPanel?.(e),t||this.runBlackFadeOut()},r),t||this.runBlackFadeIn()}},Un={PIXELS:0,DELAY:1},Wn=class e{static SpeedType=Un;speed;type;pos;prevPos;target;offset;constructor(e,t){this.speed=e,this.type=t,this.pos=O.newZero(),this.prevPos=O.newZero(),this.target=O.newZero(),this.offset=O.newZero()}moveTo(t,n,r){this.target.x=t,this.target.y=n,r?(this.pos.copyFrom(this.target),this.prevPos.copyFrom(this.target)):this.type===e.SpeedType.DELAY?(this.offset=O.subtract(this.target,this.pos),this.offset.multiply(this.speed)):this.type===e.SpeedType.PIXELS&&(this.offset=O.subtract(this.target,this.pos),this.offset.normalize(),this.offset.multiply(this.speed))}update(e){this.prevPos.copyFrom(this.pos),this.pos.equals(this.target)||(this.pos.add(O.multiply(this.offset,e)),this.pos.round(),(!I.sameSign(this.offset.x,this.target.x-this.pos.x)||!I.sameSign(this.offset.y,this.target.y-this.pos.y))&&this.pos.copyFrom(this.target))}applyCameraTransformation(){(this.pos.x!==0||this.pos.y!==0)&&C.context&&C.context.translate(-this.pos.x,-this.pos.y)}cancelCameraTransformation(){(this.pos.x!==0||this.pos.y!==0)&&C.context&&C.context.translate(this.pos.x,this.pos.y)}applyInterpolatedTransformation(e){let t=Math.min(Math.max(e,0),1),n=this.prevPos.x+(this.pos.x-this.prevPos.x)*t,r=this.prevPos.y+(this.pos.y-this.prevPos.y)*t;return(n!==0||r!==0)&&C.context&&C.context.translate(-n,-r),new O(n,r)}cancelInterpolatedTransformation(e){(e.x!==0||e.y!==0)&&C.context&&C.context.translate(e.x,e.y)}};const Gn=9.8*P.PIXEL_TO_SI_METERS_K;var Kn=new class e{static EARTH_Y=Gn;current;constructor(){this.current=new O(0,Gn)}toggle(){this.current.y=-this.current.y}isZero(){return this.current.y===0&&this.current.x===0}isNormal(){return this.current.y===e.EARTH_Y&&this.current.x===0}reset(){this.current.x=0,this.current.y=Gn}},qn=15,Jn={UP:0,DOWN:1},Yn=class e extends T{static StateType=Jn;buttonId;state;touchLeftInc;touchRightInc;touchTopInc;touchBottomInc;onButtonPressed;forcedTouchZone;constructor(e){super(),this.buttonId=e,this.state=Jn.UP,this.touchLeftInc=0,this.touchRightInc=0,this.touchTopInc=0,this.touchBottomInc=0,this.onButtonPressed=null,this.forcedTouchZone=new w(P.UNDEFINED,P.UNDEFINED,P.UNDEFINED,P.UNDEFINED)}initWithElements(t,n){t.parentAnchor=n.parentAnchor=S.TOP|S.LEFT,this.addChildWithID(t,e.StateType.UP),this.addChildWithID(n,e.StateType.DOWN),this.setState(e.StateType.UP)}initWithTextures(e,t){let n=new j;n.initTexture(e);let r=new j;r.initTexture(t),this.initWithElements(n,r)}forceTouchRect(e){this.forcedTouchZone=e}setTouchIncrease(e,t,n,r){this.touchLeftInc=e,this.touchRightInc=t,this.touchTopInc=n,this.touchBottomInc=r}setState(t){this.state=t;let n=this.getChild(e.StateType.UP),r=this.getChild(e.StateType.DOWN);if(!n||!r)throw Error(`Button elements not initialized`);n.setEnabled(t===e.StateType.UP),r.setEnabled(t===e.StateType.DOWN)}isInTouchZone(e,t,n){let r=n?0:qn;return this.forcedTouchZone.w===P.UNDEFINED?w.pointInRect(e,t,this.drawX-this.touchLeftInc-r,this.drawY-this.touchTopInc-r,this.width+(this.touchLeftInc+this.touchRightInc)+r*2,this.height+(this.touchTopInc+this.touchBottomInc)+r*2):w.pointInRect(e,t,this.drawX+this.forcedTouchZone.x-r,this.drawY+this.forcedTouchZone.y-r,this.forcedTouchZone.w+r*2,this.forcedTouchZone.h+r*2)}onTouchDown(t,n){return super.onTouchDown(t,n),this.state===e.StateType.UP&&this.isInTouchZone(t,n,!0)?(this.setState(e.StateType.DOWN),!0):!1}onTouchUp(t,n){return super.onTouchUp(t,n),this.state===e.StateType.DOWN&&(this.setState(e.StateType.UP),this.isInTouchZone(t,n,!1))?(this.onButtonPressed&&this.onButtonPressed(this.buttonId),!0):!1}onTouchMove(t,n){if(super.onTouchMove(t,n),this.state===e.StateType.DOWN)if(!this.isInTouchZone(t,n,!1))this.setState(e.StateType.UP);else return!0;return!1}addChildWithID(t,n){super.addChildWithID(t,n),t.parentAnchor=S.TOP|S.LEFT,n===e.StateType.DOWN&&(this.width=t.width,this.height=t.height,this.setState(e.StateType.UP))}},Xn={FACE1:0,FACE2:1},Zn=class extends T{buttonId;onButtonPressedCallback;b1;b2;constructor(e,t,n,r,i){super(),this.buttonId=i,this.onButtonPressedCallback=null,this.b1=new Yn(Xn.FACE1),this.b1.initWithElements(e,t),this.b2=new Yn(Xn.FACE2),this.b2.initWithElements(n,r),this.b1.parentAnchor=this.b2.parentAnchor=S.TOP|S.LEFT,this.width=this.b1.width,this.height=this.b1.height,this.addChildWithID(this.b1,Xn.FACE1),this.addChildWithID(this.b2,Xn.FACE2),this.b2.setEnabled(!1),this.b1.onButtonPressed=this.onButtonPressed.bind(this),this.b2.onButtonPressed=this.onButtonPressed.bind(this)}onButtonPressed(e){switch(e){case Xn.FACE1:case Xn.FACE2:this.toggle();break}this.onButtonPressedCallback&&this.onButtonPressedCallback(this.buttonId)}setTouchIncrease(e,t,n,r){this.b1.setTouchIncrease(e,t,n,r),this.b2.setTouchIncrease(e,t,n,r)}toggle(){this.b1.setEnabled(!this.b1.isEnabled()),this.b2.setEnabled(!this.b2.isEnabled())}isOn(){return this.b2.isEnabled()}},Qn=56,$n=57,er=class e extends Zn{static DefaultId=0;constructor(){let t=j.create(n.IMG_OBJ_STAR_IDLE,Qn),r=j.create(n.IMG_OBJ_STAR_IDLE,Qn),i=j.create(n.IMG_OBJ_STAR_IDLE,$n),a=j.create(n.IMG_OBJ_STAR_IDLE,$n);super(t,r,i,a,e.DefaultId),this.setTouchIncrease(10,10,10,10)}},tr=class{start;end;startSize;endSize;color;constructor(e,t,n,r,i){this.start=e,this.end=t,this.startSize=n,this.endSize=r,this.color=i}},nr=1,rr=58,ir={NORMAL:0,UPSIDE_DOWN:1},ar=class e extends j{static TimelineId=ir;constructor(t,r){super(),this.initTextureWithId(n.IMG_OBJ_STAR_IDLE),this.setTextureQuad(rr),this.anchor=S.CENTER;let i=new o;i.addKeyFrame(D.makeRotation(0,D.TransitionType.LINEAR,0)),i.addKeyFrame(D.makeRotation(180,D.TransitionType.EASE_OUT,.3)),this.addTimelineWithID(i,e.TimelineId.UPSIDE_DOWN);let a=new o;a.addKeyFrame(D.makeRotation(180,D.TransitionType.LINEAR,0)),a.addKeyFrame(D.makeRotation(0,D.TransitionType.EASE_OUT,.3)),this.addTimelineWithID(a,e.TimelineId.NORMAL),this.setElementPositionWithOffset(n.IMG_BGR_08_P1,nr),this.x+=t,this.y+=r}};function or(e,t){t||=1;let n=e.length,r;if(n)for(;t--;)for(let t=0;t<n;++t){if(r=e[t],!r)continue;let n=r.constraints,i=n.length,a=r.pin,o=r.pos,s=r.invWeight,c,l,u,d;if(a.x!==-1){o.x=a.x,o.y=a.y;continue}for(let e=0;e<i;e++){let t=n[e];if(!t)continue;let r=t.cp,i=r.pos;c=i.x-o.x,l=i.y-o.y,c===0&&l===0&&(c=1,l=1);let a=c*c+l*l,f=t.restLength,p=f*f,m=t.type;if(m===1){if(a<=p)continue}else if(m===2&&a>=p)continue;let h=r.pin.x===-1,g=r.invWeight,_=Math.sqrt(a),v=_>1?_:1,y=(_-f)/(v*(s+g));h&&(u=c,d=l);let b=s*y;if(c*=b,l*=b,o.x+=c,o.y+=l,h){let e=g*y;u&&d&&(i.x-=u*e,i.y-=d*e)}}}}var sr=or,cr=class{relaxationTimes;parts;constructor(){this.relaxationTimes=1,this.parts=[]}addPartAtIndex(e,t){this.parts.splice(t,0,e)}addPart(e){this.parts[this.parts.length]=e}log(){lt.debug(`Constraint System Log:`);for(let e=0,t=this.parts.length;e<t;e++){let t=this.parts[e];if(t){lt.debug(`-- Point: ${t.posString()}`);for(let e=0,n=t.constraints.length;e<n;e++){let n=t.constraints[e];if(!n)continue;let r=`---- Constraint: ${n.cp.posString()} len: ${n.restLength}`;lt.debug(r)}}}}removePartAtIndex(e){this.parts.splice(e,1)}update(e){let t=this.parts,n=t.length,r=this.relaxationTimes;for(let r=0;r<n;r++){let n=t[r];n&&n.update(e)}sr(t,r)}},lr={DISTANCE:0,NOT_MORE_THAN:1,NOT_LESS_THAN:2},ur=class{disableGravity;weight;invWeight;gravity;v;a;pos;posDelta;totalForce;constructor(){this.disableGravity=!1,this.setWeight(1);let e=O.newZero;this.v=e(),this.a=e(),this.pos=e(),this.posDelta=e(),this.totalForce=e()}setWeight(e){this.weight=e,this.invWeight=1/e,this.gravity=new O(0,Gn*e)}resetAll(){let e=O.newZero;this.v=e(),this.a=e(),this.pos=e(),this.posDelta=e(),this.totalForce=e()}updateWithPrecision(e,t){let n=(e/t>>0)+1;n!=0&&(e/=n);for(let t=0;t<n;t++)this.update(e)}update(e){this.totalForce=O.newZero(),this.disableGravity||(!Kn.isZero()&&this.weight?this.totalForce.add(O.multiply(Kn.current,this.weight)):this.gravity&&this.totalForce.add(this.gravity));let t=e/P.TIME_SCALE;this.invWeight&&(this.totalForce.multiply(this.invWeight),this.a=O.multiply(this.totalForce,t),this.v.add(this.a),this.posDelta=O.multiply(this.v,t),this.pos.add(this.posDelta))}applyImpulse(e,t){if(!e.isZero()){let n=O.multiply(e,t/P.TIME_SCALE);this.pos.add(n)}}},dr=class{cp;restLength;type;constructor(e,t,n){this.cp=e,this.restLength=t,this.type=n}},fr=class extends ur{prevPos;pin;constraints;constructor(){super(),this.prevPos=new O(P.INT_MAX,P.INT_MAX),this.pin=new O(P.UNDEFINED,P.UNDEFINED),this.constraints=[],this.totalForce=O.newZero()}resetAll(){super.resetAll(),this.prevPos.x=P.INT_MAX,this.prevPos.y=P.INT_MAX,this.removeConstraints()}removeConstraints(){this.constraints=[]}addConstraint(e,t,n){let r=new dr(e,t,n);this.constraints.push(r)}removeConstraint(e){let t=this.constraints,n=t.length;for(let r=0;r<n;r++){let n=t[r];if(n&&n.cp===e){t.splice(r,1);return}}}removeConstraintAtIndex(e){this.constraints.splice(e,1)}changeConstraint(e,t){let n=this.constraints,r=n.length;for(let i=0;i<r;i++){let r=n[i];if(r&&r.cp===e){r.cp=t;return}}}hasConstraint(e){let t=this.constraints,n=t.length;for(let r=0;r<n;r++){let n=t[r];if(n&&n.cp===e)return!0}return!1}changeRestLength(e,t){let n=this.constraints,r=n.length;for(let i=0;i<r;i++){let r=n[i];if(r&&r.cp===e){r.restLength=t;return}}}changeConstraintAndLength(e,t,n){let r=this.constraints,i=r.length;for(let a=0;a<i;a++){let i=r[a];if(i&&i.cp===e){i.cp=t,i.restLength=n;return}}}restLength(e){let t=this.constraints,n=t.length;for(let r=0;r<n;r++){let n=t[r];if(n&&n.cp===e)return n.restLength}return P.UNDEFINED}update(e){let t=this.totalForce,n=Kn.current;if(this.disableGravity)t.x=0,t.y=0;else{if(!this.gravity||!this.invWeight)return;n.y!==0||n.x!==0?(t.x=n.x,t.y=n.y):(t.x=this.gravity.x*this.invWeight,t.y=this.gravity.y*this.invWeight)}let r=e/P.TIME_SCALE*e/P.TIME_SCALE;if(this.a.x=this.totalForce.x*r,this.a.y=this.totalForce.y*r,this.prevPos.x===P.INT_MAX&&(this.prevPos.x=this.pos.x,this.prevPos.y=this.pos.y),this.posDelta.x=this.pos.x-this.prevPos.x+this.a.x,this.posDelta.y=this.pos.y-this.prevPos.y+this.a.y,e>0){let t=1/e;this.v.x=this.posDelta.x*t,this.v.y=this.posDelta.y*t}this.prevPos.x=this.pos.x,this.prevPos.y=this.pos.y,this.pos.x+=this.posDelta.x,this.pos.y+=this.posDelta.y}satisfyConstraints(){let e=this.pin,t=this.pos,n=this.invWeight,r,i,a,o;if(e.x!==-1){t.x=e.x,t.y=e.y;return}let s=this.constraints,c=s.length;for(let e=0;e<c;e++){let c=s[e];if(!c)continue;let l=c.cp,u=l.pos;r=u.x-t.x,i=u.y-t.y,r===0&&i===0&&(r=1,i=1);let d=r*r+i*i,f=c.restLength,p=f*f,m=c.type;if(m===1){if(d<=p)continue}else if(m===2&&d>=p)continue;let h=l.pin.x===-1,g=l.invWeight,_=Math.sqrt(d),v=_>1?_:1;if(!n||!g)return;let y=(_-f)/(v*(n+g));if(h&&(a=r,o=i),!n)return;let b=n*y;if(r*=b,i*=b,t.x+=r,t.y+=i,h){if(!g)return;let e=g*y;a&&o&&(u.x-=a*e,u.y-=o*e)}}}qcpUpdate(e){this.update(e)}posString(){return`${this.pos.x.toFixed(2)}, ${this.pos.y.toFixed(2)}`}},G=class{static MAX_CAPACITY=100;path=[];moveSpeed;pos=new O(0,0);prevPos=new O(0,0);angle=0;prevAngle=0;targetPoint=0;offset=new O(0,0);paused=!1;reverse=!1;overrun=0;constructor(e,t,n=0){this.pathCapacity=e,this.rotateSpeed=n;let r=e>0?e:0;if(this.moveSpeed=Array(r),r>0)for(let e=0;e<r;e++)this.moveSpeed[e]=t||0}setMoveSpeed(e){for(let t=0,n=this.pathCapacity;t<n;t++)this.moveSpeed[t]=e}setPathFromString(e,t){if(e.length!==0)if(e[0]===`R`){let n=e[1]===`C`,r=parseInt(e.slice(2),10),i=r/2,a=2*Math.PI/i,o=0;n||(a=-a);for(let e=0;e<i;++e){let e=t.x+r*Math.cos(o),n=t.y+r*Math.sin(o);this.addPathPoint(new O(e,n)),o+=a}}else{this.addPathPoint(t.copy());let n=e;n[n.length-1]===`,`&&(n=n.slice(0,n.length-1));let r=n.split(`,`),i=r.length;for(let e=0;e<i;e+=2){let n=parseFloat(r[e]),i=parseFloat(r[e+1]),a=new O(t.x+n,t.y+i);this.addPathPoint(a)}}}addPathPoint(e){this.path.push(e)}start(){this.path.length>0&&(this.pos.copyFrom(this.path[0]),this.prevPos.copyFrom(this.pos),this.targetPoint=1%this.path.length,this.calculateOffset())}pause(){this.paused=!0}unpause(){this.paused=!1}setRotateSpeed(e){this.rotateSpeed=e}jumpToPoint(e){this.path[e]&&(this.targetPoint=e,this.pos.copyFrom(this.path[e]),this.prevPos.copyFrom(this.pos),this.calculateOffset())}calculateOffset(){let e=this.path[this.targetPoint];if(!e){this.offset.setToZero();return}if(this.offset=O.subtract(e,this.pos),this.offset.isZero()){this.offset.setToZero();return}this.offset.normalize();let t=this.moveSpeed[this.targetPoint]??0;this.offset.multiply(t)}setMoveSpeedAt(e,t){this.moveSpeed[t]=e}setMoveReverse(e){this.reverse=e}update(e){if(this.prevPos.copyFrom(this.pos),this.prevAngle=this.angle,!this.paused){if(this.path.length>0){let t=this.path[this.targetPoint];if(!t)return;let n=!1;if(this.pos.equals(t))n=!0;else{let r=e;if(this.overrun!==0&&(r+=this.overrun,this.overrun=0),this.pos.add(O.multiply(this.offset,r)),!I.sameSign(this.offset.x,t.x-this.pos.x)||!I.sameSign(this.offset.y,t.y-this.pos.y)){this.overrun=O.subtract(this.pos,t).getLength();let e=this.offset.getLength();e!==0&&(this.overrun/=e),this.pos.copyFrom(t),n=!0}}n&&(this.reverse?(this.targetPoint--,this.targetPoint<0&&(this.targetPoint=this.path.length-1)):(this.targetPoint++,this.targetPoint>=this.path.length&&(this.targetPoint=0)),this.calculateOffset())}this.rotateSpeed!==0&&(this.angle+=this.rotateSpeed*e)}}static moveToTarget(e,t,n,r){return t!==e&&(t>e?(e+=n*r,e>t&&(e=t)):(e-=n*r,e<t&&(e=t))),e}static moveToTargetWithStatus(e,t,n,r){let i=!1;return t!==e&&(t>e?(e+=n*r,e>t&&(e=t)):(e-=n*r,e<t&&(e=t)),t===e&&(i=!0)),{value:e,reachedZero:i}}getInterpolated(e){let t=Math.min(Math.max(e,0),1);return{x:this.prevPos.x+(this.pos.x-this.prevPos.x)*t,y:this.prevPos.y+(this.pos.y-this.prevPos.y)*t,angle:this.prevAngle+(this.angle-this.prevAngle)*t}}},pr=[{primary:new k(.475,.305,.185,1),secondary:new k(.6755555555555556,.44,.27555555555555555,1)},{primary:new k(.624,.294,.114,1),secondary:new k(1,.627,.463,1)},{primary:new k(.404,.612,.635,1),secondary:new k(.773,.898,.902,1)},{primary:new k(.757,.533,0,1),secondary:new k(.98,.843,.2,1)},{primary:new k(.98,.243,.243,1),secondary:new k(.282,.525,.153,1)},{primary:new k(.176,.318,.659,1),secondary:new k(1,1,1,1)},{primary:new k(.631,.957,1,1),secondary:new k(.996,.631,.953,1)},{primary:new k(1,.329,.318,1),secondary:new k(1,.992,.941,1)},{primary:new k(1,.831,.404,1),secondary:new k(.251,.239,.278,1)}],mr=`selectedRopeSkin`;const hr=()=>Xe.getIntOrDefault(mr,0)??0,gr=(e=hr())=>pr[e]??pr[0]??{primary:new k(.475,.305,.185,1),secondary:new k(.6755555555555556,.44,.27555555555555555,1)};function _r(e){return Math.min(Math.max(e,0),1)}function vr(e,t,n){return e+(t-e)*n}function yr(e,t,n,r){if(e.x===P.INT_MAX||e.y===P.INT_MAX||n>=1)return t;let i=t.x-e.x,a=t.y-e.y;return i*i+a*a>r?t:n<=0?e:new O(e.x+i*n,e.y+a*n)}var br=25,xr=.02,Sr=.5,Cr=2,wr=.05,Tr=function(e){return e[e.NORMAL=0]=`NORMAL`,e[e.LOCKED=1]=`LOCKED`,e}(Tr||{}),Er=new k(0,0,0,1),Dr=new k(0,0,0,1),Or=new k(0,0,0,1),kr=new k(0,0,0,1),Ar=new k(0,0,0,1),jr=class extends cr{static BUNGEE_RELAXION_TIMES=br;relaxed;lineWidth;width;cut;cutTime;bungeeMode;highlighted;BUNGEE_REST_LEN;bungeeAnchor;tail;forceWhite;initialCandleAngle;chosenOne;hideTailParts;dontDrawRedStretch;drawPts;BUNGEE_BEZIER_POINTS;lightRandomSeed;interpolationAlpha;constructor(e,t,n,r,i,a,o){super(),this.relaxed=0,this.relaxationTimes=br,this.lineWidth=A.DEFAULT_BUNGEE_LINE_WIDTH,this.width=A.DEFAULT_BUNGEE_WIDTH,this.cut=P.UNDEFINED,this.cutTime=0,this.bungeeMode=Tr.NORMAL,this.highlighted=!1,this.BUNGEE_REST_LEN=A.BUNGEE_REST_LEN,this.bungeeAnchor=e??new fr,r==null?(this.tail=new fr,this.tail.setWeight(1)):this.tail=r,this.bungeeAnchor.setWeight(xr),this.bungeeAnchor.pos.x=t,this.bungeeAnchor.pos.y=n,this.tail.pos.x=i,this.tail.pos.y=a,this.addPart(this.bungeeAnchor),this.addPart(this.tail),this.tail.addConstraint(this.bungeeAnchor,this.BUNGEE_REST_LEN,lr.DISTANCE);let s=O.subtract(this.tail.pos,this.bungeeAnchor.pos),c=Math.round(o/this.BUNGEE_REST_LEN+2);s.divide(c),this.roll(o,s),this.forceWhite=!1,this.initialCandleAngle=P.UNDEFINED,this.chosenOne=!1,this.hideTailParts=!1,this.dontDrawRedStretch=!1,this.drawPts=[],this.BUNGEE_BEZIER_POINTS=A.BUNGEE_BEZIER_POINTS,this.lightRandomSeed=null,this.interpolationAlpha=1}getLength(){let e=0,t=this.parts,n=t.length;if(n>0){let r=t[0]?.pos;for(let i=1;i<n;i++){let n=t[i];!n||!r||(e+=r.distance(n.pos),r=n.pos)}}return e}roll(e,t){t??=O.newZero();let n=this.parts,r=this.tail,i=n[n.length-2];if(!i)return;let a=r.restLength(i),o=null;for(;e>0;)if(e>=this.BUNGEE_REST_LEN){if(i=n[n.length-2],!i)break;o=new fr,o.setWeight(xr),o.pos=O.add(i.pos,t),this.addPartAtIndex(o,this.parts.length-1),r.changeConstraintAndLength(i,o,a),o.addConstraint(i,this.BUNGEE_REST_LEN,lr.DISTANCE),e-=this.BUNGEE_REST_LEN}else{let t=e+a;if(t>this.BUNGEE_REST_LEN)e=this.BUNGEE_REST_LEN,a=t-this.BUNGEE_REST_LEN;else{if(i=n[n.length-2],!i)break;r.changeRestLength(i,t),e=0}}}rollBack(e){let t=this.parts,n=t.length,r=t[n-2],i=this.tail,a=e,o;if(!r)return a;let s=i.restLength(r);for(;a>0;)if(a>=this.BUNGEE_REST_LEN){let e=n-2,r=t[n-3];if(o=t[e],!o||!r)break;i.changeConstraintAndLength(o,r,s),this.removePartAtIndex(e),n--,a-=this.BUNGEE_REST_LEN}else{let e=s-a;if(e<1)a=this.BUNGEE_REST_LEN,s=this.BUNGEE_REST_LEN+e+1;else{if(o=t[n-2],!o)break;i.changeRestLength(o,e),a=0}}let c=(n-1)*(this.BUNGEE_REST_LEN+3),l=i.constraints,u=l.length;for(let e=0;e<u;e++){let t=l[e];t&&t.type===lr.NOT_MORE_THAN&&(t.restLength=c)}return a}strengthen(){let e=this.parts,t=e.length;for(let n=0;n<t;n++){let t=e[n];if(t&&this.bungeeAnchor.pin.x!=P.UNDEFINED&&(t!==this.tail&&t.setWeight(Sr),n>0)){let e=n*(this.BUNGEE_REST_LEN+3);t.addConstraint(this.bungeeAnchor,e,lr.NOT_MORE_THAN)}}}update(e){this.cutTime>0&&(this.cutTime=G.moveToTarget(this.cutTime,0,1,e),this.cutTime<Cr-wr&&this.forceWhite&&this.removePart(this.cut));let t=this.parts,n=t.length,r=this.relaxationTimes,i=this.tail,a;for(a=0;a<n;a++){let n=t[a];n&&n!==i&&n.update(e)}sr(t,r)}removePart(e){this.forceWhite=!1;let t=this.parts,n=t[e],r=t[e+1];if(n){if(!r)n.removeConstraints();else{let t=r.constraints,i=t.length;for(let a=0;a<i;a++){let i=t[a];if(i&&i.cp===n){r.removeConstraintAtIndex(a);let t=new fr;t.setWeight(1e-5),t.pos.copyFrom(r.pos),t.prevPos.copyFrom(r.prevPos),this.addPartAtIndex(t,e+1),t.addConstraint(n,this.BUNGEE_REST_LEN,lr.DISTANCE);break}}}for(let e=0,n=t.length;e<n;e++){let n=t[e];n&&n!==this.tail&&n.setWeight(1e-5)}}}setCut(e){this.cut=e,this.cutTime=Cr,this.forceWhite=!0,this.highlighted=!1}draw(){let e=this.parts,t=e.length,n=C.context,r=_r(this.interpolationAlpha),i=this.BUNGEE_REST_LEN*4,a=i*i,o=e=>yr(e.prevPos,e.pos,r,a);if(n&&(n.lineJoin=`round`,n.lineWidth=this.lineWidth),this.cut===P.UNDEFINED){let n=Array(t);for(let r=0;r<t;r++){let t=e[r];n[r]=t?o(t):O.newZero()}this.drawBungee(n,1)}else{let n=[],r=[],i=!1,a=0;for(let s=0;s<t;s++){let t=e[s];if(!t)continue;let c=!0;if(s>0){let n=e[s-1];n&&!t.hasConstraint(n)&&(c=!1)}t.pin.x===P.UNDEFINED&&!c&&(i=!0,a=s);let l=o(t);i?r.push(l):n[s]=l}n.length>0&&this.drawBungee(n,0),r.length>0&&!this.hideTailParts&&this.drawBungee(r,a)}n&&(n.lineWidth=1)}drawBungee(e,t){let n=e.length,r=this.BUNGEE_BEZIER_POINTS,i=this.drawPts;if(n<2)return;let a=this.cut===P.UNDEFINED||this.forceWhite?1:this.cutTime/(Cr-wr);if(a<=0)return;let o=e[0],s=e[1];if(!o||!s)return;let c=o.x-s.x,l=o.y-s.y,u=Math.sqrt(c*c+l*l);if(u<=this.BUNGEE_REST_LEN+.3?this.relaxed=0:u<=this.BUNGEE_REST_LEN+1?this.relaxed=1:u<this.BUNGEE_REST_LEN+4?this.relaxed=2:this.relaxed=3,n<3)return;let d=Er,f=Dr,p=Or,m=kr,h=Ar;d.r=0,d.g=0,d.b=0,d.a=a;let g=gr();if(f.copyFrom(g.primary),f.a=a,p.copyFrom(g.primary),p.multiply(.4),p.a=a,m.copyFrom(g.secondary),m.a=a,h.copyFrom(g.secondary),h.multiply(.45),h.a=a,this.highlighted&&(f.r*=3,f.g*=3,f.b*=3,m.r*=3,m.g*=3,m.b*=3,p.r*=3,p.g*=3,p.b*=3,h.r*=3,h.g*=3,h.b*=3),u>this.BUNGEE_REST_LEN+7&&!this.dontDrawRedStretch){let e=u/this.BUNGEE_REST_LEN*2;p.r*=e,h.r*=e}let _=!0,v=(n-1)*r,y=new k(p.r,p.g,p.b,p.a),b=new k(h.r,h.g,h.b,h.a),x=v-1,ee=(f.r-p.r)/x,te=(f.g-p.g)/x,ne=(f.b-p.b)/x,re=(m.r-h.r)/x,ie=(m.g-h.g)/x,ae=(m.b-h.b)/x,oe=this.BUNGEE_BEZIER_POINTS-1,S=oe-1,se=C.context;if(!se)return;let ce=se.globalAlpha;ce!==a&&(se.globalAlpha=a);let le=i[0];le?(le.x=o.x,le.y=o.y):le=i[0]=o.copy(),se.beginPath();for(let t=1;t<=v;t++){let n=t/v,r=i[t];r||=i[t]=new O(0,0),O.setCalcPathBezier(e,n,r);let a=(t-1)%oe;if(a===S||t===v){se.beginPath();let e;e=this.forceWhite?k.styles.SOLID_OPAQUE:_?y.rgbaStyle():b.rgbaStyle(),se.strokeStyle=e;let n=t-a-1,r=i[n++];if(!r)continue;for(se.moveTo(r.x,r.y);n<=t;n++)r=i[n],r&&se.lineTo(r.x,r.y);se.stroke(),_=!_;let o=a+1;y.r+=ee*o,y.g+=te*o,y.b+=ne*o,b.r+=re*o,b.g+=ie*o,b.b+=ae*o}}se.stroke(),ce!==a&&(se.globalAlpha=ce),this.drawChristmasLights(i,v+1,a,t)}drawChristmasLights(e,t,r,i){if(!L||!e||t<2||r<=0)return;let a=C.context,o=nt.getTexture(n.IMG_XMAS_LIGHTS);if(!o||!o.image)return;let s=o.rects||[],c=o.image;if(s.length===0)return;let l=A.BUNGEE_REST_LEN*1.5,u=0,d=[0];for(let n=1;n<t;n++){let t=e[n],r=e[n-1];if(!t||!r){d.push(u);continue}let i=t.x-r.x,a=t.y-r.y,o=Math.sqrt(i*i+a*a);u+=o,d.push(u)}if(!a)return;let f=a.globalAlpha;r<1&&(a.globalAlpha=r),this.lightRandomSeed||=Math.floor(Math.random()*1e3);let p=i*this.BUNGEE_REST_LEN,m=l/2;for(;m<u;){for(let n=1;n<t;n++){let t=e[n],r=e[n-1],i=d[n],o=d[n-1];if(!(!t||!r||i===void 0||o===void 0)&&m<=i){let e=i-o||1,n=(m-o)/e,u=r.x+(t.x-r.x)*n,d=r.y+(t.y-r.y)*n,f=m+p,h=Math.round(f/l),g=s[(this.lightRandomSeed+h)%s.length];g&&a.drawImage(c,g.x,g.y,g.w,g.h,u-g.w/2,d-g.h/2,g.w,g.h);break}}m+=l}r<1&&(a.globalAlpha=f)}},K=class extends j{addAnimationDelay(e,t,n,r){let i=this.timelines.length;return this.addAnimationEndpoints(i,e,t,n,r),i}addAnimationWithDelay(e,t,n,r){let i=this.timelines.length;this.addAnimationSequence(i,e,t,n,r)}addAnimationSequence(e,t,n,r,i,a){this.addAnimation(e,t,n,r,i[0]??0,P.UNDEFINED,i,a)}addAnimationEndpoints(e,t,n,r,i,a,o){let s=i-r+1;this.addAnimation(e,t,n,s,r,i,a,o)}addAnimation(e,t,n,r,i,a,s,c){let l=new o,u=[Ne.create(this,b.SET_DRAWQUAD,i,0)];l.addKeyFrame(D.makeAction(u,0)),c=c===void 0?this.resId:c;let d=i;for(let e=1;e<r;e++)s?d=s[e]??d:d++,u=[Ne.create(this,b.SET_DRAWQUAD,d,0)],l.addKeyFrame(D.makeAction(u,t)),e==r-1&&n===o.LoopType.REPLAY&&l.addKeyFrame(D.makeAction(u,t));n&&(l.loopType=n),this.addTimelineWithID(l,e),c!==void 0&&(l.resourceId=c)}setDelay(e,t,n){let r=this.getTimeline(n);if(!r)return;let i=r.getTrack(te.ACTION);if(!i)return;let a=i.keyFrames[t];a&&(a.timeOffset=e)}setPause(e,t){this.setAction(b.PAUSE_TIMELINE,this,0,0,e,t)}setAction(e,t,n,r,i,a){let o=this.getTimeline(a);if(!o)return;let s=o.getTrack(te.ACTION);if(!s)return;let c=s.keyFrames[i];if(!c)return;let l=Ne.create(t,e,n,r);c.value.actionSet.push(l)}switchToAnimation(e,t,n){let r=this.getTimeline(t);if(!r)return;let i=[Ne.create(this,b.PLAY_TIMELINE,0,e)],a=D.makeAction(i,n);r.addKeyFrame(a)}jumpTo(e){let t=this.currentTimeline;t&&t.jumpToTrack(te.ACTION,e)}},q=class extends K{bb;rbb;mover;rotatedBB;topLeftCalculated;interpolationAlpha;constructor(){super(),this.isDrawBB=!1,this.rotatedBB=!1,this.topLeftCalculated=!1,this.interpolationAlpha=1}initTexture(e){super.initTexture(e),this.bb=new w(0,0,this.width,this.height),this.rbb=new wt(this.bb.x,this.bb.y,this.bb.w,this.bb.h),this.anchor=S.CENTER,this.rotatedBB=!1,this.topLeftCalculated=!1}setBBFromFirstQuad(){let e=this.texture.offsets[0],t=this.texture.rects[0];!e||!t||(this.bb=new w(Math.round(e.x),Math.round(e.y),t.w,t.h),this.rbb=new wt(this.bb.x,this.bb.y,this.bb.w,this.bb.h))}parseMover(e){this.rotation=e.angle||0;let t=e.path;if(typeof t==`string`){let n=G.MAX_CAPACITY;if(t[0]===`R`){let e=parseInt(t.slice(2),10);n=Math.round(e/2+1)}let r=new G(n,e.moveSpeed??0,e.rotateSpeed??0);r.angle=this.rotation,r.setPathFromString(t,new O(this.x,this.y)),this.setMover(r),r.start()}}setMover(e){this.mover=e,this.drawPosIncrement=1e-4}update(e){super.update(e),this.topLeftCalculated||=(this.calculateTopLeft(),!0),this.mover&&(this.mover.update(e),this.x=this.mover.pos.x,this.y=this.mover.pos.y,this.rotatedBB?this.rotateWithBB(this.mover.angle):this.rotation=this.mover.angle)}draw(){if(this.mover&&this.interpolationAlpha<1){let e=this.x,t=this.y,n=this.rotation,r=this.mover.getInterpolated(this.interpolationAlpha);this.x=r.x,this.y=r.y,this.rotation=r.angle,super.draw(),this.x=e,this.y=t,this.rotation=n}else super.draw()}rotateWithBB(e){this.rotatedBB||=!0,this.rotation=e;let t=this.bb;if(!t)return;let n=new O(t.x,t.y),r=new O(t.x+t.w,t.y),i=new O(r.x,t.y+t.h),a=new O(t.x,i.y),o=z.fromDegrees(e),s=this.width/2+this.rotationCenterX,c=this.height/2+this.rotationCenterY;n.rotateAround(o,s,c),r.rotateAround(o,s,c),i.rotateAround(o,s,c),a.rotateAround(o,s,c);let l=this.rbb;l&&(l.tlX=n.x,l.tlY=n.y,l.trX=r.x,l.trY=r.y,l.brX=i.x,l.brY=i.y,l.blX=a.x,l.blY=a.y)}drawBB(){let e=C.context,t=this.drawX,n=this.drawY,r=this.bb,i=this.rbb;!e||!r||(e.strokeStyle=`red`,e.lineWidth=2,this.rotatedBB?(e.beginPath(),i&&(e.moveTo(t+i.tlX,n+i.tlY),e.lineTo(t+i.trX,n+i.trY),e.lineTo(t+i.brX,n+i.brY),e.lineTo(t+i.blX,n+i.blY),e.stroke(),e.closePath())):e.strokeRect(t+r.x,n+r.y,r.w,r.h))}pointInObject(e,t){let n=this.bb;if(!n)return!1;let r=this.drawX+n.x,i=this.drawY+n.y;return w.pointInRect(e,t,r,i,n.w,n.h)}rectInObject(e,t,n,r){if(!this.bb)return;let i=this.drawX+this.bb.x,a=this.drawY+this.bb.y;return w.rectInRect(e,t,n,r,i,a,i+this.bb.w,a+this.bb.h)}static intersect(e,t){if(!e.bb||!t.bb)return;let n=e.drawX+e.bb.x,r=e.drawY+e.bb.y,i=t.drawX+t.bb.x,a=t.drawY+t.bb.y;return w.rectInRect(n,r,n+e.bb.w,r+e.bb.h,i,a,i+t.bb.w,a+t.bb.h)}},Mr=class extends G{setPathAndStart(e,t,n){let r=A.MOVER_SCALE;if(e[0]===`R`){let i=parseInt(e.slice(2),10),a=Math.round(i*3/2),o=2*Math.PI/a,s=0,c=e[1]===`C`;i*=r,c||(o=-o);for(let e=0;e<a;e++){let e=t+i*Math.cos(s),r=n+i*Math.sin(s);this.addPathPoint(new O(e,r)),s+=o}}else{this.addPathPoint(new O(t,n));let i=e;i[i.length-1]===`,`&&(i=i.slice(0,i.length-1));let a=i.split(`,`),o=a.length;for(let e=0;e<o;e+=2){let i=parseFloat(a[e]),o=parseFloat(a[e+1]);this.addPathPoint(new O(t+i*r,n+o*r))}}}},Nr=class extends q{parseMover(e){this.rotation=e.angle||0;let t=e.path,n=A.MOVER_SCALE;if(typeof t==`string`){let r=G.MAX_CAPACITY;if(t[0]===`R`){let e=parseInt(t.slice(2),10);r=Math.round(e*3/2+1)}let i=e.moveSpeed??0,a=e.rotateSpeed,o=new Mr(r,i*n,a);o.angle=this.rotation,o.setPathAndStart(t,this.x,this.y),this.setMover(o),o.start()}}},J=class e{static loadedMap=null;static pack=0;static level=0;static survival=!1;static loadLevel(t,n){e.pack=t-1,e.level=n-1;let r=E.boxes[e.pack];if(!r)throw Error(`Box not found for pack index ${e.pack}`);e.loadedMap=r.levels[e.level]??null}},Pr=class extends j{tiles;offsets;align;initTexture(e){super.initTexture(e),this.tiles=[0,0,0],this.offsets=[0,0,0],this.align=S.CENTER}setTileHorizontally(e,t,n){if(!this.tiles||this.tiles.length===0)return;this.tiles[0]=e,this.tiles[1]=t,this.tiles[2]=n;let r=this.texture.rects[e],i=this.texture.rects[t],a=this.texture.rects[n];if(!r||!i||!a)return;let o=r.h,s=i.h,c=a.h;o>=s&&o>=c?this.height=o:s>=o&&s>=c?this.height=s:this.height=c,!(!this.offsets||this.offsets.length===0)&&(this.offsets[0]=Math.trunc((this.height-o)/2),this.offsets[1]=Math.trunc((this.height-s)/2),this.offsets[2]=Math.trunc((this.height-c)/2))}draw(){if(this.preDraw(),!this.tiles||this.tiles.length===0)return;let e=this.tiles[0],t=this.tiles[1],n=this.tiles[2];if(e===void 0||t===void 0||n===void 0)return;let r=this.texture.rects[e],i=this.texture.rects[t],a=this.texture.rects[n];if(!r||!i||!a)return;let o=this.width-(Math.trunc(r.w)+Math.trunc(a.w)),s=C.context,c=Math.round(this.drawX),l=Math.round(this.drawY),u=Math.ceil(r.w),d=Math.ceil(r.h),f=Math.ceil(a.w),p=Math.ceil(a.h);if(!s||!this.offsets||this.offsets.length===0)return;let m=this.texture.image;if(!m)return;let h=this.offsets[0],g=this.offsets[1],_=this.offsets[2];if(!(h===void 0||g===void 0||_===void 0)){if(o>=0)s.drawImage(m,r.x,r.y,u,d,c,l+h,u,d),this.drawTiled(t,c+u,l+g,o,i.h),s.drawImage(m,a.x,a.y,f,p,c+u+o,l+_,f,p);else{let e={...r},t={...a};e.w=Math.min(e.w,this.width/2),t.w=Math.min(t.w,this.width-e.w),t.x+=a.w-t.w,s.drawImage(m,e.x,e.y,e.w,e.h,c,l+h,e.w,e.h),s.drawImage(m,t.x,t.y,t.w,t.h,c+e.w,l+_,t.w,t.h)}this.postDraw()}}getImage(){let e=C.element;C.setTarget(document.createElement(`canvas`));let t=C.element,n=Math.ceil(this.width),r=Math.ceil(this.height);if(!t)return;t.width=n,t.height=r,this.draw();let i=t.toDataURL(`image/png`),a=new Image;return a.src=i,a.width=n,a.height=r,e&&C.setTarget(e),a}},Fr=0,Ir=1,Lr=2,Rr=class extends j{constructor(e){super();let t=new Pr;t.initTextureWithId(n.IMG_OBJ_HOOK_MOVABLE),t.setTileHorizontally(Fr,Lr,Ir),t.width=e+A.GRAB_MOVE_BG_WIDTH;let r=t.getImage(),i=Math.ceil(t.width),a=Math.ceil(t.height),o=r?{drawable:r,width:i,height:a}:null;this.initTexture(new Nt(o))}},zr={START:0,WALK:1,BUSTER:2,CATCH:3},Br=0,Vr=6,Hr=7,Ur=10,Wr=0,Gr=1,Kr=0,qr=1,Jr=0,Yr=1,Xr=2,Zr=3,Qr=3,$r=4,ei=0,ti=1,ni=2,ri=3,ii=4,ai=10,oi=0,si=1,ci=2,li=3,ui=4,di=0,fi=1,pi=2,mi=4,hi={},gi=(A.BUNGEE_REST_LEN*4)**2,Y=class e extends Nr{static GunCup={SHOW:0,HIDE:1,DROP_AND_HIDE:2};static GunQuads={BACK:ei,ARROW:ti,FRONT:ni,FRONT_FIRED:ri};static StickerQuads={STAIN:oi,KICKED_BACK:si,KICKED_FRONT:ci,IDLE_BACK:li,IDLE_FRONT:ui};static KICK_MOVE_LENGTH=10;static KICK_CUT_RADIUS=15;static GUN_CUT_RADIUS=15;static KICK_TAP_RADIUS=70;static GUN_TAP_RADIUS=75;static STICK_DELAY=.05;static MAX_STAINS=10;rope;gun;gunFired;invisible;kicked;kickActive;wheel;wheelOperating;lastWheelTouch;moveLength;moveVertical;moveOffset;moveBackground;grabMoverHighlight;grabMover;moverDragging;minMoveValue;maxMoveValue;hasSpider;spiderActive;spider;spiderPos;shouldActivate;wheelDirty;launcher;launcherSpeed;launcherIncreaseSpeed;hideRadius;radiusAlpha;radius;previousRadius;balloon;bee;wheelImage;wheelImage2;wheelImage3;wheelHighlight;back;front;gunBack;gunArrow;gunFront;gunCup;gunInitialRotation;gunCandyInitialRotation;stickTimer;stainCounter;kickable;constructor(){super(),this.rope=null,this.gun=!1,this.gunFired=!1,this.invisible=!1,this.kicked=!1,this.kickActive=!1,this.wheel=!1,this.wheelOperating=P.UNDEFINED,this.lastWheelTouch=O.newZero(),this.moveLength=0,this.moveVertical=!1,this.moveOffset=0,this.moveBackground=null,this.grabMoverHighlight=null,this.grabMover=null,this.moverDragging=0,this.minMoveValue=0,this.maxMoveValue=0,this.hasSpider=!1,this.spiderActive=!1,this.spider=null,this.spiderPos=0,this.shouldActivate=!1,this.wheelDirty=!1,this.launcher=!1,this.launcherSpeed=0,this.launcherIncreaseSpeed=!1,this.hideRadius=!1,this.radiusAlpha=0,this.radius=0,this.previousRadius=void 0,this.balloon=!1,this.bee=null,this.back=null,this.front=null,this.gunBack=null,this.gunArrow=null,this.gunFront=null,this.gunCup=null,this.gunInitialRotation=0,this.gunCandyInitialRotation=0,this.stickTimer=P.UNDEFINED,this.stainCounter=0}getRotateAngle(e,t,n){let r=O.subtract(e,n),i=O.subtract(t,n).normalizedAngle()-r.normalizedAngle();return z.toDegrees(i)}handleWheelTouch(e,t){this.lastWheelTouch.x=e,this.lastWheelTouch.y=t}handleWheelRotate(e){U.playSound(n.SND_WHEEL);let t=new O(this.x,this.y),r=this.getRotateAngle(this.lastWheelTouch,e,t);r>180?r-=360:r<-180&&(r+=360),!(!this.wheelImage2||!this.wheelImage3||!this.wheelHighlight)&&(this.wheelImage2.rotation+=r,this.wheelImage3.rotation+=r,this.wheelHighlight.rotation+=r,r=r>0?Math.min(Math.max(1,r),A.GRAB_WHEEL_MAX_ROTATION):Math.max(Math.min(-1,r),-A.GRAB_WHEEL_MAX_ROTATION),this.rope&&(r>0?this.rope.getLength()<A.GRAB_ROPE_ROLL_MAX_LENGTH&&this.rope.roll(r,null):r!==0&&this.rope.parts.length>3&&this.rope.rollBack(-r),this.wheelDirty=!0),this.lastWheelTouch.copyFrom(e))}update(e){if(super.update(e),this.launcher&&this.rope){let t=this.rope.bungeeAnchor,n;t.pos.x=this.x,t.pos.y=this.y,t.pin.copyFrom(t.pos),this.launcherIncreaseSpeed?(n=G.moveToTargetWithStatus(this.launcherSpeed,200,30,e),this.launcherSpeed=n.value,n.reachedZero&&(this.launcherIncreaseSpeed=!1)):(n=G.moveToTargetWithStatus(this.launcherSpeed,130,30,e),this.launcherSpeed=n.value,n.reachedZero&&(this.launcherIncreaseSpeed=!0)),this.mover&&this.mover.setMoveSpeed(this.launcherSpeed)}if(this.hideRadius&&(this.radiusAlpha-=1.5*e,this.radiusAlpha<=0&&(this.radius=P.UNDEFINED,this.hideRadius=!1)),this.bee&&this.mover){let t=this.mover.path[this.mover.targetPoint],n=this.mover.pos,r=0;if(t){let e=O.subtract(t,n);Math.abs(e.x)>15&&(r=e.x>0?10:-10)}this.bee.rotation=G.moveToTarget(this.bee.rotation,r,60,e)}if(this.wheel&&this.wheelDirty&&this.rope&&this.wheelImage2){let e=this.rope.getLength()*.7;if(e===0)this.wheelImage2.scaleX=this.wheelImage2.scaleY=0;else{let t=Math.max(0,Math.min(1.2,1-e/A.GRAB_WHEEL_SCALE_DIVISOR));this.wheelImage2.scaleX=t,this.wheelImage2.scaleY=t}}}updateSpider(e){if(this.spider&&this.hasSpider&&this.shouldActivate&&(this.shouldActivate=!1,this.spiderActive=!0,U.playSound(n.SND_SPIDER_ACTIVATE),this.spider.playTimeline(zr.START)),this.spider&&this.hasSpider&&this.spiderActive){this.spider.currentTimelineIndex!==zr.START&&(this.spiderPos+=e*A.SPIDER_SPEED);let t=0,n=!1;if(this.rope){let e=this.rope.drawPts,r=2*A.BUNGEE_REST_LEN/3;for(let i=0,a=e.length;i<a;i++){let o=e[i],s=e[i+1];if(!o||!s)continue;let c=o.distance(s),l=r>c?r:c;if(this.spiderPos>=t&&(this.spiderPos<t+l||i>a-3)){let e=this.spiderPos-t,r=O.subtract(s,o);r.multiply(e/l),this.spider.x=o.x+r.x,this.spider.y=o.y+r.y,i>a-3&&(n=!0),this.spider.currentTimelineIndex!==zr.START&&(this.spider.rotation=r.normalizedAngle()*57.29577951308232+270);break}else t+=l}}n&&(this.spiderPos=P.UNDEFINED)}}drawWithMoverInterpolation(e){if(this.mover&&this.interpolationAlpha<1){let t=this.x,n=this.y,r=this.rotation,i=this.mover.getInterpolated(this.interpolationAlpha);this.x=i.x,this.y=i.y,this.rotation=i.angle,e(),this.x=t,this.y=n,this.rotation=r}else e()}drawBack(){if(!this.invisible){if(this.kickable&&this.kicked&&this.rope){let e=this.rope.bungeeAnchor,t=yr(e.prevPos,e.pos,this.interpolationAlpha,gi);this.x=t.x*.8+this.x*.2,this.y=t.y*.8+this.y*.2}if(this.gun){this.drawWithMoverInterpolation(()=>{this.preDraw()});return}this.drawWithMoverInterpolation(()=>{if(this.preDraw(),this.moveLength>0?this.moveBackground?.draw():this.back?.draw(),this.radius!==P.UNDEFINED||this.hideRadius){let e=new k(.2,.5,.9,this.radiusAlpha),t=this.radius===P.UNDEFINED?this.previousRadius:this.radius;this.drawGrabCircle(this.x,this.y,t,e)}})}}drawGrabCircle(e,t,n,r){if(!n||n<0)return;let i=`${n.toString()}|${r.rgbaStyle()}`,a;if(hi[i])a=hi[i];else{a=document.createElement(`canvas`),a.width=a.height=n*2+4;let e=a.getContext(`2d`),t=2*Math.PI,o=n/(A.CANVAS_SCALE*2),s=Math.max(16,Math.round(o));s%2!=0&&s++,e&&(e.lineWidth=2,e.strokeStyle=r.rgbaStyle());let c=t/s;for(let r=0;r<s;r++)if(r%2==0){let i=r/s*t;e&&(e.beginPath(),e.arc(n+2,n+2,n,i,i+c,!1),e.stroke(),e.closePath())}hi[i]=a}let o=C.context;o&&o.drawImage(a,e-n-2,t-n-2)}drawBB(){this.wheel&&this.drawGrabCircle(this.x,this.y,A.GRAB_WHEEL_RADIUS,k.red)}draw(){if(!this.invisible){if(this.kickable&&this.kicked&&this.rope){let e=this.rope.bungeeAnchor,t=yr(e.prevPos,e.pos,this.interpolationAlpha,gi);this.x=t.x,this.y=t.y}this.drawWithMoverInterpolation(()=>{let e=this.rope;this.wheel&&this.wheelHighlight&&this.wheelImage3&&this.wheelImage&&(this.wheelHighlight.visible=this.wheelOperating!==P.UNDEFINED,this.wheelImage3.visible=this.wheelOperating===P.UNDEFINED,this.wheelImage.draw()),this.gun&&(this.gunBack?.draw(),this.gunFired||this.gunArrow?.draw()),e&&e.draw(),this.gunFront?.draw(),this.moveLength<=0?this.front?.draw():this.moverDragging==P.UNDEFINED?this.grabMover?.draw():this.grabMoverHighlight?.draw(),this.wheel&&this.wheelImage2?.draw(),this.postDraw()})}}drawSpider(){this.spider?.draw()}drawGunCup(){this.gunFired&&this.gunCup?.draw()}setRope(e){this.rope=e,this.previousRadius=this.radius,this.radius=P.UNDEFINED,this.hasSpider&&(this.shouldActivate=!0)}setLauncher(){this.launcher=!0,this.launcherIncreaseSpeed=!0,this.launcherSpeed=130;let e=new G(100,this.launcherSpeed,0);e.setPathFromString(`RC30`,new O(this.x,this.y)),this.setMover(e),e.start()}setRadius(t){if(this.previousRadius=this.radius,this.radius=t,this.gun){this.gunBack=j.create(n.IMG_OBJ_GUN,e.GunQuads.BACK),this.gunBack.doRestoreCutTransparency(),this.gunBack.anchor=this.gunBack.parentAnchor=S.CENTER,this.addChild(this.gunBack),this.gunBack.visible=!1,this.gunArrow=j.create(n.IMG_OBJ_GUN,e.GunQuads.ARROW),this.gunArrow.doRestoreCutTransparency(),this.gunArrow.anchor=this.gunArrow.parentAnchor=S.CENTER,this.addChild(this.gunArrow),this.gunArrow.visible=!1,this.gunFront=j.create(n.IMG_OBJ_GUN,e.GunQuads.FRONT),this.gunFront.doRestoreCutTransparency(),this.gunFront.anchor=this.gunFront.parentAnchor=S.CENTER,this.addChild(this.gunFront),this.gunFront.visible=!1,this.gunCup=new K,this.gunCup.initTextureWithId(n.IMG_OBJ_GUN),this.gunCup.doRestoreCutTransparency(),this.gunCup.addAnimationEndpoints(e.GunCup.SHOW,.1,o.LoopType.NO_LOOP,ii,ai),this.gunCup.anchor=S.CENTER,this.addChild(this.gunCup),this.gunCup.visible=!1;let t=new o;t.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,0)),t.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,1)),this.gunCup.addTimelineWithID(t,e.GunCup.HIDE);let r=new o;r.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,0)),r.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,1)),r.addKeyFrame(D.makePos(0,0,D.TransitionType.LINEAR,0)),r.addKeyFrame(D.makePos(0,50,D.TransitionType.EASE_IN,1)),this.gunCup.addTimelineWithID(r,e.GunCup.DROP_AND_HIDE);let i=r.getTrack(te.POSITION);i&&(i.relative=!0);return}if(this.kickable)this.stainCounter=e.MAX_STAINS,this.back=j.create(n.IMG_OBJ_STICKER,e.StickerQuads.IDLE_BACK),this.back.doRestoreCutTransparency(),this.back.anchor=this.back.parentAnchor=S.CENTER,this.front=j.create(n.IMG_OBJ_STICKER,e.StickerQuads.IDLE_FRONT),this.front.doRestoreCutTransparency(),this.front.anchor=this.front.parentAnchor=S.CENTER,this.addChild(this.back),this.addChild(this.front),this.back.visible=!1,this.front.visible=!1,this.bb=new w(-this.back.width/2,-this.back.height/2,this.back.width,this.back.height),this.updateKickState();else if(t===P.UNDEFINED||t===P.CANDY2_FLAG){let e=I.randomRange(n.IMG_OBJ_HOOK_01,n.IMG_OBJ_HOOK_02);this.back=j.create(e,Kr),this.back.doRestoreCutTransparency(),this.back.anchor=this.back.parentAnchor=S.CENTER,this.front=j.create(e,qr),this.front.anchor=this.front.parentAnchor=S.CENTER,this.addChild(this.back),this.addChild(this.front),this.back.visible=!1,this.front.visible=!1}else this.back=j.create(n.IMG_OBJ_HOOK_AUTO,Wr),this.back.doRestoreCutTransparency(),this.back.anchor=this.back.parentAnchor=S.CENTER,this.front=j.create(n.IMG_OBJ_HOOK_AUTO,Gr),this.front.anchor=this.front.parentAnchor=S.CENTER,this.addChild(this.back),this.addChild(this.front),this.back.visible=!1,this.front.visible=!1,this.radiusAlpha=A.GRAB_RADIUS_ALPHA,this.hideRadius=!1;this.wheel&&(this.wheelImage=j.create(n.IMG_OBJ_HOOK_REGULATED,Jr),this.wheelImage.anchor=this.wheelImage.parentAnchor=S.CENTER,this.addChild(this.wheelImage),this.wheelImage.visible=!1,this.wheelImage2=j.create(n.IMG_OBJ_HOOK_REGULATED,Yr),this.wheelImage2.passTransformationsToChilds=!1,this.wheelHighlight=j.create(n.IMG_OBJ_HOOK_REGULATED,Xr),this.wheelHighlight.anchor=this.wheelHighlight.parentAnchor=S.CENTER,this.wheelImage2.addChild(this.wheelHighlight),this.wheelImage3=j.create(n.IMG_OBJ_HOOK_REGULATED,Zr),this.wheelImage3.anchor=this.wheelImage3.parentAnchor=this.wheelImage2.anchor=this.wheelImage2.parentAnchor=S.CENTER,this.wheelImage2.addChild(this.wheelImage3),this.addChild(this.wheelImage2),this.wheelImage2.visible=!1,this.wheelDirty=!1)}setMoveLength(e,t,r){this.moveLength=e,this.moveVertical=t,this.moveOffset=r,this.moveLength>0&&(this.moveBackground=new Rr(e),this.moveBackground.rotationCenterX=-Math.round(this.moveBackground.width/2)+A.GRAB_MOVE_BG_X_OFFSET,this.moveBackground.x=-A.GRAB_MOVE_BG_X_OFFSET,this.grabMoverHighlight=j.create(n.IMG_OBJ_HOOK_MOVABLE,Qr),this.grabMoverHighlight.visible=!1,this.grabMoverHighlight.anchor=this.grabMoverHighlight.parentAnchor=S.CENTER,this.addChild(this.grabMoverHighlight),this.grabMover=j.create(n.IMG_OBJ_HOOK_MOVABLE,$r),this.grabMover.visible=!1,this.grabMover.anchor=this.grabMover.parentAnchor=S.CENTER,this.addChild(this.grabMover),this.grabMover.addChild(this.moveBackground),this.moveVertical?(this.moveBackground.rotation=90,this.moveBackground.y=-this.moveOffset,this.minMoveValue=this.y-this.moveOffset,this.maxMoveValue=this.y+(this.moveLength-this.moveOffset),this.grabMover.rotation=90,this.grabMoverHighlight.rotation=90):(this.minMoveValue=this.x-this.moveOffset,this.maxMoveValue=this.x+(this.moveLength-this.moveOffset),this.moveBackground.x+=-this.moveOffset),this.moveBackground.anchor=S.VCENTER|S.LEFT,this.moveBackground.x+=this.x,this.moveBackground.y+=this.y,this.moveBackground.visible=!1),this.moverDragging=P.UNDEFINED,this.moveLength>=0&&(this.kickable=!1)}setBee(){this.bee=j.create(n.IMG_OBJ_BEE_HD,fi),this.bee.doRestoreCutTransparency(),this.bee.parentAnchor=S.CENTER;let e=new K;e.initTextureWithId(n.IMG_OBJ_BEE_HD),e.parentAnchor=e.anchor=S.TOP|S.LEFT,e.doRestoreCutTransparency(),e.addAnimationDelay(.03,o.LoopType.PING_PONG,pi,mi),e.playTimeline(0),e.jumpTo(I.randomRange(0,mi-pi)),this.bee.addChild(e);let t=this.bee.texture?.offsets[di];t&&(this.bee.x=-t.x,this.bee.y=-t.y,this.bee.rotationCenterX=t.x-this.bee.width/2,this.bee.rotationCenterY=t.y-this.bee.width/2),this.bee.scaleX=this.bee.scaleY=1/1.3,this.addChild(this.bee)}setSpider(e){this.hasSpider=e,this.shouldActivate=!1,this.spiderActive=!1,this.spider=new K,this.spider.initTextureWithId(n.IMG_OBJ_SPIDER),this.spider.doRestoreCutTransparency(),this.spider.anchor=S.CENTER,this.spider.x=this.x,this.spider.y=this.y,this.spider.visible=!1,this.spider.addAnimationEndpoints(zr.START,.05,o.LoopType.NO_LOOP,Br,Vr),this.spider.setDelay(.4,5,zr.START),this.spider.addAnimationEndpoints(zr.WALK,.1,o.LoopType.REPLAY,Hr,Ur),this.spider.switchToAnimation(zr.WALK,zr.START,.05),this.addChild(this.spider)}updateKickState(){this.kickable&&(this.kicked?(this.back?.setTextureQuad(e.StickerQuads.KICKED_BACK),this.front?.setTextureQuad(e.StickerQuads.KICKED_FRONT)):(this.back?.setTextureQuad(e.StickerQuads.IDLE_BACK),this.front?.setTextureQuad(e.StickerQuads.IDLE_FRONT)),this.rope&&(this.x=this.rope.bungeeAnchor.pos.x,this.y=this.rope.bungeeAnchor.pos.y))}destroyRope(){this.rope=null}},_i=100,vi=_i*_i,yi=(e,t)=>{let n=yr(e.prevPos,e.pos,t,vi);return{x:n.x,y:n.y}},bi=(e,t,n)=>e+((t-e+540)%360-180)*n,xi=function(e){let t=C.context;if(!t)return;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,A.CANVAS_WIDTH,A.CANVAS_HEIGHT);let n=e.updateable?Math.min(Math.max(e.gameController.frameBalance,0),1):1;e.preDraw();let r=e.camera.applyInterpolatedTransformation(n);e.bgTexture?.image&&t.drawImage(e.bgTexture.image,0,0,A.CANVAS_WIDTH,A.CANVAS_HEIGHT),e.back.updateWithCameraPos(r),e.back.draw(),e.miceManager&&e.miceManager.drawHoles();let i=Math.ceil(2*A.CANVAS_SCALE/.1875);if(e.mapHeight>A.CANVAS_HEIGHT){let n=e.overlayTexture;if(n){let e=n.offsets[0]?.y??0,r=n.rects[0];r&&n.image&&t.drawImage(n.image,r.x,r.y+i,r.w,r.h-i*2,0,e+i,r.w,r.h-i*2)}}for(let t=0,n=e.drawings.length;t<n;t++)e.drawings[t]?.draw();for(let t=0,n=e.earthAnims.length;t<n;t++)e.earthAnims[t]?.draw();e.pollenDrawer&&e.pollenDrawer.draw(),e.gravityButton&&e.gravityButton.draw(),e.support.draw(),e.target.draw(),e.sleepAnimPrimary?.visible&&e.sleepAnimPrimary.draw(),e.sleepAnimSecondary?.visible&&e.sleepAnimSecondary.draw();for(let t=0,n=e.tutorials.length;t<n;t++)e.tutorials[t]?.draw();for(let t=0,n=e.tutorialImages.length;t<n;t++){let n=e.tutorialImages[t];n&&n.special!==2&&n.draw()}for(let t=0,n=e.razors.length;t<n;t++)e.razors[t]?.draw();for(let t=0,n=e.rotatedCircles.length;t<n;t++)e.rotatedCircles[t]?.draw();for(let t=0,n=e.ghosts.length;t<n;t++)e.ghosts[t]?.draw();e.conveyors.interpolationAlpha=n,e.conveyors.draw();for(let t=0,r=e.bubbles.length;t<r;t++){let r=e.bubbles[t];r&&(r.interpolationAlpha=n,r.draw())}for(let t=0,r=e.pumps.length;t<r;t++){let r=e.pumps[t];r&&(r.interpolationAlpha=n,r.draw())}for(let t=0,r=e.spikes.length;t<r;t++){let r=e.spikes[t];r&&(r.interpolationAlpha=n,r.draw())}for(let t=0,r=e.bouncers.length;t<r;t++){let r=e.bouncers[t];r&&(r.interpolationAlpha=n,r.draw())}e.miceManager&&e.miceManager.drawMice();for(let t=0,r=e.socks.length;t<r;t++){let r=e.socks[t];r&&(r.interpolationAlpha=n,r.y-=25,r.draw(),r.y+=25)}for(let t=0,n=e.tubes.length;t<n;t++)e.tubes[t]?.drawBack();for(let t=0,r=e.lanterns.length;t<r;t++){let r=e.lanterns[t];r&&(r.interpolationAlpha=n,r.draw())}e.kickStainsPool.draw();let a=e.bungees;for(let e=0,t=a.length;e<t;e++){let t=a[e];t&&(t.interpolationAlpha=n,t.rope&&(t.rope.interpolationAlpha=n))}for(let e=0,t=a.length;e<t;e++){let t=a[e];t&&(t.drawBack(),t.draw())}let o=!e.noCandy&&!e.isCandyInLantern?yi(e.star,n):{x:e.star.pos.x,y:e.star.pos.y},s=bi(e.prevCandyRotation,e.candyMain.rotation,n);for(let e=0,t=a.length;e<t;e++){let t=a[e];if(t?.gun)if(!t.gunFired&&t.gunArrow){let e=O.subtract(new O(t.x,t.y),o);t.gunArrow.rotation=z.toDegrees(e.normalizedAngle())}else t.gunCup&&(t.gunCup.currentTimelineIndex!==Y.GunCup.DROP_AND_HIDE&&(t.gunCup.x=o.x,t.gunCup.y=o.y,t.gunCup.rotation=t.gunInitialRotation+s-t.gunCandyInitialRotation),t.drawGunCup())}for(let t=0,r=e.lightbulbs.length;t<r;t++){let r=e.lightbulbs[t];r&&(r.interpolationAlpha=n,r.drawLight())}for(let t=0,r=e.stars.length;t<r;t++){let r=e.stars[t];r&&(r.interpolationAlpha=n,r.draw())}if(!e.noCandy&&!e.targetSock){let t=e.candy.x,r=e.candy.y;if(!e.isCandyInLantern){let t=yi(e.star,n);e.candy.x=t.x,e.candy.y=t.y}e.candy.draw(),!e.isCandyInLantern&&e.candyBlink.currentTimeline!=null&&e.candyBlink.draw(),e.candy.x=t,e.candy.y=r}if(e.twoParts!==M.NONE){if(!e.noCandyL){let t=e.candyL.x,r=e.candyL.y,i=yi(e.starL,n);e.candyL.x=i.x,e.candyL.y=i.y,e.candyL.draw(),e.candyL.x=t,e.candyL.y=r}if(!e.noCandyR){let t=e.candyR.x,r=e.candyR.y,i=yi(e.starR,n);e.candyR.x=i.x,e.candyR.y=i.y,e.candyR.draw(),e.candyR.x=t,e.candyR.y=r}}for(let t=0,r=e.lightbulbs.length;t<r;t++){let r=e.lightbulbs[t];r&&(r.interpolationAlpha=n,r.drawBottleAndFirefly())}for(let t=0,n=e.tubes.length;t<n;t++)e.tubes[t]?.drawFront();for(let e=0,t=a.length;e<t;e++){let t=a[e];t?.hasSpider&&t.drawSpider()}e.aniPool.interpolationAlpha=n,e.aniPool.draw(),Si(e),e.camera.cancelInterpolatedTransformation(r),e.staticAniPool.draw();for(let t=0,n=e.tutorialImages.length;t<n;t++){let n=e.tutorialImages[t];n&&n.special===2&&n.draw()}e.postDraw()},Si=function(e){let t=A.CUT_MAX_SIZE;for(let n=0;n<P.MAX_TOUCHES;n++){let r=e.fingerCuts[n]??[];if(r.length>0){let e=1,n=[];for(let e of r)e&&(n.length===0&&n.push(e.start),n.push(e.end));let i=Math.max(n.length-1,0);if(i===0)continue;let a=[],o=i*2,s=1/o,c=0;for(;;){c>1&&(c=1);let e=O.calcPathBezier(n,c);if(a.push(e),c===1)break;c+=s}let l=t/o,u=[];for(let t=0,n=o-1;t<n;t++){let n=e,r=t===o-1?1:e+l,i=a[t],s=a[t+1],c=O.subtract(s,i);c.normalize();let d=O.rPerpendicular(c),f=O.perpendicular(c);{let e=O.add(i,O.multiply(d,n)),t=O.add(i,O.multiply(f,n));u.push(t),u.push(e)}let p=O.add(s,O.multiply(d,r)),m=O.add(s,O.multiply(f,r));u.push(m),u.push(p),e+=l}C.fillTriangleStrip(u,k.styles.SOLID_OPAQUE)}}},Ci=class{scene;constructor(e){this.scene=e}draw(){xi(this.scene)}};function wi(e,t){return t?e.ghosts.some(e=>e?.bubble===t):!1}function Ti(e,t){if(t)for(let n of e.ghosts)n?.bubble===t&&(n.cyclingEnabled=!0,n.resetToState(1))}function Ei(e,t){if(!t)return!1;let n=!1;for(let r of e.ghosts)r?.bubble===t&&(r.cyclingEnabled=!1,n=!0);return n}function Di(e,t,r,i,a){let o=A.BUBBLE_SIZE,s=o*2;return w.pointInRect(r.x,r.y,t.x-o,t.y-o,s,s)?(i&&e.popBubble(t.x,t.y),a.visible=!0,U.playSound(n.SND_BUBBLE),t.popped=!0,t.removeChildWithID(0),e.conveyors.remove(t),wi(e,t)&&Ei(e,t),e.attachCandy(),!0):!1}function Oi(e,t){e.twoParts===M.NONE?(Ti(e,e.candyBubble),e.candyBubble=null,e.candyBubbleAnimation.visible=!1,e.candyGhostBubbleAnimation&&(e.candyGhostBubbleAnimation.visible=!1),e.popBubble(e.candy.x,e.candy.y)):t?(Ti(e,e.candyBubbleL),e.candyBubbleL=null,e.candyBubbleAnimationL.visible=!1,e.candyGhostBubbleAnimationL&&(e.candyGhostBubbleAnimationL.visible=!1),e.popBubble(e.candyL.x,e.candyL.y)):(Ti(e,e.candyBubbleR),e.candyBubbleR=null,e.candyBubbleAnimationR.visible=!1,e.candyGhostBubbleAnimationR&&(e.candyGhostBubbleAnimationR.visible=!1),e.popBubble(e.candyR.x,e.candyR.y))}function ki(e,t,r){e.detachCandy(),U.playSound(n.SND_BUBBLE_BREAK),e.bubbleDisappear.x=t,e.bubbleDisappear.y=r,e.bubbleDisappear.playTimeline(0),e.aniPool.addChild(e.bubbleDisappear)}function Ai(e,t){let r=t.capturingBubble;r&&(Ti(e,r),t.capturingBubble=null,t.capturingGhostBubble=!1,r.capturedByBulb=!1,r.popped=!0,r.removeChildWithID(0),U.playSound(n.SND_BUBBLE_BREAK),e.bubbleDisappear.x=t.x,e.bubbleDisappear.y=t.y,e.bubbleDisappear.playTimeline(0),e.aniPool.addChild(e.bubbleDisappear))}function ji(e,t,n,r){return w.pointInRect(n+e.camera.pos.x,r+e.camera.pos.y,t.pos.x-A.BUBBLE_TOUCH_OFFSET,t.pos.y-A.BUBBLE_TOUCH_OFFSET,A.BUBBLE_TOUCH_SIZE,A.BUBBLE_TOUCH_SIZE)?(e.popCandyBubble(t===e.starL),!0):!1}function Mi(e,t,n,r){return t.capturingBubble&&w.pointInRect(n+e.camera.pos.x,r+e.camera.pos.y,t.constraint.pos.x-A.BUBBLE_TOUCH_OFFSET,t.constraint.pos.y-A.BUBBLE_TOUCH_OFFSET,A.BUBBLE_TOUCH_SIZE,A.BUBBLE_TOUCH_SIZE)?(Ai(e,t),!0):!1}var Ni=class{scene;constructor(e){this.scene=e}isBubbleCapture(e,t,n,r){return Di(this.scene,e,t,n,r)}popCandyBubble(e){Oi(this.scene,e)}popBubble(e,t){ki(this.scene,e,t)}popLightBulbBubble(e){Ai(this.scene,e)}handleBubbleTouch(e,t,n){return ji(this.scene,e,t,n)}handleLightBulbBubbleTouch(e,t,n){return Mi(this.scene,e,t,n)}};function Pi(e){let t=e.targetSock;if(!t)return;let n=t,r=n.light;r&&(r.playTimeline(0),r.visible=!0);let i=new O(0,A.SOCK_TELEPORT_Y);i.rotate(z.fromDegrees(n.rotation)),e.star.pos.x=n.x,e.star.pos.y=n.y,e.star.pos.add(i),e.star.prevPos.copyFrom(e.star.pos),e.star.v.x=0,e.star.v.y=-1,e.star.v.rotate(z.fromDegrees(n.rotation)),e.star.v.multiply(e.savedSockSpeed),e.star.posDelta.copyFrom(e.star.v),e.star.posDelta.divide(60),e.star.prevPos.copyFrom(e.star.pos),e.star.prevPos.subtract(e.star.posDelta),e.targetSock=null}var Fi=class{scene;constructor(e){this.scene=e}teleport(){Pi(this.scene)}};function Ii(e){e.restartState=ge.FADE_IN,e.dimTime=P.DIM_TIMEOUT}function Li(e){return e.restartState===ge.FADE_IN}function Ri(e){e.timeBonus=Math.max(0,30-e.time)*100,e.timeBonus/=10,e.timeBonus*=10,e.starBonus=1e3*e.starsCollected,e.score=Math.ceil(e.timeBonus+e.starBonus)}function zi(e){e.dd.cancelAllDispatches(),e.target.playTimeline(g.WIN),U.playSound(n.SND_MONSTER_CHEWING),e.candyBubble&&e.popCandyBubble(!1),e.noCandy=!0,e.miceManager&&(e.miceManager.activeMouse&&e.miceManager.activeMouse.beginRetreat(),e.miceManager.lockActiveMouse()),e.candy.passTransformationsToChilds=!0,e.candyMain.scaleX=1,e.candyMain.scaleY=1,e.candyTop.scaleX=1,e.candyTop.scaleY=1;let t=new o;t.addKeyFrame(D.makePos(e.candy.x,e.candy.y,D.TransitionType.LINEAR,0)),t.addKeyFrame(D.makePos(e.target.x,e.target.y+10,D.TransitionType.LINEAR,.1)),t.addKeyFrame(D.makeScale(.71,.71,D.TransitionType.LINEAR,0)),t.addKeyFrame(D.makeScale(0,0,D.TransitionType.LINEAR,.1)),t.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,0)),t.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.1)),e.candy.addTimelineWithID(t,0),e.candy.playTimeline(0),t.onFinished=e.aniPool.timelineFinishedDelegate(),e.aniPool.addChild(e.candy),e.calculateScore(),e.releaseAllRopes(!1),qt.showMenu&&e.dd.callObject(e,()=>{R.publish(R.ChannelId.LevelWon,{stars:e.starsCollected,time:e.time,score:e.score,fps:1/e.gameController.avgDelta})},null,1),e.dd.callObject(e,()=>{U.stopSound(n.SND_ELECTRIC)},null,1.5),e.dd.callObject(e,()=>{e.gameController.onLevelWon.call(e.gameController)},null,1.8)}function Bi(e){e.gameLostTriggered||(e.gameLostTriggered=!0,e.dd.cancelAllDispatches(),e.sleepAnimPrimary&&(e.sleepAnimPrimary.visible=!1,e.sleepAnimPrimary.getTimeline(0)?.stop()),e.sleepAnimSecondary&&(e.sleepAnimSecondary.visible=!1,e.sleepAnimSecondary.getTimeline(0)?.stop()),e.target.playTimeline(g.FAIL),U.playSound(n.SND_MONSTER_SAD),e.dd.callObject(e,()=>{e.gameController.onLevelLost.call(e.gameController),R.publish(R.ChannelId.LevelLost,{time:e.time})},null,1),e.miceManager&&(e.miceManager.activeMouse&&e.miceManager.activeMouse.beginRetreat(),e.miceManager.lockActiveMouse()))}var Vi=class{scene;constructor(e){this.scene=e}animateLevelRestart(){return Ii(this.scene)}isFadingIn(){return Li(this.scene)}calculateScore(){return Ri(this.scene)}gameWon(){return zi(this.scene)}gameLost(){return Bi(this.scene)}};function Hi(e,t){for(let n of e.bungees){let r=n.rope;r&&(r.tail===e.star||r.tail===e.starL&&t||r.tail===e.starR&&!t)&&(r.cut===P.UNDEFINED?(r.setCut(r.parts.length-2),e.detachCandy()):r.hideTailParts=!0,n.hasSpider&&n.spiderActive&&e.spiderBusted(n),n.gun&&n.gunCup?.color.equals(k.solidOpaque)&&n.gunCup.playTimeline(Y.GunCup.DROP_AND_HIDE))}}function Ui(e){e.attachCount+=1}function Wi(e){--e.attachCount,e.juggleTimer=0}var Gi=class{scene;constructor(e){this.scene=e}releaseAllRopes(e){Hi(this.scene,e)}attachCandy(){Ui(this.scene)}detachCandy(){Wi(this.scene)}},Ki=class{x;y;size;constructor(e,t,n){this.x=e,this.y=t,this.size=n}},qi=class{startPos;pos;prevPos;dir;radialAccel;tangentialAccel;color;deltaColor;size;life;deltaAngle;angle;prevAngle;width;height;constructor(){this.startPos=new O(0,0),this.pos=new O(0,0),this.prevPos=new O(0,0),this.dir=new O(0,0),this.radialAccel=0,this.tangentialAccel=0,this.color=new k(0,0,0,0),this.deltaColor=new k(0,0,0,0),this.size=0,this.life=0,this.deltaAngle=0,this.angle=0,this.prevAngle=0,this.width=0,this.height=0}},Ji=class extends T{totalParticles;particles;active;duration;elapsed;gravity;posVar;angle;angleVar;speed;speedVar;tangentialAccel;tangentialAccelVar;radialAccel;radialAccelVar;size;sizeVar;life;lifeVar;startColor;startColorVar;endColor;endColorVar;blendAdditive;colorModulate;emissionRate;emitCounter;texture;vertices;colors;particleIdx;interpolationAlpha=1;onFinished;constructor(e){super(),this.width=A.CANVAS_WIDTH,this.height=A.CANVAS_HEIGHT,this.totalParticles=e,this.particles=[],this.active=!1,this.duration=0,this.elapsed=0,this.gravity=new O(0,0),this.posVar=new O(0,0),this.angle=0,this.angleVar=0,this.speed=0,this.speedVar=0,this.tangentialAccel=0,this.tangentialAccelVar=0,this.radialAccel=0,this.radialAccelVar=0,this.size=0,this.sizeVar=0,this.life=0,this.lifeVar=0,this.startColor=new k(0,0,0,0),this.startColorVar=new k(0,0,0,0),this.endColor=new k(0,0,0,0),this.endColorVar=new k(0,0,0,0),this.blendAdditive=!1,this.colorModulate=!1,this.emissionRate=0,this.emitCounter=0,this.texture=null,this.vertices=[],this.colors=[],this.particleIdx=0,this.onFinished=null}addParticle(){if(this.particles.length==this.totalParticles)return!1;let e=new qi;return this.initParticle(e),this.particles.push(e),!0}initParticle(e){e.pos.x=this.x+this.posVar.x*I.randomMinus1to1(),e.pos.y=this.y+this.posVar.y*I.randomMinus1to1(),e.startPos.copyFrom(e.pos),e.prevPos.copyFrom(e.pos);let t=z.fromDegrees(this.angle+this.angleVar*I.randomMinus1to1()),n=new O(Math.cos(t),Math.sin(t)),r=this.speed+this.speedVar*I.randomMinus1to1();n.multiply(r),e.dir=n,e.radialAccel=this.radialAccel+this.radialAccelVar*I.randomMinus1to1(),e.tangentialAccel=this.tangentialAccel+this.tangentialAccelVar*I.randomMinus1to1(),e.life=this.life+this.lifeVar*I.randomMinus1to1();let i=new k(this.startColor.r+this.startColorVar.r*I.randomMinus1to1(),this.startColor.g+this.startColorVar.g*I.randomMinus1to1(),this.startColor.b+this.startColorVar.b*I.randomMinus1to1(),this.startColor.a+this.startColorVar.a*I.randomMinus1to1()),a=new k(this.endColor.r+this.endColorVar.r*I.randomMinus1to1(),this.endColor.g+this.endColorVar.g*I.randomMinus1to1(),this.endColor.b+this.endColorVar.b*I.randomMinus1to1(),this.endColor.a+this.endColorVar.a*I.randomMinus1to1());e.color=i,e.deltaColor.r=(a.r-i.r)/e.life,e.deltaColor.g=(a.g-i.g)/e.life,e.deltaColor.b=(a.b-i.b)/e.life,e.deltaColor.a=(a.a-i.a)/e.life,e.size=this.size+this.sizeVar*I.randomMinus1to1()}update(e){if(super.update(e),this.onFinished&&this.particles.length===0&&!this.active){this.onFinished(this);return}if(this.active&&this.emissionRate){let t=1/this.emissionRate;for(this.emitCounter+=e;this.particles.length<this.totalParticles&&this.emitCounter>t;)this.addParticle(),this.emitCounter-=t;this.elapsed+=e,this.duration!==-1&&this.duration<this.elapsed&&this.stopSystem()}for(this.particleIdx=0;this.particleIdx<this.particles.length;){let t=this.particles[this.particleIdx];if(!t)break;t.life>0?(t.prevPos.copyFrom(t.pos),t.prevAngle=t.angle,this.updateParticleLocation(t,e),t.color.r+=t.deltaColor.r*e,t.color.g+=t.deltaColor.g*e,t.color.b+=t.deltaColor.b*e,t.color.a+=t.deltaColor.a*e,t.life-=e,this.updateParticle(t,this.particleIdx,e),this.particleIdx++):this.removeParticle(this.particleIdx)}}updateParticleLocation(e,t){let n;e.pos.x||e.pos.y?(n=e.pos.copy(),n.normalize()):n=new O(0,0);let r=n.copy();n.multiply(e.radialAccel);let i=r.x;r.x=-r.y,r.y=i,r.multiply(e.tangentialAccel);let a=O.add(n,r);a.add(this.gravity),a.multiply(t),e.dir.add(a),a.copyFrom(e.dir),a.multiply(t),e.pos.add(a)}updateParticle(e,t,n){this.vertices[this.particleIdx]=new Ki(e.pos.x,e.pos.y,e.size),this.colors[this.particleIdx]=e.color}removeParticle(e){this.particles.splice(e,1)}startSystem(e){this.particles.length=0;for(let t=0;t<e;t++)this.addParticle();this.active=!0}stopSystem(){this.active=!1,this.elapsed=this.duration,this.emitCounter=0}resetSystem(){this.elapsed=0,this.emitCounter=0}draw(){if(this.preDraw(),this.color.a!==0){let e=C.context,t=this.texture?.image;if(!e||!t)return;for(let n=0,r=this.particleIdx;n<r;n++){let r=this.particles[n];r&&e.drawImage(t,Math.round(r.pos.x),Math.round(r.pos.y))}}this.postDraw()}isFull(){return this.particles.length===this.totalParticles}},Yi=class extends Ji{imageGrid;drawer;constructor(e,t){super(e),this.imageGrid=t,this.drawer=new ie(t),this.width=A.CANVAS_WIDTH,this.height=A.CANVAS_HEIGHT}initParticle(e){let t=this.imageGrid,n=I.randomRange(0,t.rects.length-1),r=t.rects[n];if(!r)return;let i=new w(0,0,0,0);this.drawer.setTextureQuad(this.particles.length,r,i,1),super.initParticle(e),e.width=r.w*e.size,e.height=r.h*e.size}updateParticle(e,t,n){this.drawer.vertices[t]=new w(e.pos.x-e.width/2,e.pos.y-e.height/2,e.width,e.height),this.drawer.alphas[t]=e.color.a,this.colors[t]=e.color}removeParticle(e){this.drawer.removeQuads(e),super.removeParticle(e)}draw(){if(this.preDraw(),this.interpolationAlpha<1){let e=this.interpolationAlpha;for(let t=0;t<this.particleIdx;t++){let n=this.particles[t],r=this.drawer.vertices[t];!n||!r||(r.x=vr(n.prevPos.x,n.pos.x,e)-n.width/2,r.y=vr(n.prevPos.y,n.pos.y,e)-n.height/2)}}this.drawer.draw(),this.postDraw()}},Xi=6,Zi=8,Qi=.9,$i=60,ea=class extends Yi{additive;constructor(e,t,n){super(e,t),this.duration=.6,this.angle=n,this.angleVar=10,this.speed=1e3,this.speedVar=100,this.life=.6,this.size=2,this.sizeVar=.5,this.emissionRate=100,this.startColor.r=1,this.startColor.g=1,this.startColor.b=1,this.startColor.a=.6,this.endColor.r=1,this.endColor.g=1,this.endColor.b=1,this.endColor.a=0,this.additive=!0}configureForFlowLength(e){if(this.life<=0)return;let t=Math.max(0,e),n=this.life*$i;if(n<=0)return;let r=1-Qi,i=Math.abs(r)<1e-4?n:Qi*(1-Qi**+n)/r;i<=0||(this.speed=t*$i/i)}initParticle(e){super.initParticle(e);let t=this.imageGrid,n=I.randomRange(Xi,Zi),r=t.rects[n];if(!r)return;let i=new w(0,0,0,0);this.drawer.setTextureQuad(this.particles.length,r,i,1),e.width=r.w*e.size,e.height=r.h*e.size}updateParticleLocation(e,t){let n=Qi**+(t*$i);e.dir.multiply(n);let r=O.multiply(e.dir,t);r.add(this.gravity),e.pos.add(r)}};function ta(e,t,n,r){let i=A.PUMP_POWER_RADIUS;if(i===void 0)return;let a=e.bb;if(!a||!(n.rectInObject(e.x-i,e.y-i,e.x+i,e.y+i)??!1))return;let o=new O(0,0),s=new O(0,0),c=new O(n.x,n.y);if(o.x=e.x-a.w/2,s.x=e.x+a.w/2,o.y=s.y=e.y,e.angle!==0&&c.rotateAround(-e.angle,e.x,e.y),!(c.y<o.y&&w.rectInRect(c.x-a.w/2,c.y-a.h/2,c.x+a.w/2,c.y+a.h/2,o.x,o.y-i,s.x,s.y)))return;let l=new O(0,-(i*2*(i-(o.y-c.y))/i));l.rotate(e.angle),t.applyImpulse(l,r)}function na(e,t,n){if(t.attachedSock!=null)return;let r=A.PUMP_POWER_RADIUS;if(r===void 0)return;let i=e.bb;if(!i)return;let a=t.worldBounds;if(!w.rectInRect(e.x-r,e.y-r,e.x+r,e.y+r,a.x,a.y,a.x+a.w,a.y+a.h))return;let o=new O(0,0),s=new O(0,0),c=new O(t.x,t.y);if(o.x=e.x-i.w/2,s.x=e.x+i.w/2,o.y=s.y=e.y,e.angle!==0&&c.rotateAround(-e.angle,e.x,e.y),!(c.y<o.y&&w.rectInRect(c.x-a.w/2,c.y-a.h/2,c.x+a.w/2,c.y+a.h/2,o.x,o.y-r,s.x,s.y)))return;let l=new O(0,-(r*2*(r-(o.y-c.y))/r));l.rotate(e.angle),t.constraint.applyImpulse(l,n)}function ra(e,t,r){t.playTimeline(0);let i=I.randomRange(n.SND_PUMP_1,n.SND_PUMP_4);U.playSound(i);let a=nt.getTexture(n.IMG_OBJ_PUMP);if(a){let n=Math.max(0,(A.PUMP_POWER_RADIUS??0)-A.PUMP_DIRT_OFFSET),r=new ea(5,a,z.toDegrees(t.angle)-90);r.configureForFlowLength(n),r.onFinished=e.aniPool.particlesFinishedDelegate();let i=new O(t.x+A.PUMP_DIRT_OFFSET,t.y);i.rotateAround(t.angle-Math.PI/2,t.x,t.y),r.x=i.x,r.y=i.y,r.startSystem(5),e.aniPool.addChild(r)}if(e.noCandy||e.handlePumpFlow(t,e.star,e.candy,r),e.twoParts!==M.NONE&&(e.noCandyL||e.handlePumpFlow(t,e.starL,e.candyL,r),e.noCandyR||e.handlePumpFlow(t,e.starR,e.candyR,r)),e.lightbulbs.length>0)for(let n of e.lightbulbs)n&&na(t,n,r);for(let n of e.bungees)n?.rope&&n.kickable&&n.kicked&&ta(t,n.rope.bungeeAnchor,n,r)}var ia=class{scene;constructor(e){this.scene=e}handlePumpFlow(e,t,n,r){ta(e,t,n,r)}operatePump(e,t){ra(this.scene,e,t)}};function aa(e,t,r){if(e.skip)return;let i=O.subtract(t.prevPos,t.pos),a=t.prevPos.copy(),o=e.angle,{x:s,y:c}=e;a.rotateAround(-o,s,c);let l=a.y<e.y?-1:1,u=i.getLength()*40,d=A.BOUNCER_MAX_MOVEMENT,f=(u>d?u:d)*l,p=O.forAngle(e.angle),m=O.perpendicular(p);m.multiply(f),t.pos.rotateAround(-o,s,c),t.prevPos.rotateAround(-o,s,c),t.prevPos.y=t.pos.y,t.pos.rotateAround(o,s,c),t.prevPos.rotateAround(o,s,c),t.applyImpulse(m,r),e.playTimeline(0),U.playSound(n.SND_BOUNCER)}var oa=class{scene;constructor(e){this.scene=e}handleBounce(e,t,n){aa(e,t,n)}};function sa(e,t,r,i,a){let o=0,s=A.GRAB_WHEEL_RADIUS,c=s*2,l=Y.GUN_CUT_RADIUS,u=l*2;for(let d of e.bungees){let f=d.rope;if(!f||f.cut!==P.UNDEFINED)continue;let p=f.parts;for(let m=0,h=p.length-1;m<h;m++){let h=p[m],g=p[m+1],_=!1;if(t){if(h.prevPos.x!==P.INT_MAX){let e=I.minOf4(h.pos.x,h.prevPos.x,g.pos.x,g.prevPos.x),n=I.minOf4(h.pos.y,h.prevPos.y,g.pos.y,g.prevPos.y),r=I.maxOf4(h.pos.x,h.prevPos.x,g.pos.x,g.prevPos.x),i=I.maxOf4(h.pos.y,h.prevPos.y,g.pos.y,g.prevPos.y);_=w.rectInRect(e,n,r,i,t.drawX,t.drawY,t.drawX+t.width,t.drawY+t.height)}}else _=d.wheel&&w.lineInRect(r.x,r.y,i.x,i.y,d.x-s,d.y-s,c,c)||d.gun&&w.lineInRect(r.x,r.y,i.x,i.y,d.x-l,d.y-l,u,u)?!1:I.lineInLine(r.x,r.y,i.x,i.y,h.pos.x,h.pos.y,g.pos.x,g.pos.y);if(_)return o++,d.hasSpider&&d.spiderActive&&e.spiderBusted(d),U.playSound(n.SND_ROPE_BLEAK_1+f.relaxed),f.setCut(m),e.detachCandy(),a&&(f.cutTime=0,f.removePart(m)),d.gun&&d.gunCup&&d.gunCup.playTimeline(Y.GunCup.HIDE),o}}return o}var ca=class{scene;constructor(e){this.scene=e}cut(e,t,n,r){return sa(this.scene,e,t,n,r)}};function la(e,t){U.playSound(n.SND_SPIDER_FALL),t.hasSpider=!1;let r=t.spider;if(!r)return;let i=j.create(n.IMG_OBJ_SPIDER,11);i.doRestoreCutTransparency();let a=new o;e.gravityButton&&!e.gravityNormal?(a.addKeyFrame(D.makePos(r.x,r.y,D.TransitionType.EASE_OUT,0)),a.addKeyFrame(D.makePos(r.x,r.y+50,D.TransitionType.EASE_OUT,.3)),a.addKeyFrame(D.makePos(r.x,r.y-A.CANVAS_HEIGHT,D.TransitionType.EASE_IN,1))):(a.addKeyFrame(D.makePos(r.x,r.y,D.TransitionType.EASE_OUT,0)),a.addKeyFrame(D.makePos(r.x,r.y-50,D.TransitionType.EASE_OUT,.3)),a.addKeyFrame(D.makePos(r.x,r.y+A.CANVAS_HEIGHT,D.TransitionType.EASE_IN,1))),a.addKeyFrame(D.makeRotation(0,0,0)),a.addKeyFrame(D.makeRotation(I.randomRange(-120,120),0,1)),i.addTimelineWithID(a,0),i.playTimeline(0),i.x=r.x,i.y=r.y,i.anchor=S.CENTER,a.onFinished=e.aniPool.timelineFinishedDelegate(),e.aniPool.addChild(i),t.spider=null}function ua(e,t,n){let r=t.rope;!r||r.tail!==e.star||(r.cut===P.UNDEFINED?(r.setCut(r.parts.length-2),e.detachCandy(),r.forceWhite=!1):t.destroyRope(),t.hasSpider&&t.spiderActive&&n!==t.spider&&e.spiderBusted(t),t.gun&&t.gunCup?.color.equals(k.solidOpaque)&&t.gunCup.playTimeline(Y.GunCup.DROP_AND_HIDE))}function da(e,t){U.playSound(n.SND_SPIDER_WIN);let r=t.spider;if(!r)return;for(let t of e.bungees)ua(e,t,r);t.hasSpider=!1,e.spiderTookCandy=!0,e.noCandy=!0;let i=j.create(n.IMG_OBJ_SPIDER,12);i.doRestoreCutTransparency(),e.candy.anchor=e.candy.parentAnchor=S.CENTER,e.candy.x=0,e.candy.y=-5,i.addChild(e.candy);let a=new o;e.gravityButton&&!e.gravityNormal?(a.addKeyFrame(D.makePos(r.x,r.y-10,D.TransitionType.EASE_OUT,0)),a.addKeyFrame(D.makePos(r.x,r.y+70,D.TransitionType.EASE_OUT,.3)),a.addKeyFrame(D.makePos(r.x,r.y-A.CANVAS_HEIGHT,D.TransitionType.EASE_IN,1))):(a.addKeyFrame(D.makePos(r.x,r.y-10,D.TransitionType.EASE_OUT,0)),a.addKeyFrame(D.makePos(r.x,r.y-70,D.TransitionType.EASE_OUT,.3)),a.addKeyFrame(D.makePos(r.x,r.y+A.CANVAS_HEIGHT,D.TransitionType.EASE_IN,1))),i.addTimelineWithID(a,0),i.playTimeline(0),i.x=r.x,i.y=r.y-10,i.anchor=S.CENTER,a.onFinished=e.aniPool.timelineFinishedDelegate(),e.aniPool.addChild(i),e.restartState!==ge.FADE_IN&&e.dd.callObject(e,e.gameLost,null,2)}var fa=class{scene;constructor(e){this.scene=e}spiderBusted(e){la(this.scene,e)}spiderWon(e){da(this.scene,e)}};function pa(e){for(let t of e.bungees){let e=t.rope;!e||e.cut!==P.UNDEFINED||(e.highlighted=!1)}}function ma(e,t,n,r){let i=A.CLICK_TO_CUT_SEARCH_RADIUS,a=null,o=i,s=new O(n,r);for(let n of e.bungees){let e=n.rope;if(e)for(let r of e.drawPts){let e=r.distance(s);e<i&&e<o&&(o=e,a=n,t.copyFrom(r))}}return a}function ha(e,t,n){let r=Number.MAX_VALUE,i=null,a=r,o=t.copy(),s=n.rope;if(!s||s.cut!==P.UNDEFINED)return null;let c=A.GRAB_WHEEL_RADIUS,l=c*2,u=s.parts;for(let e=0;e<u.length-1;e++){let r=u[e];if(!r)continue;let d=r.pos.distance(o);d>=a||(!n.wheel||w.pointInRect(r.pos.x,r.pos.y,n.x-c,n.y-c,l,l))&&(a=d,i=s,t.copyFrom(r.pos))}return i}var ga=class{scene;constructor(e){this.scene=e}resetBungeeHighlight(){pa(this.scene)}getNearestBungeeGrabByBezierPoints(e,t,n){return ma(this.scene,e,t,n)}getNearestBungeeSegmentByConstraints(e,t){return ha(this.scene,e,t)}},_a=class{context;plugins;constructor(e){this.context=e,this.plugins=[]}register(e){this.plugins.push(e);let t=e.createSystems?.(this.context);return Array.isArray(t)?t:[]}beforeUpdate(e,t){for(let n of this.plugins)n.onBeforeSystems?.(this.context,e,t)}afterSystem(e,t,n,r){for(let i of this.plugins)i.onAfterSystem?.(this.context,e,t,n,r)}afterUpdate(e,t){for(let n of this.plugins)n.onAfterSystems?.(this.context,e,t)}},va={updateBasics(e,t){e.updateBasics(t)}},ya=class{id=`physics`;context;dependencies;constructor(e,t=va){this.context=e,this.dependencies=t}update(e,t){return this.dependencies.updateBasics(this.context.physics,e),{continue:!0}}},ba={updateCamera(e,t){e.updateCamera(t)}},xa=class{id=`camera`;context;dependencies;constructor(e,t=ba){this.context=e,this.dependencies=t}update(e,t){return this.dependencies.updateCamera(this.context.animation,e),{continue:!0}}},Sa={updateBungees(e,t){return e.updateBungees(t)}},Ca=class{id=`bungees`;context;dependencies;constructor(e,t=Sa){this.context=e,this.dependencies=t}update(e,t){return t.numGrabs=this.dependencies.updateBungees(this.context.candy,e),{continue:!0}}},wa={updateCollectibles(e,t){e.updateCollectibles(t)}},Ta=class{id=`collectibles`;context;dependencies;constructor(e,t=wa){this.context=e,this.dependencies=t}update(e,t){return this.dependencies.updateCollectibles(this.context.candy,e),{continue:!0}}},Ea={updateHazards(e,t,n){return e.updateHazards(t,n)}},Da=class{id=`hazards`;context;dependencies;constructor(e,t=Ea){this.context=e,this.dependencies=t}update(e,t){let n=t.numGrabs??0;return this.dependencies.updateHazards(this.context.candy,e,n)?{continue:!0}:{continue:!1,reason:`game_lost`}}},Oa={updateTargetState(e,t){return e.updateTargetState(t)}},ka=class{id=`target`;context;dependencies;constructor(e,t=Oa){this.context=e,this.dependencies=t}update(e,t){let n=this.dependencies.updateTargetState(this.context.candy,e);return n.continue===!1?{continue:!1,reason:n.reason}:{continue:!0}}},Aa={updateSpecial(e,t){e.updateSpecial(t)}},ja=class{id=`special`;context;dependencies;constructor(e,t=Aa){this.context=e,this.dependencies=t}update(e,t){return this.dependencies.updateSpecial(this.context.candy,e),{continue:!0}}},Ma={updateClickToCut(e,t){e.updateClickToCut(t)}},Na=class{id=`interaction`;context;dependencies;constructor(e,t=Ma){this.context=e,this.dependencies=t}update(e,t){return this.dependencies.updateClickToCut(this.context.animation,e),{continue:!0}}};const Pa=e=>[new ya(e),new xa(e),new Ca(e),new Ta(e),new Da(e),new ka(e),new ja(e),new Na(e)];var Fa=class{id;key;loader;priority;constructor({id:e,key:t,loader:n=null,priority:r=1}){this.id=e,this.key=t,this.loader=n,this.priority=r}},X=e=>Object.freeze(new Fa(e)),Ia={MAP:X({id:0,key:`map`,loader:`loadMapSettings`,priority:0}),GAME_DESIGN:X({id:1,key:`gameDesign`,loader:`loadGameDesign`,priority:0}),TARGET:X({id:2,key:`target`,loader:`loadTarget`}),STAR:X({id:3,key:`star`,loader:`loadStar`}),TUTORIAL_TEXT:X({id:4,key:`tutorialText`,loader:`loadTutorialText`}),TUTORIAL_01:X({id:5,key:`tutorial01`,loader:`loadTutorialImage`}),TUTORIAL_02:X({id:6,key:`tutorial02`,loader:`loadTutorialImage`}),TUTORIAL_03:X({id:7,key:`tutorial03`,loader:`loadTutorialImage`}),TUTORIAL_04:X({id:8,key:`tutorial04`,loader:`loadTutorialImage`}),TUTORIAL_05:X({id:9,key:`tutorial05`,loader:`loadTutorialImage`}),TUTORIAL_06:X({id:10,key:`tutorial06`,loader:`loadTutorialImage`}),TUTORIAL_07:X({id:11,key:`tutorial07`,loader:`loadTutorialImage`}),TUTORIAL_08:X({id:12,key:`tutorial08`,loader:`loadTutorialImage`}),TUTORIAL_09:X({id:13,key:`tutorial09`,loader:`loadTutorialImage`}),TUTORIAL_10:X({id:14,key:`tutorial10`,loader:`loadTutorialImage`}),TUTORIAL_11:X({id:15,key:`tutorial11`,loader:`loadTutorialImage`}),TUTORIAL_12:X({id:16,key:`tutorial12`,loader:`loadTutorialImage`}),TUTORIAL_13:X({id:17,key:`tutorial13`,loader:`loadTutorialImage`}),TUTORIAL_14:X({id:18,key:`tutorial14`,loader:`loadTutorialImage`}),CANDY_L:X({id:50,key:`candyL`,loader:`loadCandyL`,priority:0}),CANDY_R:X({id:51,key:`candyR`,loader:`loadCandyR`,priority:0}),CANDY:X({id:52,key:`candy`,loader:`loadCandy`,priority:0}),GRAVITY_SWITCH:X({id:53,key:`gravitySwitch`,loader:`loadGravitySwitch`}),BUBBLE:X({id:54,key:`bubble`,loader:`loadBubble`}),PUMP:X({id:55,key:`pump`,loader:`loadPump`}),SOCK:X({id:56,key:`sock`,loader:`loadSock`}),SPIKE_1:X({id:57,key:`spike1`,loader:`loadSpike`}),SPIKE_2:X({id:58,key:`spike2`,loader:`loadSpike`}),SPIKE_3:X({id:59,key:`spike3`,loader:`loadSpike`}),SPIKE_4:X({id:60,key:`spike4`,loader:`loadSpike`}),SPIKES_SWITCH:X({id:61,key:`spikesSwitch`,loader:null}),ELECTRO:X({id:80,key:`electro`,loader:`loadSpike`}),BOUNCER1:X({id:81,key:`bouncer1`,loader:`loadBouncer`}),BOUNCER2:X({id:82,key:`bouncer2`,loader:`loadBouncer`}),GRAB:X({id:100,key:`grab`,loader:`loadGrab`}),HIDDEN_01:X({id:101,key:`hidden01`,loader:`loadHidden`}),HIDDEN_02:X({id:102,key:`hidden02`,loader:`loadHidden`}),HIDDEN_03:X({id:103,key:`hidden03`,loader:`loadHidden`}),ROTATED_CIRCLE:X({id:120,key:`rotatedCircle`,loader:`loadRotatedCircle`}),TARGET_2:X({id:121,key:`target2`,loader:`loadTarget`}),CANDY_2:X({id:122,key:`candy2`,loader:`loadCandy`}),GHOST:X({id:130,key:`ghost`,loader:`loadGhost`}),STEAM_TUBE:X({id:131,key:`steamTube`,loader:`loadSteamTube`}),LANTERN:X({id:132,key:`lantern`,loader:`loadLantern`,priority:2}),MOUSE:X({id:133,key:`mouse`,loader:`loadMouse`}),LIGHT_BULB:X({id:134,key:`lightBulb`,loader:`loadLightBulb`,priority:0}),CONVEYOR_BELT:X({id:135,key:`conveyorBelt`,loader:`loadConveyorBelt`})},La=Object.values(Ia),Ra=new Map(La.map(e=>[e.id,e])),za=new Map(La.map(e=>[e.key,e])),Ba=e=>Ra.get(e)??null,Va=e=>za.get(e)??null,Ha=e=>{let t=Va(e);return t?t.id:(alert(`Unknown map item: ${e}`),null)},Ua=Object.freeze({...Ia,fromName:Ha,getDefinitionById:Ba,getDefinitionByKey:Va}),Wa=class extends T{removeList;interpolationAlpha=1;constructor(){super(),this.removeList=[]}update(e){for(let e=0,t=this.removeList.length;e<t;e++){let t=this.removeList[e];t&&this.removeChild(t)}this.removeList.length=0,super.update(e)}draw(){for(let e of this.children)e instanceof Ji&&(e.interpolationAlpha=this.interpolationAlpha);super.draw()}timelineFinished(e){e.element&&e.element instanceof T&&this.removeList.push(e.element)}timelineFinishedDelegate(){return e=>{this.timelineFinished(e)}}particlesFinished(e){this.removeList.push(e)}particlesFinishedDelegate(){return e=>{this.particlesFinished(e)}}},Ga={NONE:0,ALL:1,EDGES:2},Ka=class{drawerIndex;quad;constructor(e,t){this.drawerIndex=e,this.quad=t}},qa=class e extends T{rows;columns;cameraViewWidth;cameraViewHeight;parallaxRatio;drawers;tiles;matrix;repeatedVertically;repeatedHorizontally;horizontalRandom;verticalRandom;restoreTileTransparency;randomSeed;tileWidth;tileHeight;tileMapWidth;tileMapHeight;maxColsOnScreen;maxRowsOnScreen;static RepeatType=Ga;constructor(t,n){super(),this.rows=t,this.columns=n,this.cameraViewWidth=A.CANVAS_WIDTH,this.cameraViewHeight=A.CANVAS_HEIGHT,this.parallaxRatio=1,this.drawers=[],this.tiles=[],this.matrix=[];for(let e=0;e<n;e++){let n=this.matrix[e]=[];for(let e=0;e<t;e++)n[e]=P.UNDEFINED}this.repeatedVertically=e.RepeatType.NONE,this.repeatedHorizontally=e.RepeatType.NONE,this.horizontalRandom=!1,this.verticalRandom=!1,this.restoreTileTransparency=!0,this.randomSeed=I.randomRange(1e3,2e3),this.tileWidth=0,this.tileHeight=0,this.tileMapWidth=0,this.tileMapHeight=0,this.maxColsOnScreen=0,this.maxRowsOnScreen=0}addTile(e,t){if(t===P.UNDEFINED)this.tileWidth=e.imageWidth,this.tileHeight=e.imageHeight;else{let n=e.rects[t];if(!n)return;this.tileWidth=n.w,this.tileHeight=n.h}this.updateVars();let n=P.UNDEFINED;for(let t=0,r=this.drawers.length;t<r;t++){let r=this.drawers[t];if(r&&r.texture===e){n=t;break}}if(n===P.UNDEFINED){let t=new ie(e);n=this.drawers.length,this.drawers.push(t)}let r=new Ka(n,t);this.tiles.push(r)}updateVars(){this.maxColsOnScreen=2+Math.trunc(this.cameraViewWidth/(this.tileWidth+1)),this.maxRowsOnScreen=2+Math.trunc(this.cameraViewHeight/(this.tileHeight+1)),this.repeatedVertically===e.RepeatType.NONE&&(this.maxRowsOnScreen=Math.min(this.maxRowsOnScreen,this.rows)),this.repeatedHorizontally===e.RepeatType.NONE&&(this.maxColsOnScreen=Math.min(this.maxColsOnScreen,this.columns)),this.width=this.tileMapWidth=this.columns*this.tileWidth,this.height=this.tileMapHeight=this.rows*this.tileHeight}fill(e,t,n,r,i){for(let a=t,o=t+r;a<o;a++){let t=this.matrix[a];if(t)for(let r=e,a=e+n;r<a;r++)t[r]=i}}setParallaxRation(e){this.parallaxRatio=e}setRepeatHorizontally(e){this.repeatedHorizontally=e,this.updateVars()}setRepeatVertically(e){this.repeatedVertically=e,this.updateVars()}updateWithCameraPos(t){let n=Math.round(t.x/this.parallaxRatio),r=Math.round(t.y/this.parallaxRatio),i=this.x,a=this.y,o,s,c,l;if(this.repeatedVertically!==e.RepeatType.NONE){let e=a-r;o=Math.trunc(e)%this.tileMapHeight,a=e<0?o+r:o-this.tileMapHeight+r}if(this.repeatedHorizontally!==e.RepeatType.NONE){let e=i-n;o=Math.trunc(e)%this.tileMapWidth,i=e<0?o+n:o-this.tileMapWidth+n}if(!w.rectInRect(n,r,n+this.cameraViewWidth,r+this.cameraViewHeight,i,a,i+this.tileMapWidth,a+this.tileMapHeight))return;let u=w.rectInRectIntersection(i,a,this.tileMapWidth,this.tileMapHeight,n,r,this.cameraViewWidth,this.cameraViewHeight),d=new O(Math.max(0,u.x),Math.max(0,u.y)),f=new O(Math.trunc(Math.trunc(d.x)/this.tileWidth),Math.trunc(Math.trunc(d.y)/this.tileHeight)),p=a+f.y*this.tileHeight,m=new O(i+f.x*this.tileWidth,p);for(s=0,c=this.drawers.length;s<c;s++){let e=this.drawers[s];e&&(e.numberOfQuadsToDraw=0)}let h=f.x+this.maxColsOnScreen-1,g=f.y+this.maxRowsOnScreen-1;for(this.repeatedVertically===e.RepeatType.NONE&&(g=Math.min(this.rows-1,g)),this.repeatedHorizontally===e.RepeatType.NONE&&(h=Math.min(this.columns-1,h)),s=f.x;s<=h;s++){m.y=p;for(let i=f.y;i<=g&&!(m.y>=r+this.cameraViewHeight);i++){let a=w.rectInRectIntersection(n,r,this.cameraViewWidth,this.cameraViewHeight,m.x,m.y,this.tileWidth,this.tileHeight),o=new w(n-m.x+a.x,r-m.y+a.y,a.w,a.h),c=Math.round(s),u=Math.round(i);this.repeatedVertically===e.RepeatType.EDGES&&(m.y<this.y?u=0:m.y>=this.y+this.tileMapHeight&&(u=this.rows-1)),this.repeatedHorizontally===e.RepeatType.EDGES&&(m.x<this.x?c=0:m.x>=this.x+this.tileMapWidth&&(c=this.columns-1)),this.horizontalRandom&&(l=Math.sin(m.x)*this.randomSeed,c=Math.abs(Math.trunc(l)%this.columns)),this.verticalRandom&&(l=Math.sin(m.y)*this.randomSeed,u=Math.abs(Math.trunc(l)%this.rows)),c>=this.columns&&(c%=this.columns),u>=this.rows&&(u%=this.rows);let d=this.matrix[c];if(!d)continue;let f=d[u];if(f!==void 0&&f>=0){let e=this.tiles[f];if(!e)continue;let n=this.drawers[e.drawerIndex];if(!n)continue;let r=n.texture;if(e.quad!==P.UNDEFINED){let t=r.rects[e.quad];t&&(o.x+=t.x,o.y+=t.y)}let i=new w(t.x+a.x,t.y+a.y,a.w,a.h);n.setTextureQuad(n.numberOfQuadsToDraw++,o,i,null)}m.y+=this.tileHeight}if(m.x+=this.tileWidth,m.x>=n+this.cameraViewWidth)break}}draw(){this.preDraw();for(let e=0,t=this.drawers.length;e<t;e++){let t=this.drawers[e];t&&t.draw()}this.postDraw()}},Ja=class extends qa{lastCameraPos;constructor(e,t){super(e,t),this.lastCameraPos=O.newUndefined()}updateWithCameraPos(e){this.lastCameraPos.equals(e)||(super.updateWithCameraPos(e),this.lastCameraPos.copyFrom(e))}draw(){super.draw()}},Ya=class{constructor(e,t,n,r){this.object=e,this.callback=t,this.param=n,this.delay=r}dispatch(){this.callback.apply(this.object,this.param??[])}},Xa=class{dispatchers=[];callObject(e,t,n,r){let i=new Ya(e,t,n,r);this.dispatchers.push(i)}cancelAllDispatches(){this.dispatchers.length=0}cancelDispatch(e,t,n){for(let[r,i]of this.dispatchers.entries())if(i.object===e&&i.callback===t&&i.param===n){this.dispatchers.splice(r,1);return}}update(e){let t=this.dispatchers.slice();for(let n of t){let t=this.dispatchers.indexOf(n);t<0||(n.delay-=e,n.delay<=0&&(this.dispatchers.splice(t,1),n.dispatch()))}}},Za=new Xa,Qa=.7,$a=class e{static nextIndex=0;markedForRemoval=!1;isSettling=!0;nextOffset;offset;index;constructor(t){this.nextOffset=t,this.offset=t,this.index=e.nextIndex++}},eo=class extends T{plateQuad;segments=[];tileWidth;tileHeight;tileScaleX;tileScaleY;textureId=n.IMG_OBJ_TRANSPORTER;offset=0;prevOffset=0;interpolationAlpha=1;constructor(e,t,n){super(),this.width=e,this.height=t,this.anchor=S.TOP|S.LEFT,this.parentAnchor=S.TOP|S.LEFT,n<0?this.plateQuad=6:n>0?this.plateQuad=5:this.plateQuad=4;let r=j.create(this.textureId,this.plateQuad);r.anchor=S.CENTER,r.parentAnchor=S.TOP|S.LEFT,this.tileWidth=r.width,this.tileHeight=r.height,this.tileScaleY=this.tileHeight>0?this.height/this.tileHeight:1,this.tileScaleX=Qa,this.segments.push(r),this.addChild(r)}getTileScale(){return this.tileScaleX}move(e){if(this.tileWidth<=0)return;let t=this.tileWidth*this.tileScaleX;if(!(t<=0)){for(this.prevOffset=this.offset,this.offset+=e;this.offset>this.width;)this.offset-=t;for(;this.offset<0;)this.offset+=t}}updateLayout(){if(this.tileWidth<=0||this.tileHeight<=0||this.width<=0)return;let e=this.tileWidth*this.tileScaleX;if(e<=0)return;let t;if(this.interpolationAlpha<1){let n=this.prevOffset,r=this.offset,i=r-n;Math.abs(i)>e/2&&(i>0?r-=e:r+=e),t=n+(r-n)*this.interpolationAlpha}else t=this.offset;t-=Math.floor(t/e)*e,t<0&&(t+=e);let n=0;n=this.layoutSegment(n,0,t);let r=t;for(;r+e<=this.width;)n=this.layoutSegment(n,r,e),r+=e;let i=Math.max(this.width-r,0);n=this.layoutSegment(n,r,i);for(let e=n;e<this.segments.length;e++)this.segments[e].visible=!1}layoutSegment(e,t,n){let r=this.ensureSegment(e);if(n<=0)return r.visible=!1,e+1;let i=n/this.tileWidth;r.scaleX=i,r.scaleY=this.tileScaleY;let a=this.tileWidth*Math.abs(i),o=this.tileHeight*Math.abs(this.tileScaleY);return r.x=t+a/2,r.y=o/2,r.visible=!0,e+1}ensureSegment(e){if(this.segments[e])return this.segments[e];let t=j.create(this.textureId,this.plateQuad);return t.anchor=S.CENTER,t.parentAnchor=S.TOP|S.LEFT,this.segments[e]=t,this.addChild(t),t}},to=class e extends T{velocity=10;offset=0;id=-1;isManual=!1;manualTravelDistance=0;rotationRad=0;offsetDelta=0;direction=O.newZero();active=!1;activePointerId=-1;lastDragPosition=O.newZero();beltVisual=null;itemStates=new Map;items=[];interpolationAlpha=1;constructor(){super(),this.anchor=S.LEFT|S.VCENTER}draw(){this.beltVisual&&(this.beltVisual.interpolationAlpha=this.interpolationAlpha,this.beltVisual.updateLayout()),super.draw()}static create(t,n,r,i,a,o,s,c){let l=new e;return l.initializeBelt(t,n,r,i,a,o,s,c),l}initializeBelt(e,t,n,r,i,a,o,s){this.activePointerId=-1,this.id=e,this.x=t,this.y=n,this.width=r,this.height=i;let c=-a;this.rotation=c,this.isManual=o,this.rotationRad=z.fromDegrees(c),this.direction=O.forAngle(this.rotationRad),this.velocity=s,this.rotationCenterX=-r/2,this.rotationCenterY=0,this.removeAllChildren(),this.buildVisuals()}update(t){super.update(t),this.isManual||(this.offsetDelta=t*this.velocity*10,this.offset+=this.offsetDelta,this.offset=this.wrapOffset(this.offset,this.width)),this.active=Math.abs(this.offsetDelta)>.001,this.isManual&&this.active&&(this.manualTravelDistance+=Math.abs(this.offsetDelta),this.manualTravelDistance>=15&&(this.playManualMoveSound(),this.manualTravelDistance=0)),this.cleanupMarkedItems();let r=null,i=null;for(let[a,o]of this.itemStates.entries()){if(o.markedForRemoval)continue;let s=o.offset+this.offsetDelta,c=!0;s>=this.width?s-=this.width:s<=0?s+=this.width:c=!1;let l=e.getItemSize(a),u=e.getItemPosition(a),d=new O(l.x*this.direction.x,l.y*this.direction.y).getLength()/2,f=1,p=s;s<d?(f=.5+.5*s/d,r=a,p=d*f):this.width-s<d&&(f=.5+.5*(this.width-s)/d,i=a,p=this.width-d*f);for(let[n,r]of this.itemStates.entries()){if(n===a||r.markedForRemoval||f!==1)continue;let i=r.offset-o.offset,c=e.getItemSize(n),u=O.add(l,c);if(.25*(u.x*u.x+u.y*u.y)>i*i){if(Math.abs(i)<.001){let e=this.items.indexOf(n)-this.items.indexOf(a);i=600*(e>0?1:e<0?-1:0)}else Math.abs(i)<600&&(i=Math.sign(i)*600);s-=i*t}}e.applyItemScale(a,f);let m=new O(this.x+this.direction.x*p-u.x,this.y+this.direction.y*p-u.y);if(o.isSettling){let n=new O(this.direction.y,-this.direction.x),r=m.getDot(n)/this.direction.getLength(),i=new O(n.x*r,n.y*r),s=800*t,c=i.x*i.x+i.y*i.y;if(c>=s*s){let e=Math.sqrt(c);i.multiply((e-s)/e)}else o.isSettling=!1;m.subtract(i),e.setItemPosition(a,O.add(u,m))}else e.setItemPosition(a,O.add(new O(this.x,this.y),O.multiply(this.direction,p)));o.nextOffset=s,c&&(a.onConveyorDrop?.(),U.playSound(n.SND_TRANSPORTER_DROP))}for(let e of this.itemStates.values())e.offset=this.wrapOffset(e.nextOffset,this.width);if(this.beltVisual&&this.beltVisual.move(this.offsetDelta),this.isManual&&(this.offsetDelta=0),this.activePointerId===-1)if(r&&i)for(let[e,n]of this.itemStates.entries())n.markedForRemoval||(e===r&&(n.offset+=1500*t),e===i&&(n.offset-=1500*t));else r?this.offsetDelta=1500*t:i&&(this.offsetDelta=-1500*t)}onPointerDown(e,t,n){if(!this.isManual)return!1;let r=!1,i=this.toLocalSpace(new O(e,t));return i.x>=0&&i.x<=this.width&&i.y>=-.5*this.height&&i.y<=.5*this.height&&(this.activePointerId=n,this.lastDragPosition.copyFrom(i),r=!0),r}onPointerUp(e,t,n){if(!this.isManual)return!1;let r=!1;if(this.activePointerId===n){this.activePointerId=-1,this.offsetDelta=0;for(let[e,t]of this.itemStates.entries())t.markedForRemoval&&this.remove(e);r=!0}return r}onPointerMove(e,t,n){if(!this.isManual)return!1;let r=!1;if(this.activePointerId===n){let n=this.toLocalSpace(new O(e,t));this.offsetDelta=n.x-this.lastDragPosition.x,this.offset+=this.offsetDelta,this.offset=this.wrapOffset(this.offset,this.width),this.lastDragPosition.copyFrom(n),r=!0}return r}contains(e){let t=this.toLocalSpace(e);return!(t.x<0||t.x>this.width||t.y<-.5*this.height||t.y>.5*this.height)}containsWithPadding(e,t){let n=this.toLocalSpace(e);return!(n.x<-t||n.x>this.width+t||n.y<-.5*this.height-t||n.y>.5*this.height+t)}toLocalSpace(e){let t=this.rotationRad-.5*Math.PI,n=new O(Math.cos(t),Math.sin(t)),r=e.x-this.x,i=e.y-this.y;return new O(this.direction.x*r+this.direction.y*i,n.x*r+n.y*i)}attachItem(e){this.registerItem(e)}markItemForRemoval(e){let t=this.itemStates.get(e);t&&(t.markedForRemoval=!0),e.conveyorId=-1}hasItem(e){return this.itemStates.has(e)}remove(e){this.itemStates.delete(e)}isItemMarkedForRemoval(e){return this.itemStates.get(e)?.markedForRemoval??!1}isActive(){return this.active}wrapOffset(e,t){let n=t-0,r=e;return r>t&&(r-=n),r<0&&(r+=n),r}registerItem(t){let n=e.getItemPosition(t),r=new O(n.x-this.x,n.y-this.y),i=Math.max(Math.min(r.x*this.direction.x+r.y*this.direction.y,this.width),0);this.itemStates.set(t,new $a(i)),this.items.push(t),t.conveyorId=this.id,e.cacheBaseScale(t)}buildVisuals(){let e=this.width,t=this.height,n=.75,r=t-10,i=e=>e.height*Math.abs(e.scaleY),a=e=>e.width*Math.abs(e.scaleX),o=this.createPiece(1);o.scaleX=n,o.scaleY=n;let s=i(o),c=a(o),l=c*.2,u=this.createPiece(2);u.scaleX=(e-c+l)/u.width,u.scaleY=r/u.height,u.x=0,u.y=0,this.addChild(u);let d=this.createPiece(1);d.scaleX=n,d.scaleY=-n,d.x=-l,d.y=s-3,this.addChild(d);let f=this.createPiece(1);f.scaleX=-n,f.scaleY=-n,f.x=e+l,f.y=s-3,this.addChild(f);let p=this.createPiece(1);p.scaleX=-n,p.scaleY=n,p.x=e+l,p.y=t-s+3,this.addChild(p);let m=o;m.scaleX=n,m.x=-l,m.y=t-s+3,this.addChild(m);let h=this.createPiece(0);h.scaleX=n,h.scaleY=r/h.height,h.x=-l,h.y=5,this.addChild(h);let g=this.createPiece(0);g.scaleX=n,g.scaleY=r/g.height,g.x=e-a(g)+l,g.y=5,this.addChild(g);let _=this.createPiece(3);_.scaleX=(e-c)/_.width,_.scaleY=-n,_.x=15,_.y=s-4,this.addChild(_);let v=this.createPiece(3);v.scaleX=(e-c)/v.width,v.scaleY=n,v.x=15,v.y=t-s+4,this.addChild(v);let y=this.isManual?0:this.velocity>0?1:-1;this.beltVisual=new eo(e-2,r,y),this.beltVisual.x=0,this.beltVisual.y=5,this.addChild(this.beltVisual);let b=this.createPiece(7);b.scaleX=n,b.scaleY=r/b.height,b.x=0,b.y=5,this.addChild(b);let x=this.createPiece(7);x.scaleX=-n,x.scaleY=r/x.height,x.x=e,x.y=5,this.addChild(x)}createPiece(e){let t=j.create(n.IMG_OBJ_TRANSPORTER,e);return t.anchor=S.TOP|S.LEFT,t.parentAnchor=S.TOP|S.LEFT,t.rotationCenterX=-t.width/2,t.rotationCenterY=-t.height/2,t}cleanupMarkedItems(){let t=[];for(let[n,r]of this.itemStates.entries())r.markedForRemoval&&!this.contains(e.getItemPosition(n))&&t.push(n);for(let n of t){this.itemStates.delete(n);let t=this.items.indexOf(n);t>=0&&this.items.splice(t,1),e.restoreItemScale(n)}}playManualMoveSound(){let e=I.randomRange(n.SND_CONV01,n.SND_CONV04);U.playSound(e)}static cacheBaseScale(e){e.conveyorBaseScaleX===void 0&&(e.conveyorBaseScaleX=e.scaleX??1),e.conveyorBaseScaleY===void 0&&(e.conveyorBaseScaleY=e.scaleY??1)}static restoreItemScale(e){e.conveyorBaseScaleX!==void 0&&(e.scaleX=e.conveyorBaseScaleX),e.conveyorBaseScaleY!==void 0&&(e.scaleY=e.conveyorBaseScaleY)}static applyItemScale(t,n){e.cacheBaseScale(t);let r=t.conveyorBaseScaleX??1,i=t.conveyorBaseScaleY??1;t.scaleX=r*n,t.scaleY=i*n}static getItemPosition(e){return typeof e.getConveyorPosition==`function`?e.getConveyorPosition():new O(e.x,e.y)}static setItemPosition(e,t){if(typeof e.setConveyorPosition==`function`){e.setConveyorPosition(t);return}e.x=t.x,e.y=t.y}static getItemSize(e){if(typeof e.getConveyorSize==`function`)return e.getConveyorSize();let t=e.width??0,n=e.height??0,r=e.bb?.w??0,i=e.bb?.h??0,a=r>0?r:t,o=i>0?i:n;if(r<=0&&i<=0&&e instanceof j&&e.restoreCutTransparency&&e.quadToDraw!==void 0&&e.quadToDraw!==P.UNDEFINED){let t=e.texture?.rects[e.quadToDraw];t&&(a=t.w+(e.texture.adjustmentMaxX??0),o=t.h+(e.texture.adjustmentMaxY??0))}let s=Math.abs(e.conveyorBaseScaleX??1),c=Math.abs(e.conveyorBaseScaleY??1);return new O(a*s,o*c)}static getItemPadding(t){if(typeof t.getConveyorPadding==`function`)return t.getConveyorPadding();let n=e.getItemSize(t);return(n.x+n.y)/4}},no=class{pointerPositions=new Map;list=[];needsSort=!1;interpolationAlpha=1;count(){return this.list.length}clear(){this.list.length=0,this.pointerPositions.clear(),this.needsSort=!1}push(e){this.list.push(e)}iterator(){return this.list.values()}draw(){for(let e of this.list)e.interpolationAlpha=this.interpolationAlpha,e.draw()}attachItems(e){for(let t of e)t&&this.attachItemToBelts(t)}processItems(e){for(let t of e)t&&this.processItem(t)}update(e){for(let t of this.list)t.update(e);this.needsSort&&=(this.sortBelts(),!1)}remove(e){for(let t of this.list)t.remove(e)}onPointerDown(e,t,n){for(let r=this.list.length-1;r>=0;r--)if(this.list[r]?.onPointerDown(e,t,n))return this.pointerPositions.set(n,new O(e,t)),!0;return!1}onPointerUp(e,t,n){for(let r=this.list.length-1;r>=0;r--)if(this.list[r]?.onPointerUp(e,t,n))return this.pointerPositions.delete(n),!0;return!1}onPointerMove(e,t,n){let r=this.pointerPositions.get(n);if(r){let i=O.subtract(new O(e,t),r);if(i.x*i.x+i.y*i.y<4)return!1;let a=i.copy();a.normalize();let o=-1,s=null;for(let e of this.list){if(!e.contains(r))continue;let t=Math.abs(a.getDot(e.direction));t>=o&&(o=t,s=e)}s&&s.onPointerDown(r.x,r.y,n),this.pointerPositions.delete(n)}for(let r=this.list.length-1;r>=0;r--)if(this.list[r].onPointerMove(e,t,n))return this.requestSort(),!0;return!1}attachItemToBelts(e){let t=to.getItemPosition(e);for(let n of this.list)n.contains(t)&&n.attachItem(e)}processItem(e){let t=null,n=[],r=to.getItemPosition(e),i=to.getItemPadding(e);for(let a of this.list)a.containsWithPadding(r,i)&&n.push(a),a.hasItem(e)&&(t=a);if(t?.isManual){for(let t of n)if(t.isManual&&t.isActive()){this.moveItemToBelt(t,e);return}for(let t of n)t.isManual||this.moveItemToBelt(t,e)}}moveItemToBelt(e,t){if(!e.hasItem(t)||e.isItemMarkedForRemoval(t)){for(let e of this.list)e.hasItem(t)&&e.markItemForRemoval(t);e.attachItem(t),U.playSound(n.SND_TRANSPORTER_MOVE)}}sortBelts(){let e=this.count()-1;for(let t=e;t>=0;t--)if(this.list[t].isManual&&this.list[t].isActive()){for(let n=t;n<e;n++)this.swapBelts(n,n+1);e--}this.sortByManualFlag()}sortByManualFlag(){let e=this.count()-1;for(let t=e;t>=0;t--)if(!this.list[t].isManual){for(let n=t;n<e;n++)this.swapBelts(n,n+1);e--}}swapBelts(e,t){let n=this.list[e];this.list[e]=this.list[t],this.list[t]=n}requestSort(){this.needsSort=!0}};function ro(){this.starDisappearPool=[],this.bubbleDisappear=new K,this.bubbleDisappear.initTextureWithId(n.IMG_OBJ_BUBBLE_POP),this.bubbleDisappear.doRestoreCutTransparency(),this.bubbleDisappear.anchor=S.CENTER;let e=this.bubbleDisappear.addAnimationDelay(.05,o.LoopType.NO_LOOP,0,11),t=this.bubbleDisappear.getTimeline(e);t&&(t.onFinished=this.aniPool.timelineFinishedDelegate()),this.aniPool.removeAllChildren(),this.staticAniPool.removeAllChildren(),this.dd.cancelAllDispatches(),this.attachCount=0,this.juggleTimer=0}var io=-1;function ao(){let e=E.levelBackgroundIds[J.pack],t=E.levelOverlayIds[J.pack];if(e==null)return!1;if(io!=J.pack){this.bgTexture=nt.getTexture(e)??null;let t=document.getElementById(`c`),n=this.bgTexture?.image;if(typeof this.bgTexture?.imageSrc==`string`||n instanceof HTMLImageElement&&n.src,!t)return!1;t.style.display=`block`,io=J.pack}else this.bgTexture||=nt.getTexture(e)??null;this.overlayTexture=t?nt.getTexture(t)??null:this.bgTexture,this.back=new Ja(1,1),this.back.setRepeatHorizontally(qa.RepeatType.NONE),this.back.setRepeatVertically(qa.RepeatType.ALL);let n=this.bgTexture;return n?(this.back.addTile(n,0),this.back.fill(0,0,1,1,0),!0):(lt.alert(`Background texture ${e} failed to load`),!1)}var oo=0,so=1,co=2,lo=3,uo=10,fo=0,po=1,mo=2,ho=.4,go=function(e){return e[e.INACTIVE=0]=`INACTIVE`,e[e.ACTIVE=1]=`ACTIVE`,e}(go||{}),Z=function(e){return e[e.ACTIVATION=0]=`ACTIVATION`,e[e.DEACTIVATION=1]=`DEACTIVATION`,e[e.FIRE_BOUNCE=2]=`FIRE_BOUNCE`,e}(Z||{}),_o=class e extends Nr{static STATE={INACTIVE:go.INACTIVE,ACTIVE:go.ACTIVE};static CANDY_REVEAL_TIME=d;static getAllLanterns(){return e.allLanterns}static removeAllLanterns(){e.sharedCandyPoint=null,e.allLanterns.length=0}static sharedCandyPoint=null;static allLanterns=[];lanternState;prevPos;idleForm;activeForm;innerCandy;fire;delayedDispatcher;constructor(t,r,i,a){super(),this.prevPos=O.newZero(),this.delayedDispatcher=new Xa,this.lanternState=go.INACTIVE,this.initTextureWithId(n.IMG_OBJ_LANTERN),e.getAllLanterns().push(this),this.x=t,this.y=r,this.fire=new q,this.fire.initTextureWithId(n.IMG_OBJ_LANTERN),this.fire.setTextureQuad(oo),this.fire.anchor=this.fire.parentAnchor=S.CENTER,this.fire.color=k.transparent.copy(),this.fire.doRestoreCutTransparency(),this.addChild(this.fire);let s=new o;s.addKeyFrame(D.makeScale(1.4,1,D.TransitionType.LINEAR,0)),s.addKeyFrame(D.makeScale(1.05,1.3,D.TransitionType.EASE_OUT,.5)),s.addKeyFrame(D.makeColor(new k(.7,.7,.7,.7),D.TransitionType.LINEAR,0)),s.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,.5)),s.loopType=o.LoopType.PING_PONG,this.fire.addTimelineWithID(s,Z.FIRE_BOUNCE),this.idleForm=new q,this.idleForm.initTextureWithId(n.IMG_OBJ_LANTERN),this.idleForm.setTextureQuad(co),this.idleForm.anchor=this.idleForm.parentAnchor=S.CENTER,this.idleForm.doRestoreCutTransparency(),this.addChild(this.idleForm);let c=new o;c.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,0)),c.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.3)),this.idleForm.addTimelineWithID(c,Z.ACTIVATION);let l=new o;l.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,0)),l.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,.3)),this.idleForm.addTimelineWithID(l,Z.DEACTIVATION),this.activeForm=new q,this.activeForm.initTextureWithId(n.IMG_OBJ_LANTERN),this.activeForm.setTextureQuad(so),this.activeForm.anchor=this.activeForm.parentAnchor=S.CENTER,this.activeForm.color=k.transparent.copy(),this.activeForm.y=1,this.activeForm.doRestoreCutTransparency(),this.addChild(this.activeForm);let u=new o;u.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,0)),u.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,.3)),this.activeForm.addTimelineWithID(u,Z.ACTIVATION);let d=new o;d.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,0)),d.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.3)),this.activeForm.addTimelineWithID(d,Z.DEACTIVATION);let f=n.IMG_OBJ_LANTERN,p=lo+i;i>=3&&(f=a,p=uo),this.innerCandy=new q,this.innerCandy.initTextureWithId(f),this.innerCandy.setTextureQuad(p),this.innerCandy.anchor=this.innerCandy.parentAnchor=S.CENTER,this.innerCandy.color=k.transparent.copy(),this.innerCandy.y=-4,this.innerCandy.doRestoreCutTransparency(),this.addChild(this.innerCandy);let m=new o;m.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,0)),m.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,.2)),m.addKeyFrame(D.makeScale(1,1,D.TransitionType.LINEAR,0)),m.addKeyFrame(D.makeScale(1,.8,D.TransitionType.LINEAR,.07)),m.addKeyFrame(D.makeScale(.85,1.05,D.TransitionType.LINEAR,.05)),m.addKeyFrame(D.makeScale(1,1,D.TransitionType.LINEAR,.05)),m.addKeyFrame(D.makePos(0,-4,D.TransitionType.LINEAR,0)),m.addKeyFrame(D.makePos(0,0,D.TransitionType.LINEAR,.1)),m.addKeyFrame(D.makePos(0,-1,D.TransitionType.LINEAR,.05)),this.innerCandy.addTimelineWithID(m,fo);let h=new o;h.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,0)),h.addKeyFrame(D.makeColor(new k(.6,.6,.6,.6),D.TransitionType.LINEAR,.06)),h.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.04)),h.addKeyFrame(D.makeScale(1,1,D.TransitionType.LINEAR,0)),h.addKeyFrame(D.makeScale(1.15,.8,D.TransitionType.LINEAR,.06)),h.addKeyFrame(D.makeScale(1,1,D.TransitionType.LINEAR,.04)),h.addKeyFrame(D.makePos(0,0,D.TransitionType.LINEAR,0)),h.addKeyFrame(D.makePos(0,-4,D.TransitionType.EASE_OUT,.06)),h.addKeyFrame(D.makePos(0,4,D.TransitionType.EASE_IN,.04)),this.innerCandy.addTimelineWithID(h,po);let g=new o;g.addKeyFrame(D.makeScale(1,1,D.TransitionType.IMMEDIATE,0)),g.addKeyFrame(D.makeScale(.93,.93,D.TransitionType.EASE_IN,.35)),g.addKeyFrame(D.makeScale(.87,.87,D.TransitionType.EASE_OUT,.35)),g.addKeyFrame(D.makeScale(.93,.93,D.TransitionType.EASE_IN,.35)),g.addKeyFrame(D.makeScale(1,1,D.TransitionType.EASE_OUT,.35)),g.loopType=o.LoopType.REPLAY,this.innerCandy.addTimelineWithID(g,mo)}captureCandyFromDispatcher(e){this.captureCandy(e)}captureCandy(t){U.playSound(n.SND_LANTERN_TELEPORT_IN),e.sharedCandyPoint=t,t.disableGravity=!0,t.pos.x=this.x,t.pos.y=this.y,t.prevPos.x=this.x,t.prevPos.y=this.y;for(let t of e.getAllLanterns())t.lanternState=go.ACTIVE,t.idleForm.playTimeline(Z.ACTIVATION),t.activeForm.playTimeline(Z.ACTIVATION),t.innerCandy.playTimeline(fo),t.fire.scaleX=1.4,t.fire.scaleY=1,t.fire.color=new k(.7,.7,.7,.7),t.delayedDispatcher.cancelAllDispatches(),t.delayedDispatcher.callObject(t,t.playFireBounceTimeline,null,.4*Math.random()),t.delayedDispatcher.callObject(t,t.playInnerCandyIdleTimeline,null,.2+.2*Math.random())}update(t){this.prevPos=new O(this.x,this.y),super.update(t),this.delayedDispatcher.update(t),e.sharedCandyPoint&&(e.sharedCandyPoint.pos.x=this.x,e.sharedCandyPoint.pos.y=this.y,e.sharedCandyPoint.prevPos.x=this.x,e.sharedCandyPoint.prevPos.y=this.y,this.lanternState!==go.ACTIVE&&(this.lanternState=go.ACTIVE))}onTouchDown(t,n){let r=O.distance(t,n,this.x,this.y);return this.lanternState===go.ACTIVE&&e.sharedCandyPoint&&r<(A.LANTERN_TOUCH_RADIUS??85)?(this.initiateReleasingCandy(),!0):!1}releaseCandy(){e.sharedCandyPoint&&=(e.sharedCandyPoint.disableGravity=!1,e.sharedCandyPoint.pos.x=this.x,e.sharedCandyPoint.pos.y=this.y,e.sharedCandyPoint.prevPos=this.prevPos.copy(),null)}static becomeCandyAware(...e){let t=e[0];t.lanternState=go.INACTIVE}initiateReleasingCandy(){U.playSound(n.SND_LANTERN_TELEPORT_OUT);for(let t of e.getAllLanterns()){t.idleForm.playTimeline(Z.DEACTIVATION),t.activeForm.playTimeline(Z.DEACTIVATION),t.innerCandy.playTimeline(po);let n=t.fire.getTimeline(Z.FIRE_BOUNCE);n&&n.state===o.StateType.PLAYING&&t.fire.stopCurrentTimeline(),t.fire.color=k.transparent.copy(),t.delayedDispatcher.cancelAllDispatches(),t.delayedDispatcher.callObject(t,e.becomeCandyAware,[t],ho+.1)}this.delayedDispatcher.callObject(this,this.releaseCandy,null,.01)}playFireBounceTimeline(){this.fire.playTimeline(Z.FIRE_BOUNCE)}playInnerCandyIdleTimeline(){this.innerCandy.playTimeline(mo)}};function vo(){this.gravityButton=null,this.gravityTouchDown=P.UNDEFINED,this.twoParts=M.NONE,this.partsDist=0,this.targetSock=null,U.stopSound(n.SND_ELECTRIC);for(let e of this.ghosts)e?.destroy();this.bungees=[],this.razors=[],this.spikes=[],this.stars=[],this.bubbles=[],this.tubes=[],this.pumps=[],this.lanterns=[],this.lightbulbs=[],this.rockets=[],this.socks=[],this.ghosts=[],this.mice=[],this.miceManager=null,this.conveyors.clear(),this.tutorialImages=[],this.tutorials=[],this.drawings=[],this.bouncers=[],this.rotatedCircles=[],this.pollenDrawer=null,this.star=new fr,this.star.setWeight(1),this.starL=new fr,this.starL.setWeight(1),this.starR=new fr,this.starR.setWeight(1),this.isCandyInLantern=!1,_o.removeAllLanterns(),this.sleepAnimPrimary=null,this.sleepAnimSecondary=null,this.isNightTargetAwake=null,this.sleepPulseActive=!1,this.sleepPulseTime=0,this.sleepPulseDelay=0,this.sleepPulseBaseY=0,this.sleepSoundTimer=0,this.sleepSoundId!=null&&U.stopSound(this.sleepSoundId),this.sleepSoundId=null,this.gameLostTriggered=!1}function yo(){let e=this.getCandyResourceId(),t=this.getCandyFxResourceId(),r=this.getCandyConstants();this.candyResourceId=e,this.candy=new q,this.candy.initTextureWithId(e),this.candy.setTextureQuad(r.candy_bottom),this.candy.doRestoreCutTransparency(),this.candy.anchor=S.CENTER,this.candy.bb=w.copy(A.CANDY_BB),this.candy.passTransformationsToChilds=!1,this.candy.scaleX=this.candy.scaleY=.71,this.candy.drawPosIncrement=1e-4,this.candyMain=new q,this.candyMain.initTextureWithId(e),this.candyMain.setTextureQuad(r.candy_main),this.candyMain.doRestoreCutTransparency(),this.candyMain.anchor=this.candyMain.parentAnchor=S.CENTER,this.candy.addChild(this.candyMain),this.candyMain.scaleX=this.candyMain.scaleY=.71,this.candyMain.drawPosIncrement=1e-4,this.candyTop=new q,this.candyTop.initTextureWithId(e),this.candyTop.setTextureQuad(r.candy_top),this.candyTop.doRestoreCutTransparency(),this.candyTop.anchor=this.candyTop.parentAnchor=S.CENTER,this.candy.addChild(this.candyTop),this.candyTop.scaleX=this.candyTop.scaleY=.71,this.candyTop.drawPosIncrement=1e-4,this.candyBlink=new K,this.candyBlink.initTextureWithId(t),this.candyBlink.doRestoreCutTransparency(),this.candyBlink.addAnimationEndpoints(be.INITIAL,.07,o.LoopType.NO_LOOP,r.highlight_start,r.highlight_end);let i=this.candyBlink.getTimeline(be.INITIAL);i&&(i.onFinished=()=>{this.candyBlink.stopCurrentTimeline()}),this.candyBlink.addAnimationSequence(be.STAR,.3,o.LoopType.NO_LOOP,2,[r.glow,r.glow]);let a=this.candyBlink.getTimeline(be.STAR);a&&(a.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,0)),a.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.2))),this.candyBlink.visible=!1,this.candyBlink.anchor=this.candyBlink.parentAnchor=S.CENTER,this.candyBlink.scaleX=this.candyBlink.scaleY=.71,this.candy.addChild(this.candyBlink),this.candyBlink.drawPosIncrement=1e-4,this.candyBubbleAnimation=new K,this.candyBubbleAnimation.initTextureWithId(n.IMG_OBJ_BUBBLE_FLIGHT),this.candyBubbleAnimation.x=this.candy.x,this.candyBubbleAnimation.y=this.candy.y,this.candyBubbleAnimation.parentAnchor=this.candyBubbleAnimation.anchor=S.CENTER,this.candyBubbleAnimation.addAnimationDelay(.05,o.LoopType.REPLAY,0,12),this.candyBubbleAnimation.playTimeline(0),this.candy.addChild(this.candyBubbleAnimation),this.candyBubbleAnimation.visible=!1,this.candyBubbleAnimation.drawPosIncrement=1e-4}var bo=class extends K{initWithResId(e){return this.initTextureWithId(e),this.parentAnchor=this.anchor=S.CENTER,this.addAnimationDelay(.05,o.LoopType.REPLAY,0,12),this.visible=!1,this.addSupportingCloudsTimelines(),this.playTimeline(0),this}addSupportingCloudsTimelines(){this.createPulsingCloud(6,this.x+63.75,this.y+18.75,[{scale:.8,dx:1,dy:1,transition:D.TransitionType.IMMEDIATE,duration:0},{scale:.78,dx:0,dy:0,transition:D.TransitionType.EASE_IN,duration:.48},{scale:.76,dx:-1,dy:-1,transition:D.TransitionType.EASE_OUT,duration:.48},{scale:.78,dx:0,dy:0,transition:D.TransitionType.EASE_IN,duration:.48},{scale:.8,dx:1,dy:1,transition:D.TransitionType.EASE_OUT,duration:.48}]),this.createPulsingCloud(5,this.x+48.75,this.y+41.25,[{scale:.93,dx:1,dy:1,transition:D.TransitionType.IMMEDIATE,duration:0},{scale:.965,dx:0,dy:0,transition:D.TransitionType.EASE_IN,duration:.4},{scale:1,dx:-1,dy:-1,transition:D.TransitionType.EASE_OUT,duration:.4},{scale:.965,dx:0,dy:0,transition:D.TransitionType.EASE_IN,duration:.4},{scale:.93,dx:1,dy:1,transition:D.TransitionType.EASE_OUT,duration:.4}]),this.createPulsingCloud(5,this.x-67.5,this.y+11.25,[{scale:.33,dx:1,dy:1,transition:D.TransitionType.IMMEDIATE,duration:0},{scale:.365,dx:0,dy:0,transition:D.TransitionType.EASE_IN,duration:.43},{scale:.4,dx:-1,dy:-1,transition:D.TransitionType.EASE_OUT,duration:.43},{scale:.365,dx:0,dy:0,transition:D.TransitionType.EASE_IN,duration:.43},{scale:.33,dx:1,dy:1,transition:D.TransitionType.EASE_OUT,duration:.43}]),this.createPulsingCloud(6,this.x-56.25,this.y+33.75,[{scale:.6,dx:-1,dy:1,transition:D.TransitionType.IMMEDIATE,duration:0},{scale:.565,dx:0,dy:0,transition:D.TransitionType.EASE_IN,duration:.42},{scale:.53,dx:1,dy:-1,transition:D.TransitionType.EASE_OUT,duration:.42},{scale:.565,dx:0,dy:0,transition:D.TransitionType.EASE_IN,duration:.42},{scale:.6,dx:-1,dy:1,transition:D.TransitionType.EASE_OUT,duration:.42}]);let e=this.createPulsingCloud(2,this.x-15,this.y+56.25,[{scale:.93,dx:1,dy:-1,transition:D.TransitionType.IMMEDIATE,duration:0},{scale:.965,dx:0,dy:0,transition:D.TransitionType.EASE_IN,duration:.47},{scale:1,dx:-1,dy:1,transition:D.TransitionType.EASE_OUT,duration:.47},{scale:.965,dx:0,dy:0,transition:D.TransitionType.EASE_IN,duration:.47},{scale:.93,dx:1,dy:-1,transition:D.TransitionType.EASE_OUT,duration:.47}]),t=new o;t.addKeyFrame(D.makeRotation(350,D.TransitionType.IMMEDIATE,0)),e.addTimeline(t),e.playTimeline(0),this.passColorToChilds=!0}createPulsingCloud(e,t,r,i){let a=j.create(n.IMG_OBJ_GHOST,e);a.anchor=a.parentAnchor=S.CENTER,a.x=t,a.y=r,this.addChild(a);let s=new o;s.loopType=o.LoopType.REPLAY;for(let e of i)s.addKeyFrame(D.makeScale(e.scale,e.scale,e.transition,e.duration)),s.addKeyFrame(D.makePos(a.x+e.dx,a.y+e.dy,e.transition,e.duration));return a.addTimeline(s),a.playTimeline(0),a}};function xo(){this.twoParts===M.NONE?(this.candyGhostBubbleAnimation=new bo().initWithResId(n.IMG_OBJ_BUBBLE_FLIGHT),this.candy.addChild(this.candyGhostBubbleAnimation)):(this.candyBubbleAnimationL=new K,this.candyBubbleAnimationL.initTextureWithId(n.IMG_OBJ_BUBBLE_FLIGHT),this.candyBubbleAnimationL.parentAnchor=this.candyBubbleAnimationL.anchor=S.CENTER,this.candyBubbleAnimationL.addAnimationDelay(.05,o.LoopType.REPLAY,0,12),this.candyBubbleAnimationL.playTimeline(0),this.candyL.addChild(this.candyBubbleAnimationL),this.candyBubbleAnimationL.visible=!1,this.candyBubbleAnimationL.drawPosIncrement=1e-4,this.candyBubbleAnimationR=new K,this.candyBubbleAnimationR.initTextureWithId(n.IMG_OBJ_BUBBLE_FLIGHT),this.candyBubbleAnimationR.parentAnchor=this.candyBubbleAnimationR.anchor=S.CENTER,this.candyBubbleAnimationR.addAnimationDelay(.05,o.LoopType.REPLAY,0,12),this.candyBubbleAnimationR.playTimeline(0),this.candyR.addChild(this.candyBubbleAnimationR),this.candyBubbleAnimationR.visible=!1,this.candyBubbleAnimationR.drawPosIncrement=1e-4,this.candyGhostBubbleAnimationL=new bo().initWithResId(n.IMG_OBJ_BUBBLE_FLIGHT),this.candyL.addChild(this.candyGhostBubbleAnimationL),this.candyGhostBubbleAnimationR=new bo().initWithResId(n.IMG_OBJ_BUBBLE_FLIGHT),this.candyR.addChild(this.candyGhostBubbleAnimationR))}function So(){for(let e of this.rotatedCircles)e.operating=P.UNDEFINED,e.circles=this.rotatedCircles;this.startCamera(),this.conveyors.attachItems(this.stars),this.conveyors.attachItems(this.socks),this.conveyors.attachItems(this.bubbles),this.conveyors.attachItems(this.tubes),this.conveyors.attachItems(this.pumps),this.conveyors.attachItems(this.bouncers),this.conveyors.sortBelts(),this.tummyTeasers=0,this.starsCollected=0,this.candyBubble=null,this.candyBubbleL=null,this.candyBubbleR=null,this.mouthOpen=!1,this.noCandy=this.twoParts!==M.NONE,this.noCandyL=!1,this.noCandyR=!1,this.blink.playTimeline(0),this.spiderTookCandy=!1,this.time=0,this.score=0,this.gravityNormal=!0,Kn.reset(),this.dimTime=0,this.ropesCutAtOnce=0,this.ropesAtOnceTimer=0,this.dd.callObject(this,this.doCandyBlink,null,1)}var Co=class extends j{setText(e,t,n,r,i=!1){let a={fontId:e,text:t};n!==void 0&&(a.width=n),r!==void 0&&(a.alignment=r),i&&(a.canvas=!0,a.img=document.createElement(`canvas`));let o=N.drawImg(a);this.initTexture(new Nt(o))}};function wo(){let e=new Co,t=`${J.pack+1} - ${J.level+1}`;e.setText(n.FNT_BIG_FONT,t,void 0,void 0,!0),e.anchor=S.BOTTOM|S.LEFT,e.x=37*A.CANVAS_SCALE,e.y=A.CANVAS_HEIGHT-5*A.CANVAS_SCALE;let r=new Co;r.setText(n.FNT_BIG_FONT,$e.menuText(F.LEVEL),void 0,void 0,!0),r.anchor=S.BOTTOM|S.LEFT,r.parentAnchor=S.TOP|S.LEFT,r.y=60*A.CANVAS_SCALE,r.rotationCenterX-=r.width/2,r.scaleX=r.scaleY=.7,e.addChild(r);let i=new o;i.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,0)),i.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.5)),i.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,.5)),i.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,1)),i.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.5)),e.addTimelineWithID(i,0),e.playTimeline(0),i.onFinished=this.staticAniPool.timelineFinishedDelegate(),this.staticAniPool.addChild(e),this.clickToCut&&this.resetBungeeHighlight()}function To(){for(let e=0;e<3;e++){let t=this.hudStars[e];t&&(t.currentTimeline&&t.currentTimeline.stop(),t.setTextureQuad(0))}}var Eo=51,Do=9,Oo=12,ko={CANDY:`selectedCandySkin`,ROPE:`selectedRopeSkin`,CANDY_WAS_CHANGED:`candyWasChanged`},Ao=e=>String(e+1).padStart(2,`0`),jo=()=>Xe.getIntOrDefault(ko.CANDY,0)??0,Mo=()=>Xe.getIntOrDefault(ko.ROPE,0)??0,No=new class{mode=`candy`;currentPage=0;tabsBuilt=!1;languageSubscribed=!1;tabContainer=null;grid=null;backButton=null;navBack=null;navForward=null;init(){this.tabContainer=document.getElementById(`skinTabs`),this.grid=document.getElementById(`skinGrid`),this.backButton=document.getElementById(`skinBack`),this.navBack=document.getElementById(`skinNavBack`),this.navForward=document.getElementById(`skinNavForward`),!(!this.tabContainer||!this.grid||!this.backButton||!this.navBack||!this.navForward)&&(this.tabsBuilt||=(this.buildTabs(),this.backButton.addEventListener(`click`,()=>{U.playSound(n.SND_TAP),Hn.showPanel(V.MENU)}),this.navBack.addEventListener(`click`,()=>{this.currentPage>0&&(U.playSound(n.SND_TAP),this.currentPage--,this.renderGrid())}),this.navForward.addEventListener(`click`,()=>{let e=this.getTotalPages();this.currentPage<e-1&&(U.playSound(n.SND_TAP),this.currentPage++,this.renderGrid())}),!0),this.languageSubscribed||=(R.subscribe(R.ChannelId.LanguageChanged,()=>{this.updateTabText()}),!0),this.renderGrid(),this.updateMenuCandySkin())}updateMenuCandySkin(){let e=jo(),t=document.getElementById(`menuCandySkin`);t&&(t.className=`menu-sprite ${`candy_${Ao(e)}`}`,this.updateHandVisibility())}updateHandVisibility(){let e=document.getElementById(`menuCandyHand`);e&&(Xe.getIntOrDefault(ko.CANDY_WAS_CHANGED,0)===0?e.classList.add(`show`):e.classList.remove(`show`))}markCandyAsChanged(){Xe.set(ko.CANDY_WAS_CHANGED,1),this.updateHandVisibility()}buildTabs(){if(!this.tabContainer)return;this.tabContainer.innerHTML=``;let e=this.createTab(F.CANDIES_BTN,`candy`),t=this.createTab(F.ROPE_SKINS_BTN,`rope`);this.tabContainer.append(e,t),this.updateTabState()}updateTabText(){this.tabContainer&&Array.from(this.tabContainer.querySelectorAll(`.sBtn`)).forEach(e=>{let t=e.dataset.mode===`candy`?F.CANDIES_BTN:F.ROPE_SKINS_BTN,n=e.firstChild,r=N.drawBig({text:$e.menuText(t),scaleToUI:!0});n?e.replaceChild(r,n):e.appendChild(r)})}createTab(e,t){let r=document.createElement(`div`);r.className=`sBtn ctrPointer`,r.dataset.mode=t;let i=N.drawBig({text:$e.menuText(e),scaleToUI:!0});return r.appendChild(i),r.addEventListener(`click`,()=>{this.mode!==t&&(U.playSound(n.SND_TAP),this.mode=t,this.currentPage=0,this.updateTabState(),this.renderGrid())}),r}updateTabState(){this.tabContainer&&Array.from(this.tabContainer.querySelectorAll(`.sBtn`)).forEach(e=>{let t=e.dataset.mode,n=this.mode===t;e.classList.toggle(`active`,n)})}getTotalPages(){let e=this.mode===`candy`?Eo:Do;return Math.ceil(e/Oo)}updateNavButtons(){if(!this.navBack||!this.navForward)return;let e=this.getTotalPages();this.currentPage===0?this.navBack.classList.add(`disabled`):this.navBack.classList.remove(`disabled`),this.currentPage>=e-1?this.navForward.classList.add(`disabled`):this.navForward.classList.remove(`disabled`)}renderGrid(){if(!this.grid)return;this.grid.innerHTML=``;let e=this.mode===`candy`,t=e?Eo:Do,n=e?jo():Mo(),r=this.currentPage*Oo,i=Math.min(r+Oo,t);for(let t=r;t<i;t++){let r=this.createSlot(t,n,e);this.grid.appendChild(r)}this.updateNavButtons()}createSlot(e,t,r){let i=e===t,a=document.createElement(`div`);a.className=`skin-slot ctrPointer ${i?`equipped`:``}`,a.dataset.index=String(e);let o=document.createElement(`div`);o.className=`skin-slot-bg sprite ${i?`button_equipped_idle`:`button_available_idle`}`;let s=document.createElement(`div`);return s.className=`skin-icon sprite ${r?`candy_${Ao(e)}`:`rope0${e+1}`}`,a.appendChild(o),a.appendChild(s),a.addEventListener(`click`,()=>{U.playSound(n.SND_TAP),r?(Xe.set(ko.CANDY,e),this.updateMenuCandySkin()):Xe.set(ko.ROPE,e),this.renderGrid()}),a}},Po=class extends T{initAnimations=ro;initBackground=ao;resetGameState=vo;initCandy=yo;initCandyBubbles=xo;initPostLoad=So;initLevelLabel=wo;resetHudStars=To;dd;initialCameraToStarDistance;restartState;aniPool;kickStainsPool;staticAniPool;camera;starsCollected;hudStars;starDisappearPool;slastTouch;fingerCuts;clickToCut;PM;PMY;PMX;mapOffsetX;mapOffsetY;earthAnims;paddingtonFinalFrame;pendingPaddingtonIdleTransition;lastCandyRotateDelta;lastCandyRotateDeltaL;lastCandyRotateDeltaR;prevCandyRotation;attachCount;juggleTimer;dragging;startPos;prevStartPos;bubbleDisappear;bgTexture;overlayTexture;back;gravityButton;gravityTouchDown;twoParts;partsDist;targetSock;bungees;razors;spikes;stars;bubbles;pumps;lanterns;lightbulbs;tubes;rockets;socks;ghosts;mice;miceManager;tutorialImages;tutorials;drawings;bouncers;rotatedCircles;pollenDrawer;conveyors;star;starL;starR;candyResourceId;candy;candyMain;candyTop;candyBlink;candyBubbleAnimation;candyBubbleAnimationL;candyBubbleAnimationR;candyGhostBubbleAnimation;candyGhostBubbleAnimationL;candyGhostBubbleAnimationR;candyBubble;candyBubbleL;candyBubbleR;candyL;candyR;tummyTeasers;mouthOpen;noCandy;isCandyInLantern;noCandyL;noCandyR;spiderTookCandy;time;score;gravityNormal;dimTime;ropesCutAtOnce;ropesAtOnceTimer;blink;blinkTimer;idlesTimer;target;sleepAnimPrimary;sleepAnimSecondary;isNightTargetAwake;sleepPulseActive;sleepPulseTime;sleepPulseDelay;sleepPulseBaseY;sleepSoundTimer;sleepSoundId;gameLostTriggered;support;mapWidth;mapHeight;special;ropePhysicsSpeed;nightLevel;ignoreTouches;fastenCamera;freezeCamera;cameraMoveMode;animateRestartDim;savedSockSpeed;timeBonus;starBonus;gameController;attachCandy;resetBungeeHighlight;rotateAllSpikesWithId;onButtonPressed;constructor(){super(),this.dd=Za,this.initialCameraToStarDistance=P.UNDEFINED,this.restartState=P.UNDEFINED,this.aniPool=new Wa,this.aniPool.visible=!1,this.addChild(this.aniPool),this.kickStainsPool=new Wa,this.kickStainsPool.visible=!1,this.addChild(this.kickStainsPool),this.staticAniPool=new Wa,this.staticAniPool.visible=!1,this.addChild(this.staticAniPool),this.camera=new Wn(A.CAMERA_SPEED,Wn.SpeedType.DELAY),this.starsCollected=0,this.hudStars=[],this.starDisappearPool=[];for(let e=0;e<3;e++){let t=new K;this.hudStars[e]=t,t.initTextureWithId(n.IMG_HUD_STAR),t.doRestoreCutTransparency(),t.addAnimationDelay(.05,o.LoopType.NO_LOOP,0,9),t.setPause(9,0),t.x=10+(t.width+5)*e,t.y=8,this.addChild(t)}this.slastTouch=O.newZero(),this.fingerCuts=Array.from({length:P.MAX_TOUCHES},()=>[]),this.clickToCut=qt.getClickToCut(),this.PM=A.PM,this.PMY=A.PMY,this.PMX=0,this.mapOffsetX=0,this.mapOffsetY=0,this.earthAnims=[],this.paddingtonFinalFrame=null,this.pendingPaddingtonIdleTransition=!1,this.lastCandyRotateDelta=0,this.lastCandyRotateDeltaL=0,this.lastCandyRotateDeltaR=0,this.prevCandyRotation=0,this.attachCount=0,this.juggleTimer=0,this.dragging=Array.from({length:P.MAX_TOUCHES},()=>!1),this.startPos=Array.from({length:P.MAX_TOUCHES},()=>O.newZero()),this.prevStartPos=Array.from({length:P.MAX_TOUCHES},()=>O.newZero()),this.bgTexture=null,this.overlayTexture=null,this.gravityButton=null,this.gravityTouchDown=P.UNDEFINED,this.twoParts=M.NONE,this.partsDist=0,this.targetSock=null,this.bungees=[],this.razors=[],this.spikes=[],this.stars=[],this.bubbles=[],this.pumps=[],this.lanterns=[],this.lightbulbs=[],this.tubes=[],this.rockets=[],this.socks=[],this.ghosts=[],this.mice=[],this.miceManager=null,this.conveyors=new no,this.tutorialImages=[],this.tutorials=[],this.drawings=[],this.bouncers=[],this.rotatedCircles=[],this.pollenDrawer=null,this.star=new fr,this.star.setWeight(1),this.starL=new fr,this.starL.setWeight(1),this.starR=new fr,this.starR.setWeight(1);let e=this.getCandyResourceId();this.candyResourceId=e,this.candy=new q,this.candy.initTextureWithId(e),this.candy.setTextureQuad(0),this.candy.doRestoreCutTransparency(),this.candy.anchor=S.CENTER,this.candy.bb=w.copy(A.CANDY_BB),this.candy.passTransformationsToChilds=!1,this.candy.scaleX=this.candy.scaleY=.71,this.candy.drawPosIncrement=1e-4,this.candyMain=new q,this.candyMain.initTextureWithId(e),this.candyMain.setTextureQuad(1),this.candyMain.doRestoreCutTransparency(),this.candyMain.anchor=this.candyMain.parentAnchor=S.CENTER,this.candy.addChild(this.candyMain),this.candyMain.scaleX=this.candyMain.scaleY=.71,this.candyMain.drawPosIncrement=1e-4,this.candyTop=new q,this.candyTop.initTextureWithId(e),this.candyTop.setTextureQuad(2),this.candyTop.doRestoreCutTransparency(),this.candyTop.anchor=this.candyTop.parentAnchor=S.CENTER,this.candy.addChild(this.candyTop),this.candyTop.scaleX=this.candyTop.scaleY=.71,this.candyTop.drawPosIncrement=1e-4,this.candyBlink=new K,this.candyBlink.initTextureWithId(n.IMG_OBJ_CANDY_01),this.candyBlink.doRestoreCutTransparency(),this.candyBlink.addAnimationEndpoints(be.INITIAL,.07,o.LoopType.NO_LOOP,8,17);let t=this.candyBlink.getTimeline(be.INITIAL);t&&(t.onFinished=()=>{this.candyBlink.stopCurrentTimeline()}),this.candyBlink.addAnimationSequence(be.STAR,.3,o.LoopType.NO_LOOP,2,[18,18]);let r=this.candyBlink.getTimeline(be.STAR);r&&(r.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,0)),r.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.2))),this.candyBlink.visible=!1,this.candyBlink.anchor=this.candyBlink.parentAnchor=S.CENTER,this.candyBlink.scaleX=this.candyBlink.scaleY=.71,this.candy.addChild(this.candyBlink),this.candyBlink.drawPosIncrement=1e-4,this.candyBubbleAnimation=new K,this.candyBubbleAnimation.initTextureWithId(n.IMG_OBJ_BUBBLE_FLIGHT),this.candyBubbleAnimation.x=this.candy.x,this.candyBubbleAnimation.y=this.candy.y,this.candyBubbleAnimation.parentAnchor=this.candyBubbleAnimation.anchor=S.CENTER,this.candyBubbleAnimation.addAnimationDelay(.05,o.LoopType.REPLAY,0,12),this.candyBubbleAnimation.playTimeline(0),this.candy.addChild(this.candyBubbleAnimation),this.candyBubbleAnimation.visible=!1,this.candyBubbleAnimation.drawPosIncrement=1e-4,this.candyBubble=null,this.candyBubbleL=null,this.candyBubbleR=null,this.tummyTeasers=0,this.mouthOpen=!1,this.noCandy=!1,this.isCandyInLantern=!1,this.noCandyL=!1,this.noCandyR=!1,this.spiderTookCandy=!1,this.time=0,this.score=0,this.gravityNormal=!0,this.dimTime=0,this.ropesCutAtOnce=0,this.ropesAtOnceTimer=0,this.mapWidth=0,this.mapHeight=0,this.special=0,this.ropePhysicsSpeed=1,this.nightLevel=0,this.sleepAnimPrimary=null,this.sleepAnimSecondary=null,this.isNightTargetAwake=null,this.sleepPulseActive=!1,this.sleepPulseTime=0,this.sleepPulseDelay=0,this.sleepPulseBaseY=0,this.sleepSoundTimer=0,this.sleepSoundId=null,this.gameLostTriggered=!1,this.ignoreTouches=!1,this.fastenCamera=!1,this.freezeCamera=!1,this.cameraMoveMode=he.TO_CANDY,this.animateRestartDim=!1,this.savedSockSpeed=0,this.timeBonus=0,this.starBonus=0}getCandyResourceId(){let e=E.boxTypes?.[J.pack]===p.HOLIDAY;if(c&&e)return n.IMG_OBJ_CANDY_PADDINGTON;let t=jo();return t===0?n.IMG_OBJ_CANDY_01_NEW:n.IMG_OBJ_CANDY_02+(t-1)}getCandyFxResourceId(){return n.IMG_OBJ_CANDY_FX}getCandyConstants(){let e=E.boxTypes?.[J.pack]===p.HOLIDAY;return c&&e?{candy_bottom:0,candy_main:1,candy_top:2,part_1:19,part_2:20,highlight_start:0,highlight_end:9,glow:10,part_fx_start:11,part_fx_end:15}:{candy_bottom:0,candy_main:1,candy_top:2,part_1:8,part_2:9,highlight_start:0,highlight_end:9,glow:10,part_fx_start:11,part_fx_end:15}}pointOutOfScreen(e){let t=this.mapHeight+A.OUT_OF_SCREEN_ADJUSTMENT_BOTTOM,n=A.OUT_OF_SCREEN_ADJUSTMENT_TOP;return e.pos.y>t||e.pos.y<n}restart(){this.hide(),this.show()}showGreeting(){let e=E.boxTypes?.[J.pack]===p.HOLIDAY;if(c&&e){this.playPaddingtonIntro();return}L?(this.target.playTimeline(g.GREETINGXMAS),U.playSound(n.SND_XMAS_BELL)):this.target.playTimeline(g.GREETING)}hidePaddingtonFinalFrame(){this.paddingtonFinalFrame&&(this.paddingtonFinalFrame.visible=!1)}showPaddingtonFinalFrame(){this.paddingtonFinalFrame&&(this.paddingtonFinalFrame.visible=!0)}preparePaddingtonIntro(){this.pendingPaddingtonIdleTransition=!1,this.dd&&this.dd.cancelDispatch&&this.dd.cancelDispatch(this,this.playRegularIdleAfterPaddington,null),this.hidePaddingtonFinalFrame()}playPaddingtonIntro(){this.target&&(this.preparePaddingtonIntro(),this.target.playTimeline(g.IDLEPADDINGTON))}shouldSkipTutorialElement(e){let t=qt.getLangId(),n=e.locale;return ke.fromString(n)!==t}show(){if(this.initAnimations(),!this.initBackground())return;this.resetGameState(),this.initCandy(),this.resetHudStars();let e=J.loadedMap;e&&(this.loadMap(e),this.initCandyBubbles(),this.initPostLoad(),this.initLevelLabel())}startCamera(){let e=A.CANVAS_WIDTH,t=A.CANVAS_HEIGHT;if(this.mapWidth>e||this.mapHeight>t){this.ignoreTouches=!0,this.fastenCamera=!1,this.camera.type=Wn.SpeedType.PIXELS,this.camera.speed=10,this.cameraMoveMode=he.TO_CANDY_PART;let n,r,i=this.twoParts===M.NONE?this.star:this.starL;this.mapWidth>e?i.pos.x>this.mapWidth/2?(n=0,r=0):(n=this.mapWidth-e,r=0):i.pos.y>this.mapHeight/2?(n=0,r=0):(n=0,r=this.mapHeight-t);let a=i.pos.x-e/2,o=i.pos.y-t/2,s=I.fitToBoundaries(a,0,this.mapWidth-e),c=I.fitToBoundaries(o,0,this.mapHeight-t);this.camera.moveTo(n,r,!0),this.initialCameraToStarDistance=this.camera.pos.distance(new O(s,c))}else this.ignoreTouches=!1,this.camera.moveTo(0,0,!0)}doCandyBlink(){this.candyBlink.playTimeline(be.INITIAL)}};function Fo(e){this.mapWidth=e.width,this.mapHeight=e.height,this.PMX=(A.CANVAS_WIDTH-this.mapWidth*this.PM)/2,this.mapWidth*=this.PM,this.mapHeight*=this.PM,E.showEarth[J.pack]&&(this.mapWidth>A.CANVAS_WIDTH&&this.earthAnims.push(new ar(A.CANVAS_WIDTH,0)),this.mapHeight>A.CANVAS_HEIGHT&&this.earthAnims.push(new ar(0,A.CANVAS_HEIGHT)),this.earthAnims.push(new ar(0,0)))}function Io(e){this.special=e.special||0,this.ropePhysicsSpeed=e.ropePhysicsSpeed,this.nightLevel=e.nightLevel,this.twoParts=e.twoParts?M.SEPARATE:M.NONE,this.mapOffsetX=Number(e.mapOffsetX??0),this.mapOffsetY=Number(e.mapOffsetY??0),this.ropePhysicsSpeed*=A.PHYSICS_SPEED_MULTIPLIER}var Lo=0,Ro=class{parentIndex;x;y;scaleX;startScaleX;endScaleX;scaleY;startScaleY;endScaleY;alpha;startAlpha;endAlpha;constructor(){this.parentIndex=0,this.x=0,this.y=0,this.scaleX=1,this.startScaleX=1,this.endScaleX=1,this.scaleY=1,this.startScaleY=1,this.endScaleY=1,this.alpha=1,this.startAlpha=1,this.endAlpha=1}},zo=class extends T{qw;qh;drawer;pollens;constructor(){super();let e=nt.getTexture(n.IMG_OBJ_POLLEN_HD);if(!e)throw Error(`Failed to load pollen texture`);this.qw=e.imageWidth,this.qh=e.imageHeight,this.drawer=new ie(e),this.pollens=[]}addPollen(e,t){let n=[.3,.3,.5,.5,.6],r=n.length,i=1,a=1,o=n[I.randomRange(0,r-1)],s=o;if(!o||!s)return;I.randomBool()?o*=1+I.randomRange(0,1)/10:s*=1+I.randomRange(0,1)/10,i*=o,a*=s;let c=this.qw*i,l=this.qh*a,u=Math.min(1-i,1-a),d=Math.random(),f=new Ro;f.parentIndex=t,f.x=e.x,f.y=e.y,f.startScaleX=u+i,f.startScaleY=u+a,f.scaleX=f.startScaleX*d,f.scaleY=f.startScaleY*d,f.endScaleX=i,f.endScaleY=a,f.endAlpha=.3,f.startAlpha=1,f.alpha=.7*d+.3;let p=this.drawer.texture.rects[Lo];if(!p)throw Error(`Failed to find pollen texture quad`);let m=new w(e.x-c/2,e.y-l/2,c,l);this.drawer.setTextureQuad(this.pollens.length,p,m,f.alpha),this.pollens.push(f)}fillWithPollenFromPath(e,t,n){let r=n.mover.path[e],i=n.mover.path[t];if(!r||!i)return;let a=A.POLLEN_MIN_DISTANCE,o=O.subtract(i,r),s=o.getLength(),c=Math.trunc(s/a),l=A.POLLEN_MAX_OFFSET,u,d;for(o.normalize(),u=0;u<=c;u++)d=O.add(r,O.multiply(o,u*a)),d.x+=I.randomRange(-l,l),d.y+=I.randomRange(-l,l),this.addPollen(d,e)}update(e){super.update(e),this.drawer.update(e);let t=this.pollens.length,n,r,i,a,o,s;for(n=0;n<t;n++)r=this.pollens[n],r&&(s=G.moveToTargetWithStatus(r.scaleX,r.endScaleX,1,e),r.scaleX=s.value,s.reachedZero&&(i=r.startScaleX,r.startScaleX=r.endScaleX,r.endScaleX=i),s=G.moveToTargetWithStatus(r.scaleY,r.endScaleY,1,e),r.scaleY=s.value,s.reachedZero&&(i=r.startScaleY,r.startScaleY=r.endScaleY,r.endScaleY=i),a=this.qw*r.scaleX,o=this.qh*r.scaleY,this.drawer.vertices[n]=new w(r.x-a/2,r.y-o/2,a,o),s=G.moveToTargetWithStatus(r.alpha,r.endAlpha,1,e),r.alpha=s.value,s.reachedZero&&(i=r.startAlpha,r.startAlpha=r.endAlpha,r.endAlpha=i),this.drawer.alphas[n]=r.alpha)}draw(){this.preDraw(),this.drawer.draw(),this.postDraw()}};function Bo(e){let t=e.x*this.PM+this.PMX,n=e.y*this.PM+this.PMY,r=e.length*this.PM,i=e.wheel,a=e.kickable??!1,o=e.kicked??!1,s=e.invisible??!1,c=e.moveLength*this.PM||-1,l=e.moveVertical,u=e.moveOffset*this.PM||0,d=e.spider,f=e.part===`L`,p=e.hidePath??!1,m=e.gun??!1,h=e.bindBulb??!1,g=new Y,_=e.radius;if(g.x=t,g.y=n,g.wheel=i,g.gun=m,g.kickable=a,g.kicked=o,g.invisible=s,g.setSpider(d),g.parseMover(e),g.mover&&(g.setBee(),!p)){let t=e.path?.[0]===`R`;this.pollenDrawer||=new zo;for(let e=0,n=g.mover.path.length-1;e<n;e++)(!t||e%3==0)&&this.pollenDrawer.fillWithPollenFromPath(e,e+1,g);g.mover.path.length>2&&this.pollenDrawer.fillWithPollenFromPath(0,g.mover.path.length-1,g)}if(_!==P.UNDEFINED&&(_*=this.PM),_===P.UNDEFINED&&!m){let e=this.star,i=!0;h&&this.lightbulbs.length>0?(e=this.lightbulbs[this.lightbulbs.length-1].constraint,i=!1):this.twoParts!==M.NONE&&(e=f?this.starL:this.starR);let a=new jr(null,t,n,e,e.pos.x,e.pos.y,r);a.bungeeAnchor.pin.copyFrom(a.bungeeAnchor.pos),g.setRope(a),i&&this.attachCandy(),g.kicked&&(a.bungeeAnchor.pin.x=P.UNDEFINED,a.bungeeAnchor.pin.y=P.UNDEFINED,a.bungeeAnchor.setWeight(.1))}if(g.setRadius(_),g.setMoveLength(c,l,u),g.gun&&g.gunArrow){let e=this.star;this.twoParts!==M.NONE&&(e=f?this.starL:this.starR);let t=O.subtract(new O(g.x,g.y),e.pos);g.gunArrow.rotation=z.toDegrees(t.normalizedAngle())}this.bungees.push(g)}function Vo(e){this.starL.pos.x=e.x*this.PM+this.PMX,this.starL.pos.y=e.y*this.PM+this.PMY;let t=this.getCandyResourceId(),n=this.getCandyConstants();this.candyL=new q,this.candyL.initTextureWithId(t),this.candyL.setTextureQuad(n.part_1),this.candyL.scaleX=this.candyL.scaleY=.71,this.candyL.passTransformationsToChilds=!1,this.candyL.doRestoreCutTransparency(),this.candyL.anchor=S.CENTER,this.candyL.x=this.starL.pos.x,this.candyL.y=this.starL.pos.y,this.candyL.bb=w.copy(A.CANDY_LR_BB)}function Ho(e){this.starR.pos.x=e.x*this.PM+this.PMX,this.starR.pos.y=e.y*this.PM+this.PMY;let t=this.getCandyResourceId(),n=this.getCandyConstants();this.candyR=new q,this.candyR.initTextureWithId(t),this.candyR.setTextureQuad(n.part_2),this.candyR.scaleX=this.candyR.scaleY=.71,this.candyR.passTransformationsToChilds=!1,this.candyR.doRestoreCutTransparency(),this.candyR.anchor=S.CENTER,this.candyR.x=this.starR.pos.x,this.candyR.y=this.starR.pos.y,this.candyR.bb=w.copy(A.CANDY_LR_BB)}function Uo(e){this.star.pos.x=e.x*this.PM+this.PMX,this.star.pos.y=e.y*this.PM+this.PMY}function Wo(e){this.gravityButton=new er,this.gravityButton.onButtonPressed=this.onButtonPressed.bind(this),this.gravityButton.visible=!1,this.gravityButton.touchable=!1,this.addChild(this.gravityButton),this.gravityButton.x=e.x*this.PM+this.PMX,this.gravityButton.y=e.y*this.PM+this.PMY,this.gravityButton.anchor=S.CENTER}var Go=class extends K{draw(){let e=C.context;if(!e){super.draw();return}let t=e.globalCompositeOperation;e.globalCompositeOperation=`lighter`,super.draw(),e.globalCompositeOperation=t}},Ko=1,qo=18,Jo=19,Yo=55,Xo=0,Zo=1,Qo=18,$o=19,es=24,ts=25,ns=30,rs=[n.SND_STAR_LIGHT_1,n.SND_STAR_LIGHT_2],is=.9,as=8,os=1.2,ss=class extends Nr{conveyorId=-1;time;timeout;timedAnim;isLit;nightMode;idleSprite;dimmedIdleSprite;glowSprite;lightUpAnim;lightDownAnim;bobTime=0;constructor(){super(),this.time=0,this.timeout=0,this.timedAnim=null,this.isLit=null,this.nightMode=!1,this.idleSprite=null,this.dimmedIdleSprite=null,this.glowSprite=null,this.lightUpAnim=null,this.lightDownAnim=null,this.drawPosIncrement=1e-4}enableNightMode(){this.nightMode=!0}createAnimations(){let e;if(this.timeout>0){this.timedAnim=new K,this.timedAnim.initTextureWithId(n.IMG_OBJ_STAR_IDLE),this.timedAnim.anchor=this.timedAnim.parentAnchor=S.CENTER;let t=this.timeout/(Yo-Jo+1);this.timedAnim.addAnimationEndpoints(0,t,o.LoopType.NO_LOOP,Jo,Yo),this.timedAnim.playTimeline(0),this.time=this.timeout,this.timedAnim.visible=!1,this.addChild(this.timedAnim);let r=new o;r.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,0)),r.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.5)),this.timedAnim.addTimelineWithID(r,1),e=new o,e.addKeyFrame(D.makeScale(1,1,D.TransitionType.LINEAR,0)),e.addKeyFrame(D.makeScale(0,0,D.TransitionType.LINEAR,.25)),e.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,0)),e.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.25)),this.addTimelineWithID(e,1)}this.bb=w.copy(A.STAR_DEFAULT_BB),this.bobTime=I.randomRange(0,20)/10;let t=new K;t.initTextureWithId(n.IMG_OBJ_STAR_IDLE),t.doRestoreCutTransparency(),t.addAnimationDelay(.05,o.LoopType.REPLAY,Ko,qo),t.playTimeline(0),t.getTimeline(0)?.update(I.randomRange(0,20)/10),t.anchor=t.parentAnchor=S.CENTER,this.idleSprite=t,this.nightMode&&(this.glowSprite=new q,this.glowSprite.initTextureWithId(n.IMG_OBJ_STAR_NIGHT),this.glowSprite.setTextureQuad(Xo),this.glowSprite.anchor=this.glowSprite.parentAnchor=S.CENTER,this.glowSprite.color.a=.4,this.addChild(this.glowSprite),this.dimmedIdleSprite=new K,this.dimmedIdleSprite.initTextureWithId(n.IMG_OBJ_STAR_NIGHT),this.dimmedIdleSprite.anchor=this.dimmedIdleSprite.parentAnchor=S.CENTER,this.dimmedIdleSprite.addAnimationDelay(.05,o.LoopType.REPLAY,Zo,Qo),this.dimmedIdleSprite.playTimeline(0),this.dimmedIdleSprite.color.a=0,this.addChild(this.dimmedIdleSprite)),this.addChild(t),this.nightMode&&(this.lightUpAnim=new Go,this.lightUpAnim.initTextureWithId(n.IMG_OBJ_STAR_NIGHT),this.lightUpAnim.anchor=this.lightUpAnim.parentAnchor=S.CENTER,this.lightUpAnim.addAnimationDelay(.05,o.LoopType.NO_LOOP,ts,ns),this.lightUpAnim.visible=!1,this.addChild(this.lightUpAnim),this.lightDownAnim=new K,this.lightDownAnim.initTextureWithId(n.IMG_OBJ_STAR_NIGHT),this.lightDownAnim.anchor=this.lightDownAnim.parentAnchor=S.CENTER,this.lightDownAnim.addAnimationDelay(.05,o.LoopType.NO_LOOP,$o,es),this.lightDownAnim.visible=!1,this.addChild(this.lightDownAnim),this.updateNightVisibility(),this.isLit||(this.quadToDraw=void 0))}setLitState(e){if(!this.nightMode){this.isLit=!0;return}if(this.isLit===e)return;let t=this.isLit===null;if(this.isLit=e,e){if(this.lightUpAnim&&!t){this.lightUpAnim.visible=!0;let e=this.lightUpAnim.getTimeline(0);e&&(e.onFinished=()=>{this.lightUpAnim&&(this.lightUpAnim.visible=!1)}),this.lightUpAnim.playTimeline(0)}if(!t&&rs.length>0){let e=I.randomRange(0,rs.length-1);U.playSound(rs[e])}}else if(this.lightDownAnim&&!t){this.lightDownAnim.visible=!0;let e=this.lightDownAnim.getTimeline(0);e&&(e.onFinished=()=>{this.lightDownAnim&&(this.lightDownAnim.visible=!1)}),this.lightDownAnim.playTimeline(0)}else t&&(this.glowSprite&&(this.glowSprite.color.a=0),this.idleSprite&&(this.idleSprite.color.a=0));this.updateNightVisibility()}updateNightVisibility(){this.nightMode&&(this.glowSprite&&(this.glowSprite.visible=!0),this.idleSprite&&(this.idleSprite.visible=!0),this.dimmedIdleSprite&&(this.dimmedIdleSprite.visible=!0))}adjustNightAlpha(e,t){if(!e)return;let n=Math.min(1,Math.max(0,e.color.a+t));e.color.a=n}update(e){if(this.timeout>0&&this.time>0&&(this.time=G.moveToTarget(this.time,0,1,e)),this.nightMode){let e=.1;this.isLit?(this.adjustNightAlpha(this.glowSprite,e),this.adjustNightAlpha(this.dimmedIdleSprite,-e),this.adjustNightAlpha(this.idleSprite,e)):(this.adjustNightAlpha(this.glowSprite,-e),this.adjustNightAlpha(this.dimmedIdleSprite,e),this.adjustNightAlpha(this.idleSprite,-e))}super.update(e),this.updateBobOffset(e)}updateBobOffset(e){this.bobTime+=e;let t=this.conveyorId===-1?3*Math.sin(3*this.bobTime):0;for(let e of this.getChildren())e.y=t}draw(){this.timedAnim&&this.timedAnim.draw(),super.draw()}getConveyorSize(){let e=this.bb??A.STAR_BB;return new O(e.w*is,e.h*is)}getConveyorPadding(){return as*A.PM/os}};function cs(e){let t=new ss;t.initTextureWithId(n.IMG_OBJ_STAR_IDLE),this.nightLevel&&t.enableNightMode(),t.x=e.x*this.PM+this.PMX,t.y=e.y*this.PM+this.PMY,t.timeout=e.timeout,t.createAnimations(),t.bb=w.copy(A.STAR_BB),t.parseMover(e),t.update(0);let r=this.stars.push(t),i=this.starDisappearPool[r-1]=new K;i.initTextureWithId(n.IMG_OBJ_STAR_DISAPPEAR),i.doRestoreCutTransparency(),i.anchor=S.CENTER,i.addAnimationDelay(.05,o.LoopType.NO_LOOP,0,12)}var ls=class extends Co{special;constructor(){super(),this.special=0}};function us(e){if(this.shouldSkipTutorialElement(e))return;if(e.text==null||e.text===``){lt.debug(`Missing tutorial text`);return}let t=new ls;t.x=e.x*this.PM+this.PMX,t.y=e.y*this.PM+this.PMY,t.special=e.special||0,t.align=S.HCENTER;let r=e.text,i=Math.ceil(e.width*this.PM);t.setText(n.FNT_SMALL_FONT,r,i,S.HCENTER),t.color=k.transparent.copy();let a=new o,s=J.pack===0&&J.level===0;a.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,0)),a.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,1)),a.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,s?10:5)),a.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.5)),t.addTimelineWithID(a,0),t.special===0&&t.playTimeline(0),this.tutorials.push(t)}function ds(e){if(this.shouldSkipTutorialElement(e))return;let t=e.name-Ua.TUTORIAL_01.id,r=new Nr;r.initTextureWithId(n.IMG_TUTORIAL_SIGNS),r.setTextureQuad(t),r.color=k.transparent.copy(),r.x=e.x*this.PM+this.PMX,r.y=e.y*this.PM+this.PMY,r.rotation=e.angle||0,r.special=e.special||0,r.parseMover(e);let i=new o;if(i.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,0)),i.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,1)),J.pack===0&&J.level===0?i.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,10)):i.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,5.2)),i.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.5)),r.addTimelineWithID(i,0),r.special===0)r.playTimeline(0);else if(r.special===2){let e=new o;e.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,0)),e.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,.5)),e.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,1)),e.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,1.1)),e.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.5)),e.addKeyFrame(D.makePos(r.x,r.y,D.TransitionType.LINEAR,0)),e.addKeyFrame(D.makePos(r.x,r.y,D.TransitionType.LINEAR,.5)),e.addKeyFrame(D.makePos(r.x,r.y,D.TransitionType.LINEAR,1)),e.addKeyFrame(D.makePos(r.x+A.TUTORIAL_HAND_TARGET_X_1,r.y,D.TransitionType.LINEAR,.5)),e.addKeyFrame(D.makePos(r.x+A.TUTORIAL_HAND_TARGET_X_2,r.y,D.TransitionType.LINEAR,.5)),e.loopsLimit=2,e.loopType=o.LoopType.REPLAY,r.addTimelineWithID(e,1),r.playTimeline(1)}this.tutorialImages.push(r)}var fs=class extends q{ingame;drawingIndex;constructor(e,t){super(),this.initTextureWithId(n.IMG_DRAWING_HIDDEN),this.setTextureQuad(e),this.ingame=!0,this.drawingIndex=t,this.passTransformationsToChilds=!1}showDrawing(){R.publish(R.ChannelId.DrawingClicked,this.drawingIndex)}};function ps(e){let t=e.name-Ua.HIDDEN_01.id,n=e.drawing-1;if(!E.disableHiddenDrawings){let r=new fs(t,n);r.x=e.x*this.PM+this.PMX,r.y=e.y*this.PM+this.PMY,r.rotation=e.angle||0,this.drawings.push(r)}}var ms=class extends q{popped;withoutShadow;capturedByBulb;conveyorId=-1;constructor(){super(),this.popped=!1,this.withoutShadow=!1,this.capturedByBulb=!1}draw(){this.withoutShadow||this.conveyorId!==-1?(this.preDraw(),this.postDraw()):super.draw()}};function hs(e){let t=I.randomRange(1,3),r=new ms;r.initTextureWithId(n.IMG_OBJ_BUBBLE_ATTACHED),r.setTextureQuad(t),r.doRestoreCutTransparency(),r.bb=w.copy(A.BUBBLE_BB),r.x=e.x*this.PM+this.PMX,r.y=e.y*this.PM+this.PMY,r.anchor=S.CENTER,r.popped=!1;let i=new j;i.initTextureWithId(n.IMG_OBJ_BUBBLE_ATTACHED),i.setTextureQuad(0),i.doRestoreCutTransparency(),i.parentAnchor=i.anchor=S.CENTER,r.addChild(i),this.bubbles.push(r)}var gs=class e extends q{angle;t1;t2;touchTimer;touch;static CONVEYOR_OFFSET=new O(.8,-1.2);constructor(){super(),this.angle=0,this.t1=O.newZero(),this.t2=O.newZero(),this.touchTimer=0,this.touch=0}updateRotation(){if(!this.bb)return;let e=this.bb.w/2;this.t1.x=this.x-e,this.t2.x=this.x+e,this.t1.y=this.t2.y=this.y,this.angle=z.fromDegrees(this.rotation),this.t1.rotateAround(this.angle,this.x,this.y),this.t2.rotateAround(this.angle,this.x,this.y)}getConveyorSize(){let e=A.PUMP_BB,t=.48;return new O(e.w*t,e.h*t)}getConveyorPadding(){let e=this.getConveyorSize();return(e.x+e.y)/4}getConveyorPosition(){let t=e.CONVEYOR_OFFSET.copy();return t.rotate(this.angle),O.add(new O(this.x,this.y),t)}setConveyorPosition(t){let n=e.CONVEYOR_OFFSET.copy();n.rotate(this.angle);let r=O.subtract(t,n);this.x=r.x,this.y=r.y}};function _s(e){let t=new gs;t.initTextureWithId(n.IMG_OBJ_PUMP),t.doRestoreCutTransparency(),t.addAnimationWithDelay(.05,o.LoopType.NO_LOOP,4,[1,2,3,0]),t.bb=w.copy(A.PUMP_BB),t.x=e.x*this.PM+this.PMX,t.y=e.y*this.PM+this.PMY,t.rotation=e.angle+90,t.updateRotation(),t.anchor=S.CENTER,this.pumps.push(t)}var vs=L?n.IMG_OBJ_SOCKS_XMAS:n.IMG_OBJ_SOCKS,ys=.28,bs=new O(-2.1,16),xs=1.2,Q=class e extends Nr{static Quads={IMG_OBJ_SOCKS_hat_01:0,IMG_OBJ_SOCKS_hat_02:1,IMG_OBJ_SOCKS_glow_start:2,IMG_OBJ_SOCKS_level:3,IMG_OBJ_SOCKS_glow_end:4};static StateType={RECEIVING:0,THROWING:1,IDLE:2};static IDLE_TIMEOUT=.8;group;angle;t1;t2;b1;b2;idleTimeout;light;constructor(){super(),this.group=0,this.angle=0,this.t1=new O(0,0),this.t2=new O(0,0),this.b1=new O(0,0),this.b2=new O(0,0),this.idleTimeout=0,this.light=null}createAnimations(){this.light=new K,this.light.initTextureWithId(vs),this.light.anchor=S.BOTTOM|S.HCENTER,this.light.parentAnchor=S.TOP|S.HCENTER,this.light.y=L?A.SOCK_LIGHT_Y-20:A.SOCK_LIGHT_Y,this.light.x=0,this.light.addAnimationSequence(0,.05,o.LoopType.NO_LOOP,4,[e.Quads.IMG_OBJ_SOCKS_glow_start,e.Quads.IMG_OBJ_SOCKS_glow_start+1,e.Quads.IMG_OBJ_SOCKS_glow_start+2,e.Quads.IMG_OBJ_SOCKS_glow_end]),this.light.doRestoreCutTransparency(),this.light.visible=!1,this.addChild(this.light)}playGlowAnimation(){this.light&&(this.light.visible=!0)}updateRotation(){this.t1.x=this.x-A.SOCK_WIDTH/2,this.t2.x=this.x+A.SOCK_WIDTH/2,this.t1.y=this.t2.y=this.y,this.b1.x=this.t1.x,this.b2.x=this.t2.x,this.b1.y=this.b2.y=this.y+A.SOCK_ROTATION_Y_OFFSET,this.angle=z.fromDegrees(this.rotation),this.t1.rotateAround(this.angle,this.x,this.y),this.t2.rotateAround(this.angle,this.x,this.y),this.b1.rotateAround(this.angle,this.x,this.y),this.b2.rotateAround(this.angle,this.x,this.y)}draw(){if(super.draw(),!this.light)return;let e=this.light.currentTimeline;e&&e.state===o.StateType.STOPPED&&this.light.visible&&(this.light.visible=!1)}drawBB(){}update(e){super.update(e),this.mover&&this.updateRotation()}getConveyorSize(){return new O(this.width*ys,this.height*ys)}getConveyorPadding(){let e=this.getConveyorSize();return(e.x+e.y)/4}getConveyorPosition(){let e=A.PM/xs,t=new O(bs.x*e,bs.y*e);return t.rotate(this.angle),O.add(new O(this.x,this.y),t)}setConveyorPosition(e){let t=A.PM/xs,n=new O(bs.x*t,bs.y*t);n.rotate(this.angle);let r=O.subtract(e,n);this.x=r.x,this.y=r.y}};function Ss(e){let t=L?n.IMG_OBJ_SOCKS_XMAS:n.IMG_OBJ_SOCKS,r=new Q;r.initTextureWithId(t),r.scaleX=r.scaleY=.7,r.createAnimations(),r.doRestoreCutTransparency(),r.x=e.x*this.PM+this.PMX,r.y=e.y*this.PM+this.PMY,r.group=e.group,r.anchor=S.TOP|S.HCENTER,r.rotationCenterY-=r.height/2-25,r.setTextureQuad(r.group===0?Q.Quads.IMG_OBJ_SOCKS_hat_01:Q.Quads.IMG_OBJ_SOCKS_hat_02),r.state=Q.StateType.IDLE,r.parseMover(e),r.rotation+=90,r.mover&&(r.mover.angle+=90),r.updateRotation(),this.socks.push(r)}var Cs=10,ws=0,Ts=1,Es=4,Ds=0,Os=0,ks=1,As={ELECTRODES_BASE:0,ELECTRODES_ELECTRIC:1,ROTATION_ADJUSTED:2},js=class extends Nr{rotateButton;spikesNormal;originalRotation;t1;t2;b1;b2;electro;initialDelay;onTime;offTime;electroOn;electroTimer;electroInstanceKey;toggled;shouldUpdateRotation;touchIndex;angle;onButtonPressed;constructor(e,t,r,i,a){super();let s;if(a!==P.UNDEFINED)s=n.IMG_OBJ_ROTATABLE_SPIKES_01+r-1;else switch(r){case 1:s=n.IMG_OBJ_SPIKES_01;break;case 2:s=n.IMG_OBJ_SPIKES_02;break;case 3:s=n.IMG_OBJ_SPIKES_03;break;case 4:s=n.IMG_OBJ_SPIKES_04;break;case 5:s=n.IMG_OBJ_ELECTRODES;break;default:s=n.IMG_OBJ_SPIKES_01;break}if(this.initTextureWithId(s),this.rotateButton=null,a>0){this.doRestoreCutTransparency();let e=Os+(a-1)*2,t=ks+(a-1)*2,r=j.create(n.IMG_OBJ_ROTATABLE_SPIKES_BUTTON,e),i=j.create(n.IMG_OBJ_ROTATABLE_SPIKES_BUTTON,t);r.doRestoreCutTransparency(),i.doRestoreCutTransparency(),this.rotateButton=new Yn(Ds),this.rotateButton.initWithElements(r,i),this.rotateButton.onButtonPressed=this.handleButtonPressed.bind(this),this.rotateButton.anchor=this.rotateButton.parentAnchor=S.CENTER,this.addChild(this.rotateButton);let o=r.texture,s=o.offsets[e],c=o.rects[e],l=new O(c.w,c.h),u=new O(o.preCutSize.x,o.preCutSize.y);u.subtract(l),u.subtract(s),this.rotateButton.setTouchIncrease(-s.x+l.x/2,-u.x+l.x/2,-s.y+l.y/2,-u.y+l.y/2)}this.passColorToChilds=!1,this.spikesNormal=!1,this.originalRotation=this.rotation=i,this.t1=O.newZero(),this.t2=O.newZero(),this.b1=O.newZero(),this.b2=O.newZero(),this.electro=!1,this.initialDelay=0,this.onTime=0,this.offTime=0,this.electroOn=!1,this.electroTimer=0,this.x=e,this.y=t,this.electroInstanceKey=`${Math.round(e)}_${Math.round(t)}`,this.toggled=P.UNDEFINED,this.onButtonPressed=null,this.shouldUpdateRotation=!1,this.touchIndex=P.UNDEFINED,this.angle=0,this.setToggled(a),this.updateRotation(),r===5&&(this.addAnimationEndpoints(As.ELECTRODES_BASE,.05,o.LoopType.REPLAY,ws,ws),this.addAnimationEndpoints(As.ELECTRODES_ELECTRIC,.05,o.LoopType.REPLAY,Ts,Es),this.doRestoreCutTransparency()),this.touchIndex=P.UNDEFINED}updateRotation(){let e=this.texture;if(!e)return;let t=this.quadToDraw,n=t===void 0?null:e.rects[t],r=this.electro?this.width-400*A.CANVAS_SCALE:n?.w??this.width;r/=2,this.t1.x=this.x-r,this.t2.x=this.x+r,this.t1.y=this.t2.y=this.y-Cs/2,this.b1.x=this.t1.x,this.b2.x=this.t2.x,this.b1.y=this.b2.y=this.y+Cs/2,this.angle=z.fromDegrees(this.rotation),this.t1.rotateAround(this.angle,this.x,this.y),this.t2.rotateAround(this.angle,this.x,this.y),this.b1.rotateAround(this.angle,this.x,this.y),this.b2.rotateAround(this.angle,this.x,this.y)}turnElectroOn(){this.electroOn=!0,this.playTimeline(As.ELECTRODES_ELECTRIC),this.electroTimer=this.onTime;let e=Math.max(0,this.initialDelay*1e3)+Math.random()*30;U.playLoopedSound(n.SND_ELECTRIC,this.electroInstanceKey,e)}turnElectroOff(){this.electroOn=!1,this.playTimeline(As.ELECTRODES_BASE),this.electroTimer=this.offTime,U.stopLoopedSoundInstance(n.SND_ELECTRIC,this.electroInstanceKey)}update(e){super.update(e),(this.mover||this.shouldUpdateRotation)&&this.updateRotation(),this.electro&&(this.electroOn?(this.electroTimer=G.moveToTarget(this.electroTimer,0,1,e),this.electroTimer===0&&this.turnElectroOff()):(this.electroTimer=G.moveToTarget(this.electroTimer,0,1,e),this.electroTimer===0&&this.turnElectroOn()))}setToggled(e){this.toggled=e}getToggled(){return this.toggled}rotateSpikes(){this.spikesNormal=!this.spikesNormal,this.removeTimeline(As.ROTATION_ADJUSTED);let e=this.spikesNormal?90:0,t=this.originalRotation+e,n=new o;n.addKeyFrame(D.makeRotation(this.rotation,D.TransitionType.LINEAR,0)),n.addKeyFrame(D.makeRotation(t,D.TransitionType.EASE_OUT,Math.abs(t-this.rotation)/90*.3)),n.onFinished=this.timelineFinished.bind(this),this.addTimelineWithID(n,As.ROTATION_ADJUSTED),this.playTimeline(As.ROTATION_ADJUSTED),this.shouldUpdateRotation=!0,this.rotateButton&&(this.rotateButton.scaleX=-this.rotateButton.scaleX)}timelineFinished(e){this.updateRotation(),this.shouldUpdateRotation=!1}handleButtonPressed(e){e===Ds&&(this.onButtonPressed&&this.toggled&&this.onButtonPressed(this.toggled),this.spikesNormal?U.playSound(n.SND_SPIKE_ROTATE_IN):U.playSound(n.SND_SPIKE_ROTATE_OUT))}drawBB(){let e=C.context;e&&(e.beginPath(),e.strokeStyle=`red`,e.moveTo(this.t1.x,this.t1.y),e.lineTo(this.t2.x,this.t2.y),e.lineTo(this.b2.x,this.b2.y),e.lineTo(this.b1.x,this.b1.y),e.lineTo(this.t1.x,this.t1.y),e.closePath(),e.stroke())}};function Ms(e){let t=e.x*this.PM+this.PMX,n=e.y*this.PM+this.PMY,r=e.size,i=e.angle??0,a=e.toggled===!1?P.UNDEFINED:e.toggled||P.UNDEFINED,o=new js(t,n,r,i,a);o.parseMover(e),a&&(o.onButtonPressed=this.rotateAllSpikesWithId.bind(this)),e.name===Ua.ELECTRO.id?(o.electro=!0,o.initialDelay=e.initialDelay??0,o.onTime=e.onTime??0,o.offTime=e.offTime??0,o.electroTimer=0,o.turnElectroOff(),o.electroTimer+=o.initialDelay,o.updateRotation()):o.electro=!1,this.spikes.push(o)}var Ns=0,Ps=1,Fs=2,Is=3,Ls=4,Rs=5,zs=.2,Bs=.75,Vs=.4,Hs=.5,Us=167;15*A.PM;var Ws=7*A.PM,Gs=3*A.PM,Ks=22.5*A.PM,qs=.03*A.PM,Js=class extends j{drawPosIncrement;constructor(){super(),this.initTextureWithId(n.IMG_OBJ_VINIL),this.setTextureQuad(Fs),this.drawPosIncrement=0}},Ys=class e extends T{containedObjects;circles;soundPlaying;lastTouch;vinilStickerL;vinilStickerR;vinilActiveControllerL;vinilActiveControllerR;vinil;vinilCenter;vinilHighlightL;vinilHighlightR;vinilControllerL;vinilControllerR;size;sizeInPixels;zone;operating;handle1;handle2;constructor(){super(),this.containedObjects=[],this.circles=[],this.soundPlaying=P.UNDEFINED,this.lastTouch=O.newUndefined(),this.size=0,this.sizeInPixels=0,this.operating=P.UNDEFINED,this.vinilStickerL=new Js,this.vinilStickerL.anchor=S.RIGHT|S.VCENTER,this.vinilStickerL.scaleX=1,this.vinilStickerL.parentAnchor=S.CENTER,this.vinilStickerL.rotationCenterX=this.vinilStickerL.width/2+.5,this.vinilStickerL.drawPosIncrement=.001,this.vinilStickerR=new Js,this.vinilStickerR.scaleX=-1,this.vinilStickerR.anchor=S.RIGHT|S.VCENTER,this.vinilStickerR.parentAnchor=S.CENTER,this.vinilStickerR.rotationCenterX=this.vinilStickerR.width/2-.5,this.vinilStickerR.drawPosIncrement=.001,this.vinilCenter=j.create(n.IMG_OBJ_VINIL,Is),this.vinilCenter.anchor=S.CENTER,this.vinilHighlightL=j.create(n.IMG_OBJ_VINIL,Ps),this.vinilHighlightL.anchor=S.TOP|S.RIGHT,this.vinilHighlightR=j.create(n.IMG_OBJ_VINIL,Ps),this.vinilHighlightR.scaleX=-1,this.vinilHighlightR.anchor=S.TOP|S.LEFT,this.vinilControllerL=j.create(n.IMG_OBJ_VINIL,Rs),this.vinilControllerL.anchor=S.CENTER,this.vinilControllerL.rotation=90,this.vinilControllerR=j.create(n.IMG_OBJ_VINIL,Rs),this.vinilControllerR.anchor=S.CENTER,this.vinilControllerR.rotation=-90,this.vinilActiveControllerL=j.create(n.IMG_OBJ_VINIL,Ls),this.vinilActiveControllerL.anchor=this.vinilControllerL.anchor,this.vinilActiveControllerL.rotation=this.vinilControllerL.rotation,this.vinilActiveControllerL.visible=!1,this.vinilActiveControllerR=j.create(n.IMG_OBJ_VINIL,Ls),this.vinilActiveControllerR.anchor=this.vinilControllerR.anchor,this.vinilActiveControllerR.rotation=this.vinilControllerR.rotation,this.vinilActiveControllerR.visible=!1,this.vinil=j.create(n.IMG_OBJ_VINIL,Ns),this.vinil.anchor=S.CENTER,this.passColorToChilds=!1,this.addChild(this.vinilStickerL),this.addChild(this.vinilStickerR),this.addChild(this.vinilActiveControllerL),this.addChild(this.vinilActiveControllerR),this.addChild(this.vinilControllerL),this.addChild(this.vinilControllerR)}setSize(e){this.size=e;let t=this.size/Us;this.vinilHighlightL.scaleX=this.vinilHighlightL.scaleY=this.vinilHighlightR.scaleY=t,this.vinilHighlightR.scaleX=-t,this.vinil.scaleX=this.vinil.scaleY=t;let n=t>=Vs?t:Vs;this.vinilStickerL.scaleX=this.vinilStickerL.scaleY=this.vinilStickerR.scaleY=n,this.vinilStickerR.scaleX=-n;let r=t>=Bs?t:Bs;this.vinilControllerL.scaleX=this.vinilControllerL.scaleY=this.vinilControllerR.scaleX=this.vinilControllerR.scaleY=r,this.vinilActiveControllerL.scaleX=this.vinilActiveControllerL.scaleY=this.vinilActiveControllerR.scaleX=this.vinilActiveControllerR.scaleY=r,this.vinilCenter.scaleX=1-(1-n)*Hs,this.vinilCenter.scaleY=this.vinilCenter.scaleX,this.sizeInPixels=this.vinilHighlightL.width*this.vinilHighlightL.scaleX,this.updateChildPositions()}hasOneHandle(){return!this.vinilControllerL.visible}setHasOneHandle(e){this.vinilControllerL.visible=!e}isLeftControllerActive(){return this.vinilActiveControllerL.visible}setIsLeftControllerActive(e){this.vinilActiveControllerL.visible=e}isRightControllerActive(){return this.vinilActiveControllerR.visible}setIsRightControllerActive(e){this.vinilActiveControllerR.visible=e}containsSameObjectWithAnotherCircle(){let e=this.circles.length,t;for(t=0;t<e;t++){let e=this.circles[t];if(e&&e!=this&&this.containsSameObjectWithCircle(e))return!0}return!1}draw(){let e=C.context;if(this.isRightControllerActive()||this.isLeftControllerActive()){let t=(Gs+A.PM)*this.vinilControllerL.scaleX;if(!this.sizeInPixels)return;let n=this.sizeInPixels+Math.trunc(t/2);e&&(e.beginPath(),e.strokeStyle=`white`,e.lineWidth=t,e.arc(this.x,this.y,n,0,2*Math.PI,!1),e.stroke())}this.vinilHighlightL.color=this.color,this.vinilHighlightR.color=this.color,this.vinilControllerL.color=this.color,this.vinilControllerR.color=this.color,this.vinil.color=this.color,this.vinil.draw();let t=this.circles.length,n=this.circles.indexOf(this);if(!e)return;let r=e.globalAlpha,i;for(r!==zs&&(e.globalAlpha=zs),i=0;i<t;i++){let e=this.circles[i];!e||!this.sizeInPixels||!e.sizeInPixels||e!=this&&e.containsSameObjectWithAnotherCircle()&&this.circles.indexOf(e)<n&&this.drawCircleIntersection(this.x,this.y,this.sizeInPixels,e.x,e.y,e.sizeInPixels,Ws*e.vinilHighlightL.scaleX*.5)}r!==zs&&(e.globalAlpha=r),this.vinilHighlightL.draw(),this.vinilHighlightR.draw(),super.draw(),this.vinilCenter.draw()}drawCircleIntersection(e,t,n,r,i,a,o){let s=O.distance(e,t,r,i);if(s>=n+a||n>=s+a)return;let c=s-(n*n-a*a+s*s)/(2*s),l=Math.acos(c/a),u=new O(e-r,t-i).angle(),d=u-l,f=u+l;r>e&&(d+=Math.PI,f+=Math.PI);let p=C.context;p&&(p.beginPath(),p.strokeStyle=`white`,p.lineWidth=o,p.arc(r,i,a,d,f,!1),p.stroke())}updateChildPositions(){this.vinil.x=this.vinilCenter.x=this.x,this.vinil.y=this.vinilCenter.y=this.y;let e=this.vinilHighlightL.width/2*(1-this.vinilHighlightL.scaleX),t=this.vinilHighlightL.height/2*(1-this.vinilHighlightL.scaleY);if(!this.sizeInPixels||!this.size)return;let n=this.sizeInPixels-(Ks-qs*this.size)+(1-this.vinilControllerL.scaleX)*(this.vinilControllerL.width/2);this.vinilHighlightL.x=this.x+e,this.vinilHighlightR.x=this.x-e,this.vinilHighlightL.y=this.vinilHighlightR.y=this.y-t,this.vinilControllerL.x=this.x-n,this.vinilControllerR.x=this.x+n,this.vinilControllerL.y=this.vinilControllerR.y=this.y,this.vinilActiveControllerL.x=this.vinilControllerL.x,this.vinilActiveControllerL.y=this.vinilControllerL.y,this.vinilActiveControllerR.x=this.vinilControllerR.x,this.vinilActiveControllerR.y=this.vinilControllerR.y}containsSameObjectWithCircle(e){if(this.x===e.x&&this.y===e.y&&this.size===e.size)return!1;let t=this.containedObjects.length,n;for(n=0;n<t;n++){let t=this.containedObjects[n];if(t&&e.containedObjects.indexOf(t)>=0)return!0}return!1}copy(t){let n=new e;if(t?n.zone=t:delete n.zone,n.x=this.x,n.y=this.y,n.rotation=this.rotation,n.circles=this.circles,n.containedObjects=this.containedObjects,n.operating=P.UNDEFINED,!this.size)return;let r=this.size*A.PM,i=z.fromDegrees(n.rotation);return n.handle1=new O(n.x-r,n.y),n.handle2=new O(n.x+r,n.y),n.handle1.rotateAround(i,n.x,n.y),n.handle2.rotateAround(i,n.x,n.y),n.setSize(this.size),n.setHasOneHandle(this.hasOneHandle()),n.vinilControllerL.visible=!1,n.vinilControllerR.visible=!1,n}};function Xs(e){let t=e.x*this.PM+this.PMX,n=e.y*this.PM+this.PMY,r=e.size,i=e.handleAngle??0,a=z.fromDegrees(i),o=e.oneHandle,s=new Ys;s.anchor=S.CENTER,s.x=t,s.y=n,s.rotation=i,s.handle1=new O(s.x-r*this.PM,s.y),s.handle2=new O(s.x+r*this.PM,s.y),s.handle1.rotateAround(a,s.x,s.y),s.handle2.rotateAround(a,s.x,s.y),s.setSize(r),s.setHasOneHandle(o),this.rotatedCircles.push(s)}var Zs=10,Qs=0,$s=4,ec=class extends Nr{angle;skip;t1;t2;b1;b2;constructor(e,t,r,i){super(),this.angle=0,this.skip=0,this.t1=O.newZero(),this.t2=O.newZero(),this.b1=O.newZero(),this.b2=O.newZero();let a=P.UNDEFINED;r===1?a=n.IMG_OBJ_BOUNCER_01:r===2&&(a=n.IMG_OBJ_BOUNCER_02),this.initTextureWithId(a),this.rotation=i,this.x=e,this.y=t,this.updateRotation();let s=.04,c=this.addAnimationDelay(s,o.LoopType.NO_LOOP,Qs,$s),l=this.getTimeline(c);l&&l.addKeyFrame(D.makeSingleAction(this,b.SET_DRAWQUAD,0,0,s))}updateRotation(){let e=this.x,t=this.y,n=this.width/2;this.t1.x=e-n,this.t2.x=e+n,this.t1.y=this.t2.y=t-Zs/2,this.b1.x=this.t1.x,this.b2.x=this.t2.x,this.b1.y=this.b2.y=t+Zs/2;let r=this.angle=z.fromDegrees(this.rotation);this.t1.rotateAround(r,e,t),this.t2.rotateAround(r,e,t),this.b1.rotateAround(r,e,t),this.b2.rotateAround(r,e,t)}update(e){super.update(e),this.mover&&this.updateRotation()}getConveyorSize(){return new O(this.width,this.height)}getConveyorPadding(){let e=this.getConveyorSize();return(e.x+e.y)/4}};function tc(e){let t=e.x*this.PM+this.PMX,n=e.y*this.PM+this.PMY,r=e.size,i=e.angle,a=new ec(t,n,r,i);a.parseMover(e),this.bouncers.push(a)}var nc=class extends T{steamState;heightScale;phase;tube;valve;steamBack;steamFront;onConveyor=!1;constructor(e,t,r=A.PM){super(),this.heightScale=r,this.steamState=0,this.phase=0,this.anchor=S.CENTER,this.x=e.x,this.y=e.y,this.rotation=t,this.tube=j.create(n.IMG_OBJ_PIPE,0),this.tube.anchor=S.TOP|S.HCENTER,this.tube.parentAnchor=S.CENTER,this.tube.x=0,this.tube.y=0,this.addChild(this.tube),this.valve=j.create(n.IMG_OBJ_PIPE,1),this.valve.anchor=S.CENTER,this.valve.parentAnchor=S.CENTER,this.valve.x=0,this.valve.y=27*this.heightScale,this.addChild(this.valve),this.steamBack=new T,this.steamBack.anchor=this.steamBack.parentAnchor=S.CENTER,this.addChild(this.steamBack),this.steamFront=new T,this.steamFront.anchor=this.steamFront.parentAnchor=S.CENTER,this.addChild(this.steamFront),this.adjustSteam(),this.setupValveTimelines()}drawBack(){let e=C.context;this.preDraw(),this.tube.draw(),this.valve.draw(),this.steamBack.draw(),e?.restore()}drawFront(){let e=C.context;this.preDraw(),this.steamFront.draw(),e?.restore()}getCurrentHeightModulated(){return this.getCurrentHeight()+this.heightScale*Math.sin(6*this.phase)}getHeightScale(){return this.heightScale}update(e){super.update(e),this.phase+=e}onTouchDown(e,t){let r;if(this.onConveyor)r=new O(this.x,this.y);else{let e=new O(0,27*this.heightScale);e.rotate(z.fromDegrees(this.rotation)),r=O.add(new O(this.x,this.y),e)}if(O.distance(e,t,r.x,r.y)>=30)return!1;let i=0;switch(this.steamState){case 0:this.steamState=1,U.playSound(n.SND_STEAM_START2);break;case 1:this.steamState=2,U.playSound(n.SND_STEAM_START);break;default:this.steamState=0,i=1,U.playSound(n.SND_STEAM_END);break}this.adjustSteam();let a=this.valve.getTimeline(0),s=this.valve.getTimeline(1);return a?.state!==o.StateType.PLAYING&&s?.state!==o.StateType.PLAYING&&this.valve.playTimeline(i),!0}setupValveTimelines(){let e=new o;e.addKeyFrame(D.makeRotation(0,D.TransitionType.LINEAR,0)),e.addKeyFrame(D.makeRotation(180,D.TransitionType.LINEAR,.55)),this.valve.addTimelineWithID(e,0);let t=new o;t.addKeyFrame(D.makeRotation(0,D.TransitionType.LINEAR,0)),t.addKeyFrame(D.makeRotation(-180,D.TransitionType.LINEAR,.55)),this.valve.addTimelineWithID(t,1)}getCurrentHeight(){return(this.steamState===0?32.9:this.steamState===1?94:this.steamState===2?141:0)*this.heightScale}adjustSteam(){this.phase=0;let e=e=>{for(let t of e.getChildren()){let e=t.getTimeline(0);e&&(e.loopType=o.LoopType.NO_LOOP)}};if(e(this.steamBack),e(this.steamFront),this.steamState===3)return;this.steamBack.anchor=this.steamBack.parentAnchor=S.CENTER,this.steamFront.anchor=this.steamFront.parentAnchor=S.CENTER;let t=7;this.steamState===1?t=14:this.steamState===2&&(t=20);for(let e=0;e<t;e++){let r=24,i=34;e%3==1?(r=13,i=23):e%3==2&&(r=2,i=12);let a=.6,s=a/(i-r+1),c=-this.getCurrentHeight();c*=1+.1*I.randomMinus1to1(),this.steamState===1&&(e%3==1||e%3==2)&&(c*=.95),this.steamState===2&&(e%3==1||e%3==2)&&(c*=.94);let l=1;e%3==0?l=0:e%3==1?l*=this.steamState:e%3==2&&(l*=-this.steamState);let u=new K;u.initTextureWithId(n.IMG_OBJ_PIPE),u.doRestoreCutTransparency(),u.addAnimationEndpoints(0,s,o.LoopType.REPLAY,r,i),u.anchor=u.parentAnchor=S.CENTER;let d=new o;d.addKeyFrame(D.makePos(0,0,D.TransitionType.IMMEDIATE,0)),d.addKeyFrame(D.makePos(l,c,D.TransitionType.EASE_OUT,a)),d.addKeyFrame(D.makeScale(1,1,D.TransitionType.IMMEDIATE,0)),d.addKeyFrame(D.makeScale(1.5,1.5,D.TransitionType.LINEAR,a)),d.loopType=o.LoopType.REPLAY,d.onFinished=this.removeFinishedPuff;let f=new T;f.anchor=f.parentAnchor=S.CENTER,f.addTimelineWithID(d,0),f.setEnabled(!1),f.addChild(u);let p=a*e/t;Za.callObject(this,this.startPuffFloatingAndAnimation,[f],p),e%3==0?this.steamBack.addChild(f):this.steamFront.addChild(f)}}startPuffFloatingAndAnimation(e){e.setEnabled(!0),e.playTimeline(0);let t=e.childCount()-1;e.getChild(t)?.playTimeline(0)}removeFinishedPuff(e){let t=e.element,n=t?.parent;n&&t&&n.removeChild(t)}getConveyorSize(){return new O(40,56)}getConveyorPadding(){return 40*.3}setConveyorPosition(e){this.onConveyor=!0,this.tube.y=-24*this.heightScale,this.valve.y=3*this.heightScale,this.steamBack.y=-27*this.heightScale,this.steamFront.y=-27*this.heightScale,this.x=e.x,this.y=e.y}};function rc(e){let t=new O(e.x*this.PM+this.PMX,e.y*this.PM+this.PMY),n=(e.scale??1)*this.PM,r=new nc(t,e.angle??0,n);this.tubes.push(r)}function ic(e){let t=new q,r=t;this.target=t;let i=E.boxTypes?.[J.pack]===p.HOLIDAY,a=c;this.pendingPaddingtonIdleTransition=!1;let s;t.initTextureWithId(n.IMG_CHAR_ANIMATIONS),t.initTextureWithId(n.IMG_CHAR_ANIMATIONS2),t.initTextureWithId(n.IMG_CHAR_ANIMATIONS3),a&&t.initTextureWithId(n.IMG_CHAR_ANIMATION_PADDINGTON),this.nightLevel&&t.initTextureWithId(n.IMG_CHAR_ANIMATIONS_SLEEPING),L&&(t.initTextureWithId(n.IMG_CHAR_GREETINGS_XMAS),t.initTextureWithId(n.IMG_CHAR_IDLE_XMAS)),r.doRestoreCutTransparency(),r.bb=w.copy(A.TARGET_BB),r.bbOverride=w.copy(A.TARGET_BB);let l=r.playTimeline;if(r.playTimeline=function(e){l.call(this,e);let t=this;t.bbOverride&&(t.bb=w.copy(t.bbOverride),t.rbb&&=new wt(t.bb.x,t.bb.y,t.bb.w,t.bb.h))},r.drawPosIncrement=1e-4,r.addAnimationEndpoints(g.GREETING,.05,o.LoopType.NO_LOOP,47,76,void 0,n.IMG_CHAR_ANIMATIONS2),r.addAnimationEndpoints(g.GREETINGXMAS,.05,o.LoopType.NO_LOOP,0,33,void 0,n.IMG_CHAR_GREETINGS_XMAS),r.addAnimationEndpoints(g.IDLE,.05,o.LoopType.REPLAY,0,18,void 0,n.IMG_CHAR_ANIMATIONS),this.nightLevel){r.addAnimationEndpoints(g.SLEEPING,.05,o.LoopType.NO_LOOP,0,6,void 0,n.IMG_CHAR_ANIMATIONS_SLEEPING);let e=[];for(s=7;s<=43;s++)e.push(s);let t=Array(15).fill(7),i=[...e,...t],a=[...t,...e];this.sleepAnimPrimary=new K,this.sleepAnimPrimary.initTextureWithId(n.IMG_CHAR_ANIMATIONS_SLEEPING),this.sleepAnimPrimary.anchor=this.sleepAnimPrimary.parentAnchor=S.CENTER,this.sleepAnimPrimary.doRestoreCutTransparency(),this.sleepAnimPrimary.addAnimationSequence(0,1/30,o.LoopType.REPLAY,i.length,i,n.IMG_CHAR_ANIMATIONS_SLEEPING),this.sleepAnimPrimary.playTimeline(0),this.sleepAnimPrimary.visible=!1,this.sleepAnimSecondary=new K,this.sleepAnimSecondary.initTextureWithId(n.IMG_CHAR_ANIMATIONS_SLEEPING),this.sleepAnimSecondary.anchor=this.sleepAnimSecondary.parentAnchor=S.CENTER,this.sleepAnimSecondary.doRestoreCutTransparency(),this.sleepAnimSecondary.addAnimationSequence(0,1/30,o.LoopType.REPLAY,a.length,a,n.IMG_CHAR_ANIMATIONS_SLEEPING),this.sleepAnimSecondary.playTimeline(0),this.sleepAnimSecondary.visible=!1}else this.sleepAnimPrimary=null,this.sleepAnimSecondary=null;r.addAnimationEndpoints(g.IDLE2,.05,o.LoopType.NO_LOOP,43,67,void 0,n.IMG_CHAR_ANIMATIONS),r.addAnimationEndpoints(g.IDLEXMAS,.05,o.LoopType.NO_LOOP,0,30,void 0,n.IMG_CHAR_IDLE_XMAS),r.addAnimationEndpoints(g.IDLE2XMAS,.05,o.LoopType.NO_LOOP,31,61,void 0,n.IMG_CHAR_IDLE_XMAS);let u=[];for(s=68;s<=83;s++)u.push(s);for(s=68;s<=83;s++)u.push(s);if(t.addAnimationSequence(g.IDLE3,.05,o.LoopType.NO_LOOP,u.length,u,n.IMG_CHAR_ANIMATIONS),a&&i){t.addAnimationEndpoints(g.IDLEPADDINGTON,.05,o.LoopType.NO_LOOP,0,38,void 0,n.IMG_CHAR_ANIMATION_PADDINGTON);let e=t.getTimeline(g.IDLEPADDINGTON);e&&(e.onKeyFrame=this.onPaddingtonIdleKeyFrame.bind(this)),t.setDelay(.75,1,g.IDLEPADDINGTON),t.setDelay(.75,2,g.IDLEPADDINGTON),this.paddingtonFinalFrame=j.create(n.IMG_CHAR_ANIMATION_PADDINGTON,39),this.paddingtonFinalFrame.doRestoreCutTransparency(),this.paddingtonFinalFrame.anchor=S.CENTER,this.paddingtonFinalFrame.parentAnchor=S.CENTER,this.paddingtonFinalFrame.visible=!1,t.addChild(this.paddingtonFinalFrame)}else this.paddingtonFinalFrame=null;t.addAnimationEndpoints(g.EXCITED,.05,o.LoopType.NO_LOOP,0,19,void 0,n.IMG_CHAR_ANIMATIONS2),t.addAnimationEndpoints(g.PUZZLED,.05,o.LoopType.NO_LOOP,20,46,void 0,n.IMG_CHAR_ANIMATIONS2),t.addAnimationEndpoints(g.FAIL,.05,o.LoopType.NO_LOOP,0,12,void 0,n.IMG_CHAR_ANIMATIONS3),t.addAnimationEndpoints(g.WIN,.05,o.LoopType.NO_LOOP,28,31,void 0,n.IMG_CHAR_ANIMATIONS),t.addAnimationEndpoints(g.MOUTH_OPEN,.05,o.LoopType.NO_LOOP,19,27,void 0,n.IMG_CHAR_ANIMATIONS),t.addAnimationEndpoints(g.MOUTH_CLOSE,.05,o.LoopType.NO_LOOP,28,31,void 0,n.IMG_CHAR_ANIMATIONS),t.addAnimationEndpoints(g.CHEW,.05,o.LoopType.REPLAY,32,40,void 0,n.IMG_CHAR_ANIMATIONS),t.switchToAnimation(g.CHEW,g.WIN,.05),t.switchToAnimation(g.PUZZLED,g.MOUTH_CLOSE,.05),t.switchToAnimation(g.IDLE,g.GREETING,.05),t.switchToAnimation(g.IDLE,g.GREETINGXMAS,.05),t.switchToAnimation(g.IDLE,g.IDLE2,.05),t.switchToAnimation(g.IDLE,g.IDLE3,.05),t.switchToAnimation(g.IDLE,g.IDLEXMAS,.05),t.switchToAnimation(g.IDLE,g.IDLE2XMAS,.05),t.switchToAnimation(g.IDLE,g.EXCITED,.05),t.switchToAnimation(g.IDLE,g.PUZZLED,.05),qt.showGreeting&&=(!(a&&i)&&!this.nightLevel&&this.dd.callObject(this,this.showGreeting,null,2),!1),a&&i?this.playPaddingtonIntro():this.nightLevel?t.playTimeline(g.SLEEPING):t.playTimeline(g.IDLE);let d=t.getTimeline(g.IDLE);d&&(d.onKeyFrame=this.onIdleOmNomKeyFrame.bind(this)),t.setPause(8,g.MOUTH_OPEN),this.blink=new K,this.blink.initTextureWithId(n.IMG_CHAR_ANIMATIONS),this.blink.parentAnchor=S.TOP|S.LEFT,this.blink.visible=!1,this.blink.addAnimationSequence(0,.05,o.LoopType.NO_LOOP,4,[41,42,42,42]),this.blink.setAction(b.SET_VISIBLE,this.blink,0,0,2,0),this.blinkTimer=3,this.blink.doRestoreCutTransparency(),t.addChild(this.blink);let f=E.supports?.[J.pack]??null,m=i?n.IMG_CHAR_SUPPORTS_XMAS:n.IMG_CHAR_SUPPORTS,h=i?a?1:0:f;this.support=j.create(m,h),this.support.doRestoreCutTransparency(),this.support.anchor=S.CENTER;let _=e.x,v=e.y,y=_*this.PM+this.PMX|0,x=v*this.PM+this.PMY|0,ee=i&&a?75:0;this.target.x=y,this.target.y=x,this.support.x=y,this.support.y=x+ee,this.idlesTimer=I.randomRange(5,20)}var ac=class extends ms{clouds;bubbleOutlineIndex=-1;constructor(){super(),this.clouds=[]}initAt(e,t){this.initTextureWithId(n.IMG_OBJ_BUBBLE_ATTACHED);let r=Math.floor(Math.random()*3)+1;this.setTextureQuad(r),this.doRestoreCutTransparency(),this.bb=w.copy(A.BUBBLE_BB),this.x=e,this.y=t,this.anchor=S.CENTER,this.popped=!1;let i=j.create(n.IMG_OBJ_BUBBLE_ATTACHED,0);return i.doRestoreCutTransparency(),i.parentAnchor=i.anchor=S.CENTER,this.addChild(i),this.bubbleOutlineIndex=this.children.indexOf(i),this.addSupportingClouds(),this}addSupportingClouds(){this.addBackCloud(63.75,18.75,6,.8,.78,.76,.48),this.addBackCloud(48.75,41.25,5,.93,.965,1,.4),this.addBackCloud(-67.5,11.25,5,.33,.365,.4,.43),this.addBackCloud(-56.25,33.75,6,.6,.565,.53,.42,-1,1),this.addBackCloud(-15,56.25,2,.93,.965,1,.47,1,-1,350),this.passTransformationsToChilds=!0,this.passColorToChilds=!0}addBackCloud(e,t,r,i,a,s,c,l=1,u=1,d=0){let f=j.create(n.IMG_OBJ_GHOST,r);f.anchor=f.parentAnchor=S.CENTER,f.x=e,f.y=t,this.addChild(f),this.clouds.push(f);let p=new o;p.loopType=o.LoopType.REPLAY,p.addKeyFrame(D.makeScale(i,i,D.TransitionType.IMMEDIATE,0)),p.addKeyFrame(D.makeScale(a,a,D.TransitionType.EASE_IN,c)),p.addKeyFrame(D.makeScale(s,s,D.TransitionType.EASE_OUT,c)),p.addKeyFrame(D.makeScale(a,a,D.TransitionType.EASE_IN,c)),p.addKeyFrame(D.makeScale(i,i,D.TransitionType.EASE_OUT,c)),p.addKeyFrame(D.makePos(e+l,t+u,D.TransitionType.IMMEDIATE,0)),p.addKeyFrame(D.makePos(e,t,D.TransitionType.EASE_IN,c)),p.addKeyFrame(D.makePos(e-l,t-u,D.TransitionType.EASE_OUT,c)),p.addKeyFrame(D.makePos(e,t,D.TransitionType.EASE_IN,c)),p.addKeyFrame(D.makePos(e+l,t+u,D.TransitionType.EASE_OUT,c)),d!==0&&p.addKeyFrame(D.makeRotation(d,D.TransitionType.IMMEDIATE,0)),f.addTimeline(p),f.playTimeline(0)}removeChildWithID(e){if(e===0&&this.bubbleOutlineIndex!==-1){super.removeChildWithID(this.bubbleOutlineIndex),this.bubbleOutlineIndex=-1;return}super.removeChildWithID(e)}draw(){if(this.popped&&!this.capturedByBulb)for(let e of this.clouds)e.visible=!1;if(super.draw(),this.popped&&!this.capturedByBulb)for(let e of this.clouds)e.visible=!0}},oc=class extends Yi{rotateSpeed;rotateSpeedVar;constructor(e,t){super(e,t),this.rotateSpeed=0,this.rotateSpeedVar=0,this.drawer.rotationAngles=[],this.drawer.rotationPositions=[]}initParticle(e){super.initParticle(e),e.angle=0,e.deltaAngle=z.fromDegrees(this.rotateSpeed+this.rotateSpeedVar*I.randomMinus1to1());let t=this.particles.length;this.drawer.rotationAngles[t]=0,this.drawer.rotationPositions[t]=new O(0,0)}rotatePreCalc(e,t,n,r,i){e.x-=r,e.y-=i;let a=e.x*t-e.y*n,o=e.x*n+e.y*t;e.x=a+r,e.y=o+i}updateParticle(e,t,n){super.updateParticle(e,t,n),e.angle+=e.deltaAngle*n,this.drawer.rotationAngles[t]=e.angle;let r=this.drawer.rotationPositions[t];r&&r.copyFrom(e.pos)}draw(){if(this.interpolationAlpha<1){let e=this.interpolationAlpha;for(let t=0;t<this.particleIdx;t++){let n=this.particles[t];if(!n)continue;this.drawer.rotationAngles[t]=vr(n.prevAngle,n.angle,e);let r=this.drawer.rotationPositions[t];r&&(r.x=vr(n.prevPos.x,n.pos.x,e),r.y=vr(n.prevPos.y,n.pos.y,e))}}super.draw()}removeParticle(e){this.drawer.rotationAngles.splice(e,1),this.drawer.rotationPositions.splice(e,1),super.removeParticle(e)}},sc=7,cc=class extends oc{constructor(e,t=sc){super(t,e),this.size=.6,this.sizeVar=.2,this.angle=0,this.angleVar=360,this.rotateSpeedVar=30,this.life=.6,this.lifeVar=.15,this.duration=1.5,this.speed=200,this.speedVar=60,this.startColor=k.solidOpaque.copy(),this.endColor=k.transparent.copy()}initParticle(e){super.initParticle(e);let t=I.randomRange(4,6),n=this.imageGrid.rects[t];if(!n)return;this.drawer.setTextureQuad(this.particles.length,n,new w(0,0,0,0),void 0);let r=e.size;e.width=n.w*r,e.height=n.h*r}updateParticle(e,t,n){if(super.updateParticle(e,t,n),e.life<=0)return;let r=.7*this.life;e.life<r&&(e.deltaColor.r=(this.endColor.r-this.startColor.r)/r,e.deltaColor.g=(this.endColor.g-this.startColor.g)/r,e.deltaColor.b=(this.endColor.b-this.startColor.b)/r,e.deltaColor.a=(this.endColor.a-this.startColor.a)/r),e.dir.multiply(.92),e.width*=1.015,e.height*=1.015}},lc=class extends Y{backClouds=[];initAt(e,t){this.x=e,this.y=t;let r=j.create(n.IMG_OBJ_GHOST,5);r.anchor=r.parentAnchor=S.CENTER,r.x=-45,r.y=1.5,this.addChild(r),this.backClouds.push(r),this.addFloatTimeline(r,.65,.43,.465,.5,-1,1);let i=j.create(n.IMG_OBJ_GHOST,4);i.anchor=i.parentAnchor=S.CENTER,i.x=43.5,i.y=13.5,this.addChild(i),this.backClouds.push(i),this.addFloatTimeline(i,.45,.9,.8,.7,1,1);let a=j.create(n.IMG_OBJ_GHOST,2);return a.anchor=a.parentAnchor=S.CENTER,a.x=-11.25,a.y=33.75,this.addChild(a),this.backClouds.push(a),this.addFloatTimeline(a,.5,1.1,1,.9,-1,1),this.passTransformationsToChilds=!0,this}draw(){if(this.visible){if(this.preDraw(),this.back&&(this.back.color=this.color,this.back.draw()),this.radius!==P.UNDEFINED||this.hideRadius){let e=new k(.2,.5,.9,this.radiusAlpha),t=this.radius===P.UNDEFINED?this.previousRadius:this.radius;this.drawGrabCircle(this.x,this.y,t,e)}this.rope&&this.rope.draw(),this.front&&(this.front.color=this.color,this.front.draw()),this.postDraw()}}drawBack(){}addFloatTimeline(e,t,n,r,i,a,s){let c=e.x,l=e.y,u=new o;u.loopType=o.LoopType.REPLAY,u.addKeyFrame(D.makeScale(n,n,D.TransitionType.IMMEDIATE,0)),u.addKeyFrame(D.makeScale(r,r,D.TransitionType.EASE_IN,t)),u.addKeyFrame(D.makeScale(i,i,D.TransitionType.EASE_OUT,t)),u.addKeyFrame(D.makeScale(r,r,D.TransitionType.EASE_IN,t)),u.addKeyFrame(D.makeScale(n,n,D.TransitionType.EASE_OUT,t)),u.addKeyFrame(D.makePos(c+a,l+s,D.TransitionType.IMMEDIATE,0)),u.addKeyFrame(D.makePos(c,l,D.TransitionType.EASE_IN,t)),u.addKeyFrame(D.makePos(c-a,l-s,D.TransitionType.EASE_OUT,t)),u.addKeyFrame(D.makePos(c,l,D.TransitionType.EASE_IN,t)),u.addKeyFrame(D.makePos(c+a,l+s,D.TransitionType.EASE_OUT,t)),e.addTimeline(u),e.playTimeline(0)}},uc=Math.sqrt(5060),dc=class extends ec{backCloud;backCloud2;ghost;backCloudOffset;backCloud2Offset;constructor(e,t,r,i,a){super(e,t,r,i),this.ghost=a;let o=i+170;this.backCloud2Offset={x:uc*Math.cos(z.fromDegrees(o)),y:uc*Math.sin(z.fromDegrees(o))},this.backCloud2=this.createCloud(0,4),this.backCloud2.visible=!1,this.addFloatTimeline(this.backCloud2,.35,.7,.55,.4);let s=i+10;this.backCloudOffset={x:uc*Math.cos(z.fromDegrees(s)),y:uc*Math.sin(z.fromDegrees(s))},this.backCloud=this.createCloud(0,4),this.backCloud.visible=!1,this.addFloatTimeline(this.backCloud,.39,.9,.8,.7);let c=j.create(n.IMG_OBJ_GHOST,3);c.anchor=c.parentAnchor=S.CENTER,c.x=45,c.y=41.25,this.addChild(c),this.addFloatTimeline(c,.45,1.1,1,.9);let l=j.create(n.IMG_OBJ_GHOST,2);l.anchor=l.parentAnchor=S.CENTER,l.x=-37.5,l.y=41.25,this.addChild(l),this.addFloatTimeline(l,.5,1.1,1,.9),this.passTransformationsToChilds=!0}playTimeline(e){this.currentTimelineIndex!==11&&(e!==11&&this.currentTimelineIndex===10&&this.currentTimeline?.state!==o.StateType.STOPPED&&(this.color=k.solidOpaque.copy()),super.playTimeline(e))}update(e){super.update(e),this.backCloud.update(e),this.backCloud2.update(e),this.backCloud.x=this.x+this.backCloudOffset.x,this.backCloud.y=this.y+this.backCloudOffset.y,this.backCloud2.x=this.x+this.backCloud2Offset.x,this.backCloud2.y=this.y+this.backCloud2Offset.y}draw(){this.backCloud.color=this.color,this.backCloud2.color=this.color,this.backCloud.draw(),this.backCloud2.draw(),super.draw(),this.ghost?.morphingBubbles&&this.ghost.morphingBubbles.draw(),this.ghost?.morphingCloud&&this.ghost.morphingCloud.draw()}createCloud(e,t){let r=j.create(n.IMG_OBJ_GHOST,t);return r.anchor=r.parentAnchor=S.CENTER,r.x=uc*Math.cos(z.fromDegrees(e)),r.y=uc*Math.sin(z.fromDegrees(e)),r}addFloatTimeline(e,t,n,r,i){let a=new o;a.loopType=o.LoopType.REPLAY,a.addKeyFrame(D.makeScale(n,n,D.TransitionType.IMMEDIATE,0)),a.addKeyFrame(D.makeScale(r,r,D.TransitionType.EASE_IN,t)),a.addKeyFrame(D.makeScale(i,i,D.TransitionType.EASE_OUT,t)),a.addKeyFrame(D.makeScale(r,r,D.TransitionType.EASE_IN,t)),a.addKeyFrame(D.makeScale(n,n,D.TransitionType.EASE_OUT,t)),a.addKeyFrame(D.makePos(e.x+1,e.y+1,D.TransitionType.IMMEDIATE,0)),a.addKeyFrame(D.makePos(e.x,e.y,D.TransitionType.EASE_IN,t)),a.addKeyFrame(D.makePos(e.x-1,e.y-1,D.TransitionType.EASE_OUT,t)),a.addKeyFrame(D.makePos(e.x,e.y,D.TransitionType.EASE_IN,t)),a.addKeyFrame(D.makePos(e.x+1,e.y+1,D.TransitionType.EASE_OUT,t)),e.addTimeline(a),e.playTimeline(0)}},fc=80,pc=1,mc=1,hc=7,gc=.36,_c=.16,vc=class extends T{ghostState;bubble;grab;bouncer;cyclingEnabled;grabRadius;candyBreak;possibleStatesMask;bouncerAngle;ghostImage;ghostImageBody;ghostImageFace;morphingBubbles;morphingCloud;scene;constructor(e,t,r,i,a){super(),this.scene=a,this.possibleStatesMask=t|mc,this.ghostState=mc,this.bouncerAngle=i,this.grabRadius=r,this.bubble=null,this.grab=null,this.bouncer=null,this.cyclingEnabled=!0,this.candyBreak=!1,this.x=e.x,this.y=e.y,this.ghostImage=new T,this.addChild(this.ghostImage),this.ghostImageFace=j.create(n.IMG_OBJ_GHOST,1),this.ghostImageFace.anchor=this.ghostImageFace.parentAnchor=S.CENTER,this.ghostImageFace.x=this.x,this.ghostImageFace.y=this.y,this.ghostImageBody=j.create(n.IMG_OBJ_GHOST,0),this.ghostImageBody.anchor=this.ghostImageBody.parentAnchor=S.CENTER,this.ghostImageBody.x=this.x,this.ghostImageBody.y=this.y,this.ghostImage.addChild(this.ghostImageBody),this.ghostImage.addChild(this.ghostImageFace),this.addFloatTimeline(this.ghostImageFace,2,.005),this.addFloatTimeline(this.ghostImageBody,3);let s=new o;s.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.IMMEDIATE,0)),s.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,gc)),this.ghostImage.addTimelineWithID(s,10);let c=new o;c.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.IMMEDIATE,0)),c.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,_c)),this.ghostImage.addTimelineWithID(c,11),this.ghostImage.playTimeline(10);let l=yt[n.IMG_OBJ_GHOST]?.texture??null;this.morphingBubbles=l?new cc(l):null,this.morphingCloud=null,this.morphingBubbles&&(this.morphingBubbles.x=e.x,this.morphingBubbles.y=e.y,this.addChild(this.morphingBubbles))}updateGhost(e){this.bubble&&this.bubble.currentTimelineIndex===11&&this.bubble.currentTimeline?.state===o.StateType.STOPPED&&(this.removeFromSceneArray(this.scene.bubbles,this.bubble),this.bubble=null),this.bouncer&&this.bouncer.currentTimelineIndex===11&&this.bouncer.currentTimeline?.state===o.StateType.STOPPED&&(this.removeFromSceneArray(this.scene.bouncers,this.bouncer),this.bouncer=null),this.grab&&this.grab.currentTimelineIndex===11&&this.grab.currentTimeline?.state===o.StateType.STOPPED&&(this.grab.destroyRope(),this.removeFromSceneArray(this.scene.bungees,this.grab),this.grab=null),super.update(e),this.grab&&this.grab.rope&&this.grab.rope.cut!==P.UNDEFINED&&this.grab.currentTimelineIndex===10&&(this.cyclingEnabled=!0,this.resetToState(mc))}resetToNextState(){let e=this.ghostState;do e<<=1,e===16&&(e=2);while((e&this.possibleStatesMask)===0);this.resetToState(e)}resetToState(e){if((e&this.possibleStatesMask)===0)return;this.ghostState=e;let t=new o;if(t.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.IMMEDIATE,0)),t.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,_c)),this.bubble&&(this.bubble.currentTimelineIndex===11?(this.removeFromSceneArray(this.scene.bubbles,this.bubble),this.bubble=null):(this.bubble.addTimelineWithID(t,11),this.bubble.playTimeline(11),this.bubble.popped=!0)),this.grab){let e=this.grab.rope;e&&(e.forceWhite=!0,e.cutTime=gc,e.cut===P.UNDEFINED&&(e.cut=0)),this.grab.currentTimelineIndex===11?(this.grab.destroyRope(),this.removeFromSceneArray(this.scene.bungees,this.grab),this.grab=null):(this.grab.addTimelineWithID(t,11),this.grab.playTimeline(11))}this.bouncer&&(this.bouncer.currentTimelineIndex===11?(this.removeFromSceneArray(this.scene.bouncers,this.bouncer),this.bouncer=null):(this.bouncer.skip=1,this.bouncer.addTimelineWithID(t,11),this.bouncer.playTimeline(11))),this.ghostImage.currentTimelineIndex===10&&this.ghostImage.playTimeline(11);let r=new o;switch(r.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.IMMEDIATE,0)),r.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,gc)),e){case mc:this.ghostImage.playTimeline(10);break;case 2:{let e=new ac().initAt(this.x,this.y);e.addTimelineWithID(r,10),e.playTimeline(10),this.scene.bubbles.push(e),this.bubble=e;break}case 4:{let e=new lc().initAt(this.x,this.y);if(e.wheel=!1,e.spider=null,e.setRadius(this.grabRadius),this.grabRadius===-1){let t=this.getGhostRopeAnchor();if(t){let n=Math.max(O.distance(this.x,this.y,t.pos.x,t.pos.y),A.BUNGEE_REST_LEN),r=new jr(null,this.x,this.y,t,t.pos.x,t.pos.y,n);r.bungeeAnchor.pin.copyFrom(r.bungeeAnchor.pos),e.setRope(r)}}this.scene.bungees.push(e),this.grab=e,e.addTimelineWithID(r,10),e.playTimeline(10);break}case 8:{let e=new dc(this.x,this.y,pc,this.bouncerAngle,this);this.scene.bouncers.push(e),e.color=k.transparent.copy(),e.skip=1,e.addTimelineWithID(r,10),e.playTimeline(10),this.bouncer=e;break}default:break}U.playSound(n.SND_GHOST_PUFF),this.morphingBubbles?.startSystem(hc)}onTouchDown(e,t){let n=O.distance(e,t,this.x,this.y);return this.cyclingEnabled&&!this.candyBreak&&n<fc?(this.resetToNextState(),!0):!1}removeFromSceneArray(e,t){if(!t)return;let n=e.indexOf(t);n!==-1&&e.splice(n,1)}destroy(){this.removeFromSceneArray(this.scene.bubbles,this.bubble),this.removeFromSceneArray(this.scene.bouncers,this.bouncer),this.grab&&this.grab.destroyRope(),this.removeFromSceneArray(this.scene.bungees,this.grab),this.bubble=null,this.grab=null,this.bouncer=null}addFloatTimeline(e,t,n=0){let r=new o,i=Math.random();r.addKeyFrame(D.makePos(e.x,e.y,D.TransitionType.IMMEDIATE,0)),r.addKeyFrame(D.makePos(e.x,e.y-t,D.TransitionType.EASE_OUT,i+n)),r.onFinished=()=>{let n=new o;n.loopType=o.LoopType.REPLAY,n.addKeyFrame(D.makePos(e.x,e.y-t,D.TransitionType.IMMEDIATE,0)),n.addKeyFrame(D.makePos(e.x,e.y,D.TransitionType.EASE_IN,.38)),n.addKeyFrame(D.makePos(e.x,e.y+t,D.TransitionType.EASE_OUT,.38)),n.addKeyFrame(D.makePos(e.x,e.y,D.TransitionType.EASE_IN,.38)),n.addKeyFrame(D.makePos(e.x,e.y-t,D.TransitionType.EASE_OUT,.38)),e.addTimelineWithID(n,12),e.playTimeline(12)},e.addTimelineWithID(r,13),e.playTimeline(13)}getGhostRopeAnchor(){if(this.scene.twoParts===M.NONE)return!this.scene.noCandy&&this.scene.star?this.scene.star:this.scene.star??this.scene.starL??this.scene.starR;let e=null,t=Number.MAX_VALUE,n=(n,r)=>{if(!n||r)return;let i=O.distance(this.x,this.y,n.pos.x,n.pos.y);i<t&&(t=i,e=n)};return n(this.scene.starL,this.scene.noCandyL),n(this.scene.starR,this.scene.noCandyR),e||(!this.scene.noCandy&&this.scene.star?this.scene.star:this.scene.star??this.scene.starL??this.scene.starR)}};function yc(e){let t=e.x*this.PM+this.PMX,n=e.y*this.PM+this.PMY,r=e.radius*this.PM,i=e.angle??0,a=e.grab??!1,o=e.bubble??!1,s=(e.bouncer??!1?8:0)|(o?2:0)|(a?4:0),c=new vc(new O(t,n),s,r,i,this);this.ghosts.push(c)}function bc(e){let t=new _o(e.x*this.PM+this.PMX,e.y*this.PM+this.PMY,jo(),this.candyResourceId);t.parseMover(e),this.lanterns.push(t);let n=typeof e.candyCaptured==`string`?e.candyCaptured.toLowerCase():e.candyCaptured;(n===!0||n===1||n===`1`||n===`true`)&&(this.isCandyInLantern=!0,t.captureCandy(this.star),this.candy.x=this.star.pos.x,this.candy.y=this.star.pos.y,this.candy.color=k.transparent.copy())}var xc=class{path=[];duration=0;elapsed=0;active=!1;currentOffset=O.newZero();play(e){this.path=e,this.duration=e[e.length-1]?.time??0,this.elapsed=0,this.active=this.duration>0,e.length>0&&(this.currentOffset=e[0].offset.copy())}update(e){if(!this.active||this.path.length===0)return this.currentOffset;if(this.elapsed+=e,this.elapsed>=this.duration)return this.elapsed=this.duration,this.active=!1,this.currentOffset=this.path[this.path.length-1].offset.copy(),this.currentOffset;let t=0;for(;t<this.path.length-1&&this.path[t+1].time<=this.elapsed;)t++;let n=this.path[t],r=this.path[t+1]??n,i=Math.max(r.time-n.time,1e-4),a=Math.min(Math.max((this.elapsed-n.time)/i,0),1);return this.currentOffset.x=n.offset.x+(r.offset.x-n.offset.x)*a,this.currentOffset.y=n.offset.y+(r.offset.y-n.offset.y)*a,this.currentOffset}isPlaying(){return this.active}},$=function(e){return e[e.ENTRY_EMPTY=0]=`ENTRY_EMPTY`,e[e.ENTRY_WITH_CANDY=1]=`ENTRY_WITH_CANDY`,e[e.EXIT_EMPTY=2]=`EXIT_EMPTY`,e[e.EXIT_WITH_CANDY=3]=`EXIT_WITH_CANDY`,e[e.RETREAT=4]=`RETREAT`,e[e.IDLE=5]=`IDLE`,e}($||{}),Sc=class extends T{index;grabRadius;activeDuration;angleDeg;isActive;elapsedActive;carriedStar;carriedCandy;entryOffsets;exitOffsets;mouthPathPlayer;mouseGroup;holeSprite;sharedSprites;retreating;grabAnimating;manager;constructor(e){super(),this.manager=e,this.index=0,this.grabRadius=0,this.activeDuration=0,this.angleDeg=0,this.isActive=!1,this.retreating=!1,this.elapsedActive=0,this.carriedStar=null,this.carriedCandy=null,this.grabAnimating=!1,this.entryOffsets=[],this.exitOffsets=[],this.mouthPathPlayer=new xc,this.sharedSprites=null,this.mouseGroup=new T,this.mouseGroup.anchor=this.mouseGroup.parentAnchor=S.CENTER,this.holeSprite=j.create(n.IMG_OBJ_GAP,0),this.holeSprite.anchor=this.holeSprite.parentAnchor=S.CENTER,this.holeSprite.scaleX=this.holeSprite.scaleY=1,this.holeSprite.doRestoreCutTransparency(),this.addChild(this.mouseGroup)}initialize(e,t,n,r){this.x=e.x,this.y=e.y,this.angleDeg=t,this.grabRadius=n,this.activeDuration=r,this.isActive=!1,this.retreating=!1,this.elapsedActive=0,this.carriedStar=null,this.carriedCandy=null;let i=t*Math.PI/180,a=O.newZero(),o=e=>{let t=e.copy();return t.rotate(i),t};this.entryOffsets[0]=O.add(a,o(new O(0,-4.4))),this.entryOffsets[1]=O.add(a,o(new O(0,-48))),this.entryOffsets[2]=O.add(a,o(new O(0,-57))),this.entryOffsets[3]=O.add(a,o(new O(0,-53))),this.exitOffsets[0]=O.add(a,o(new O(0,-36.4))),this.exitOffsets[1]=O.add(a,o(new O(0,-43.2))),this.exitOffsets[2]=O.add(a,o(new O(0,-9.2)))}spawn(e,t,r){if(this.sharedSprites=e,this.carriedCandy=t,this.carriedStar=r??null,this.mouseGroup.removeAllChildren(),this.mouseGroup.addChild(e.container),e.container.parent=this.mouseGroup,t&&!r){let e=this.entryOffsets[3]??O.newZero();t.x=this.x+e.x,t.y=this.y+e.y}this.playAnimation(t?$.ENTRY_WITH_CANDY:$.ENTRY_EMPTY),this.retreating=!1,this.isActive=!1,this.elapsedActive=0,this.grabAnimating=!1,e.eyes.visible=!1,r&&this.attachExistingCandy(r,t),U.playSound(n.SND_MOUSE_RUSTLE)}createEntryPath(){return[{offset:this.entryOffsets[0]??O.newZero(),time:0},{offset:this.entryOffsets[1]??O.newZero(),time:.05},{offset:this.entryOffsets[2]??O.newZero(),time:.1},{offset:this.entryOffsets[3]??O.newZero(),time:.15}]}createExitPath(){return[{offset:this.exitOffsets[0]??O.newZero(),time:0},{offset:this.exitOffsets[1]??O.newZero(),time:.05},{offset:this.exitOffsets[2]??O.newZero(),time:.1}]}playAnimation(e){let t=this.sharedSprites;t&&(t.body.playTimeline(e),t.body.currentTimeline&&(t.body.currentTimeline.onFinished=this.onAnimationFinished.bind(this)))}enableEyesBlink(){let e=this.sharedSprites;e&&(e.eyes.visible=!0,e.eyes.playTimeline(0))}onAnimationFinished(){let e=this.sharedSprites,t=e?.body.currentTimelineIndex??$.IDLE;if(t===$.EXIT_EMPTY||t===$.EXIT_WITH_CANDY){e?(this.mouseGroup.removeChild(e.container),this.sharedSprites=null):this.mouseGroup.removeAllChildren(),this.manager.advanceToNextMouse();return}(t===$.ENTRY_EMPTY||t===$.ENTRY_WITH_CANDY)&&(this.isActive=!0,this.elapsedActive=0,t===$.ENTRY_EMPTY&&Math.random()<.5&&(this.playAnimation($.IDLE),this.enableEyesBlink()))}isWithinGrabRadius(e){return O.distance(this.x,this.y,e.pos.x,e.pos.y)<this.grabRadius}grabCandy(e,t){this.carriedStar=e,this.carriedCandy=t,e.disableGravity=!0,e.v.x=0,e.v.y=0;let r=this.entryOffsets[3]??O.newZero();e.pos.x=this.x+r.x,e.pos.y=this.y+r.y,e.prevPos.copyFrom(e.pos),this.mouthPathPlayer.play(this.createEntryPath()),this.grabAnimating=!0;let i=this.sharedSprites;i&&i.body.setTextureQuad(19),U.playSound(n.SND_MOUSE_IDLE)}dropCandy(){this.carriedStar&&(this.carriedStar.disableGravity=!1,this.carriedStar.prevPos.copyFrom(this.carriedStar.pos),this.carriedStar=null,this.carriedCandy=null,this.grabAnimating=!1,U.playSound(n.SND_MOUSE_TAP))}dropCandyAndRetreat(){this.dropCandy(),this.beginRetreat()}beginRetreat(){if(this.retreating)return;let e=this.sharedSprites;e&&(e.eyes.visible=!1),this.retreating=!0,this.isActive=!1,this.elapsedActive=0,this.grabAnimating=!1,this.mouthPathPlayer.play(this.createExitPath()),this.playAnimation(this.carriedStar?$.EXIT_WITH_CANDY:$.EXIT_EMPTY)}update(e){super.update(e);let t=this.sharedSprites;t&&t.container.parent===this.mouseGroup&&(t.container.rotation=this.angleDeg,t.container.scaleX=t.container.scaleY=1);let n=this.mouthPathPlayer.update(e);if(this.grabAnimating&&!this.mouthPathPlayer.isPlaying()&&(this.grabAnimating=!1),this.carriedStar){let e=this.carriedStar;e.pos.x=this.x+n.x,e.pos.y=this.y+n.y,e.prevPos.copyFrom(e.pos)}this.isActive&&!this.retreating&&!this.grabAnimating&&(this.elapsedActive+=e,this.elapsedActive>=this.activeDuration&&this.beginRetreat()),this.mouseGroup.x=this.x,this.mouseGroup.y=this.y}attachExistingCandy(e,t){this.carriedStar=e,this.carriedCandy=t??null,e.disableGravity=!0,e.v.x=0,e.v.y=0;let n=this.entryOffsets[3]??O.newZero();e.pos.x=this.x+n.x,e.pos.y=this.y+n.y,e.prevPos.copyFrom(e.pos),this.mouthPathPlayer.play(this.createEntryPath()),this.grabAnimating=!0}hasCandy(){return!!this.carriedStar}isClickable(e,t){return!this.isActive||!this.carriedStar||this.retreating?!1:O.distance(this.x,this.y,e,t)<this.grabRadius}drawHole(){this.holeSprite.x=this.x,this.holeSprite.y=this.y,this.holeSprite.draw()}drawMouse(){this.mouseGroup.draw()}lock(){this.retreating=!0,this.isActive=!1}detachCarriedCandy(){let e=this.carriedStar,t=this.carriedCandy;return this.carriedStar=null,this.carriedCandy=null,{star:e,candy:t}}},Cc=class{mice=[];activeMouse=null;activeIndex=-1;sharedSpriteContainer=null;advanceLocked=!1;carriedStar=null;carriedCandy=null;scene;constructor(e){this.scene=e}update(e){for(let t of this.mice)t.update(e)}drawHoles(){for(let e of this.mice)e.drawHole()}drawMice(){for(let e of this.mice)e===this.activeMouse&&e.drawMouse()}registerMouse(e,t){e.index=t,this.mice.push(e),this.sharedSpriteContainer||=this.createSharedSprites();let n=this.mice.some(e=>e.index===1);this.sharedSpriteContainer&&(t===1||!this.activeMouse&&!n)&&(this.activeMouse=e,this.activeIndex=t,e.spawn(this.sharedSpriteContainer,this.carriedCandy,this.carriedStar))}isActiveMouseInRange(e){let t=this.activeMouse;return t?t.isActive&&t.isWithinGrabRadius(e):!1}grabWithActiveMouse(e,t,n){let r=this.activeMouse;!r||r.hasCandy()||(this.scene.releaseAllRopes(n),this.scene.attachCount=0,this.scene.detachCandy(),this.carriedStar=e,this.carriedCandy=t,r.grabCandy(e,t))}activeMouseHasCandy(){return!!this.activeMouse?.hasCandy()}handleClick(e,t){let n=this.activeMouse;return!n||!n.hasCandy()?!1:n.isClickable(e,t)?(n.dropCandyAndRetreat(),this.carriedStar=null,this.carriedCandy=null,!0):!1}advanceToNextMouse(){if(this.advanceLocked||!this.sharedSpriteContainer||!this.activeMouse||this.mice.length===0)return;let e=[...this.mice].sort((e,t)=>e.index-t.index),t=e.find(e=>e.index===this.activeIndex),n=e[((t?e.indexOf(t):-1)+1)%e.length]??e[0];!t||!n||(t.detachCarriedCandy(),this.activeIndex=n.index,this.activeMouse=n,n.spawn(this.sharedSpriteContainer,this.carriedCandy,this.carriedStar))}lockActiveMouse(){this.advanceLocked=!0,this.activeMouse?.lock()}createSharedSprites(){let e=new T;e.anchor=e.parentAnchor=S.CENTER;let t=new K;t.initTextureWithId(n.IMG_OBJ_GAP),t.anchor=t.parentAnchor=S.CENTER,t.doRestoreCutTransparency(),t.addAnimationSequence(0,.05,o.LoopType.NO_LOOP,3,[11,12,13]),t.addAnimationSequence(1,.05,o.LoopType.NO_LOOP,3,[14,15,19]),t.addAnimationSequence(2,.05,o.LoopType.NO_LOOP,4,[13,17,18,22]),t.addAnimationSequence(3,.05,o.LoopType.NO_LOOP,4,[19,20,21,22]),t.addAnimationEndpoints(5,.05,o.LoopType.NO_LOOP,10,10),e.addChild(t);let r=new K;return r.initTextureWithId(n.IMG_OBJ_GAP),r.anchor=r.parentAnchor=S.CENTER,r.doRestoreCutTransparency(),r.addAnimationEndpoints(0,.05,o.LoopType.NO_LOOP,1,9),e.addChild(r),r.visible=!1,{container:e,body:t,eyes:r}}};function wc(e){let t=e.x*this.PM+this.PMX,n=e.y*this.PM+this.PMY,r=e.angle??0,i=(e.radius??0)*this.PM||80*this.PM,a=e.activeTime??3,o=e.index??this.mice.length+1;this.miceManager||=new Cc(this);let s=new Sc(this.miceManager);s.initialize(new O(t,n),r,i,a),this.mice.push(s),this.miceManager.registerMouse(s,o)}var Tc=0,Ec=1,Dc=2,Oc=3,kc=42,Ac=1,jc=100,Mc=jc*jc,Nc=class extends q{draw(){let e=C.context;if(!e){super.draw();return}let t=e.globalCompositeOperation;e.globalCompositeOperation=`lighter`,super.draw(),e.globalCompositeOperation=t}},Pc=class extends Nr{lightRadius;rotationVelocity;constraint;attachedSock;capturingBubble;capturingGhostBubble;sockSpeed;localBounds;worldBounds;lightGlow;firefly;bottle;top;bubbleAnimation;ghostBubbleAnimation;PM;constructor(e,t){super(),this.lightRadius=e,this.rotationVelocity=0,this.constraint=t,this.attachedSock=null,this.capturingBubble=null,this.capturingGhostBubble=!1,this.sockSpeed=0,this.scaleX=Ac,this.scaleY=Ac,this.PM=A.PM,this.lightGlow=new Nc,this.lightGlow.initTextureWithId(n.IMG_OBJ_LIGHTER),this.lightGlow.setTextureQuad(Tc),this.lightGlow.anchor=this.lightGlow.parentAnchor=S.CENTER,this.lightGlow.color=new k(1,1,1,.4),this.addChild(this.lightGlow),this.bottle=new q,this.bottle.initTextureWithId(n.IMG_OBJ_LIGHTER),this.bottle.setTextureQuad(Ec),this.bottle.anchor=this.bottle.parentAnchor=S.CENTER,this.bottle.doRestoreCutTransparency(),this.addChild(this.bottle),this.top=new q,this.top.initTextureWithId(n.IMG_OBJ_LIGHTER),this.top.setTextureQuad(Dc),this.top.anchor=this.top.parentAnchor=S.CENTER,this.top.doRestoreCutTransparency(),this.addChild(this.top),this.firefly=new K,this.firefly.initTextureWithId(n.IMG_OBJ_LIGHTER),this.firefly.anchor=this.firefly.parentAnchor=S.CENTER,this.firefly.addAnimationDelay(.05,o.LoopType.REPLAY,Oc,kc),this.firefly.playTimeline(0),this.addChild(this.firefly),this.bubbleAnimation=new K,this.bubbleAnimation.initTextureWithId(n.IMG_OBJ_BUBBLE_FLIGHT),this.bubbleAnimation.anchor=this.bubbleAnimation.parentAnchor=S.CENTER,this.bubbleAnimation.addAnimationDelay(.05,o.LoopType.REPLAY,0,12),this.bubbleAnimation.playTimeline(0),this.bubbleAnimation.visible=!1,this.addChild(this.bubbleAnimation),this.ghostBubbleAnimation=new bo().initWithResId(n.IMG_OBJ_BUBBLE_FLIGHT),this.ghostBubbleAnimation.visible=!1,this.addChild(this.ghostBubbleAnimation);let r=A.CANDY_BB.w,i=A.CANDY_BB.h,a=r*Ac/2,s=i*Ac/2;this.localBounds=new w(-a,-s,a*2,s*2),this.worldBounds=w.copy(this.localBounds),this.applyGlowScale(),this.syncToConstraint()}applyGlowScale(){let e=this.lightGlow.width;if(e<=0)return;let t=this.lightRadius*this.PM/e*1.5/Ac;this.lightGlow.scaleX=t,this.lightGlow.scaleY=t}syncToConstraint(){this.x=this.constraint.pos.x,this.y=this.constraint.pos.y,this.updateBounds()}updateBounds(){this.worldBounds.x=this.x+this.localBounds.x,this.worldBounds.y=this.y+this.localBounds.y,this.worldBounds.w=this.localBounds.w,this.worldBounds.h=this.localBounds.h}update(e){super.update(e),this.visible=this.attachedSock==null;let t=this.capturingBubble!=null&&this.attachedSock==null;this.bubbleAnimation.visible=t&&!this.capturingGhostBubble,this.ghostBubbleAnimation.visible=t&&this.capturingGhostBubble,this.rotationVelocity!==0&&(this.rotation+=Math.min(5,this.rotationVelocity),this.rotationVelocity*=.98),this.updateBounds()}applyInterpolation(){let e=this.x,t=this.y;if(this.interpolationAlpha<1){let e=yr(this.constraint.prevPos,this.constraint.pos,this.interpolationAlpha,Mc);this.x=e.x,this.y=e.y}return{originalX:e,originalY:t}}drawLight(){if(!this.visible)return;let{originalX:e,originalY:t}=this.applyInterpolation();this.preDraw(),this.lightGlow.draw(),this.x=e,this.y=t}drawBottleAndFirefly(){if(!this.visible)return;let{originalX:e,originalY:t}=this.applyInterpolation();this.bottle.draw(),this.top.draw(),this.firefly.draw(),this.bubbleAnimation.visible&&this.bubbleAnimation.draw(),this.ghostBubbleAnimation.visible&&this.ghostBubbleAnimation.draw(),this.postDrawNoChildren(),this.x=e,this.y=t}postDrawNoChildren(){let e=C.context;e&&e.restore()}};function Fc(e){let t=new fr;t.setWeight(1),t.disableGravity=!1,t.pos.x=e.x*this.PM+this.PMX,t.pos.y=e.y*this.PM+this.PMY;let n=new Pc(e.litRadius*this.PM,t);this.lightbulbs.push(n)}function Ic(e){let t=e.x*this.PM+this.PMX,n=e.y*this.PM+this.PMY,r=e.length*this.PM,i=e.width*this.PM,a=e.angle,o=e.velocity*1.44/(this.PM*this.PM)*(e.direction===`forward`?1:-1),s=e.type===`manual`,c=to.create(this.conveyors.count(),t,n,r,i,a,s,o);this.conveyors.push(c)}var Lc=class extends Po{loadMapSettings=Fo;loadGameDesign=Io;loadGrab=Bo;loadCandy=Uo;loadCandyL=Vo;loadCandyR=Ho;loadGravitySwitch=Wo;loadStar=cs;loadTutorialText=us;loadTutorialImage=ds;loadHidden=ps;loadBubble=hs;loadPump=_s;loadSteamTube=rc;loadSock=Ss;loadSpike=Ms;loadRotatedCircle=Xs;loadBouncer=tc;loadTarget=ic;loadGhost=yc;loadLantern=bc;loadMouse=wc;loadLightBulb=Fc;loadConveyorBelt=Ic;loadMap(e){if(!e)return;let t=[];for(let n of Object.keys(e)){let r=e[n];Array.isArray(r)&&t.push(r)}let n=[],r=0;for(let e of t)for(let t of e){let e=Ba(typeof t.name==`number`?t.name:Number(t.name));if(!e){lt.alert(`Unknown map item id: ${t.name}`);continue}n.push({item:t,definition:e,order:r++})}n.sort((e,t)=>{let n=e.definition.priority??1,r=t.definition.priority??1;return n===r?e.order-t.order:n-r}).forEach(({item:e,definition:t})=>{let n=t.loader;if(typeof n!=`string`){lt.alert(`Loader not implemented for map item: ${t.key}`);return}let r=this[n];if(typeof r!=`function`){lt.alert(`Loader not implemented for map item: ${t.key}`);return}r.call(this,e,t)})}},Rc=class extends Lc{onIdleOmNomKeyFrame(e,t,n){if(!(this.nightLevel&&this.isNightTargetAwake===!1)&&n===1){this.blinkTimer--,this.blinkTimer===0&&(this.blink.visible=!0,this.blink.playTimeline(0),this.blinkTimer=3),this.idlesTimer--;let e=L?g.IDLEXMAS:g.IDLE2,t=L?g.IDLEXMAS:g.IDLE3;if(this.idlesTimer===0){let n=I.randomRange(0,1)===1?e:t;this.target.playTimeline(n),this.idlesTimer=I.randomRange(5,20)}}}onPaddingtonIdleKeyFrame(e,t,n){if(c){if(n!==38){this.hidePaddingtonFinalFrame();return}n===38&&(this.showPaddingtonFinalFrame(),this.pendingPaddingtonIdleTransition||(this.pendingPaddingtonIdleTransition=!0,this.dd.callObject(this,this.playRegularIdleAfterPaddington,null,.05)))}}playRegularIdleAfterPaddington(){this.target&&this.target.playTimeline(g.IDLE),this.pendingPaddingtonIdleTransition=!1}onRotatedCircleTimelineFinished(e){let t=e.element;t&&(t.removeOnNextUpdate=!0)}},zc=30,Bc=7*.05,Vc=433/480,Hc=4,Uc=[n.SND_MONSTER_SLEEP_1,n.SND_MONSTER_SLEEP_2,n.SND_MONSTER_SLEEP_3],Wc=A.PM*A.STAR_RADIUS,Gc=e=>e*Vc-e/2;const Kc=(e,t)=>{if(e.lightbulbs.length===0)return;let n=t*e.ropePhysicsSpeed;for(let r of e.lightbulbs){r.constraint.update(n);for(let e=0;e<zc;e++)r.constraint.satisfyConstraints();r.syncToConstraint(),r.update(t)}},qc=e=>{if(e.lightbulbs.length!==0){for(let t=0;t<e.lightbulbs.length;t++){let n=e.lightbulbs[t];if(!(!n||n.attachedSock!=null)){!e.noCandy&&!e.targetSock&&Zc(n.constraint,e.star,Wc);for(let r=t+1;r<e.lightbulbs.length;r++){let t=e.lightbulbs[r];!t||t.attachedSock!=null||Zc(n.constraint,t.constraint,Wc)}}}for(let t of e.lightbulbs)t.syncToConstraint();for(let t=e.lightbulbs.length-1;t>=0;t--){let n=e.lightbulbs[t];n&&e.pointOutOfScreen(n.constraint)&&e.lightbulbs.splice(t,1)}}};var Jc=e=>{e.sleepSoundId!=null&&(U.stopSound(e.sleepSoundId),e.sleepSoundId=null)},Yc=e=>{if(Uc.length===0)return;let t=Uc[I.randomRange(0,Uc.length-1)];t!=null&&(e.sleepSoundId=t,U.playSound(t))},Xc=(e,t)=>{e.sleepAnimPrimary&&(e.sleepAnimPrimary.visible=t,t?e.sleepAnimPrimary.playTimeline(0):e.sleepAnimPrimary.getTimeline(0)?.stop()),e.sleepAnimSecondary&&(e.sleepAnimSecondary.visible=t,t?e.sleepAnimSecondary.playTimeline(0):e.sleepAnimSecondary.getTimeline(0)?.stop())},Zc=(e,t,n)=>{let r=O.subtract(e.pos,t.pos),i=r.getLength();if(i>=n)return;i===0&&(r.x=1,r.y=0,i=1);let a=n-i,o=e.v.getLength()+t.v.getLength();if(o<=0||a<1e3/o*2){let n=r.x/i,o=r.y/i,s=a/2;e.pos.x+=n*s,e.pos.y+=o*s,t.pos.x-=n*s,t.pos.y-=o*s;return}let s=O.subtract(t.pos,e.pos),c=-s.y,l=s.x,u=(e.v.x*s.x+e.v.y*s.y)/n,d=(e.v.x*c+e.v.y*l)/n;c=(t.v.x*c+e.v.x*l)/n,l=u,u=(t.v.x*s.x+t.v.y*s.y)/n;let f=s.x/n,p=s.y/n,m=u*f-d*p,h=u*p+d*f,g=l*f-c*p,_=l*p+c*f;e.v.x=m,e.v.y=h,t.v.x=g,t.v.y=_;let v=a/2*(r.x/i),y=a/2*(r.y/i);e.pos.x+=v,e.pos.y+=y,t.pos.x-=v,t.pos.y-=y,e.prevPos.x=e.pos.x-e.v.x/60,e.prevPos.y=e.pos.y-e.v.y/60,t.prevPos.x=t.pos.x-t.v.x/60,t.prevPos.y=t.pos.y-t.v.y/60},Qc=(e,t)=>{if(e.isNightTargetAwake!==t){if(e.isNightTargetAwake=t,t){e.sleepPulseActive=!1,e.sleepPulseTime=0,e.sleepPulseDelay=0,e.sleepSoundTimer=0,e.sleepPulseBaseY=0,Jc(e),e.target.scaleX=1,e.target.scaleY=1,e.target.rotationCenterX=0,e.target.rotationCenterY=0,Xc(e,!1),e.target.playTimeline(g.EXCITED);return}e.noCandy||(e.sleepPulseActive=!1,e.sleepPulseTime=0,e.sleepPulseDelay=Bc,e.sleepSoundTimer=0,Xc(e,!0),e.target.playTimeline(g.SLEEPING),e.sleepPulseBaseY=Gc(e.target.height),e.target.rotationCenterY=e.sleepPulseBaseY)}};function $c(e){if(this.nightLevel){if(this.sleepAnimPrimary&&this.sleepAnimPrimary.update(e),this.sleepAnimSecondary&&this.sleepAnimSecondary.update(e),!this.noCandy){let e=new O(this.target.x,this.target.y),t=!1;for(let n of this.lightbulbs)if(O.distance(n.constraint.pos.x,n.constraint.pos.y,e.x,e.y)<n.lightRadius){t=!0;break}Qc(this,t)}if(this.isNightTargetAwake===!1){if(this.sleepPulseActive||(this.sleepPulseDelay=Math.max(0,this.sleepPulseDelay-e),this.sleepPulseDelay===0&&(this.sleepPulseActive=!0)),this.sleepPulseActive){let t=.95+(Math.sin(this.sleepPulseTime*2)+1)/2*.1;this.target.currentTimelineIndex===g.SLEEPING&&(this.target.rotationCenterY=86,this.target.scaleY=t),this.sleepPulseTime+=e}this.sleepSoundTimer+=e,this.sleepSoundTimer>Hc&&(this.sleepSoundTimer=0,Yc(this))}for(let e of this.stars){if(!e)continue;let t=!1;for(let n of this.lightbulbs)if(O.distance(n.constraint.pos.x,n.constraint.pos.y,e.x,e.y)<n.lightRadius){t=!0;break}e.setLitState(t)}this.lightbulbs.length===0&&this.restartState!==ge.FADE_IN&&!this.noCandy&&this.gameLost(),this.sleepAnimPrimary&&(this.sleepAnimPrimary.x=this.target.x,this.sleepAnimPrimary.y=this.target.y),this.sleepAnimSecondary&&(this.sleepAnimSecondary.x=this.target.x,this.sleepAnimSecondary.y=this.target.y)}}function el(e){for(let t of this.drawings)t.update(e);T.prototype.update.call(this,e),this.dd.update(e),this.pollenDrawer&&this.pollenDrawer.update(e);for(let t=0;t<P.MAX_TOUCHES;t++){let n=this.fingerCuts[t];if(!n)continue;let r=n.length,i=0;for(;i<r;){let t=n[i];if(!t){i++;continue}let a=G.moveToTargetWithStatus(t.color.a,0,10,e);t.color.a=a.value,a.reachedZero?(n.splice(i,1),r--):i++}}for(let t of this.earthAnims)t.update(e);if(this.ropesAtOnceTimer=G.moveToTarget(this.ropesAtOnceTimer,0,1,e),this.attachCount===0&&(this.juggleTimer+=e,this.juggleTimer>30&&(this.juggleTimer=0)),Kc(this,e),qc(this),$c.call(this,e),e>0){let t=e;for(;t>0;){let e=Math.min(.01,t);this.conveyors.update(e),this.conveyors.processItems(this.bubbles),this.conveyors.processItems(this.stars),this.conveyors.processItems(this.bouncers),this.conveyors.processItems(this.socks),this.conveyors.processItems(this.tubes),this.conveyors.processItems(this.pumps),t-=e}}}var tl=class{scene;constructor(e){this.scene=e}updateBasics(e){el.call(this.scene,e)}};function nl(e){let t=this.bungees.length;if(t>0){this.prevCandyRotation=this.candyMain.rotation;let r=!1,i=!1,a=!1;for(let o=0;o<t;o++){let t=this.bungees[o];if(!t)continue;t.update(e);let s=t.rope;if(t.mover&&s&&(s.bungeeAnchor.pos.x=t.x,s.bungeeAnchor.pos.y=t.y,s.bungeeAnchor.pin.copyFrom(s.bungeeAnchor.pos)),s&&t.stickTimer!==P.UNDEFINED&&(t.stickTimer+=e,t.stickTimer>Y.STICK_DELAY)){let e=this.PMX+this.mapOffsetX,r=this.PMY+this.mapOffsetY;(t.rectInObject(e,r,e+this.mapWidth,r+this.mapHeight)??!1)&&(s.bungeeAnchor.pin.copyFrom(s.bungeeAnchor.pos),t.kicked=!1,s.bungeeAnchor.setWeight(.02),t.updateKickState(),U.playSound(n.SND_EXP_SUCKER_LAND)),t.stickTimer=P.UNDEFINED}if(s){if(s.cut!==P.UNDEFINED&&s.cutTime===0){t.destroyRope();continue}if(s.update(e*this.ropePhysicsSpeed),t.hasSpider&&((this.camera.type!==Wn.SpeedType.PIXELS||!this.ignoreTouches)&&t.updateSpider(e),t.spiderPos===P.UNDEFINED)){this.spiderWon(t);break}}if(t.radius!==P.UNDEFINED&&!t.rope){let e=A.STAR_RADIUS,r=(r,i)=>{if(new O(t.x,t.y).distance(r.pos)>t.radius+e)return!1;let a=new jr(null,t.x,t.y,r,r.pos.x,r.pos.y,t.radius+e);return a.bungeeAnchor.pin.copyFrom(a.bungeeAnchor.pos),t.hideRadius=!0,t.setRope(a),i&&(this.miceManager?.activeMouseHasCandy()?(a.setCut(a.parts.length-2),this.detachCandy()):this.attachCandy()),U.playSound(n.SND_ROPE_GET),t.mover&&U.playSound(n.SND_BUZZ),!0};if(this.twoParts===M.NONE?r(this.star,!0):(this.noCandyL||r(this.starL,!0),!this.noCandyR&&t.rope==null&&r(this.starR,!0)),t.rope==null&&this.lightbulbs.length>0){for(let e of this.lightbulbs)if(!(!e||e.attachedSock!=null)&&r(e.constraint,!1))break}}if(s){let e=s.bungeeAnchor,t=s.parts[s.parts.length-1];if(!t)continue;let n=O.subtract(e.pos,t.pos),o=!1;if(r||(this.twoParts===M.NONE?!this.noCandy&&!r&&(o=!0):(t===this.starL&&!this.noCandyL&&!i||t===this.starR&&!this.noCandyR&&!a)&&(o=!0)),s.relaxed!==0&&s.cut===P.UNDEFINED&&o){let e=z.toDegrees(n.normalizedAngle());if(this.twoParts!==M.NONE){let n=t===this.starL?this.candyL:this.candyR;s.chosenOne||(s.initialCandleAngle=n.rotation-e),t===this.starL?(this.lastCandyRotateDeltaL=e+s.initialCandleAngle-n.rotation,i=!0):(this.lastCandyRotateDeltaR=e+s.initialCandleAngle-n.rotation,a=!0),n.rotation=e+s.initialCandleAngle}else !this.noCandy&&t===this.star&&(s.chosenOne||(s.initialCandleAngle=this.candyMain.rotation-e),this.lastCandyRotateDelta=e+s.initialCandleAngle-this.candyMain.rotation,this.candyMain.rotation=e+s.initialCandleAngle,r=!0);s.chosenOne=!0}else s.chosenOne=!1}}this.twoParts===M.NONE?!r&&!this.noCandy&&(this.candyMain.rotation+=Math.min(5,this.lastCandyRotateDelta),this.lastCandyRotateDelta*=.98):(!i&&!this.noCandyL&&(this.candyL.rotation+=Math.min(5,this.lastCandyRotateDeltaL),this.lastCandyRotateDeltaL*=.98),!a&&!this.noCandyR&&(this.candyR.rotation+=Math.min(5,this.lastCandyRotateDeltaR),this.lastCandyRotateDeltaR*=.98))}return t}function rl(e){let t;this.noCandy||(this.candy.update(e),this.star.update(e*this.ropePhysicsSpeed));let r=()=>{!this.noCandy&&!this.isCandyInLantern&&(this.candy.x=this.star.pos.x,this.candy.y=this.star.pos.y,this.candy.calculateTopLeft()),this.twoParts!==M.NONE&&(this.noCandyL||(this.candyL.x=this.starL.pos.x,this.candyL.y=this.starL.pos.y,this.candyL.calculateTopLeft()),this.noCandyR||(this.candyR.x=this.starR.pos.x,this.candyR.y=this.starR.pos.y,this.candyR.calculateTopLeft()))};if(this.twoParts!==M.NONE){let r=e*this.ropePhysicsSpeed;if(this.candyL.update(e),this.starL.update(r),this.candyR.update(e),this.starR.update(r),this.twoParts===M.DISTANCE)for(let e=0;e<jr.BUNGEE_RELAXION_TIMES;e++)this.starL.satisfyConstraints(),this.starR.satisfyConstraints();if(this.partsDist>0)if(t=G.moveToTargetWithStatus(this.partsDist,0,200,e),this.partsDist=t.value,t.reachedZero){if(U.playSound(n.SND_CANDY_LINK),this.twoParts=M.NONE,this.noCandy=!1,this.noCandyL=!0,this.noCandyR=!0,this.candyBubbleL||this.candyBubbleR){this.candyBubble=this.candyBubbleL?this.candyBubbleL:this.candyBubbleR;let e=wi(this,this.candyBubble);if(this.candyBubbleAnimation.visible=!e,e){let e=this.candyBubbleL?this.candyGhostBubbleAnimationL:this.candyGhostBubbleAnimationR;e&&((this.candyBubbleL?this.candyL:this.candyR).removeChild(e),this.candy.addChild(e),this.candyGhostBubbleAnimation=e,e.visible=!0)}}this.lastCandyRotateDelta=0,this.lastCandyRotateDeltaL=0,this.lastCandyRotateDeltaR=0,this.star.pos.x=this.starL.pos.x,this.star.pos.y=this.starL.pos.y,this.candy.x=this.star.pos.x,this.candy.y=this.star.pos.y,this.candy.calculateTopLeft();let e=O.subtract(this.starL.pos,this.starL.prevPos),t=O.subtract(this.starR.pos,this.starR.prevPos),r=new O((e.x+t.x)/2,(e.y+t.y)/2);this.star.prevPos.copyFrom(this.star.pos),this.star.prevPos.subtract(r);for(let e of this.bungees){let t=e.rope;if(t&&t.cut!==t.parts.length-3&&(t.tail===this.starL||t.tail===this.starR)){let e=t.parts[t.parts.length-2],n=t.tail.restLength(e);this.star.addConstraint(e,n,lr.DISTANCE),t.tail=this.star,t.parts[t.parts.length-1]=this.star,t.initialCandleAngle=0,t.chosenOne=!1}}let i=this.getCandyConstants(),a=this.getCandyFxResourceId(),s=new K;s.initTextureWithId(a),s.doRestoreCutTransparency(),s.x=this.candy.x,s.y=this.candy.y,s.anchor=S.CENTER;let c=s.addAnimationDelay(.05,o.LoopType.NO_LOOP,i.part_fx_start,i.part_fx_end),l=s.getTimeline(c);l&&(l.onFinished=this.aniPool.timelineFinishedDelegate()),s.playTimeline(0),this.aniPool.addChild(s)}else this.starL.changeRestLength(this.starR,this.partsDist),this.starR.changeRestLength(this.starL,this.partsDist);!this.noCandyL&&!this.noCandyR&&this.twoParts===M.SEPARATE&&q.intersect(this.candyL,this.candyR)&&(this.twoParts=M.DISTANCE,this.partsDist=this.starL.pos.distance(this.starR.pos),this.starL.addConstraint(this.starR,this.partsDist,lr.NOT_MORE_THAN),this.starR.addConstraint(this.starL,this.partsDist,lr.NOT_MORE_THAN))}if(this.target.update(e),r(),this.camera.type!==Wn.SpeedType.PIXELS||!this.ignoreTouches)for(let t=0,r=this.stars.length;t<r;t++){let r=this.stars[t];if(r)if(r.update(e),r.timeout>0&&r.time===0){let e=r.getTimeline(1);e&&(e.onFinished=this.aniPool.timelineFinishedDelegate()),this.conveyors.remove(r),this.aniPool.addChild(r),this.stars.splice(t,1),r.timedAnim?.playTimeline(1),r.playTimeline(1);break}else{let e=!1;if(!(!this.nightLevel||r.isLit===!0))continue;if(e=this.twoParts===M.NONE?!!q.intersect(this.candy,r)&&!this.noCandy:!!q.intersect(this.candyL,r)&&!this.noCandyL||!!q.intersect(this.candyR,r)&&!this.noCandyR,e){this.candyBlink.playTimeline(be.STAR),this.starsCollected++,this.hudStars[this.starsCollected-1].playTimeline(0);let e=this.starDisappearPool[t];e.x=r.x,e.y=r.y,e.playTimeline(0),this.aniPool.addChild(e),this.conveyors.remove(r),this.stars[t]=null,U.playSound(n.SND_STAR_1+this.starsCollected-1),this.target.currentTimelineIndex===g.IDLE&&this.target.playTimeline(g.EXCITED);break}}}for(let t of this.bubbles){if(t.update(e),!t.popped){if(this.twoParts!==M.NONE){if(!this.noCandyL&&this.isBubbleCapture(t,this.candyL,this.candyBubbleL,this.candyBubbleAnimationL)){Ti(this,this.candyBubbleL),this.candyBubbleL=t;let e=Ei(this,t);this.candyBubbleAnimationL.visible=!e,this.candyGhostBubbleAnimationL&&(this.candyGhostBubbleAnimationL.visible=e);break}if(!this.noCandyR&&this.isBubbleCapture(t,this.candyR,this.candyBubbleR,this.candyBubbleAnimationR)){Ti(this,this.candyBubbleR),this.candyBubbleR=t;let e=Ei(this,t);this.candyBubbleAnimationR.visible=!e,this.candyGhostBubbleAnimationR&&(this.candyGhostBubbleAnimationR.visible=e);break}}else if(!this.noCandy&&this.isBubbleCapture(t,this.candy,this.candyBubble,this.candyBubbleAnimation)){Ti(this,this.candyBubble);let e=Ei(this,t);this.candyBubble=t,this.candyBubbleAnimation.visible=!e,this.candyGhostBubbleAnimation&&(this.candyGhostBubbleAnimation.visible=e);break}}if(!t.popped&&this.lightbulbs.length>0){let e=A.BUBBLE_SIZE,r=e*2;for(let i of this.lightbulbs)if(!(!i||i.attachedSock!=null)&&w.pointInRect(i.x,i.y,t.x-e,t.y-e,r,r)){i.capturingBubble&&i.capturingBubble!==t&&this.popLightBulbBubble(i);let e=wi(this,t);i.capturingBubble=t,i.capturingGhostBubble=e,t.capturedByBulb=!e,t.popped=!0,t.removeChildWithID(0),this.conveyors.remove(t),e&&Ei(this,t),U.playSound(n.SND_BUBBLE);break}}if(!t.withoutShadow){let e=this.rotatedCircles.length;for(let n=0;n<e;n++){let e=this.rotatedCircles[n];O.distance(t.x,t.y,e.x,e.y)<e.sizeInPixels&&(t.withoutShadow=!0)}}}for(let t of this.ghosts)t.updateGhost(e);for(let t=0,n=this.tutorials.length;t<n;t++)this.tutorials[t].update(e);for(let t=0,n=this.tutorialImages.length;t<n;t++)this.tutorialImages[t].update(e);return!0}var il=[3,4,5,6,7],al=[`frame_0003.png`,`frame_0004.png`,`frame_0005.png`,`frame_0006.png`,`frame_0007.png`],ol=class extends oc{pieceFrameIndices;constructor(e,t,n={}){super(e,t),this.pieceFrameIndices=this._resolvePieceFrameIndices(n.resourceId),this.duration=2,this.gravity.x=0,this.gravity.y=500,this.angle=-90,this.angleVar=50,this.speed=150,this.speedVar=70,this.radialAccel=0,this.radialAccelVar=1,this.tangentialAccel=0,this.tangentialAccelVar=1,this.posVar.x=0,this.posVar.y=0,this.life=2,this.lifeVar=0,this.size=1,this.sizeVar=0,this.emissionRate=100,this.startColor.r=1,this.startColor.g=1,this.startColor.b=1,this.startColor.a=1,this.startColorVar.r=0,this.startColorVar.g=0,this.startColorVar.b=0,this.startColorVar.a=0,this.endColor.r=1,this.endColor.g=1,this.endColor.b=1,this.endColor.a=1,this.endColorVar.r=0,this.endColorVar.g=0,this.endColorVar.b=0,this.endColorVar.a=0,this.rotateSpeed=0,this.rotateSpeedVar=600,this.blendAdditive=!1}initParticle(e){super.initParticle(e);let t=this.imageGrid,n=this.pieceFrameIndices&&this.pieceFrameIndices.length?this.pieceFrameIndices:il,r=n[I.randomRange(0,n.length-1)],i=t.rects[r];if(!i)return;let a=new w(0,0,0,0);this.drawer.setTextureQuad(this.particles.length,i,a,void 0),e.width=i.w*this.size,e.height=i.h*this.size}_resolvePieceFrameIndices(e){if(!e)return il.slice();if(e===n.IMG_OBJ_CANDY_PADDINGTON){let t=this._lookupFrameIndices(e,al);if(t.length)return t}return il.slice()}_lookupFrameIndices(e,t){let n=yt[e]?.info;if(!n||!(`frameIndexByName`in n))return[];let r=n.frameIndexByName;return r?t.map(e=>r[e]).filter(e=>e!==void 0):[]}};const sl=(e,t,n,r)=>{e.applyImpulse(new O(-e.v.x/t,-e.v.y/t+n),r)},cl=(e,t,n)=>{let r=n*2;return w.lineInRect(e.t1.x,e.t1.y,e.t2.x,e.t2.y,t.pos.x-n,t.pos.y-n,r,r)||w.lineInRect(e.b1.x,e.b1.y,e.b2.x,e.b2.y,t.pos.x-n,t.pos.y-n,r,r)};function ll(e,t){if(e.special===t){e.special=0;for(let n of e.tutorials)n.special===t?n.playTimeline(0):n.currentTimeline?.jumpToTrack(3,2);for(let n of e.tutorialImages)n.special===t?n.playTimeline(0):n.currentTimeline?.jumpToTrack(3,2)}}function ul(e){return this.special!==0&&this.special===1&&!this.noCandy&&this.candyBubble!=null&&this.candy.y<A.CANDY_BUBBLE_TUTORIAL_LIMIT_Y&&this.candy.x>A.CANDY_BUBBLE_TUTORIAL_LIMIT_X&&ll(this,1),!0}function dl(e,t){for(let n of e.bungees){let r=n.rope;!r||r.tail!==t.constraint||(r.cut===P.UNDEFINED?r.setCut(r.parts.length-2):r.hideTailParts=!0,n.hasSpider&&n.spiderActive&&e.spiderBusted(n))}}function fl(e){if(!e.attachedSock)return;let t=e.attachedSock,n=t.light;n&&(n.playTimeline(0),n.visible=!0);let r=new O(0,A.SOCK_TELEPORT_Y);r.rotate(z.fromDegrees(t.rotation)),e.constraint.pos.x=t.x,e.constraint.pos.y=t.y,e.constraint.pos.add(r),e.constraint.prevPos.copyFrom(e.constraint.pos),e.constraint.v.x=0,e.constraint.v.y=-1,e.constraint.v.rotate(z.fromDegrees(t.rotation)),e.constraint.v.multiply(e.sockSpeed),e.constraint.posDelta.copyFrom(e.constraint.v),e.constraint.posDelta.divide(60),e.constraint.prevPos.copyFrom(e.constraint.pos),e.constraint.prevPos.subtract(e.constraint.posDelta),e.attachedSock=null,e.sockSpeed=0}function pl(e,t,n){let r=t.getHeightScale(),i=5,a=z.fromDegrees(t.rotation),o=10*r,s=t.getCurrentHeightModulated(),c=1*r,l=17.5*r,u=!!e.gravityButton&&!e.gravityNormal,d=t.x-o/2,f=t.y-s-c,p=t.x+o/2,m=t.y-l,h=c=>{let h=c.pos.copy(),g=c.v.copy();if(h.rotateAround(-a,t.x,t.y),g.rotate(-a),!w.rectInRect(h.x-l,h.y-l/2,h.x+l,h.y+l,d,f,p,m))return!1;for(let t of e.bouncers)t&&(t.skip=0);let _=0;if(t.rotation===0&&!u||t.rotation===180&&u){let e=t.x-h.x;_=Math.abs(e)>o/4?-g.x/i+.25*e:Math.abs(g.x)<1?-g.x:-g.x/i}let v=t.rotation===0&&!u||t.rotation===180&&u,y=-32/c.weight*Math.sqrt(r);v||(i*=15,t.rotation===90||t.rotation===270?y/=4:y/=2);let b=new O(_,-g.y/i+y),x=t.y-h.y;if(x>s+l){let e=Math.exp(-2*(x-(s+l)));b.multiply(e)}return b.rotate(a),c.applyImpulse(b,n),!0};e.twoParts===M.NONE?e.noCandy||h(e.star):(e.noCandyL||h(e.starL),e.noCandyR||h(e.starR));for(let t of e.lightbulbs)!t||t.attachedSock!=null||h(t.constraint)}function ml(e,t){let r=-1;for(let n=0,i=this.rotatedCircles.length;n<i;n++){let i=this.rotatedCircles[n],a=i.containedObjects;for(let e=0;e<t;e++){let t=this.bungees[e];if(!t)continue;let n=a.indexOf(t);O.distance(t.x,t.y,i.x,i.y)<=i.sizeInPixels+5*this.PM?n<0&&a.push(t):n>=0&&a.splice(n,1)}let o=this.bubbles.length;for(let e=0;e<o;e++){let t=this.bubbles[e],n=O.distance(t.x,t.y,i.x,i.y),r=a.indexOf(t);n<=i.sizeInPixels+10*this.PM?r<0&&a.push(t):r>=0&&a.splice(r,1)}i.removeOnNextUpdate&&(r=n),i.update(e)}if(r>=0&&this.rotatedCircles.splice(r,1),this.miceManager){this.miceManager.update(e);let t=(()=>this.twoParts===M.NONE?this.noCandy?null:{star:this.star,candy:this.candy,isLeft:!1}:this.noCandyL?this.noCandyR?null:{star:this.starR,candy:this.candyR,isLeft:!1}:{star:this.starL,candy:this.candyL,isLeft:!0})();t&&!this.miceManager.activeMouseHasCandy()&&this.miceManager.isActiveMouseInRange(t.star)&&(this.miceManager.grabWithActiveMouse(t.star,t.candy,t.isLeft),ll(this,4))}for(let t=0,n=this.rockets.length;t<n;t++)this.rockets[t].update(e);for(let t=0,r=this.socks.length;t<r;t++){let i=this.socks[t];i.update(e);let a=G.moveToTargetWithStatus(i.idleTimeout,0,1,e);i.idleTimeout=a.value,a.reachedZero&&(i.state=Q.StateType.IDLE);let o=i.rotation;i.rotation=0,i.updateRotation();let s=z.fromDegrees(-o),c=this.star.posDelta.copy();c.rotate(s),i.rotation=o,i.updateRotation();let l=this.star.pos.x-A.STAR_SOCK_RADIUS,u=this.star.pos.y-A.STAR_SOCK_RADIUS,d=A.STAR_SOCK_RADIUS*2,f=d,p=i.state===Q.StateType.IDLE,m=c.y>=0&&(w.lineInRect(i.t1.x,i.t1.y,i.t2.x,i.t2.y,l,u,d,f)||w.lineInRect(i.b1.x,i.b1.y,i.b2.x,i.b2.y,l,u,d,f)),h=!1;if(!p&&this.lightbulbs.length>0)for(let e of this.lightbulbs){if(!e||e.attachedSock!=null)continue;let t=e.constraint.posDelta.copy();t.rotate(s);let n=e.constraint.pos.x-A.STAR_SOCK_RADIUS,r=e.constraint.pos.y-A.STAR_SOCK_RADIUS;if(t.y>=0&&(w.lineInRect(i.t1.x,i.t1.y,i.t2.x,i.t2.y,n,r,d,f)||w.lineInRect(i.b1.x,i.b1.y,i.b2.x,i.b2.y,n,r,d,f))){h=!0;break}}if(!p){!m&&!h&&i.idleTimeout===0&&(i.idleTimeout=Q.IDLE_TIMEOUT);continue}if(m&&!this.targetSock)for(let e=0;e<r;e++){let t=this.socks[e];if(t!==i&&t.group===i.group){t.state=Q.StateType.THROWING,t.idleTimeout=Q.IDLE_TIMEOUT,this.releaseAllRopes(!1),this.savedSockSpeed=_*this.star.v.getLength()*A.PHYSICS_SPEED_MULTIPLIER,this.targetSock=t;let{light:e}=i;e&&(e.setTextureQuad(Q.Quads.IMG_OBJ_SOCKS_glow_start),e.visible=!0,e.playTimeline(0));let r=L?n.SND_TELEPORT_XMAS:n.SND_TELEPORT;U.playSound(r),this.dd.callObject(this,this.teleport,null,.1);break}}if(this.lightbulbs.length>0){let e=!1;for(let t of this.lightbulbs){if(!t||t.attachedSock!=null)continue;let a=t.constraint.posDelta.copy();a.rotate(s);let o=t.constraint.pos.x-A.STAR_SOCK_RADIUS,c=t.constraint.pos.y-A.STAR_SOCK_RADIUS;if(a.y>=0&&(w.lineInRect(i.t1.x,i.t1.y,i.t2.x,i.t2.y,o,c,d,f)||w.lineInRect(i.b1.x,i.b1.y,i.b2.x,i.b2.y,o,c,d,f))){h=!0;for(let a=0;a<r;a++){let r=this.socks[a];if(r!==i&&r.group===i.group){r.state=Q.StateType.THROWING,r.idleTimeout=Q.IDLE_TIMEOUT,dl(this,t),t.sockSpeed=_*t.constraint.v.getLength()*A.PHYSICS_SPEED_MULTIPLIER,t.attachedSock=r;let{light:a}=i;a&&(a.setTextureQuad(Q.Quads.IMG_OBJ_SOCKS_glow_start),a.visible=!0,a.playTimeline(0));let o=L?n.SND_TELEPORT_XMAS:n.SND_TELEPORT;U.playSound(o),this.dd.callObject(this,fl,[t],.1),e=!0;break}}if(e)break}}}}for(let t=0,n=this.pumps.length;t<n;t++){let n=this.pumps[t];n.update(e);let r=G.moveToTargetWithStatus(n.touchTimer,0,1,e);n.touchTimer=r.value,r.reachedZero&&this.operatePump(n,e)}for(let t of this.tubes)t&&(t.update(e),t.steamState!==3&&pl(this,t,e));let i=A.LANTERN_CAPTURE_RADIUS??A.STAR_RADIUS;for(let t of this.lanterns){t.update(e);let n=t.lanternState===_o.STATE.INACTIVE&&O.distance(this.star.pos.x,this.star.pos.y,t.x,t.y)<i;if(!this.noCandy&&!this.isCandyInLantern&&n){this.isCandyInLantern=!0,this.candy.passTransformationsToChilds=!0,this.candyMain.scaleX=this.candyMain.scaleY=1,this.candyTop.scaleX=this.candyTop.scaleY=1;let e=new o;e.addKeyFrame(D.makePos(this.candy.x,this.candy.y,D.TransitionType.LINEAR,0)),e.addKeyFrame(D.makePos(t.x,t.y,D.TransitionType.LINEAR,.1)),e.addKeyFrame(D.makeScale(.71,.71,D.TransitionType.LINEAR,0)),e.addKeyFrame(D.makeScale(.3,.3,D.TransitionType.LINEAR,.1)),e.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,0)),e.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,.1)),this.candy.removeTimeline(0),this.candy.addTimelineWithID(e,0),this.candy.playTimeline(0),this.releaseAllRopes(!1),this.candyBubble&&this.popCandyBubble(!1),this.dd.callObject(t,t.captureCandyFromDispatcher,[this.star],.05),ll(this,3)}}for(let t=0,n=this.razors.length;t<n;t++){let n=this.razors[t];n.update(e),this.cut(n,O.zero,O.zero,!1)}let a=A.STAR_SPIKE_RADIUS;for(let t=0,r=this.spikes.length;t<r;t++){let r=this.spikes[t];if((r.mover||r.shouldUpdateRotation||r.electro)&&r.update(e),!this.isCandyInLantern&&(!r.electro||r.electroOn)){let e=!1,t=!1;if(this.twoParts===M.NONE?e=!this.noCandy&&cl(r,this.star,a):(e=!this.noCandyL&&cl(r,this.starL,a),e?t=!0:e=!this.noCandyR&&cl(r,this.starR,a)),e){this.twoParts===M.NONE?this.candyBubble&&this.popCandyBubble(!1):t?this.candyBubbleL&&this.popCandyBubble(!0):this.candyBubbleR&&this.popCandyBubble(!1);let e=nt.getTexture(this.candyResourceId);if(e){let n=new ol(5,e,{resourceId:this.candyResourceId});this.gravityButton&&!this.gravityNormal&&(n.gravity.y=-500,n.angle=90),n.onFinished=this.aniPool.particlesFinishedDelegate(),this.twoParts===M.NONE?(n.x=this.candy.x,n.y=this.candy.y):t?(n.x=this.candyL.x,n.y=this.candyL.y):(n.x=this.candyR.x,n.y=this.candyR.y),n.startSystem(5),this.aniPool.addChild(n)}return this.twoParts===M.NONE?this.noCandy=!0:t?this.noCandyL=!0:this.noCandyR=!0,U.playSound(n.SND_CANDY_BREAK),this.releaseAllRopes(t),this.restartState!==ge.FADE_IN&&this.dd.callObject(this,this.gameLost,null,.3),!1}}}let s=A.BOUNCER_RADIUS;for(let t=0,n=this.bouncers.length;t<n;t++){let n=this.bouncers[t];n.update(e),n.updateRotation();let r=!1,i=!1;this.twoParts===M.NONE?r=!this.noCandy&&cl(n,this.star,s):(r=!this.noCandyL&&cl(n,this.starL,s),r?i=!0:r=!this.noCandyR&&cl(n,this.starR,s)),r&&(this.twoParts===M.NONE?this.handleBounce(n,this.star,e):i?this.handleBounce(n,this.starL,e):this.handleBounce(n,this.starR,e));let a=!1;if(this.lightbulbs.length>0)for(let t of this.lightbulbs)!t||t.attachedSock!=null||cl(n,t.constraint,s)&&(this.handleBounce(n,t.constraint,e),a=!0);if(r)break;a||(n.skip=0)}let c=this.gravityButton&&!this.gravityNormal?-1:1,l=A.BUBBLE_IMPULSE_Y*c,u=A.BUBBLE_IMPULSE_RD;if(this.twoParts===M.SEPARATE&&(this.candyBubbleL&&sl(this.starL,u,l,e),this.candyBubbleR&&sl(this.starR,u,l,e)),this.twoParts===M.DISTANCE?(this.candyBubbleL||this.candyBubbleR)&&(sl(this.starL,u,l,e),sl(this.starR,u,l,e)):this.candyBubble&&sl(this.star,u,l,e),this.lightbulbs.length>0)for(let t of this.lightbulbs)!t||t.attachedSock!=null||!t.capturingBubble||sl(t.constraint,u,l,e);return!0}function hl(e){let t,r=!this.nightLevel||this.isNightTargetAwake;if(!this.noCandy){let i=A.MOUTH_OPEN_RADIUS;if(!this.mouthOpen&&r?(t=new O(this.target.x,this.target.y),!this.isCandyInLantern&&this.star.pos.distance(t)<i&&(this.mouthOpen=!0,this.target.playTimeline(g.MOUTH_OPEN),U.playSound(n.SND_MONSTER_OPEN),this.mouthCloseTimer=1)):this.mouthCloseTimer>0&&r&&(this.mouthCloseTimer=G.moveToTarget(this.mouthCloseTimer,0,1,e),this.mouthCloseTimer<=0&&(t=new O(this.target.x,this.target.y),this.isCandyInLantern||this.star.pos.distance(t)>i?(this.mouthOpen=!1,this.target.playTimeline(g.MOUTH_CLOSE),U.playSound(n.SND_MONSTER_CLOSE)):this.mouthCloseTimer=1)),this.restartState!==ge.FADE_IN&&r&&(q.intersect(this.candy,this.target)??!1))return this.gameWon(),!1}let i=this.twoParts===M.NONE&&this.pointOutOfScreen(this.star)&&!this.noCandy,a=this.twoParts!==M.NONE&&this.pointOutOfScreen(this.starL)&&!this.noCandyL,o=this.twoParts!==M.NONE&&this.pointOutOfScreen(this.starR)&&!this.noCandyR;return(i||a||o)&&(i&&(this.noCandy=!0),a&&(this.noCandyL=!0),o&&(this.noCandyR=!0),this.restartState!==ge.FADE_IN)?(this.twoParts!==M.NONE&&this.noCandyL&&this.noCandyR||this.gameLost(),!1):!0}var gl=class{scene;constructor(e){this.scene=e}updateBungees(e){return nl.call(this.scene,e)}updateCollectibles(e){rl.call(this.scene,e)}updateHazards(e,t){return ml.call(this.scene,e,t)}updateTargetState(e){return hl.call(this.scene,e)?{continue:!0}:{continue:!1,reason:this.scene.target.currentTimelineIndex===g.WIN?`game_won`:`game_lost`}}updateSpecial(e){ul.call(this.scene,e)}};function _l(e){let t=A.CANVAS_WIDTH,n=A.CANVAS_HEIGHT,r=this.twoParts===M.NONE?this.star:this.starL,i=r.pos.x-t/2,a=r.pos.y-n/2,o=I.fitToBoundaries(i,0,this.mapWidth-t),s=I.fitToBoundaries(a,0,this.mapHeight-n);if(this.camera.moveTo(o,s,!1),this.freezeCamera&&this.camera.type===Wn.SpeedType.DELAY||this.camera.update(e),this.camera.type===Wn.SpeedType.PIXELS){let t=A.IGNORE_TOUCHES_DISTANCE,n=A.PREVIEW_CAMERA_SPEED,r=A.PREVIEW_CAMERA_SPEED2,i=A.MAX_PREVIEW_CAMERA_SPEED,a=A.MIN_PREVIEW_CAMERA_SPEED,c=this.camera.pos.distance(new O(o,s));c<t&&(this.ignoreTouches=!1),this.fastenCamera?this.camera.speed<A.CAMERA_SPEED_THRESHOLD&&(this.camera.speed*=1.5):c>this.initialCameraToStarDistance/2?(this.camera.speed+=e*n,this.camera.speed=Math.min(i,this.camera.speed)):(this.camera.speed-=e*r,this.camera.speed=Math.max(a,this.camera.speed)),Math.abs(this.camera.pos.x-o)<1&&Math.abs(this.camera.pos.y-s)<1&&(this.camera.type=Wn.SpeedType.DELAY,this.camera.speed=A.CAMERA_SPEED)}else this.time+=e}function vl(e){if(this.clickToCut&&!this.ignoreTouches){this.resetBungeeHighlight();let e=new O(0,0),t=O.add(this.slastTouch,this.camera.pos),n=this.getNearestBungeeGrabByBezierPoints(e,t.x,t.y),r=n?n.rope:null;if(r){let e=!1;if(this.gravityButton){let n=this.gravityButton.isOn()?1:0;this.gravityButton.getChild(n)?.isInTouchZone(t.x,t.y,!0)&&(e=!0)}if(this.candyBubble||this.twoParts!=M.NONE&&(this.candyBubbleL||this.candyBubbleR))for(let n of this.bubbles){let n=A.BUBBLE_RADIUS,r=n*2;if(this.candyBubble&&w.pointInRect(t.x,t.y,this.star.pos.x-n,this.star.pos.y-n,r,r)){e=!0;break}if(this.candyBubbleL&&w.pointInRect(t.x,t.y,this.starL.pos.x-n,this.starL.pos.y-n,r,r)){e=!0;break}if(this.candyBubbleR&&w.pointInRect(t.x,t.y,this.starR.pos.x-n,this.starR.pos.y-n,r,r)){e=!0;break}}for(let n of this.spikes)n.rotateButton&&n.rotateButton.isInTouchZone(t.x,t.y,!0)&&(e=!0);for(let n of this.pumps)if(n.pointInObject(t.x,t.y)){e=!0;break}for(let n of this.rotatedCircles){if(n.isLeftControllerActive()||n.isRightControllerActive()){e=!0;break}let r=n.handle2;if(r&&O.distance(t.x,t.y,r.x,r.y)<=A.RC_CONTROLLER_RADIUS){e=!0;break}}for(let n of this.bungees){if(n.wheel&&w.pointInRect(t.x,t.y,n.x-A.GRAB_WHEEL_RADIUS,n.y-A.GRAB_WHEEL_RADIUS,A.GRAB_WHEEL_RADIUS*2,A.GRAB_WHEEL_RADIUS*2)){e=!0;break}if(n.moveLength>0&&(w.pointInRect(t.x,t.y,n.x-A.GRAB_MOVE_RADIUS,n.y-A.GRAB_MOVE_RADIUS,A.GRAB_MOVE_RADIUS*2,A.GRAB_MOVE_RADIUS*2)||n.moverDragging!==P.UNDEFINED)){e=!0;break}}e||(r.highlighted=!0)}}let t=G.moveToTargetWithStatus(this.dimTime,0,1,e);this.dimTime=t.value,t.reachedZero&&(this.restartState===ge.FADE_IN?(this.restartState=ge.FADE_OUT,this.hide(),this.show(),this.dimTime=P.DIM_TIMEOUT):this.restartState=P.UNDEFINED)}var yl=class{scene;constructor(e){this.scene=e}updateCamera(e){_l.call(this.scene,e)}updateClickToCut(e){vl.call(this.scene,e)}};function bl(e,t,n){let r=e,i=t;for(let e of n){let n=i[e];typeof n==`function`&&(r[e]=n.bind(t))}}var xl=class extends Rc{drawDelegate;bubblesDelegate;teleportDelegate;lifecycleDelegate;ropeManagementDelegate;pumpUtilsDelegate;bounceUtilsDelegate;cutDelegate;spiderHandlersDelegate;selectionDelegate;physicsService;candyService;animationService;pluginManager;systemContext;systems;constructor(e={}){super();let t=this;this.drawDelegate=new Ci(t),bl(this,this.drawDelegate,[`draw`]),this.bubblesDelegate=new Ni(t),bl(this,this.bubblesDelegate,[`isBubbleCapture`,`popCandyBubble`,`popBubble`,`handleBubbleTouch`,`popLightBulbBubble`,`handleLightBulbBubbleTouch`]),this.teleportDelegate=new Fi(t),bl(this,this.teleportDelegate,[`teleport`]),this.lifecycleDelegate=new Vi(t),bl(this,this.lifecycleDelegate,[`animateLevelRestart`,`isFadingIn`,`calculateScore`,`gameWon`,`gameLost`]),this.ropeManagementDelegate=new Gi(t),bl(this,this.ropeManagementDelegate,[`releaseAllRopes`,`attachCandy`,`detachCandy`]),this.pumpUtilsDelegate=new ia(t),bl(this,this.pumpUtilsDelegate,[`handlePumpFlow`,`operatePump`]),this.bounceUtilsDelegate=new oa(t),bl(this,this.bounceUtilsDelegate,[`handleBounce`]),this.cutDelegate=new ca(t),bl(this,this.cutDelegate,[`cut`]),this.spiderHandlersDelegate=new fa(t),bl(this,this.spiderHandlersDelegate,[`spiderBusted`,`spiderWon`]),this.selectionDelegate=new ga(t),bl(this,this.selectionDelegate,[`resetBungeeHighlight`,`getNearestBungeeGrabByBezierPoints`,`getNearestBungeeSegmentByConstraints`]);let{plugins:n=[],systems:r}=e;this.physicsService=new tl(t),this.candyService=new gl(t),this.animationService=new yl(t);let i={physics:this.physicsService,candy:this.candyService,animation:this.animationService,pluginManager:null};this.pluginManager=new _a(i),i.pluginManager=this.pluginManager,this.systemContext=i,this.systems=r?[...r]:Pa(this.systemContext);for(let e of n)this.registerPlugin(e)}registerPlugin(e){let t=this.pluginManager.register(e);t.length>0&&this.systems.push(...t)}update(e){let t={};this.pluginManager.beforeUpdate(e,t);for(let n of this.systems){let r=n.update(e,t);if(this.pluginManager.afterSystem(n,r.continue,e,t),!r.continue)break}this.pluginManager.afterUpdate(e,t)}},Sl=class extends xl{overOmNom=!1;touchDown(e,t,i){if(this.ignoreTouches)return this.camera.type===Wn.SpeedType.PIXELS&&(this.fastenCamera=!0),!0;if(i>=P.MAX_TOUCHES)return!0;if(this.overOmNom=!1,this.gravityButton){let n=this.gravityButton.isOn()?1:0;if(this.gravityButton.getChild(n)?.isInTouchZone(e+this.camera.pos.x,t+this.camera.pos.y,!0))return this.gravityTouchDown=i,!0}let a=this.camera.pos,s=e+a.x,c=t+a.y;if(this.miceManager?.handleClick(s,c)||this.candyBubble&&this.handleBubbleTouch(this.star,e,t)||this.twoParts!==M.NONE&&(this.candyBubbleL&&this.handleBubbleTouch(this.starL,e,t)||this.candyBubbleR&&this.handleBubbleTouch(this.starR,e,t)))return!0;if(this.lightbulbs.length>0){for(let n of this.lightbulbs)if(n?.capturingBubble&&this.handleLightBulbBubbleTouch(n,e,t))return!0}let l=new O(e,t);if(!this.dragging[i]){this.dragging[i]=!0;let e=this.startPos[i]??(this.startPos[i]=O.newZero()),t=this.prevStartPos[i]??(this.prevStartPos[i]=O.newZero());e.copyFrom(l),t.copyFrom(l)}for(let e of this.spikes)if(e?.rotateButton&&e.touchIndex===P.UNDEFINED&&e.rotateButton.onTouchDown(s,c))return e.touchIndex=i,!0;for(let e of this.pumps)if(e&&e.pointInObject(s,c))return e.touchTimer=r,e.touch=i,!0;if(!this.noCandy)for(let e of this.bungees){if(!e||!e.gun||e.gunFired||e.rope!=null)continue;let t=Y.GUN_TAP_RADIUS;if(w.pointInRect(s,c,e.x-t,e.y-t,t*2,t*2)){let t=O.subtract(new O(e.x,e.y),this.star.pos);e.gunFired=!0,e.gunInitialRotation=z.toDegrees(t.normalizedAngle())+90,e.gunCandyInitialRotation=this.candyMain.rotation,e.gunCup&&(e.gunCup.rotation=e.gunInitialRotation,e.gunCup.playTimeline(Y.GunCup.SHOW)),e.gunFront?.setTextureQuad(Y.GunQuads.FRONT_FIRED);let r=O.distance(e.x,e.y,this.star.pos.x,this.star.pos.y)-81,i=Math.max(r,81),a=new jr(null,e.x,e.y,this.star,this.star.pos.x,this.star.pos.y,i);return a.bungeeAnchor.pin.copyFrom(a.bungeeAnchor.pos),e.setRope(a),U.playSound(n.SND_EXP_GUN),!0}}for(let e of this.tubes)if(e?.onTouchDown(s,c))return!0;for(let e of this.lanterns)if(e?.onTouchDown(s,c))return this.dd.callObject(this,this.revealCandyFromLantern,null,d),!0;let u=null,f=!1,p=!1;for(let[e,t]of this.rotatedCircles.entries()){let n=t?.handle1,r=t?.handle2;if(!t||!n||!r)continue;let a=O.distance(s,c,n.x,n.y),o=O.distance(s,c,r.x,r.y);if(a<A.RC_CONTROLLER_RADIUS&&!t.hasOneHandle()||o<A.RC_CONTROLLER_RADIUS){for(let n of this.rotatedCircles.slice(e+1)){if(!n)continue;let e=O.distance(n.x,n.y,t.x,t.y);e+n.sizeInPixels<=t.sizeInPixels&&(f=!0),e<=t.sizeInPixels+n.sizeInPixels&&(p=!0)}t.lastTouch.x=s,t.lastTouch.y=c,t.operating=i,a<A.RC_CONTROLLER_RADIUS&&t.setIsLeftControllerActive(!0),o<A.RC_CONTROLLER_RADIUS&&t.setIsRightControllerActive(!0),u=t;break}}let m=u?this.rotatedCircles.indexOf(u):-1;if(u&&m!==this.rotatedCircles.length-1&&p&&!f){let e=new o;e.addKeyFrame(D.makeColor(k.transparent.copy(),D.TransitionType.LINEAR,0)),e.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,.2));let t=new o;t.addKeyFrame(D.makeColor(k.solidOpaque.copy(),D.TransitionType.LINEAR,.2)),t.onFinished=this.onRotatedCircleTimelineFinished.bind(this);let n=u.copy();n&&(n.addTimeline(t),n.playTimeline(0),u.addTimeline(e),u.playTimeline(0),m>=0&&(this.rotatedCircles[m]=n),this.rotatedCircles.push(u)),u=null}for(let e of this.ghosts)if(e?.onTouchDown(s,c))return!0;let h=!1;for(let e of this.bungees){let t=Y.KICK_TAP_RADIUS;if(e?.kickable&&w.pointInRect(s,c,e.x-t,e.y-t,t*2,t*2)){if(!e.kicked){h=!0;break}e.kickActive=!0}}for(let e of this.bungees)e?.kickable&&e.rope&&!h&&e.kicked&&(e.stickTimer=0);let g=A.GRAB_WHEEL_RADIUS,_=g*2,v=A.GRAB_MOVE_RADIUS,y=v*2;for(let e of this.bungees)if(e&&(e.wheel&&w.pointInRect(s,c,e.x-g,e.y-g,_,_)&&(e.handleWheelTouch(s,c),e.wheelOperating=i),e.moveLength>0&&w.pointInRect(s,c,e.x-v,e.y-v,y,y)))return e.moverDragging=i,!0;if(this.conveyors.onPointerDown(s,c,i))return this.dragging[i]=!1,!0;if(this.clickToCut){let e=O.newZero(),t=this.getNearestBungeeGrabByBezierPoints(e,s,c);(t?.rope??null)?.highlighted&&t&&this.getNearestBungeeSegmentByConstraints(e,t)&&this.cut(null,e,e,!1)}return this.target.pointInDrawQuad(e,t)&&(this.overOmNom=!0),!0}doubleClick(e,t,n){return this.ignoreTouches,!0}touchUp(e,t,r){if(this.ignoreTouches)return!0;if(this.dragging[r]=!1,this.overOmNom&&this.target.pointInDrawQuad(e,t))return this.overOmNom=!1,R.publish(R.ChannelId.OmNomClicked),!0;this.overOmNom=!1;let i=this.camera.pos,a=e+i.x,o=t+i.y;for(let[e,t]of this.drawings.entries())if(t&&t.pointInObject(a,o)){t.showDrawing(),this.drawings.splice(e,1);break}if(this.gravityButton&&this.gravityTouchDown===r){let n=this.gravityButton.isOn()?1:0;this.gravityButton.getChild(n)?.isInTouchZone(e+this.camera.pos.x,t+this.camera.pos.y,!0)&&(this.gravityButton.toggle(),this.onButtonPressed(er.DefaultId)),this.gravityTouchDown=P.UNDEFINED}for(let n of this.spikes)if(n?.rotateButton&&n.touchIndex===r&&(n.touchIndex=P.UNDEFINED,n.rotateButton.onTouchUp(e+this.camera.pos.x,t+this.camera.pos.y)))return!0;for(let e of this.rotatedCircles)e&&e.operating===r&&(e.operating=P.UNDEFINED,e.soundPlaying=P.UNDEFINED,e.setIsLeftControllerActive(!1),e.setIsRightControllerActive(!1));for(let e of this.bungees)if(e&&(e.wheel&&e.wheelOperating===r&&(e.wheelOperating=P.UNDEFINED),e.moveLength>0&&e.moverDragging===r&&(e.moverDragging=P.UNDEFINED),e.kickable&&e.rope)){let t=Y.KICK_TAP_RADIUS;if(!e.kickActive&&!e.kicked&&e.rope.cut===P.UNDEFINED&&w.pointInRect(a,o,e.x-t,e.y-t,t*2,t*2)){if(e.stainCounter>0){let t=j.create(n.IMG_OBJ_STICKER,Y.StickerQuads.STAIN);t.doRestoreCutTransparency(),t.x=e.rope.bungeeAnchor.pos.x,t.y=e.rope.bungeeAnchor.pos.y,t.anchor=S.CENTER,t.color.a=e.stainCounter/Y.MAX_STAINS,this.kickStainsPool.addChild(t),e.stainCounter--}e.rope.bungeeAnchor.pin.x=P.UNDEFINED,e.rope.bungeeAnchor.pin.y=P.UNDEFINED,e.rope.bungeeAnchor.setWeight(.1),e.kicked=!0,e.stickTimer=P.UNDEFINED,e.updateKickState(),U.playSound(n.SND_EXP_SUCKER_DROP)}e.kickActive=!1}return this.conveyors.onPointerUp(a,o,r),!0}touchMove(e,t,r){if(this.ignoreTouches||r>=P.MAX_TOUCHES)return!0;let i=new O(e,t),a=this.startPos[r];if(a&&a.distance(i)>10)for(let e of this.pumps)e&&e.touch===r&&e.touchTimer!==0&&(e.touchTimer=0);this.slastTouch.copyFrom(i);let o=new O(e+this.camera.pos.x,t+this.camera.pos.y);for(let e of this.rotatedCircles)if(!(!e||!e.handle1||!e.handle2)&&e.operating===r){let t=new O(e.x,e.y);t.distance(o)<e.sizeInPixels/10&&e.lastTouch.copyFrom(o);let r=O.subtract(e.lastTouch,t),i=O.subtract(o,t).normalizedAngle()-r.normalizedAngle();i>Math.PI?i-=2*Math.PI:i<-Math.PI&&(i+=2*Math.PI),e.handle1.rotateAround(i,e.x,e.y),e.handle2.rotateAround(i,e.x,e.y),e.rotation+=z.toDegrees(i);let a=i>0?n.SND_SCRATCH_IN:n.SND_SCRATCH_OUT;Math.abs(i)<.07&&(a=P.UNDEFINED),e.soundPlaying!=a&&a!=P.UNDEFINED&&(U.playSound(a),e.soundPlaying=a);for(let n of this.bungees){if(!n)continue;let r=new O(n.x,n.y);r.distance(t)<=e.sizeInPixels+5*this.PM&&(r.rotateAround(i,e.x,e.y),n.x=r.x,n.y=r.y,n.rope&&(n.rope.bungeeAnchor.pos.copyFrom(r),n.rope.bungeeAnchor.pin.copyFrom(r)))}for(let n of this.pumps){if(!n)continue;let r=new O(n.x,n.y);r.distance(t)<=e.sizeInPixels+5*this.PM&&(r.rotateAround(i,e.x,e.y),n.x=r.x,n.y=r.y,n.rotation+=z.toDegrees(i),n.updateRotation())}for(let n of this.bubbles){if(!n)continue;let r=new O(n.x,n.y);r.distance(t)<=e.sizeInPixels+10*this.PM&&n!==this.candyBubble&&n!==this.candyBubbleR&&n!==this.candyBubbleL&&(r.rotateAround(i,e.x,e.y),n.x=r.x,n.y=r.y)}if(w.pointInRect(this.target.x,this.target.y,e.x-e.size,e.y-e.size,2*e.size,2*e.size)){let t=new O(this.target.x,this.target.y);t.rotateAround(i,e.x,e.y),this.target.x=t.x,this.target.y=t.y}return e.lastTouch.copyFrom(o),!0}for(let e of this.bungees)if(e){if(e.wheel&&e.wheelOperating===r)return e.handleWheelRotate(o),!0;if(e.moveLength>0&&e.moverDragging===r){if(e.moveVertical?e.y=I.fitToBoundaries(o.y,e.minMoveValue,e.maxMoveValue):e.x=I.fitToBoundaries(o.x,e.minMoveValue,e.maxMoveValue),e.rope){let t=e.rope.bungeeAnchor;t.pos.x=t.pin.x=e.x,t.pos.y=t.pin.y=e.y}return!0}e.kickable&&e.kicked&&e.rope&&a&&a.distance(i)>Y.KICK_MOVE_LENGTH&&(e.stickTimer=P.UNDEFINED)}if(this.conveyors.onPointerMove(o.x,o.y,r))return!0;if(this.dragging[r]){let e=this.startPos[r],t=this.prevStartPos[r],n=this.fingerCuts[r]??(this.fingerCuts[r]=[]);if(!e||!t)return!0;let a=new tr(O.add(e,this.camera.pos),O.add(i,this.camera.pos),5,5,k.white.copy()),o=0;n.push(a);for(let e of n)e&&(o+=this.cut(null,e.start,e.end,!1));o>0&&(this.freezeCamera=!1,this.ropesCutAtOnce>0&&this.ropesAtOnceTimer>0?this.ropesCutAtOnce+=o:this.ropesCutAtOnce=o,this.ropesAtOnceTimer=pe),t.copyFrom(e),e.copyFrom(i)}return!0}touchDragged(e,t,n){return n>P.MAX_TOUCHES?!1:(this.slastTouch.x=e,this.slastTouch.y=t,!0)}onButtonPressed=e=>{Kn.toggle(),this.gravityNormal=Kn.isNormal(),U.playSound(this.gravityNormal?n.SND_GRAVITY_OFF:n.SND_GRAVITY_ON);for(let e of this.earthAnims)e&&(Kn.isNormal()?e.playTimeline(ar.TimelineId.NORMAL):e.playTimeline(ar.TimelineId.UPSIDE_DOWN))};rotateAllSpikesWithId=e=>{for(let t of this.spikes)t&&t.getToggled()===e&&t.rotateSpikes()};revealCandyFromLantern(){this.isCandyInLantern=!1,this.candy.color=k.solidOpaque.copy(),this.candy.passTransformationsToChilds=!1,this.candy.scaleX=this.candy.scaleY=.71,this.candyMain.scaleX=this.candyMain.scaleY=.71,this.candyTop.scaleX=this.candyTop.scaleY=.71}},Cl=class extends Sl{};export{dn as C,cn as D,B as E,on as O,U as S,V as T,Cn as _,Vn as a,hn as b,An as c,kn as d,wn as f,gn as g,mn as h,Hn as i,Tn as l,jn as m,No as n,pn as o,Mn as p,J as r,En as s,Cl as t,On as u,Dn as v,ln as w,Pn as x,Nn as y};